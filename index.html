<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>営業支援ダッシュボード v3.0 - 月度別管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'ヒラギノ角ゴシック', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* 上段：目標・進捗エリア */
        .progress-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            color: white;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: bold;
        }

        .current-date {
            font-size: 12px;
            opacity: 0.9;
        }

        .progress-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .progress-card {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .progress-card h3 {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .progress-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-rate {
            font-size: 14px;
            font-weight: bold;
        }

        .progress-calculation {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .rate-positive { color: #4ade80; }
        .rate-negative { color: #f87171; }

        .progress-chart {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* 確率別ファネル（60%以上を強調） */
        .funnel-section {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .funnel-item {
            flex: 1;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .funnel-item:hover {
            background: rgba(255,255,255,0.3);
        }

        .funnel-excluded {
            opacity: 0.5;
            position: relative;
        }

        .funnel-excluded::after {
            content: '(対象外)';
            font-size: 8px;
            display: block;
            margin-top: 2px;
        }

        .funnel-label {
            font-size: 10px;
            margin-bottom: 4px;
        }

        .funnel-value {
            font-size: 12px;
            font-weight: bold;
        }

        /* 中段：検索・操作エリア */
        .control-section {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #4facfe;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .control-buttons-row2 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-settings {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* 下段：塾カード一覧 */
        .cards-section {
            padding: 0 20px 20px;
            background: #f8fafc;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .sort-info {
            font-size: 12px;
            color: #6b7280;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
            line-height: 1.3;
        }

        .card-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .badge-new { background: #dbeafe; color: #1d4ed8; }
        .badge-existing { background: #d1fae5; color: #065f46; }
        .badge-former { background: #fee2e2; color: #dc2626; }

        .card-location {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .current-month-badge {
            background: #4facfe;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: auto;
        }

        .card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .metric {
            background: #f8fafc;
            padding: 8px;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
        }

        .probability-section {
            margin-bottom: 15px;
        }

        .probability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .probability-label {
            font-size: 12px;
            color: #6b7280;
        }

        .probability-value {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .prob-high { background: #dcfce7; color: #166534; }
        .prob-medium-high { background: #dbeafe; color: #1e40af; }
        .prob-medium { background: #fef3c7; color: #92400e; }
        .prob-low { background: #fee2e2; color: #991b1b; }

        .probability-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }

        .last-updated {
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .last-updated:hover {
            color: #4facfe;
        }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #4facfe;
            color: white;
            transform: scale(1.1);
        }

        /* モーダル共通 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: #4facfe;
        }

        /* 住所サジェスト */
        .address-container {
            position: relative;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .address-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .address-suggestion:hover {
            background: #f8fafc;
        }

        /* 月度別データ編集 */
        .month-data-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .month-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .month-label {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
        }

        .current-month-indicator {
            background: #4facfe;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }

        .month-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* 個人設定モーダル */
        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .settings-section h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #1f2937;
        }

        /* 更新履歴 */
        .history-item {
            padding: 12px;
            border-left: 3px solid #4facfe;
            background: #f8fafc;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
        }

        .history-date {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .history-action {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .history-details {
            font-size: 12px;
            color: #6b7280;
        }

        /* PC対応 */
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
            }
            
            .cards-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                padding: 20px;
            }

            .section-header {
                grid-column: 1 / -1;
            }
        }

        /* フローティングアクションボタン */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        /* アニメーション */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 上段：目標・進捗エリア -->
        <div class="progress-section">
            <div class="progress-header">
                <div class="progress-title">営業ダッシュボード</div>
                <div class="current-date" id="currentDate">2025年8月</div>
            </div>
            
            <div class="progress-cards">
                <div class="progress-card">
                    <h3>月別目標（粗利）</h3>
                    <div class="progress-value" id="monthlyTargetDisplay">¥45万</div>
                    <div class="progress-rate rate-positive" id="monthlyRate">108.5%達成</div>
                    <div class="progress-calculation">実績+60%以上案件</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="monthlyProgressBar" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="progress-card">
                    <h3>年間目標（粗利）</h3>
                    <div class="progress-value" id="yearlyTargetDisplay">¥1300万</div>
                    <div class="progress-rate rate-positive" id="yearlyRate">104.2%達成</div>
                    <div class="progress-calculation">実績+60%以上案件</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="yearlyProgressBar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- 確率別ファネル（60%以上を進捗計算対象として強調） -->
            <div class="funnel-section">
                <div class="funnel-item" onclick="filterByProbability('80+')">
                    <div class="funnel-label">80%以上</div>
                    <div class="funnel-value" id="prob80Plus">¥259K</div>
                </div>
                <div class="funnel-item" onclick="filterByProbability('60-80')">
                    <div class="funnel-label">60-80%</div>
                    <div class="funnel-value" id="prob6080">¥81K</div>
                </div>
                <div class="funnel-item funnel-excluded" onclick="filterByProbability('50-60')">
                    <div class="funnel-label">50-60%</div>
                    <div class="funnel-value" id="prob5060">¥45K</div>
                </div>
                <div class="funnel-item funnel-excluded" onclick="filterByProbability('50-')">
                    <div class="funnel-label">50%未満</div>
                    <div class="funnel-value" id="probUnder50">¥30K</div>
                </div>
            </div>
        </div>

        <!-- 中段：検索・操作エリア -->
        <div class="control-section">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="塾名で検索..." id="searchInput">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="openNewCardModal()">
                    ➕ 新規塾登録
                </button>
                <button class="btn btn-settings" onclick="openPersonalSettingsModal()">
                    ⚙️ 個人設定
                </button>
            </div>

            <div class="control-buttons-row2">
                <button class="btn btn-secondary" onclick="openImportModal()">
                    📥 Excel読込
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    📄 Excel出力
                </button>
                <button class="btn btn-secondary" onclick="toggleSort()">
                    📊 並び替え
                </button>
            </div>

            <div class="filter-section">
                <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                    <option value="all">すべて</option>
                    <option value="new">新規</option>
                    <option value="existing">既存</option>
                    <option value="former">失注塾</option>
                </select>
                <select class="filter-select" id="probabilityFilter" onchange="applyFilters()">
                    <option value="all">全確率</option>
                    <option value="80+">80%以上</option>
                    <option value="60-80">60-80%</option>
                    <option value="50-60">50-60%</option>
                    <option value="50-">50%未満</option>
                </select>
                <select class="filter-select" id="cityFilter" onchange="applyFilters()">
                    <option value="all">全地域</option>
                    <option value="大阪市">大阪市</option>
                    <option value="豊中市">豊中市</option>
                    <option value="交野市">交野市</option>
                    <option value="堺市">堺市</option>
                </select>
            </div>
        </div>

        <!-- 下段：塾カード一覧（架空塾名使用） -->
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">塾一覧</div>
                <div class="sort-info">最終更新日順（新→古）</div>
            </div>

            <div id="cardsContainer">
                <!-- 架空塾カード1：既存塾 -->
                <div class="card" data-last-updated="2025-08-25" data-status="existing" data-probability="80+" data-city="交野市">
                    <div class="card-header">
                        <div class="card-title">青葉進学塾</div>
                        <div class="card-badge badge-existing">既存</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 交野市
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥50,000</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥14,965</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-high">80%以上</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 85%; background: linear-gradient(90deg, #22c55e, #16a34a);"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('青葉進学塾')">最終更新: 2025/08/25</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>

                <!-- 架空塾カード2：新規塾 -->
                <div class="card" data-last-updated="2025-08-24" data-status="new" data-probability="80+" data-city="豊中市">
                    <div class="card-header">
                        <div class="card-title">光風アカデミー</div>
                        <div class="card-badge badge-new">新規</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 豊中市
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥250,000</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥74,825</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-high">80%以上</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 80%; background: linear-gradient(90deg, #22c55e, #16a34a);"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('光風アカデミー')">最終更新: 2025/08/24</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>

                <!-- 架空塾カード3：失注塾 -->
                <div class="card" data-last-updated="2025-08-23" data-status="former" data-probability="50-" data-city="大阪市中央区">
                    <div class="card-header">
                        <div class="card-title">瑞光個別学院</div>
                        <div class="card-badge badge-former">失注塾</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 大阪市中央区
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥0</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-low">失注</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 0%; background: #ef4444;"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('瑞光個別学院')">最終更新: 2025/08/23</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>

                <!-- 架空塾カード4：新規塾（60-80%） -->
                <div class="card" data-last-updated="2025-08-22" data-status="new" data-probability="60-80" data-city="堺市北区">
                    <div class="card-header">
                        <div class="card-title">星陵ゼミナール</div>
                        <div class="card-badge badge-new">新規</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 堺市北区
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥70,000</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥20,951</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-medium-high">60-80%</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 70%; background: linear-gradient(90deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('星陵ゼミナール')">最終更新: 2025/08/22</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>

                <!-- 架空塾カード5：既存塾 -->
                <div class="card" data-last-updated="2025-08-21" data-status="existing" data-probability="80+" data-city="大阪市北区">
                    <div class="card-header">
                        <div class="card-title">未来スタディ</div>
                        <div class="card-badge badge-existing">既存</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 大阪市北区
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥120,000</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥35,916</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-high">80%以上</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 85%; background: linear-gradient(90deg, #22c55e, #16a34a);"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('未来スタディ')">最終更新: 2025/08/21</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>

                <!-- 架空塾カード6：新規塾（50-60%、進捗計算対象外） -->
                <div class="card" data-last-updated="2025-08-20" data-status="new" data-probability="50-60" data-city="吹田市">
                    <div class="card-header">
                        <div class="card-title">桜花学習センター</div>
                        <div class="card-badge badge-new">新規</div>
                        <div class="current-month-badge">8月</div>
                    </div>
                    
                    <div class="card-location">
                        📍 吹田市
                    </div>
                    
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">8月売上目標</div>
                            <div class="metric-value">¥30,000</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">8月粗利</div>
                            <div class="metric-value">¥8,979</div>
                        </div>
                    </div>
                    
                    <div class="probability-section">
                        <div class="probability-header">
                            <div class="probability-label">8月受注確率</div>
                            <div class="probability-value prob-medium">50-60%</div>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: 55%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="last-updated" onclick="showUpdateHistory('桜花学習センター')">最終更新: 2025/08/20</div>
                        <div class="card-actions">
                            <button class="action-btn" title="編集" onclick="editCard(this)">✏️</button>
                            <button class="action-btn" title="電話" onclick="callAction(this)">📞</button>
                            <button class="action-btn" title="メモ" onclick="addMemo(this)">📝</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フローティングアクションボタン -->
    <button class="fab" onclick="openNewCardModal()" title="新規塾登録">➕</button>

    <!-- 個人設定モーダル -->
    <div class="modal" id="personalSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">個人設定</div>
                <button class="close-btn" onclick="closePersonalSettingsModal()">&times;</button>
            </div>
            
            <form id="personalSettingsForm">
                <div class="settings-section">
                    <h4>基本情報</h4>
                    <div class="form-group">
                        <label class="form-label">担当者名</label>
                        <input type="text" class="form-input" value="八木" id="userName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">個人粗利率（%）</label>
                        <input type="number" class="form-input" value="30" step="0.1" id="profitRate">
                    </div>
                </div>

                <div class="settings-section">
                    <h4>年間目標</h4>
                    <div class="form-group">
                        <label class="form-label">年間粗利目標（円）</label>
                        <input type="number" class="form-input" value="13000000" id="yearlyProfitTarget">
                    </div>
                </div>

                <div class="settings-section">
                    <h4>月別目標</h4>
                    <div class="form-group">
                        <label class="form-label">8月粗利目標（円）</label>
                        <input type="number" class="form-input" value="450000" id="monthlyTarget8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">9月粗利目標（円）</label>
                        <input type="number" class="form-input" value="500000" id="monthlyTarget9">
                    </div>
                    <div class="form-group">
                        <label class="form-label">10月粗利目標（円）</label>
                        <input type="number" class="form-input" value="400000" id="monthlyTarget10">
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closePersonalSettingsModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新規塾登録モーダル -->
    <div class="modal" id="newCardModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">新規塾登録</div>
                <button class="close-btn" onclick="closeNewCardModal()">&times;</button>
            </div>
            
            <form id="newCardForm">
                <div class="form-group">
                    <label class="form-label">塾名 *</label>
                    <input type="text" class="form-input" placeholder="例：○○学習塾" required id="newJukuName">
                </div>
                
                <div class="form-group">
                    <label class="form-label">区分</label>
                    <select class="form-select" id="newJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">失注塾</option>
                    </select>
                </div>
                
                <div class="form-group address-container">
                    <label class="form-label">住所（市区町村）</label>
                    <input type="text" class="form-input" id="newAddressInput" placeholder="例: 豊中市、大阪市中央区" autocomplete="off">
                    <div class="address-suggestions" id="newAddressSuggestions"></div>
                </div>

                <div class="month-data-section">
                    <div class="month-data-header">
                        <div class="month-label">8月データ</div>
                        <div class="current-month-indicator">編集可能</div>
                    </div>
                    <div class="month-data-grid">
                        <div class="form-group">
                            <label class="form-label">売上目標（円）</label>
                            <input type="number" class="form-input" placeholder="50000" id="newSalesTarget">
                        </div>
                        <div class="form-group">
                            <label class="form-label">粗利（円）</label>
                            <input type="number" class="form-input" placeholder="14965" id="newProfit">
                        </div>
                        <div class="form-group">
                            <label class="form-label">受注確率</label>
                            <select class="form-select" id="newProbability">
                                <option value="80+">80%以上</option>
                                <option value="60-80">60-80%</option>
                                <option value="50-60">50-60%</option>
                                <option value="50-">50%未満</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">備考</label>
                            <input type="text" class="form-input" placeholder="メモ・備考" id="newMemo">
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeNewCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">登録</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Excel読み込みモーダル -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Excel読み込み</div>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Excelファイルを選択</label>
                <input type="file" class="form-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)" id="fileInput">
            </div>
            
            <div class="form-group">
                <p style="font-size: 12px; color: #6b7280; line-height: 1.4;">
                    ※ 塾名と住所のみを読み込みます。<br>
                    ※ 売上・粗利・確率は手動で入力してください。<br>
                    ※ PCでの操作を推奨します。<br>
                    ※ 塾名は自動的に架空名に置き換えられます。
                </p>
            </div>
            
            <div class="control-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="importExcelData()">読み込み</button>
            </div>
        </div>
    </div>

    <!-- 更新履歴モーダル -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyTitle">更新履歴</div>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            
            <div id="historyContent">
                <!-- 履歴がここに動的に挿入される -->
            </div>
        </div>
    </div>

    <!-- 塾編集モーダル -->
    <div class="modal" id="editCardModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">塾編集</div>
                <button class="close-btn" onclick="closeEditCardModal()">&times;</button>
            </div>
            
            <form id="editCardForm">
                <div class="form-group">
                    <label class="form-label">塾名</label>
                    <input type="text" class="form-input" id="editJukuName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">区分</label>
                    <select class="form-select" id="editJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">失注塾</option>
                    </select>
                </div>
                
                <div class="form-group address-container">
                    <label class="form-label">住所（市区町村）</label>
                    <input type="text" class="form-input" id="editAddressInput" autocomplete="off">
                    <div class="address-suggestions" id="editAddressSuggestions"></div>
                </div>

                <div class="month-data-section">
                    <div class="month-data-header">
                        <div class="month-label" id="editMonthLabel">8月データ</div>
                        <div class="current-month-indicator">編集可能</div>
                    </div>
                    <div class="month-data-grid">
                        <div class="form-group">
                            <label class="form-label">売上目標（円）</label>
                            <input type="number" class="form-input" id="editSalesTarget">
                        </div>
                        <div class="form-group">
                            <label class="form-label">粗利（円）</label>
                            <input type="number" class="form-input" id="editProfit">
                        </div>
                        <div class="form-group">
                            <label class="form-label">受注確率</label>
                            <select class="form-select" id="editProbability">
                                <option value="80+">80%以上</option>
                                <option value="60-80">60-80%</option>
                                <option value="50-60">50-60%</option>
                                <option value="50-">50%未満</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">備考</label>
                            <input type="text" class="form-input" id="editMemo" placeholder="メモ・備考">
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // グローバル変数
        let sortOrder = 'desc';
        let currentEditingCard = null;
        
        // パーソナル設定（確定された初期値）
        let personalSettings = {
            userName: '八木',
            profitRate: 30,
            yearlyProfitTarget: 13000000,
            monthlyTargets: {
                8: 450000,
                9: 500000,
                10: 400000,
                11: 350000,
                12: 400000,
                1: 500000,
                2: 450000,
                3: 600000
            }
        };

        // 住所サジェスト用データ（政令指定都市は区まで）
        const addressSuggestions = [
            // 大阪市（区レベル）
            '大阪市北区', '大阪市中央区', '大阪市西区', '大阪市天王寺区', '大阪市浪速区',
            '大阪市西淀川区', '大阪市淀川区', '大阪市東淀川区', '大阪市東成区', '大阪市生野区',
            '大阪市旭区', '大阪市城東区', '大阪市鶴見区', '大阪市阿倍野区', '大阪市住之江区',
            '大阪市住吉区', '大阪市東住吉区', '大阪市平野区', '大阪市西成区', '大阪市此花区',
            '大阪市港区', '大阪市大正区', '大阪市福島区', '大阪市都島区',
            // 堺市（区レベル）
            '堺市堺区', '堺市中区', '堺市東区', '堺市西区', '堺市南区', '堺市北区', '堺市美原区',
            // 京都市（区レベル）
            '京都市北区', '京都市上京区', '京都市左京区', '京都市中京区', '京都市東山区',
            '京都市下京区', '京都市南区', '京都市右京区', '京都市伏見区', '京都市山科区', '京都市西京区',
            // 神戸市（区レベル）
            '神戸市東灘区', '神戸市灘区', '神戸市兵庫区', '神戸市長田区', '神戸市須磨区',
            '神戸市垂水区', '神戸市北区', '神戸市中央区', '神戸市西区',
            // その他関西圏市町村
            '豊中市', '吹田市', '高槻市', '枚方市', '茨木市', '八尾市', '寝屋川市', '守口市',
            '門真市', '摂津市', '東大阪市', '箕面市', '柏原市', '羽曳野市', '藤井寺市',
            '松原市', '大東市', '和泉市', '交野市', '四條畷市', '泉大津市', '富田林市',
            '河内長野市', '池田市', '泉佐野市', '岸和田市', '貝塚市', '泉南市', '阪南市',
            '奈良市', '生駒市', '橿原市', '大和郡山市', '天理市', '桜井市', '五條市',
            '御所市', '香芝市', '葛城市', '宇治市', '亀岡市', '城陽市', '向日市',
            '長岡京市', '八幡市', '京田辺市', '京丹後市', '南丹市', '木津川市'
        ];

        // 現在の月を取得
        function getCurrentMonth() {
            return new Date().getMonth() + 1; // 1-12
        }

        function getCurrentYear() {
            return new Date().getFullYear();
        }

        // 住所サジェスト機能の設定
        function setupAddressSuggestion(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            if (!input || !suggestions) return;

            input.addEventListener('input', function(e) {
                const inputValue = e.target.value.toLowerCase();
                
                if (inputValue.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }

                const filtered = addressSuggestions.filter(addr => 
                    addr.toLowerCase().includes(inputValue)
                ).slice(0, 10);

                if (filtered.length > 0) {
                    suggestions.innerHTML = filtered.map(addr => 
                        `<div class="address-suggestion" onclick="selectAddress('${addr}', '${inputId}', '${suggestionsId}')">${addr}</div>`
                    ).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
        }

        function selectAddress(address, inputId, suggestionsId) {
            document.getElementById(inputId).value = address;
            document.getElementById(suggestionsId).style.display = 'none';
        }

        // 進捗計算（実績+60%以上案件）
        function calculateProgress() {
            const cards = document.querySelectorAll('.card');
            let totalActual = 0; // 実績（実装時にデータベースから取得）
            let total60Plus = 0; // 60%以上案件の加重合計
            
            cards.forEach(card => {
                if (card.style.display === 'none') return;
                
                const profitElement = card.querySelectorAll('.metric-value')[1];
                const probabilityElement = card.querySelector('.probability-value');
                
                if (!profitElement || !probabilityElement) return;
                
                const profit = parseInt(profitElement.textContent.replace('¥', '').replace(',', '')) || 0;
                const probability = probabilityElement.textContent;
                
                // 60%以上案件のみ進捗計算に含める
                if (probability.includes('80%以上')) {
                    total60Plus += profit * 0.85; // 85%で加重
                } else if (probability.includes('60-80%')) {
                    total60Plus += profit * 0.70; // 70%で加重
                }
                // 50-60%、50%未満は進捗計算対象外
            });
            
            const currentMonth = getCurrentMonth();
            const monthlyTarget = personalSettings.monthlyTargets[currentMonth] || 450000;
            const yearlyTarget = personalSettings.yearlyProfitTarget;
            
            // 進捗率計算（実績 + 60%以上案件加重合計）
            const monthlyProgress = ((totalActual + total60Plus) / monthlyTarget) * 100;
            const yearlyProgress = ((totalActual + total60Plus) / yearlyTarget) * 100;
            
            return {
                monthlyProgress: Math.min(monthlyProgress, 150), // 150%上限
                yearlyProgress: Math.min(yearlyProgress, 150),
                monthlyTarget,
                yearlyTarget
            };
        }

        // ダッシュボード更新
        function updateDashboard() {
            const progress = calculateProgress();
            const currentMonth = getCurrentMonth();
            
            // 月別目標表示更新
            document.getElementById('monthlyTargetDisplay').textContent = 
                `¥${Math.round(progress.monthlyTarget / 10000)}万`;
            document.getElementById('monthlyRate').textContent = 
                `${progress.monthlyProgress.toFixed(1)}%達成`;
            document.getElementById('monthlyRate').className = 
                progress.monthlyProgress >= 100 ? 'progress-rate rate-positive' : 'progress-rate rate-negative';
            document.getElementById('monthlyProgressBar').style.width = 
                `${Math.min(progress.monthlyProgress, 100)}%`;
            
            // 年間目標表示更新
            document.getElementById('yearlyTargetDisplay').textContent = 
                `¥${Math.round(progress.yearlyTarget / 10000)}万`;
            document.getElementById('yearlyRate').textContent = 
                `${progress.yearlyProgress.toFixed(1)}%達成`;
            document.getElementById('yearlyRate').className = 
                progress.yearlyProgress >= 100 ? 'progress-rate rate-positive' : 'progress-rate rate-negative';
            document.getElementById('yearlyProgressBar').style.width = 
                `${Math.min(progress.yearlyProgress, 100)}%`;
        }

        // 検索・フィルター機能
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const probabilityFilter = document.getElementById('probabilityFilter').value;
            const cityFilter = document.getElementById('cityFilter').value;
            
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const status = card.dataset.status;
                const probability = card.dataset.probability;
                const city = card.dataset.city;
                
                let show = true;
                
                if (searchTerm && !title.includes(searchTerm)) show = false;
                if (statusFilter !== 'all' && status !== statusFilter) show = false;
                if (probabilityFilter !== 'all' && probability !== probabilityFilter) show = false;
                if (cityFilter !== 'all' && !city.includes(cityFilter)) show = false;
                
                card.style.display = show ? 'block' : 'none';
            });
            
            // フィルター後にダッシュボード更新
            updateDashboard();
        }

        function filterByProbability(probability) {
            document.getElementById('probabilityFilter').value = probability;
            applyFilters();
        }

        // 並び替え機能
        function toggleSort() {
            sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
            const container = document.getElementById('cardsContainer');
            const cards = Array.from(container.querySelectorAll('.card'));
            
            cards.sort((a, b) => {
                const dateA = new Date(a.dataset.lastUpdated);
                const dateB = new Date(b.dataset.lastUpdated);
                return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            cards.forEach(card => container.appendChild(card));
            
            document.querySelector('.sort-info').textContent = 
                sortOrder === 'desc' ? '最終更新日順（新→古）' : '最終更新日順（古→新）';
        }

        // モーダル制御
        function openPersonalSettingsModal() {
            document.getElementById('personalSettingsModal').style.display = 'flex';
        }

        function closePersonalSettingsModal() {
            document.getElementById('personalSettingsModal').style.display = 'none';
        }

        function openNewCardModal() {
            document.getElementById('newCardModal').style.display = 'flex';
            setupAddressSuggestion('newAddressInput', 'newAddressSuggestions');
        }

        function closeNewCardModal() {
            document.getElementById('newCardModal').style.display = 'none';
        }

        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function openEditCardModal() {
            document.getElementById('editCardModal').style.display = 'flex';
            setupAddressSuggestion('editAddressInput', 'editAddressSuggestions');
        }

        function closeEditCardModal() {
            document.getElementById('editCardModal').style.display = 'none';
            currentEditingCard = null;
        }

        // Excel機能（月度別列対応）
        function exportToExcel() {
            const cards = document.querySelectorAll('.card');
            const currentMonth = getCurrentMonth();
            const currentYear = getCurrentYear();
            
            // 固定列 + 現在月の4列
            const headers = ['塾名', '区分', '住所', '最終更新日'];
            headers.push(`${currentMonth}月売上`, `${currentMonth}月粗利`, `${currentMonth}月確率`, `${currentMonth}月備考`);
            
            const data = [headers];
            
            cards.forEach(card => {
                if (card.style.display !== 'none') {
                    const title = card.querySelector('.card-title').textContent;
                    const badge = card.querySelector('.card-badge').textContent;
                    const location = card.querySelector('.card-location').textContent.replace('📍 ', '');
                    const lastUpdated = card.querySelector('.last-updated').textContent.replace('最終更新: ', '');
                    
                    const metrics = card.querySelectorAll('.metric-value');
                    const salesTarget = metrics[0] ? metrics[0].textContent.replace('¥', '').replace(',', '') : '0';
                    const profit = metrics[1] ? metrics[1].textContent.replace('¥', '').replace(',', '') : '0';
                    const probability = card.querySelector('.probability-value').textContent;
                    
                    const memo = ''; // 実際の実装では備考データを取得
                    
                    data.push([title, badge, location, lastUpdated, salesTarget, profit, probability, memo]);
                }
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "営業管理データ");
            
            // 個人設定も別シートで追加
            const settingsData = [
                ['項目', '値'],
                ['担当者名', personalSettings.userName],
                ['個人粗利率(%)', personalSettings.profitRate],
                ['年間粗利目標', personalSettings.yearlyProfitTarget],
                [`${currentMonth}月目標`, personalSettings.monthlyTargets[currentMonth] || 0]
            ];
            const settingsWs = XLSX.utils.aoa_to_sheet(settingsData);
            XLSX.utils.book_append_sheet(wb, settingsWs, "個人設定");
            
            const fileName = `営業管理データ_月度別_${currentYear}-${String(currentMonth).padStart(2, '0')}-${new Date().getDate()}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`Excel出力完了！\nファイル名: ${fileName}\n\n月度別データと個人設定を含んでいます。`);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('選択されたファイル:', file.name);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // 最初のシートを取得
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        console.log('読み込んだデータ:', jsonData);
                        alert(`${jsonData.length}件のデータを読み込み準備完了しました。`);
                        
                    } catch (error) {
                        alert('ファイル読み込みエラーが発生しました。');
                        console.error('Excel読み込みエラー:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function importExcelData() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                alert('ファイルを選択してください。');
                return;
            }
            
            alert('Excel読み込み完了！\n塾名と住所を取り込み、架空名に自動変換しました。\n売上・粗利・確率は各カードで入力してください。');
            closeImportModal();
        }

        // 更新履歴表示（月度別対応）
        function showUpdateHistory(jukuName) {
            const modal = document.getElementById('historyModal');
            const title = document.getElementById('historyTitle');
            const content = document.getElementById('historyContent');
            
            title.textContent = `${jukuName} - 更新履歴`;
            
            const currentMonth = getCurrentMonth();
            const historyData = [
                {
                    date: '2025/08/25 14:30',
                    action: `${currentMonth}月データ更新`,
                    details: '確率: 60-80% → 80%以上に変更'
                },
                {
                    date: '2025/08/24 10:15',
                    action: '電話対応完了',
                    details: `担当者との面談アポ取得（${currentMonth}月データ）`
                },
                {
                    date: '2025/08/23 16:45',
                    action: `${currentMonth}月売上目標更新`,
                    details: '¥30,000 → ¥50,000に修正'
                },
                {
                    date: '2025/08/22 09:20',
                    action: 'メモ追加',
                    details: '見本送付完了の記録'
                }
            ];
            
            content.innerHTML = historyData.map(item => `
                <div class="history-item">
                    <div class="history-date">${item.date}</div>
                    <div class="history-action">${item.action}</div>
                    <div class="history-details">${item.details}</div>
                </div>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // カードアクション
        function editCard(button) {
            currentEditingCard = button.closest('.card');
            const cardTitle = currentEditingCard.querySelector('.card-title').textContent;
            const badge = currentEditingCard.querySelector('.card-badge').textContent;
            const location = currentEditingCard.querySelector('.card-location').textContent.replace('📍 ', '');
            const metrics = currentEditingCard.querySelectorAll('.metric-value');
            const probability = currentEditingCard.querySelector('.probability-value').textContent;
            
            const currentMonth = getCurrentMonth();
            
            // 編集モーダルに値を設定
            document.getElementById('editModalTitle').textContent = `${cardTitle} - 編集`;
            document.getElementById('editMonthLabel').textContent = `${currentMonth}月データ`;
            document.getElementById('editJukuName').value = cardTitle;
            document.getElementById('editAddressInput').value = location;
            
            // 区分の設定
            let statusValue = 'new';
            if (badge === '既存') statusValue = 'existing';
            else if (badge === '失注塾') statusValue = 'former';
            document.getElementById('editJukuStatus').value = statusValue;
            
            // 売上・粗利の設定
            if (metrics[0]) {
                document.getElementById('editSalesTarget').value = metrics[0].textContent.replace('¥', '').replace(',', '');
            }
            if (metrics[1]) {
                document.getElementById('editProfit').value = metrics[1].textContent.replace('¥', '').replace(',', '');
            }
            
            // 確率の設定
            let probValue = '50-';
            if (probability.includes('80%以上')) probValue = '80+';
            else if (probability.includes('60-80%')) probValue = '60-80';
            else if (probability.includes('50-60%')) probValue = '50-60';
            document.getElementById('editProbability').value = probValue;
            
            openEditCardModal();
        }

        function callAction(button) {
            const cardTitle = button.closest('.card').querySelector('.card-title').textContent;
            const currentMonth = getCurrentMonth();
            
            if (confirm(`${cardTitle}に電話をかけますか？`)) {
                const card = button.closest('.card');
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                card.querySelector('.last-updated').textContent = `最終更新: ${today}`;
                card.dataset.lastUpdated = today;
                alert(`通話完了として記録しました。\n${currentMonth}月データとして保存されます。`);
                updateDashboard();
            }
        }

        function addMemo(button) {
            const cardTitle = button.closest('.card').querySelector('.card-title').textContent;
            const currentMonth = getCurrentMonth();
            const memo = prompt(`${cardTitle}の${currentMonth}月メモを入力してください：`);
            
            if (memo) {
                const card = button.closest('.card');
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                card.querySelector('.last-updated').textContent = `最終更新: ${today}`;
                card.dataset.lastUpdated = today;
                alert(`${currentMonth}月メモを保存しました：\n"${memo}"`);
                updateDashboard();
            }
        }

        // フォーム送信処理
        document.getElementById('personalSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 個人設定を更新
            personalSettings.userName = document.getElementById('userName').value;
            personalSettings.profitRate = parseFloat(document.getElementById('profitRate').value);
            personalSettings.yearlyProfitTarget = parseInt(document.getElementById('yearlyProfitTarget').value);
            personalSettings.monthlyTargets[8] = parseInt(document.getElementById('monthlyTarget8').value);
            personalSettings.monthlyTargets[9] = parseInt(document.getElementById('monthlyTarget9').value);
            personalSettings.monthlyTargets[10] = parseInt(document.getElementById('monthlyTarget10').value);
            
            // ローカルストレージに保存
            localStorage.setItem('personalSettings', JSON.stringify(personalSettings));
            
            // ダッシュボードを更新
            updateDashboard();
            
            alert('個人設定を保存しました！');
            closePersonalSettingsModal();
        });

        document.getElementById('newCardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const currentMonth = getCurrentMonth();
            alert(`新規塾が登録されました！\n${currentMonth}月データとして保存されます。`);
            closeNewCardModal();
            updateDashboard();
        });

        document.getElementById('editCardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentEditingCard) {
                const jukuName = document.getElementById('editJukuName').value;
                const currentMonth = getCurrentMonth();
                
                // カードデータを更新
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                currentEditingCard.querySelector('.last-updated').textContent = `最終更新: ${today}`;
                currentEditingCard.dataset.lastUpdated = today;
                
                alert(`${jukuName}の${currentMonth}月データを更新しました！`);
                closeEditCardModal();
                updateDashboard();
            }
        });

        // 初期化
        window.addEventListener('load', () => {
            // ローカルストレージから個人設定を読み込み
            const savedSettings = localStorage.getItem('personalSettings');
            if (savedSettings) {
                personalSettings = { ...personalSettings, ...JSON.parse(savedSettings) };
            }
            
            // 現在の日付を表示
            const currentDate = new Date();
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            document.getElementById('currentDate').textContent = `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`;
            
            // 住所サジェスト外クリックで閉じる
            document.addEventListener('click', function(e) {
                const addressContainers = document.querySelectorAll('.address-container');
                addressContainers.forEach(container => {
                    if (!container.contains(e.target)) {
                        const suggestions = container.querySelector('.address-suggestions');
                        if (suggestions) suggestions.style.display = 'none';
                    }
                });
            });

            // ダッシュボードの初期化
            updateDashboard();
        });

        // モーダル外クリックで閉じる
        window.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
