<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
   <meta name="apple-mobile-web-app-title" content="上半期シミュレーション表"/>
    <meta name="theme-color" content="#20B2AA">
    <title>上半期シミュレーション表</title>
    
<!-- favicon（PCタブ用・文字なし・中央大表示） -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiNGRkZGRkYiLz4KPGcgZmlsbD0iIzIwQjJBQSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjU2LDI1NikiPgo8IS0tIOatr+OCsOODqeODlSjkuK3lpK7kuIvpg6gpIC0tPgo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtODAsNjApIHNjYWxlKDEuNikiPgo8IS0tIOODmeODvOOCueODqeOCpOODsyAtLT4KPHJlY3QgeD0iMCIgeT0iNTAiIHdpZHRoPSIxMDAiIGhlaWdodD0iNiIgcng9IjMiLz4KPCEtLSDmo5Ljg6njg5UoM+acrCkgLS0+CjxyZWN0IHg9IjEwIiB5PSIzMCIgd2lkdGg9IjE4IiBoZWlnaHQ9IjIwIiByeD0iMyIvPgo8cmVjdCB4PSI0MCIgeT0iMTAiIHdpZHRoPSIxOCIgaGVpZ2h0PSI0MCIgcng9IjMiLz4KPHJlY3QgeD0iNzAiIHk9Ii0xMCIgd2lkdGg9IjE4IiBoZWlnaHQ9IjYwIiByeD0iMyIvPgo8L2c+CjwhLS0g5q6X6LuKKOS4reWkruWPs+S4iikgLS0+CjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcwLC02MCkgc2NhbGUoMS40KSI+CjwhLS0g5q6X6LuK44Gu56qB6LW3KDjmnKwpIC0tPgo8cmVjdCB4PSItNCIgeT0iLTI4IiB3aWR0aD0iOCIgaGVpZ2h0PSIxNCIgcng9IjIiLz4KPHJlY3QgeD0iLTQiIHk9Ii0yOCIgd2lkdGg9IjgiIGhlaWdodD0iMTQiIHJ4PSIyIiB0cmFuc2Zvcm09InJvdGF0ZSg0NSkiLz4KPHJlY3QgeD0iLTQiIHk9Ii0yOCIgd2lkdGg9IjgiIGhlaWdodD0iMTQiIHJ4PSIyIiB0cmFuc2Zvcm09InJvdGF0ZSg5MCkiLz4KPHJlY3QgeD0iLTQiIHk9Ii0yOCIgd2lkdGg9IjgiIGhlaWdodD0iMTQiIHJ4PSIyIiB0cmFuc2Zvcm09InJvdGF0ZSgxMzUpIi8+CjxyZWN0IHg9Ii00IiB5PSItMjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjE0IiByeD0iMiIgdHJhbnNmb3JtPSJyb3RhdGUoMTgwKSIvPgo8cmVjdCB4PSItNCIgeT0iLTI4IiB3aWR0aD0iOCIgaGVpZ2h0PSIxNCIgcng9IjIiIHRyYW5zZm9ybT0icm90YXRlKDIyNSkiLz4KPHJlY3QgeD0iLTQiIHk9Ii0yOCIgd2lkdGg9IjgiIGhlaWdodD0iMTQiIHJ4PSIyIiB0cmFuc2Zvcm09InJvdGF0ZSgyNzApIi8+CjxyZWN0IHg9Ii00IiB5PSItMjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjE0IiByeD0iMiIgdHJhbnNmb3JtPSJyb3RhdGUoMzE1KSIvPgo8IS0tIOatr+i7iuacrOS9kyAtLT4KPGNpcmNsZSByPSIyMCIgZmlsbD0iIzIwQjJBQSIvPgo8IS0tIOS4reW/g+eptSAtLT4KPGNpcmNsZSByPSI3IiBmaWxsPSIjRkZGRkZGIi8+CjwvZz4KPC9nPgo8L3N2Zz4K">

    <!-- iPhone用アイコン（動的生成） -->
    <link id="apple-touch-icon" rel="apple-touch-icon" sizes="180x180">
    
    <!-- PWA manifest（動的生成） -->
    <link id="app-manifest" rel="manifest">
    
    <!-- アイコン自動生成スクリプト -->
    <script>
    (function() {
       const SVG_SOURCE = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="512" height="512">
  <!-- 白背景 -->
  <rect width="512" height="512" fill="#FFFFFF"/>

  <!-- 左側：グラフィック部分（絶対座標・中央配置） -->
  <g fill="#20B2AA">
    <!-- ベースライン -->
    <rect x="60" y="320" width="160" height="8" rx="4"/>
    
    <!-- 棒グラフ（3本・適切なサイズ） -->
    <rect x="75" y="270" width="28" height="50" rx="4"/>
    <rect x="115" y="240" width="28" height="80" rx="4"/>
    <rect x="155" y="210" width="28" height="110" rx="4"/>

    <!-- 歯車（右上・バランス良い配置） -->
    <g transform="translate(140,180)">
      <!-- 歯車の突起（8本） -->
      <rect x="-4" y="-32" width="8" height="16" rx="2"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(45)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(90)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(135)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(180)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(225)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(270)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(315)"/>
      
      <!-- 歯車本体 -->
      <circle r="24" fill="#20B2AA"/>
      <!-- 中心穴 -->
      <circle r="9" fill="#FFFFFF"/>
    </g>
  </g>

  <!-- 右側：テキスト部分（見切れ対策済み） -->
  <g fill="#20B2AA" font-family="system-ui, -apple-system, 'Hiragino Sans', 'Noto Sans JP', sans-serif" font-weight="bold">
    <text x="220" y="250" font-size="70" text-anchor="start">上半期</text>
    <text x="220" y="320" font-size="70" text-anchor="start">シミュ</text>
  </g>
</svg>`;

        function svgToPng(svgText, size) {
            return new Promise((resolve) => {
                const img = new Image();
                const svgBlob = new Blob([svgText], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, size, size);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = url;
            });
        }

        async function setupIcons() {
            try {
                // iPhone用180x180 PNG生成
                const png180 = await svgToPng(SVG_SOURCE, 180);
                document.getElementById('apple-touch-icon').href = png180;

                // PWA用PNG生成
                const png192 = await svgToPng(SVG_SOURCE, 192);
                const png512 = await svgToPng(SVG_SOURCE, 512);

                // PWA manifest生成
                const manifest = {
    name: '上半期シミュレーション表',
    short_name: 'シミュレーション表',
    start_url: new URL('./', window.location.href).href,
    display: 'standalone',
    background_color: '#20B2AA',
    theme_color: '#20B2AA',
    icons: [
        { src: png192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
        { src: png512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' },
        { src: png180, sizes: '180x180', type: 'image/png' }
    ]
};



                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
                const manifestUrl = URL.createObjectURL(manifestBlob);
                document.getElementById('app-manifest').href = manifestUrl;

                console.log('アプリアイコンの設定完了');
            } catch (error) {
                console.warn('アイコン生成エラー:', error);
            }
        }

        // ページ読み込み後に実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupIcons);
        } else {
            setupIcons();
        }
    })();
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'ヒラギノ角ゴ ProN', Meiryo, sans-serif;
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
            font-size: 16px;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        body.modal-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .header-section {
    background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 15px rgba(32, 178, 170, 0.3);
    flex-wrap: wrap;
    gap: 16px;
}

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .user-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .login-user-info {
            font-size: 18px;
            font-weight: bold;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            white-space: nowrap;
        }

        .view-selector-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .view-selector-label {
            color: white;
            font-weight: 500;
        }

        .view-selector {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
            min-width: 180px;
        }

        .view-permission-info {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .permission-edit {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }

        .permission-view {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-auth {
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-auth:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
        }

        .current-date-header {
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-month-selector {
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .global-month-selector option {
            color: #333;
            background: #fff;
        }

        .progress-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .progress-card {
            background: #e3f2fd !important;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: none !important;
            position: relative;
        }

        .progress-card:hover,
        .progress-card:active,
        .progress-card:focus {
            background: #e3f2fd !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .progress-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            line-height: 1.2;
            min-height: 2.4em;
            font-weight: 600;
            color: #333;
        }

        .progress-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 6px;
    color: #20B2AA;
}


        .progress-detail {
            font-size: 16px;
            margin-bottom: 4px;
            color: #333;
            font-weight: 600;
        }

        .progress-rate {
            font-size: 14px;
            font-weight: bold;
        }

        .rate-positive { color: #2E7D32; }
        .rate-negative { color: #D32F2F; }

        .progress-chart {
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            margin-top: 8px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .funnel-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .funnel-item {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .funnel-item:hover,
        .funnel-item:active {
            background: white !important;
            transform: none !important;
        }

        .funnel-label {
            font-size: 12px;
            margin-bottom: 3px;
            color: #333;
        }

        .funnel-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .control-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 40px 14px 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: #fff;
            color: #333;
        }

        .search-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

       .search-input:focus {
    border-color: #20B2AA;
    box-shadow: 0 0 0 2px rgba(32, 178, 170, 0.25);
}


        .search-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: #20B2AA;
    font-size: 18px;
}


        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .btn:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
    background: #20B2AA;
    color: white;
}

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-settings {
            background: linear-gradient(135deg, #FFD700 0%, #FFEA00 100%);
            color: #333;
        }

        .filter-section {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .filter-select, .sort-select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            min-height: 48px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .sort-section {
            margin-bottom: 16px;
        }

        .sort-select {
            width: 100%;
        }

        .cards-section {
            padding: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 12px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .sort-info {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
        }

        /* PCテーブル用CSS */
        .desktop-table-container {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .juku-table {
    width: 100%;
    table-layout: fixed;
    font-size: 14px;
    border-collapse: collapse;
}

/* 列幅の最適化 */
/* 列幅の最適化 */
.col-level { width: 8px; padding: 0 !important; }
.col-name { width: 150px; }
.col-prev-amount, .col-current-amount { width: 100px; text-align: center; }
.col-prev-prob, .col-current-prob { width: 80px; text-align: center; }
.col-change { width: 90px; text-align: center; }
.col-edit { width: 85px; text-align: center; }
.col-detail { width: 70px; text-align: center; }

/* PC版テーブルの編集可能セルの色付け */
@media (min-width: 1025px) {
    .desktop-table-container .editable-cell {
        background: rgba(76, 175, 80, 0.08) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
        border-radius: 4px;
        padding: 4px;
    }
    .desktop-table-container .editable-cell:hover {
        background: rgba(76, 175, 80, 0.16) !important;
    }
}

        .juku-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        .juku-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .juku-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .juku-table tbody tr:nth-child(odd) {
            background: #fff;
        }

        .juku-table tbody tr:hover {
            background: #e3f2fd !important;
        }

        .level-indicator {
            width: 8px;
            height: 40px;
            display: block;
        }

        .level-0 { background: #fff; }
        .level-1 { background: #BBDEFB; }
        .level-2 { background: #C8E6C9; }
        .level-3 { background: #FFF9C4; }
        .level-4 { background: #FFCDD2; }

        .editable-cell {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-cell:hover {
            background: rgba(0,123,255,0.1);
        }

        .change-positive { color: #2E7D32; font-weight: bold; }
        .change-negative { color: #D32F2F; font-weight: bold; }
        .change-neutral { color: #666; }

        .detail-btn {
    background: #20B2AA;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.detail-btn:hover {
    background: #17A2B8;
}

/* PC版テーブル用最終更新日時表示 */
.last-updated-table {
    font-size: 11px;
    color: #666;
    text-align: center;
    line-height: 1.3;
    padding: 4px 2px;
    word-break: break-all;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

        @media (max-width: 1024px) {
            .desktop-table-container {
                display: none;
            }
        }

        @media (min-width: 1025px) {
            .mobile-cards-container {
                display: none;
            }
        }

        .card {
            background: #fff !important;
            color: #333 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: none !important;
            position: relative;
        }

        .card:hover,
        .card:active,
        .card:focus {
            background: #fff !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .card-level-0 { background: #fff !important; border-left: 6px solid #fff; }
        .card-level-1 { background: #fff !important; border-left: 6px solid #BBDEFB; }
        .card-level-2 { background: #fff !important; border-left: 6px solid #C8E6C9; }
        .card-level-3 { background: #fff !important; border-left: 6px solid #FFF9C4; }
        .card-level-4 { background: #fff !important; border-left: 6px solid #FFCDD2; }

        .card-header-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .card-title-clickable {
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            color: #333 !important;
            text-decoration: underline;
            text-decoration-color: rgba(0,0,0,0.3);
            transition: text-decoration-color 0.2s ease;
        }

        .card-title-clickable:hover {
    text-decoration-color: #20B2AA;
}

        .month-selector {
            display: block;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.8);
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }

        .annual-metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }

        .annual-metric {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .annual-metric-label {
            font-size: 12px;
            margin-bottom: 2px;
            color: #333;
            font-weight: 500;
            line-height: 1.2;
        }

        .annual-metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .monthly-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 6px;
        }

        .month-data-column {
            text-align: center;
        }

        .month-data-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .month-data-content {
            background: rgba(255,255,255,0.4);
            padding: 10px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .forecast-amount {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .forecast-probability {
            font-size: 14px;
            color: #333;
            opacity: 0.9;
            font-weight: 600;
        }

        .memo-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .memo-column {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .memo-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .memo-content {
            font-size: 13px;
            line-height: 1.3;
            color: #333;
            min-height: 2.6em;
            word-wrap: break-word;
            white-space: pre-wrap;
            cursor: pointer;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.2);
        }

        .last-updated {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
            cursor: pointer;
        }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            color: rgba(0,0,0,0.9);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .action-btn:focus {
    outline: 2px solid #20B2AA;
    outline-offset: 2px;
}

.action-btn:hover {
    background: #20B2AA;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
}

        .annual-materials-mini {
            background: rgba(255,255,255,0.4);
            border: 1px solid rgba(0,176,255,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .annual-materials-mini-title {
            font-size: 14px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 8px;
            text-align: center;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(25,118,210,0.2);
        }

        .materials-mini-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .materials-mini-item {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            padding: 8px;
        }

        .materials-mini-header {
            font-size: 12px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 6px;
            text-align: center;
        }

        .material-mini-field {
            margin-bottom: 6px;
        }

        .material-mini-label {
            font-size: 11px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .material-mini-select,
        .material-mini-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
            font-size: 12px;
            background: white;
            color: #333;
            box-sizing: border-box;
        }

        .material-mini-input::placeholder {
            color: rgba(0,0,0,0.5);
            font-size: 11px;
        }

        .comparison-positive { color: #2E7D32; }
        .comparison-negative { color: #D32F2F; }
        .comparison-neutral { color: #666; }

        .change-indicator {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        .modal-history {
            max-width: 900px;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: white;
            color: #333;
        }

        .form-input:focus, .form-select:focus {
    border-color: #20B2AA;
    box-shadow: 0 0 0 2px rgba(32, 178, 170, 0.25);
}

        .form-input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            color: #333;
        }
        
        .settings-section h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .monthly-data-section {
    background: rgba(255,255,255,0.6);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
    color: #333;
}


        .monthly-row {
    display: grid;
    grid-template-columns: 70px 1fr 1fr 20px; /* 月名欄縮小 */
    gap: 8px; /* ギャップ縮小 */
    align-items: center;
    margin-bottom: 8px;
}


        .month-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            text-align: center;
        }

        .monthly-input {
    padding: 6px 8px; /* パディング縮小 */
    border: 1px solid rgba(0,0,0,0.3);
    border-radius: 4px;
    font-size: 14px; /* フォントサイズ縮小 */
    text-align: right;
    background: rgba(255,255,255,0.9);
    color: #333;
    box-sizing: border-box;
    width: 100%;
    max-width: 120px; /* 最大幅制限 */
}


        .monthly-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .monthly-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .monthly-history-container {
            max-height: 32vh;
            overflow-y: auto;
            padding: 10px;
        }

        /* コンパクトモーダル用CSS */
        .compact-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
        }

        .compact-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .compact-month-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compact-data-grid {
            display: grid;
            grid-template-columns: 1fr 80px 2fr;
            gap: 8px;
            align-items: center;
        }

        .compact-field {
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .compact-field-label {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            margin-bottom: 2px;
        }

        .compact-field-value {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .compact-memo {
            font-size: 12px;
            line-height: 1.3;
            color: #333;
            max-height: 40px;
            overflow: hidden;
            word-wrap: break-word;
        }

        .history-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f9f9f9;
        }

        .history-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .history-month-label {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .readonly-badge {
            background: #9E9E9E;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .history-data-grid {
            display: grid;
            grid-template-columns: 1fr 120px 2fr;
            gap: 12px;
            align-items: start;
        }

        .history-field label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
        }

        .history-input, .history-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .history-memo {
            width: 100%;
            min-height: 60px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .history-input:read-only, 
        .history-select:disabled, 
        .history-memo:read-only {
            background: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.7;
        }
      
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .toast-error { background: linear-gradient(135deg, #F44336, #FF5252); }
        .toast-info { background: linear-gradient(135deg, #2196F3, #007bff); }

        .editable-field {
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-field:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .editable-field .display-value {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .editable-field .edit-input,
.editable-field .edit-select {
    width: calc(100% - 12px);
    padding: 6px 8px;
    border: 1px solid #20B2AA;
    border-radius: 4px;
    font-size: 16px;
    box-sizing: border-box;
    background-color: white;
    color: #333;
}

        @media (prefers-contrast: high) {
            .card {
                border: 2px solid #000;
            }
        }
        /* カード表示改善 */
/* 既存のcard-level背景色指定を無効化 */
.card-level-0, .card-level-1, .card-level-2, .card-level-3, .card-level-4 {
    background: inherit !important;
}

/* カード背景をテーブルの縞模様に統一 */
.mobile-cards-container .card {
    background: #fff !important;
}

.mobile-cards-container .card:nth-child(even) {
    background: #f8f9fa !important;
}

/* カードのレベルインジケーター（左＋上ライン）を鮮やかに */
.mobile-cards-container .card.card-level-0 { 
    border-left: 4px solid #9E9E9E !important;
    border-top: 4px solid #9E9E9E !important;
}
.mobile-cards-container .card.card-level-1 { 
    border-left: 4px solid #2196F3 !important;
    border-top: 4px solid #2196F3 !important;
}
.mobile-cards-container .card.card-level-2 { 
    border-left: 4px solid #4CAF50 !important;
    border-top: 4px solid #4CAF50 !important;
}
.mobile-cards-container .card.card-level-3 { 
    border-left: 4px solid #FF9800 !important;
    border-top: 4px solid #FF9800 !important;
}
.mobile-cards-container .card.card-level-4 { 
    border-left: 4px solid #F44336 !important;
    border-top: 4px solid #F44336 !important;
}

/* スマホ版奇数カードオーバーレイ */
@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: rgba(173, 216, 230, 0.15);
        border-radius: 12px;
        z-index: 1;
    }
    
    .mobile-cards-container .card > * {
        position: relative;
        z-index: 2;
    }
}

/* 閲覧専用カードとの競合解決 */
.read-only-card {
    box-shadow: inset 0 0 0 2px #ffc107 !important;
    border: none !important;
}


        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-right {
                align-items: stretch;
            }
            
            .user-info-section {
                align-items: stretch;
            }
            
            .view-selector-section {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .view-selector {
                min-width: auto;
            }

            .current-date-header {
                margin-top: 12px;
            }

            .progress-cards {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .control-buttons {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin-bottom: 8px;
                min-height: 48px;
                font-size: 16px;
            }

            .filter-section {
                flex-direction: column;
            }

            .cards-section {
                display: block;
            }

            .section-header {
                margin-bottom: 12px;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }

            .monthly-comparison-section {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .materials-mini-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .annual-metrics-row {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }

            .form-input, .form-select {
                font-size: 16px;
                padding: 14px 12px;
            }
        }

        @media (min-width: 1200px) {
            .cards-section .card {
                display: inline-block;
                width: calc(50% - 8px);
                margin-right: 16px;
                vertical-align: top;
            }

            .cards-section .card:nth-child(even) {
                margin-right: 0;
            }
        }
        /* 1. スマホ表示のみ：編集可能箇所を薄い緑色で強調 */
@media (max-width: 1024px) {
    .monthly-comparison-section .month-data-column:nth-child(2) .editable-field {
        background: rgba(76, 175, 80, 0.12) !important;
        border: 1px solid rgba(76, 175, 80, 0.25);
        border-radius: 6px;
        padding: 6px 8px;
    }
    
    .memo-comparison-section .memo-column:nth-child(2) .memo-content {
        background: rgba(76, 175, 80, 0.08) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
        border-radius: 6px;
        padding: 8px;
    }
}

/* 2. 縞模様を濃いめに調整 */
.juku-table tbody tr:nth-child(even) {
    background: #f0f0f0 !important; /* #f8f9fa → #f0f0f0 */
}

.mobile-cards-container .card:nth-child(even) {
    background: #f0f0f0 !important;
}

@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        background: rgba(173, 216, 230, 0.22); /* 0.15 → 0.22 */
    }
}

/* 3. ファネル80/90/100を中段カード（黄色）と同色に */
.funnel-section .funnel-item:nth-child(4), /* 80 */
.funnel-section .funnel-item:nth-child(5), /* 90 */
.funnel-section .funnel-item:nth-child(6)  /* 100 */ {
    background: #FFF3CD !important;
    border: 1px solid #FFE082 !important;
}

.funnel-section .funnel-item:nth-child(4):hover,
.funnel-section .funnel-item:nth-child(5):hover,
.funnel-section .funnel-item:nth-child(6):hover {
    background: #FFECB3 !important;
    border-color: #FFCA28 !important;
}


/* 4. 6項目ファネルのレスポンシブ対応 */
@media (max-width: 768px) {
    .funnel-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 6px;
    }
    
    .funnel-label {
        font-size: 11px;
        margin-bottom: 3px;
        color: #333;
    }
    
    .funnel-value {
        font-size: 13px;
        font-weight: bold;
        color: #333;
    }
}

@media (max-width: 480px) {
    .funnel-section {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(3, 1fr);
    }
}

        /* PC版レイアウト（1025px以上） */
@media (min-width: 1025px) {
    .container {
        display: flex;
        flex-direction: column;
    }
    .header-section { order: 0; }
    #normalDashboardContent { order: 1; display: flex; flex-direction: column; }
    #masterViewContent { order: 2; }
    
    /* 4枚カードを確実に2×2グリッドレイアウトに設定 */
    .progress-main-cards {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        margin-bottom: 16px;
    }
    
    /* 内側セクションの順序制御 */
    #normalDashboardContent .progress-main-cards { order: 1; }
    #normalDashboardContent .progress-middle-section { order: 2; }
    #normalDashboardContent .funnel-section { order: 3; }
    #normalDashboardContent .control-section { order: 4; }
    #normalDashboardContent .cards-section { order: 5; }
}

/* スマホ版レイアウト（1024px以下） */
@media (max-width: 1024px) {
    .container {
        padding: 12px;
        display: flex;
        flex-direction: column;
    }
    .header-section { order: 0; }  /* ヘッダーを最優先 */
    #normalDashboardContent { order: 1; display: flex; flex-direction: column; }
    #masterViewContent { order: 2; }
    
    /* スマホ版の内側セクション順序 */
    #normalDashboardContent .progress-middle-section { order: 1; }
    #normalDashboardContent .funnel-section { order: 2; }
    #normalDashboardContent .control-section { order: 3; }
    #normalDashboardContent .cards-section { order: 4; }
    #normalDashboardContent .progress-main-cards { order: 5; }
}

/* 新4枚カードの基本レイアウト */
.card-metrics {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    line-height: 1.4;
}

.metric-label {
    font-weight: 600;
    color: inherit;
    min-width: 60px;
}

.metric-value {
    font-weight: bold;
    text-align: right;
    flex: 1;
}

/* カードタイトルを少し大きく */
.progress-card h3 {
    font-size: 19px !important;
    font-weight: 700 !important;
    margin-bottom: 8px;
    text-align: center;
    color: inherit;
}

/* 視認性重視の色分け（淡色背景＋黒文字） */
.new-monthly-profit-card {
    background: #E8F5E8 !important; /* 緑系・濃い */
    color: #1B5E20 !important;
}

.new-monthly-sales-card {
    background: #F1F8E9 !important; /* 緑系・薄い */
    color: #2E7D32 !important;
}

.new-cumulative-profit-card {
    background: #E3F2FD !important; /* 水色系・濃い */
    color: #0D47A1 !important;
}

.new-cumulative-sales-card {
    background: #E8F4FD !important; /* 水色系・薄い */
    color: #1565C0 !important;
}
        /* 自動計算フィールド（手入力不可）の背景色 */
.auto-calculated-field {
    background: #F8F9FA !important;
    border: 1px solid #DEE2E6 !important;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: default;
    color: #495057 !important;
}

.auto-calculated-field:hover {
    background: #E9ECEF !important;
}

/* 差額のマイナス表示（赤字） */
.metric-value.negative {
    color: #D32F2F !important;
    font-weight: bold;
}

.metric-value.positive {
    color: inherit;
}

.metric-value.neutral {
    color: inherit;
}
        
/* 中段カード */
.progress-middle-card {
    background: #FFF3CD;
    border: 1px solid #FFE082;
    border-radius: 12px;
    padding: 12px 20px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.progress-middle-content {
    font-size: 13px;
    font-weight: 600;
    color: #333;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
@media (max-width: 1024px) {
    .progress-middle-content {
        font-size: 12px;
        color: #333; /* 黒色で統一 */
    }
}

/* FABボタン */
.fab-settings {
    position: fixed;
    bottom: 100px;
    left: 20px;
    width: 56px;
    height: 56px;
    background: #CD853F;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(205, 133, 63, 0.4);
    z-index: 100;
    transition: all 0.2s ease;
}
.fab-add {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 56px;
    height: 56px;
    background: #20B2AA;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(32, 178, 170, 0.4);
    z-index: 100;
    transition: all 0.2s ease;
}

.fab-settings:hover, .fab-add:hover {
    transform: scale(1.05);
}
@media (min-width: 1025px) {
    .fab-settings, .fab-add {
        display: none;
    }
}
        .editable-profit-field {
    background: #FCE4EC !important;
    border: 1px solid #E91E63 !important;
    color: #880E4F !important;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-block;
    min-width: 60px;
    text-align: right;
    font-weight: bold;
}
.editable-profit-field:hover {
    background: #F8BBD9 !important;
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

        .master-view-container { padding: 20px; }
.master-staff-section {
    margin-bottom: 32px;
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    background: #fafafa;
}
.master-staff-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 16px;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
}
.master-main-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}
.master-middle-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}
.master-middle-card {
    background: #FFF3CD;
    border: 1px solid #FFE082;
    border-radius: 8px;
    padding: 12px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #333; /* 黒色に変更 */
    text-align: center;
}
@media (max-width: 1024px) {
    /* マスタービューをスマホでも表示可能に */
    .master-view-container { 
        display: block !important; 
        padding: 12px;
    }
    .master-view-option { display: inline !important; }
    
    /* スマホ版レイアウト調整 */
    .master-main-cards {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    .master-middle-cards {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    .master-middle-card.full-width {
        grid-column: auto !important;
    }
    
    .master-staff-section {
        margin-bottom: 24px;
        padding: 16px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
}

/* 中段黄色カードの見込み値強調 */
.value-emphasis {
    font-size: 18px !important;
    font-weight: 800 !important;
    color: #333 !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

@media (max-width: 1024px) {
    .value-emphasis {
        font-size: 16px !important;
    }
}

/* 売上カードの編集機能を完全無効化 */
.monthly-sales-card .editable-profit-field,
.cumulative-sales-card .editable-profit-field {
    background: transparent !important;
    border: none !important;
    color: inherit !important;
    cursor: default !important;
    pointer-events: none !important;
}

/* モーダル内のボタン表示確保 */
.modal .control-buttons {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 12px !important;
}

/* 4枚カードの色分け */
.monthly-profit-card {
    background: #E8F5E8 !important;
    color: #1B5E20 !important;
}

.monthly-sales-card {
    background: #F1F8E9 !important;
    color: #2E7D32 !important;
}

.cumulative-profit-card {
    background: #E3F2FD !important;
    color: #0D47A1 !important;
}

.cumulative-sales-card {
    background: #E8F4FD !important;
    color: #1565C0 !important;
}
#personalSettingsModal .monthly-row {
    display: grid;
    grid-template-columns: 50px minmax(0, 1fr) minmax(0, 1fr); /* 3列レイアウト、柔軟な幅調整 */
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    width: 100%;
}

#personalSettingsModal .monthly-input {
    padding: 6px 8px;
    border: 1px solid rgba(0,0,0,0.3);
    border-radius: 4px;
    font-size: 14px;
    text-align: right;
    background: rgba(255,255,255,0.9);
    color: #333;
    width: 100%;
    min-width: 0 !important; /* iOS/Safari対応：グリッド内縮小を許可 */
    box-sizing: border-box;
}

/* スマホ専用：最適化された表示 */
@media (max-width: 768px) {
    #personalSettingsModal .monthly-data-section {
        padding: 10px;
        overflow-x: auto; /* フォールバック：必要時のみスクロール許可 */
    }
    
    #personalSettingsModal .monthly-row {
        grid-template-columns: 45px minmax(0, 1fr) minmax(0, 1fr);
        gap: 6px;
        margin-bottom: 6px;
        min-width: 280px; /* 最小表示幅を確保 */
    }
    
    #personalSettingsModal .monthly-input {
        font-size: 13px;
        padding: 4px 6px;
        min-width: 70px; /* 入力しやすい最小幅 */
    }
    
    #personalSettingsModal .month-name {
        font-size: 12px;
        text-align: center;
    }
}

        /* スマホ表示での確実な順序制御 */
@media (max-width: 1024px) {
    /* コンテナのflex設定を確実に適用 */
    #normalDashboardContent {
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* 順序の確実な適用（既存設定の強化） */
    #normalDashboardContent .progress-middle-section { 
        order: 10 !important; 
    }
    #normalDashboardContent .funnel-section { 
        order: 20 !important; 
    }
    #normalDashboardContent .control-section { 
        order: 30 !important; 
    }
    #normalDashboardContent .cards-section { 
        order: 40 !important; 
    }
    #normalDashboardContent .progress-main-cards { 
        order: 50 !important; 
    }
}
/* スマホ版で四角ボタンを非表示 */
@media (max-width: 1024px) {
    .control-buttons {
        display: none !important;
    }
    
    /* FABボタンを確実に表示 */
    .fab-settings, .fab-add {
        display: block !important;
    }
}

/* PC版でFABボタンを非表示（既存の設定を強化） */
@media (min-width: 1025px) {
    .fab-settings, .fab-add {
        display: none !important;
    }
    
    /* 四角ボタンを確実に表示 */
    .control-buttons {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
    }
}

        /* === レイアウト重なり問題の完全解消 === */

/* 4枚カードの安定配置 */
.progress-main-cards {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
    align-items: stretch !important;
}

/* 中段カードを3枚対応のグリッド配置 */
.progress-middle-section {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
    align-items: stretch !important;
}

/* 3枚目カードを下段全幅表示 */
.progress-middle-card.full-width {
    grid-column: 1 / -1 !important;
}

/* ファネルの6項目安定配置 */
.funnel-section {
    display: grid !important;
    grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
    gap: 8px !important;
    margin-bottom: 16px !important;
}

/* 各セクション間の確実な余白確保 */
.header-section,
.progress-main-cards,
.progress-middle-section,
.funnel-section,
.control-section,
.cards-section {
    margin-bottom: 16px !important;
    position: relative !important;
    z-index: auto !important;
}

/* スマホ版レイアウト調整 */
@media (max-width: 1024px) {
    .progress-main-cards {
        grid-template-columns: 1fr !important;
    }
    
    .progress-middle-section {
        grid-template-columns: 1fr !important;
    }
    
    .progress-middle-card.full-width {
        grid-column: auto !important;
    }
    
    .funnel-section {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

@media (max-width: 480px) {
    .funnel-section {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

/* マスタービューの中段カードも同様に調整 */
.master-middle-cards {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
}

.master-middle-card.full-width {
    grid-column: 1 / -1 !important;
}

@media (max-width: 1024px) {
    .master-middle-cards {
        grid-template-columns: 1fr !important;
    }
    
    .master-middle-card.full-width {
        grid-column: auto !important;
    }
}
        /* 月別データ表示の改善（スマホ対応） */
@media (max-width: 768px) {
    .monthly-data-section {
        max-height: none !important;
        overflow-y: visible !important;
    }
    
    .modal-content {
        max-height: 95vh !important;
        overflow-y: auto;
    }
}
        
        /* 個人設定売上増目標カードの薄い緑色配色 */
.personal-sales-target-card {
    background: #E8F5E8 !important;
    border: 1px solid #C8E6C9 !important;
}

/* === 新規追加開始 === */
/* 区分別色分けシステム */
.level-indicator.status-new { background: #2196F3; } /* 新規: 青 */
.level-indicator.status-existing { background: #4CAF50; } /* 既存: 緑 */
.level-indicator.status-former { background: #FF9800; } /* 元既存: 黄 */

/* スマホ版カード用（区分別左+上ライン） */
.mobile-cards-container .card.card-status-new { 
    border-left: 4px solid #2196F3 !important;
    border-top: 4px solid #2196F3 !important;
}
.mobile-cards-container .card.card-status-existing { 
    border-left: 4px solid #4CAF50 !important;
    border-top: 4px solid #4CAF50 !important;
}
.mobile-cards-container .card.card-status-former { 
    border-left: 4px solid #FF9800 !important;
    border-top: 4px solid #FF9800 !important;
}

/* 新しい売上見込合計カード */
.progress-middle-card.total-sales-prospect-card {
    background: #E0F2F7 !important;
    border: 1px solid #B2EBF2 !important;
    color: #006064 !important;
}

/* 根拠モーダル用スタイル */
.modal-evidence {
    max-width: 90vw;
    max-height: 90vh;
    width: 800px;
}

.evidence-textarea {
    width: 100%;
    min-height: 300px;
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 16px;
    line-height: 1.5;
    resize: vertical;
}

.evidence-textarea:focus {
    border-color: #20B2AA;
    box-shadow: 0 0 0 2px rgba(32, 178, 170, 0.25);
}

.character-count {
    text-align: right;
    margin-top: 5px;
    font-size: 14px;
    color: #666;
}
/* === 新規追加終了 === */

/* マスタービューの個人設定売上増目標も同色に */
.master-middle-card.personal-sales-target-card {
    background: #E8F5E8 !important;
    border: 1px solid #C8E6C9 !important;
}

/* 文字色を確実に黒色で統一 */
.personal-sales-target-card .progress-middle-content,
.master-middle-card.personal-sales-target-card {
    color: #333 !important;
}

        /* === PC版詳細モーダル削除ボタン === */

/* モーダルヘッダーのアクション部分 */
.modal-header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* 小さな削除ボタンのスタイル */
.btn-danger {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #c82333, #a71e2a);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
}

.btn-danger:active {
    transform: translateY(0);
}

.btn-danger:focus {
    outline: 2px solid #dc3545;
    outline-offset: 2px;
}

/* スマホでのレイアウト調整 */
@media (max-width: 768px) {
    .modal-header-actions {
        flex-direction: column-reverse;
        gap: 8px;
        align-items: flex-end;
    }
    
    .btn-sm {
        font-size: 11px;
        padding: 4px 8px;
    }
}
        
    </style>
  <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { initializeFirestore, doc, getDoc, getDocs, collection, query, where, setDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Firebase設定情報（確実に定義）
  const firebaseConfig = {
    apiKey: "AIzaSyC_EUgAAVFfk0TonQgKVMxs8TcuvFdXKIQ",
    authDomain: "eigyo-shiendashboard.firebaseapp.com",
    projectId: "eigyo-shiendashboard",
    storageBucket: "eigyo-shiendashboard.firebasestorage.app",
    messagingSenderId: "665404365898",
    appId: "1:665404365898:web:a60374339c99ea5c16dab3"
  };

  const app = initializeApp(firebaseConfig);
  window.firebaseAuth = getAuth(app);
  
 // 🆕 企業ネットワーク対応：HTTP 400エラー解消（修正版）
try {
  window.db = initializeFirestore(app, {
    experimentalForceLongPolling: true,
    useFetchStreams: false
  });
  console.log('Firestore初期化成功');
} catch (error) {
  console.error('Firestore初期化エラー:', error);
  // フォールバック: 通常のFirestore初期化を試行
  const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
  window.db = getFirestore(app);
}

  window.firebaseImports = {
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    doc,
    getDoc,
    getDocs,      
    collection,   
    query,        
    where,        
    setDoc,
    deleteDoc,
    serverTimestamp
  };
</script>

</head>
<body>
    <div class="container">
        <div class="header-section">
    <div class="header-left">
        <div class="header-title">上半期シミュレーション表</div>
        <div class="current-date-header" id="currentDateHeader">
            <span id="currentDateDisplay">2025年8月</span>
            <select class="global-month-selector" id="globalMonthSelector" onchange="changeAllCardsDisplayMonth(this.value)">
            </select>
        </div>
    </div>
    
    <div class="header-right">
        <div class="user-info-section">
            <div class="login-user-info" id="loginUserInfo">
                <span class="login-status">未ログイン</span>
            </div>
            
            <div class="view-selector-section" id="viewSelectorSection" style="display: none;">
    <label class="view-selector-label">データ表示:</label>
    <select class="view-selector" id="viewSelector" onchange="changeViewTarget()">
        <option value="">選択してください</option>
    </select>
    <span class="view-permission-info" id="viewPermissionInfo"></span>
</div>
        </div>
        
        <div class="auth-buttons" id="authButtons">
            <button class="btn btn-auth" onclick="quickLogin()" id="loginBtn">🔐 ログイン</button>
            <button class="btn btn-auth" onclick="quickLogout()" id="logoutBtn" style="display: none;">🚪 ログアウト</button>
        </div>
    </div>
</div>
        
        <!-- progress-sectionラッパーを削除し、各セクションをcontainerの直接の子に -->
        <div id="normalDashboardContent">
<div class="progress-main-cards">
    <!-- 月別粗利カード -->
    <div class="progress-card monthly-profit-card">
        <h3>月別粗利</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="monthlyProfitTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value editable-profit-field" onclick="editMonthlyProfitInline(this)" id="monthlyProfitActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="monthlyProfitDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="monthlyProfitRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 月別売上カード -->
    <div class="progress-card monthly-sales-card">
        <h3>月別売上</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="monthlySalesTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value" id="monthlySalesActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="monthlySalesDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="monthlySalesRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 累積粗利カード -->
    <div class="progress-card cumulative-profit-card">
        <h3>累積粗利</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="cumulativeProfitTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value editable-profit-field" onclick="editCumulativeProfitInline(this)" id="cumulativeProfitActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="cumulativeProfitDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="cumulativeProfitRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 累積売上カード -->
    <div class="progress-card cumulative-sales-card">
        <h3>累積売上</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="cumulativeSalesTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value" id="cumulativeSalesActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="cumulativeSalesDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="cumulativeSalesRate">0.0%</span>
            </div>
        </div>
    </div>
</div>

<div class="progress-middle-section">
    <!-- 新規追加：売上見込合計カード -->
    <div class="progress-middle-card total-sales-prospect-card full-width">
        <div class="progress-middle-content" id="totalSalesProspectDisplay">
            売上見込合計 ¥0
        </div>
    </div>
    
    <!-- 既存カードはそのまま -->
    <div class="progress-middle-card personal-sales-target-card full-width">
        <div class="progress-middle-content" id="personalIncreaseTargetDisplay">
            個人設定売上増目標 0.0万円 | 粗利率 0.0%
        </div>
    </div>
    <div class="progress-middle-card">
        <div class="progress-middle-content" id="salesProspectDisplay">
            売上増見込 ¥0/¥0 (0.0%)
        </div>
    </div>
    <div class="progress-middle-card">
        <div class="progress-middle-content" id="profitProspectDisplay">
            粗利増見込 ¥0/¥0 (0.0%)
        </div>
    </div>
</div>

<!-- 根拠モーダル追加（既存モーダル群の後に） -->
<div class="modal" id="evidenceModal" role="dialog" aria-modal="true">
    <div class="modal-content modal-evidence">
        <div class="modal-header">
            <div class="modal-title" id="evidenceModalTitle">年間営業根拠</div>
            <button class="close-btn" onclick="closeEvidenceModal()" aria-label="閉じる">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="evidenceCardName">営業戦略・根拠・進捗記録</label>
            <textarea class="form-input evidence-textarea" id="evidenceContentInput" 
                      maxlength="1000" placeholder="年間を通した営業戦略、根拠、進捗などを記録してください（1000文字以内）"
                      style="min-height: 300px; resize: vertical;"></textarea>
            <div class="character-count">
                <span id="evidenceCharCount">0</span> / 1000文字
            </div>
        </div>
        
        <div class="control-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeEvidenceModal()">キャンセル</button>
            <button type="button" class="btn btn-primary" onclick="saveEvidenceContent()">保存</button>
        </div>
    </div>
</div>

<div class="funnel-section">
    <div class="funnel-item" onclick="filterByProbability('under50')" aria-label="確率50%未満で絞り込み">
        <div class="funnel-label">50%未満</div>
        <div class="funnel-value" id="probUnder50">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('50-60')" aria-label="確率50-70%で絞り込み">
        <div class="funnel-label">50%-70%未満</div>
        <div class="funnel-value" id="prob5060">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('70')" aria-label="確率70%で絞り込み">
        <div class="funnel-label">70%以上</div>
        <div class="funnel-value" id="prob70">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('80')" aria-label="確率80%で絞り込み">
        <div class="funnel-label">80%以上</div>
        <div class="funnel-value" id="prob80">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('90')" aria-label="確率90%で絞り込み">
        <div class="funnel-label">90%以上</div>
        <div class="funnel-value" id="prob90">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('100')" aria-label="確率100%で絞り込み">
        <div class="funnel-label">100%</div>
        <div class="funnel-value" id="prob100">¥0万</div>
    </div>
</div>


        <div class="control-section">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 塾名で検索..." id="searchInput" aria-label="塾名で検索">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="openNewCardModal()" aria-label="塾登録を開く">
    ➕ 塾登録
</button>
<button class="btn btn-settings" onclick="openPersonalSettingsModal()" aria-label="個人設定を開く">
    ⚙️ 個人設定
</button>
            </div>

            <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%; margin-bottom: 16px;" aria-label="フィルタをクリア">
                🔄 フィルタクリア
            </button>

            <div class="sort-section">
                <select class="sort-select" id="sortSelect" onchange="applySorting()" aria-label="並び替え">
                    <option value="sales-desc">💰 売上増見込順（大→小）</option>
                    <option value="sales-asc">💰 売上増見込順（小→大）</option>
                    <option value="updated-desc">📅 最終更新日順（新→古）</option>
                    <option value="updated-asc">📅 最終更新日順（古→新）</option>
                    <option value="probability-desc">📈 受注確率順（高→低）</option>
                    <option value="probability-asc">📈 受注確率順（低→高）</option>
                </select>
            </div>

            <div class="filter-section">
                <select class="filter-select" id="statusFilter" onchange="applyFilters()" aria-label="区分で絞り込み">
                    <option value="all">すべて</option>
                    <option value="new">新規</option>
                    <option value="existing">既存</option>
                    <option value="former">元既存</option>
                </select>
               
                <select class="filter-select" id="areaFilter" onchange="applyFilters()" aria-label="エリアで絞り込み">
                </select>
            </div>
        </div>
    
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">塾一覧</div>
                <div class="sort-info" id="sortInfo">売上増見込順（大→小）</div>
            </div>
            
            <div class="desktop-table-container" id="desktopTableContainer">
                <table class="juku-table">
                    <thead>
    <tr>
        <th class="col-level"></th>
        <th class="col-name">塾名 / URL</th>
        <th class="col-prev-amount">先月見込</th>
        <th class="col-prev-prob">先月確率</th>
        <th class="col-current-amount">今月見込</th>
        <th class="col-current-prob">今月確率</th>
        <th class="col-change">変化</th>
        <th class="col-edit">編集/更新日</th>
        <th class="col-detail">詳細</th>
    </tr>
</thead>


                    <tbody id="jukuTableBody"></tbody>
                </table>
            </div>
            
            <div class="mobile-cards-container" id="cardsContainer"></div>
        </div>
    </div>
      <!-- マスタービューコンテンツ（初期は非表示） -->
    <div id="masterViewContent" style="display: none;">
    </div>
    </div>
  
    <div class="modal" id="personalSettingsModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">個人設定</div>
                <button class="close-btn" onclick="closePersonalSettingsModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="personalSettingsForm">
                <div class="settings-section">
                    <h4>基本情報</h4>
                    <div class="form-group">
                        <label class="form-label" for="userName">担当者名</label>
                        <input type="text" class="form-input" value="担当者" id="userName">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="profitRate">個人粗利率（%）</label>
                        <input type="number" class="form-input" value="0" step="0.1" id="profitRate" oninput="updatePersonalSalesTarget()">
                    </div>
                </div>

                <div class="settings-section">
                    <h4>年間目標</h4>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitTarget">年間粗利目標</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitTarget">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitIncreaseTarget">粗利増目標</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitIncreaseTarget" oninput="updatePersonalSalesTarget()">
                        <small>昨年からの粗利増加目標額</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlySalesIncreaseTarget">年間売上増目標</label>
                        <input type="number" class="form-input" value="0" id="yearlySalesIncreaseTarget" readonly>
                        <small>粗利増目標を個人粗利率で逆算した値</small>
                    </div>
                    <!-- 🆕 個人設定売上増目標の追加 -->
                    <div class="form-group">
                        <label class="form-label" for="personalSalesIncreaseTarget">個人設定売上増目標</label>
                        <input type="number" class="form-input" value="0" id="personalSalesIncreaseTarget" placeholder="例: 5000000">
                        <small>自由設定の売上増加目標（中段カードに万円表示されます）</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>月別データ（会計年度：10月〜9月）</h4>
                    <div class="monthly-data-section">
                        <div class="monthly-row" style="font-weight: bold; margin-bottom: 8px;">
                            <div class="month-name">月</div>
                            <div style="text-align: center; font-size: 13px;">実績</div>
                            <div style="text-align: center; font-size: 13px;">目標</div>
                            <div></div>
                        </div>
                        <div id="monthlyProfitContainer"></div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closePersonalSettingsModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="monthlyHistoryModal" role="dialog" aria-modal="true">
    <div class="modal-content modal-history">
        <div class="modal-header">
            <div class="modal-title" id="historyModalTitle">月別履歴（表示専用）</div>
            <div class="modal-header-actions">
                <button type="button" class="btn btn-danger btn-sm" id="historyDeleteBtn" style="display: none;" onclick="deleteFromHistoryModal()">🗑️ 削除</button>
                <button class="close-btn" onclick="closeMonthlyHistoryModal()" aria-label="閉じる">&times;</button>
            </div>
        </div>
        
        <div class="monthly-history-container" id="monthlyHistoryContainer"></div>
        
        <div class="control-buttons">
            <button type="button" class="btn btn-primary" onclick="closeMonthlyHistoryModal()">閉じる</button>
        </div>
    </div>
</div>


    <div class="modal" id="newCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">塾登録</div>
                <button class="close-btn" onclick="closeNewCardModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="newCardForm">
                <div class="form-group">
                    <label class="form-label" for="newJukuName">塾名 *</label>
                    <input type="text" class="form-input" placeholder="例：○○学習塾" required maxlength="100" id="newJukuName">
                </div>
                <div class="form-group">
    <label class="form-label" for="newJukuUrl">ZOHO塾URL</label>
    <input type="url" class="form-input" placeholder="例: https://www.example.com" id="newJukuUrl">
    <small>塾のウェブサイトURL (https:// または http:// で始まる必要があります)</small>
</div>
                <div class="form-group">
                    <label class="form-label" for="newJukuStatus">区分</label>
                    <select class="form-select" id="newJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">元既存</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newAddressInput">住所（市区町村）</label>
                    <input type="text" class="form-input" id="newAddressInput" placeholder="例: 豊中市、大阪市中央区">
                </div>

                <div class="form-group">
    <label class="form-label" for="newAreaInput">エリア</label>
    <input type="text" class="form-input" id="newAreaInput" placeholder="例: 大阪北部">
</div>

<!-- 🆕 地域選択 -->
<div class="form-group">
    <label class="form-label" for="newJukuRegion">地域 *</label>
    <select class="form-select" id="newJukuRegion" required>
        <option value="kansai">関西</option>
        <option value="shikoku">四国</option>
    </select>
</div>


                <div class="settings-section">
                    <h4>営業データ</h4>
                    <div class="form-group">
                        <label class="form-label" for="newSalesIncreaseForecast">売上増見込</label>
                        <input type="number" class="form-input" placeholder="3000000" id="newSalesIncreaseForecast">
                        <small>※この塾からの年間売上増見込額（A+B+C合計）</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProbability">成約確率</label>
                        <select class="form-select" id="newProbability">
                            <option value="0" selected>不明</option>
                            <option value="40">50未満</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProfitActual">年間粗利実績</label>
                        <input type="number" class="form-input" placeholder="0" id="newProfitActual" oninput="updateActualSales('new')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newSalesActual">年間売上実績</label>
                        <input type="number" class="form-input" placeholder="0" id="newSalesActual" readonly>
                    </div>
                    
                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">📚 年間教材管理</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">通年教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundOrder">注文状況</label>
                                    <select class="material-mini-select" id="newYearRoundOrder">
                                        <option value="false" selected>注文なし</option>
                                        <option value="true">注文あり</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundPeriod">注文時期</label>
                                    <input type="text" class="material-mini-input" id="newYearRoundPeriod" placeholder="例: 4月上旬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">季節・入試教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalUsage">使用状況</label>
                                    <select class="material-mini-select" id="newSeasonalUsage">
    <option value="unknown" selected>不明</option>
    <option value="false">使用なし</option>
    <option value="true">使用あり</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalPeriod">使用時期</label>
                                    <input type="text" class="material-mini-input" id="newSeasonalPeriod" placeholder="例: 夏期講習">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeNewCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">登録</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">塾編集</div>
                <button class="close-btn" onclick="closeEditCardModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="editCardForm">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label class="form-label" for="editJukuName">塾名</label>
                    <input type="text" class="form-input" id="editJukuName" required maxlength="100">
                </div>
                <div class="form-group">
    <label class="form-label" for="editJukuUrl">ZOHO塾URL</label>
    <input type="url" class="form-input" placeholder="例: https://www.example.com" id="editJukuUrl">
    <small>塾のウェブサイトURL (https:// または http:// で始まる必要があります)</small>
</div>
                <div class="form-group">
                    <label class="form-label" for="editJukuStatus">区分</label>
                    <select class="form-select" id="editJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">元既存</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editAddressInput">住所（市区町村）</label>
                    <input type="text" class="form-input" id="editAddressInput">
                </div>

                <div class="form-group">
    <label class="form-label" for="editAreaInput">エリア</label>
    <input type="text" class="form-input" id="editAreaInput">
</div>

<!-- 🆕 地域選択 -->
<div class="form-group">
    <label class="form-label" for="editJukuRegion">地域 *</label>
    <select class="form-select" id="editJukuRegion" required>
        <option value="kansai">関西</option>
        <option value="shikoku">四国</option>
    </select>
</div>

                <div class="settings-section">
                    <h4>年間データ</h4>
                    <div class="form-group">
                        <label class="form-label" for="editProfitActual">年間粗利実績</label>
                        <input type="number" class="form-input" id="editProfitActual" oninput="updateActualSales('edit')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editSalesActual">年間売上実績</label>
                        <input type="number" class="form-input" id="editSalesActual" readonly>
                    </div>

                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">📚 年間教材管理</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">通年教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundOrder">注文状況</label>
                                    <select class="material-mini-select" id="editYearRoundOrder">
                                        <option value="false">注文なし</option>
                                        <option value="true">注文あり</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundPeriod">注文時期</label>
                                    <input type="text" class="material-mini-input" id="editYearRoundPeriod" placeholder="例: 4月上旬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">季節・入試教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalUsage">使用状況</label>
                                    <select class="material-mini-select" id="editSeasonalUsage">
    <option value="unknown">不明</option>
    <option value="false">使用なし</option>
    <option value="true">使用あり</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalPeriod">使用時期</label>
                                    <input type="text" class="material-mini-input" id="editSeasonalPeriod" placeholder="例: 夏期講習">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="memoDetailModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="memoModalTitle">メモ詳細</div>
                <button class="close-btn" onclick="closeMemoDetailModal()" aria-label="閉じる">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="memoCardName">メモ内容</label>
                <textarea class="form-input" id="memoContentInput" style="min-height: 150px; resize: vertical;" maxlength="1000" placeholder="メモ内容を入力してください（1000文字以内）"></textarea>
            </div>
            <div class="control-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeMemoDetailModal()">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveMemoContent()">保存</button>
            </div>
        </div>
    </div>

    <script>
const RENDER_DEBOUNCE_MS = 100;
let currentUser = null;
let currentUserData = null;
let currentUserRole = null;
let currentViewTarget = null;
let availableViewTargets = [];
let currentRegionFilter = 'all'; // 🆕 地域フィルター追加

async function quickLogin() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('Firebase初期化中です。数秒後に再度お試しください', 'info');
        return;
    }
    
    try {
        const email = prompt('メールアドレスを入力してください\n例: shimatani@eigyo-team.local');
        const password = prompt('パスワードを入力してください');
        
        if (!email || !password) return;
          // 🆕 メールアドレス形式チェック
        if (!email.includes('@') || email.trim().length === 0) {
            showToast('正しいメールアドレスを入力してください', 'error');
            return;
        }
        
        // 🆕 パスワード長チェック（Firebase認証の最小要件）
        if (password.trim().length < 6) {
            showToast('パスワードは6文字以上で入力してください', 'error');
            return;
        }
        
        await window.firebaseImports.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        showToast('ログインしました', 'success');
       } catch (error) {
        console.error('ログインエラー:', error);
        
        // 🆕 Firebase認証エラーの詳細マッピング
        const errorMessages = {
            'auth/invalid-credential': 'メールアドレスまたはパスワードが違います',
            'auth/user-not-found': 'ユーザーが見つかりません',
            'auth/wrong-password': 'パスワードが違います',
            'auth/too-many-requests': '試行回数が多すぎます。しばらく待ってから再度お試しください',
            'auth/network-request-failed': 'ネットワークエラーです。インターネット接続を確認してください',
            'auth/invalid-email': 'メールアドレスの形式が正しくありません',
            'auth/user-disabled': 'このアカウントは無効化されています。管理者にお問い合わせください'
        };
        
        const message = errorMessages[error.code] || (error.code || error.message);
        showToast('ログイン失敗: ' + message, 'error');
    }
}

async function quickLogout() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('Firebase初期化中です。数秒後に再度お試しください', 'info');
        return;
    }
    
    try {
        await window.firebaseImports.signOut(window.firebaseAuth);
        showToast('ログアウトしました', 'info');
    } catch (error) {
        console.error('ログアウトエラー:', error);
        showToast('ログアウト失敗: ' + (error.code || error.message), 'error');
    }
}

async function loadAvailableViewTargets() {
    if (!currentUser || !currentUserRole) {
        availableViewTargets = [];
        return;
    }
    
    try {
        const usersCollection = await window.firebaseImports.getDocs(
            window.firebaseImports.collection(window.db, 'users')
        );
        
        availableViewTargets = [];
        
        usersCollection.forEach((doc) => {
            const userData = doc.data();
            const userId = doc.id;
            const userRole = userData.role;
            
            // 1. 自分自身の追加（Masterは自分を持たない）
            if (userId === currentUser.uid && currentUserRole !== 'master') {
                if (userRole === 'manager') {
                    // Manager: 関西・四国プロファイルを分離表示
                    availableViewTargets.push({
                        id: generateProfileId(userId, 'kansai'),
                        uid: userId,
                        name: userData.name,
                        role: userRole,
                        profileType: 'kansai',
                        region: 'kansai',
                        canEdit: true
                    });
                    availableViewTargets.push({
                        id: generateProfileId(userId, 'shikoku'),
                        uid: userId,
                        name: userData.name,
                        role: userRole,
                        profileType: 'shikoku',
                        region: 'shikoku',
                        canEdit: true
                    });
                } else {
                    // Admin・Staff: 通常表示
                    availableViewTargets.push({
                        id: userId,
                        uid: userId,
                        name: userData.name,
                        role: userRole,
                        region: userData.region || 'kansai',
                        canEdit: true
                    });
                }
                return;
            }
            
            // 2. 他人の追加ロジック
            let shouldAdd = false;
            
                       // Admin: 全員閲覧可能（ただしMasterは除外）
            if (currentUserRole === 'admin') {
                if (userRole !== 'master') {
                    shouldAdd = true;
                }
            }
            // Master: 四国関連のみ閲覧可能
            else if (currentUserRole === 'master') {
                if (userData.region === 'shikoku' || userRole === 'manager') {
                    shouldAdd = true;
                }
            }
            // Manager: 部下のみ閲覧可能
            else if (currentUserRole === 'manager') {
                if (currentUserData.subordinates && currentUserData.subordinates.includes(userId)) {
                    shouldAdd = true;
                }
            }
            
            if (shouldAdd) {
                if (userRole === 'manager') {
                    // 対象がManagerなら、プロファイルを分離表示
                    const showKansai = currentUserRole !== 'master';
                    const showShikoku = true;
                    
                    if (showKansai) {
                        availableViewTargets.push({
                            id: generateProfileId(userId, 'kansai'),
                            uid: userId,
                            name: userData.name,
                            role: userRole,
                            profileType: 'kansai',
                            region: 'kansai',
                            canEdit: false
                        });
                    }
                    if (showShikoku) {
                        availableViewTargets.push({
                            id: generateProfileId(userId, 'shikoku'),
                            uid: userId,
                            name: userData.name,
                            role: userRole,
                            profileType: 'shikoku',
                            region: 'shikoku',
                            canEdit: false
                        });
                    }
                } else {
                    // 通常Staff・Admin
                    if (currentUserRole === 'master' && userData.region !== 'shikoku') {
                        return; // Masterは四国Staff以外見えない
                    }
                    
                    availableViewTargets.push({
                        id: userId,
                        uid: userId,
                        name: userData.name,
                        role: userRole,
                        region: userData.region || 'kansai',
                        canEdit: false
                    });
                }
            }
        });
        
        // ソート: 自分→地域順→名前順
        availableViewTargets.sort((a, b) => {
            const aIsOwn = a.uid === currentUser.uid;
            const bIsOwn = b.uid === currentUser.uid;
            
            if (aIsOwn && !bIsOwn) return -1;
            if (!aIsOwn && bIsOwn) return 1;
            
            // 自分の中では関西→四国順
            if (aIsOwn && bIsOwn) {
                if (a.profileType === 'kansai') return -1;
                if (b.profileType === 'kansai') return 1;
            }
            
            // 地域別ソート
            const aRegion = a.region || 'kansai';
            const bRegion = b.region || 'kansai';
            if (aRegion !== bRegion) {
                return aRegion === 'kansai' ? -1 : 1;
            }
            
            return a.name.localeCompare(b.name);
        });
        
    } catch (error) {
        console.error('Available view targets load error:', error);
        
        // エラー時フォールバック
        if (currentUserRole === 'manager') {
            availableViewTargets = [
                {
                    id: generateProfileId(currentUser.uid, 'kansai'),
                    uid: currentUser.uid,
                    name: currentUserData.name,
                    role: currentUserRole,
                    profileType: 'kansai',
                    region: 'kansai',
                    canEdit: true
                },
                {
                    id: generateProfileId(currentUser.uid, 'shikoku'),
                    uid: currentUser.uid,
                    name: currentUserData.name,
                    role: currentUserRole,
                    profileType: 'shikoku',
                    region: 'shikoku',
                    canEdit: true
                }
            ];
        } else if (currentUserRole !== 'master') {
            availableViewTargets = [{
                id: currentUser.uid,
                uid: currentUser.uid,
                name: currentUserData.name,
                role: currentUserRole,
                region: 'kansai',
                canEdit: true
            }];
        } else {
            availableViewTargets = [];
        }
    }
}

function updateAuthUI() {
    const loginUserInfo = document.getElementById('loginUserInfo');
    const viewSelectorSection = document.getElementById('viewSelectorSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (currentUser && currentUserData) {
        loginUserInfo.textContent = currentUserData.name;
        
        if (currentUserRole === 'staff') {
            viewSelectorSection.style.display = 'none';
        } else {
            viewSelectorSection.style.display = 'flex';
        }
        
        // 地域セレクター機能を削除（updateRegionSelectorVisibility削除）
        
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
    } else {
        loginUserInfo.textContent = '未ログイン';
        viewSelectorSection.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
    }
}

function updateViewSelector() {
    const viewSelector = document.getElementById('viewSelector');
    const viewPermissionInfo = document.getElementById('viewPermissionInfo');
    
    if (!viewSelector) return;
    
    viewSelector.innerHTML = '';
    
    // Master用特別メッセージ
    if (!availableViewTargets.length && currentUserRole === 'master') {
        viewSelector.innerHTML = '<option value="">四国メンバーを選択してください</option>';
        if (viewPermissionInfo) viewPermissionInfo.textContent = '';
        return;
    }
    
    if (!availableViewTargets.length) {
        viewSelector.innerHTML = '<option value="">データなし</option>';
        if (viewPermissionInfo) viewPermissionInfo.textContent = '';
        return;
    }
    
    // Manager用のグループ分け表示
    if (currentUserRole === 'manager') {
        // 自分のプロファイル
        const ownProfiles = availableViewTargets.filter(t => t.uid === currentUser.uid);
        
        ownProfiles.forEach(target => {
            const option = document.createElement('option');
            option.value = target.id;
            const regionLabel = target.profileType === 'kansai' ? '関西' : '四国';
            option.textContent = `${target.name}（${regionLabel}）`;
            if (target.id === currentViewTarget) option.selected = true;
            viewSelector.appendChild(option);
        });
        
        // 部下がいる場合の区切り線
        const subordinates = availableViewTargets.filter(t => t.uid !== currentUser.uid);
        
        if (subordinates.length > 0) {
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            viewSelector.appendChild(separator);
            
            subordinates.forEach(target => {
                const option = document.createElement('option');
                option.value = target.id;
                
                const roleLabel = {
                    'admin': '管理者',
                    'manager': 'マネージャー',
                    'staff': '営業担当'
                }[target.role] || target.role;
                
                const regionLabel = target.profileType 
                    ? `（${target.profileType === 'kansai' ? '関西' : '四国'}）`
                    : `（${target.region === 'shikoku' ? '四国' : '関西'}）`;
                
                option.textContent = `[部下] ${target.name}${regionLabel}`;
                if (target.id === currentViewTarget) option.selected = true;
                viewSelector.appendChild(option);
            });
        }
    } else {
        // Admin・Master・Staffの通常表示
        availableViewTargets.forEach(target => {
            const option = document.createElement('option');
            option.value = target.id;
            
            const isOwn = target.uid === currentUser.uid;
            
            if (isOwn) {
                if (target.profileType) {
                    const regionLabel = target.profileType === 'kansai' ? '関西' : '四国';
                    option.textContent = `${target.name}（${regionLabel}・自分）`;
                } else {
                    option.textContent = `${target.name}（自分）`;
                }
                        } else {
                // 🆕 役職表記を削除し、名前と地域のみ表示
                const regionLabel = target.profileType 
                    ? `（${target.profileType === 'kansai' ? '関西' : '四国'}）`
                    : (target.region ? `（${target.region === 'shikoku' ? '四国' : '関西'}）` : '');
                
                option.textContent = `${target.name}${regionLabel}`;
            }
 
            if (target.id === currentViewTarget) option.selected = true;
            viewSelector.appendChild(option);
        });
    }
    
   // マスタービューオプション追加 
if (currentUserRole === 'admin') {
        // ★新規追加：全統括を最上位に配置
    const masterAll = document.createElement('option');
    masterAll.value = 'master-all';
    masterAll.textContent = 'マスタービュー（全統括）';
    if (currentViewTarget === 'master-all') masterAll.selected = true;
    viewSelector.appendChild(masterAll);
    // 関西マスタービュー
    const masterKansai = document.createElement('option');
    masterKansai.value = 'master-kansai';
    masterKansai.textContent = 'マスタービュー（関西統括）';
    if (currentViewTarget === 'master-kansai') masterKansai.selected = true;
    viewSelector.appendChild(masterKansai);

    // 四国マスタービュー  
    const masterShikoku = document.createElement('option');
    masterShikoku.value = 'master-shikoku';
    masterShikoku.textContent = 'マスタービュー（四国統括）';
    if (currentViewTarget === 'master-shikoku') masterShikoku.selected = true;
    viewSelector.appendChild(masterShikoku);
    
} else if (currentUserRole === 'master') {
    const masterOption = document.createElement('option');
        masterOption.value = 'master-shikoku';
        masterOption.textContent = 'マスタービュー（四国統括）';
        if (currentViewTarget === 'master-shikoku') masterOption.selected = true;
        viewSelector.appendChild(masterOption);
    }
    
    // 権限表示の更新
    const currentTarget = availableViewTargets.find(t => t.id === currentViewTarget);
    if (viewPermissionInfo) {
        if (currentTarget) {
            if (currentTarget.canEdit) {
                viewPermissionInfo.textContent = '✏️ 編集可能';
                viewPermissionInfo.className = 'view-permission-info permission-edit';
            } else {
                viewPermissionInfo.textContent = '👁️ 閲覧専用';
                viewPermissionInfo.className = 'view-permission-info permission-view';
            }
        } else if (currentViewTarget === 'master-kansai') {
    viewPermissionInfo.textContent = '👑 関西統括';
    viewPermissionInfo.className = 'view-permission-info permission-edit';
} else if (currentViewTarget === 'master-shikoku') {
    if (currentUserRole === 'admin') {
        viewPermissionInfo.textContent = '👑 四国統括';
        viewPermissionInfo.className = 'view-permission-info permission-edit';
    } else {
        viewPermissionInfo.textContent = '🔍 四国監査';
        viewPermissionInfo.className = 'view-permission-info permission-view';
    }
} else if (currentViewTarget === 'master-all') {
    // ★新規追加：全統括の権限表示
    viewPermissionInfo.textContent = '🌎 全統括';
    viewPermissionInfo.className = 'view-permission-info permission-edit';
} else {
    viewPermissionInfo.textContent = '';
}

    }
}

function updateRegionSelectorOptions() {
    const regionSelector = document.getElementById('globalRegionSelector');
    if (!regionSelector) return;
    
    regionSelector.innerHTML = '';
    
    const userRegions = Array.isArray(currentUserData?.regions) ? currentUserData.regions : [];
    const isAdmin = currentUserRole === 'admin';

    // 管理者または複数地域対応なら「全エリア」を追加
    if (isAdmin || userRegions.length > 1) {
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = '全エリア';
        regionSelector.appendChild(allOption);
    }

    const regionsToAdd = isAdmin ? ['kansai', 'shikoku'] : userRegions;
    regionsToAdd.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region === 'kansai' ? '関西' : '四国';
        regionSelector.appendChild(option);
    });

    regionSelector.value = currentRegionFilter;
}

function updateRegionSelectorVisibility() {
    // 地域セレクター機能を無効化
    // 現在のプロファイル地域は parseViewTarget で自動設定
    return;
}

function changeRegionFilter() {
    // 地域セレクター機能を無効化
    // 地域切替はプロファイル選択で自動実行
    return;
}

// Manager用：自分の地域別設定を再読み込み
async function reloadOwnManagerSettings(targetRegion) {
    if (!currentUser || !window.db) return;
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', currentUser.uid)
        );
        
        if (userDoc.exists() && userDoc.data().personalSettings) {
            const cloudSettings = userDoc.data().personalSettings;
            
            // 地域別設定の存在確認
            if (cloudSettings.kansai || cloudSettings.shikoku) {
                personalSettings = { 
                    ...getDefaultSettings(),
                    ...(cloudSettings[targetRegion] || {})
                };
                
                console.log(`${targetRegion}設定に切り替えました:`, personalSettings);
                
                // 即座にUI反映
                updatePersonalSalesTarget();
                progressCache = null;
                updateDashboard();
                
                showToast(`${targetRegion === 'kansai' ? '関西' : '四国'}設定を読み込みました`, 'info');
            } else {
                console.warn('地域別設定が未構築です');
                showToast('地域別設定が未登録です。個人設定から登録してください', 'error');
            }
        }
    } catch (error) {
        console.error('Manager設定再読み込みエラー:', error);
        showToast('設定の読み込みに失敗しました', 'error');
    }
}

async function changeViewTarget() {
    const viewSelector = document.getElementById('viewSelector');
    const newTargetId = viewSelector.value;
    
    const normalContent = document.getElementById('normalDashboardContent');
    const masterContent = document.getElementById('masterViewContent');
    
    // マスタービュー切り替え
if (newTargetId === 'master-kansai' || newTargetId === 'master-shikoku' || newTargetId === 'master-all') {
    currentViewTarget = newTargetId;
    
    // ★修正：全統括の場合は地域フィルタなし
    if (newTargetId === 'master-all') {
        currentProfileRegion = 'all';
    } else {
        currentProfileRegion = newTargetId === 'master-kansai' ? 'kansai' : 'shikoku';
    }
    
    updateViewSelector();
    
    normalContent.style.display = 'none';
    masterContent.style.display = 'block';
    
    await displayMasterView();
    
    // ★修正：ラベル表示の拡張
    const labelMap = {
        'master-kansai': '関西統括',
        'master-shikoku': '四国統括',
        'master-all': '全統括'
    };
    showToast(`マスター管理画面（${labelMap[newTargetId]}）を表示中`, 'info');
    return;
}
    
    // 通常ビューへの切り替え
    if (newTargetId && newTargetId !== currentViewTarget) {
        currentViewTarget = newTargetId;
        
        // IDから地域情報を解析
        const { uid, region } = parseViewTarget(newTargetId);
        currentProfileRegion = region;
        
        updateViewSelector();
        
        // マスタービューから戻る場合
        if (masterContent.style.display === 'block') {
            masterContent.style.display = 'none';
            normalContent.style.display = 'block';
        }
        
    // ★重要：自分のプロファイル切替時は personalSettings を再読み込み★
    if (uid === currentUser.uid && currentUserRole === 'manager') {
        await reloadOwnManagerSettings(region);
    } else {
        await loadSettingsForTarget(uid);
    }
    
// 修正：すでに取得済みのuidを再利用
await loadCardsDataForTarget(uid);
        
        progressCache = null;
        renderCardsOptimized();
        updateDashboard();
        
        const targetUser = availableViewTargets.find(t => t.id === newTargetId);
        if (targetUser) {
            const profileLabel = targetUser.profileType ? `（${targetUser.profileType === 'kansai' ? '関西' : '四国'}）` : '';
            showToast(`${targetUser.name}${profileLabel}のデータを表示中`, 'info');
        }
    }
}

function restoreNormalDashboard() {
    // マスタービュー表示後に通常画面へ戻す最短手段：リロード
    const mainContainer = document.querySelector('.container');
    if (mainContainer && mainContainer.querySelector('.master-view-container')) {
        location.reload();
    }
}
async function loadCardsDataForTarget(targetUserId) {
    if (!currentUser || !targetUserId) {
        cardsData = [];
        return;
    }
    
    try {
        // プロファイルIDから実ユーザーIDと地域を特定
        let actualUserId = targetUserId;
        let targetRegion = null;

        if (targetUserId.endsWith('_kansai')) {
            actualUserId = targetUserId.replace('_kansai', '');
            targetRegion = 'kansai';
        } else if (targetUserId.endsWith('_shikoku')) {
            actualUserId = targetUserId.replace('_shikoku', '');
            targetRegion = 'shikoku';
        } else {
            const parsed = parseViewTarget(targetUserId);
            actualUserId = parsed.uid || targetUserId;
            targetRegion = parsed.region || 'kansai';
        }

        let cardsQuery;

        // Masterロールは四国限定でFirestore側フィルタ（セキュリティルール対策）
        if (currentUserRole === 'master') {
            const queryRegion = 'shikoku'; // Masterは四国のみ
            cardsQuery = window.firebaseImports.query(
                window.firebaseImports.collection(window.db, 'juku_cards'),
                window.firebaseImports.where('assignedUserId', '==', actualUserId),
                window.firebaseImports.where('region', '==', queryRegion)
            );
            console.log(`🔒 Master権限: ${actualUserId} の ${queryRegion} 限定取得`);
        } else {
            // それ以外（Admin/Manager/Staff）は全カード取得してJS側でregionを判定
            cardsQuery = window.firebaseImports.query(
                window.firebaseImports.collection(window.db, 'juku_cards'),
                window.firebaseImports.where('assignedUserId', '==', actualUserId)
            );
            console.log(`📋 通常権限: ${actualUserId} の全カード取得（表示地域: ${targetRegion || 'all'}）`);
        }

        const cardsCollection = await window.firebaseImports.getDocs(cardsQuery);
        
        cardsData = [];
        let maxId = 0;
        let filteredCount = 0;
        
        cardsCollection.forEach((doc) => {
            const raw = doc.data();
            const docId = doc.id;
            
            // docId解析
            let numericId = NaN;
            if (docId.includes('_')) {
                const parts = docId.split('_');
                const lastPart = parts[parts.length - 1];
                numericId = parseInt(lastPart, 10);
                if (!Number.isFinite(numericId)) {
                    console.warn(`docID解析失敗: ${docId}, raw.idを使用`);
                    numericId = raw.id || 0;
                }
            } else {
                numericId = parseInt(docId, 10);
            }
            
            // region未設定カードは関西として扱う（既存データ救済）
            const effectiveRegion = raw.region || 'kansai';
            
            const cardData = { 
                id: Number.isFinite(numericId) ? numericId : (raw.id || 0),
                docId,
                ...raw,
                region: effectiveRegion
            };
            
            // Master以外：JS側で地域フィルタリング
            if (currentUserRole !== 'master' && targetRegion && targetRegion !== 'all') {
                if (effectiveRegion === targetRegion) {
                    cardsData.push(cardData);
                } else {
                    filteredCount++;
                }
            } else {
                cardsData.push(cardData);
            }

            if (Number.isFinite(cardData.id) && cardData.id > maxId) {
                maxId = cardData.id;
            }
        });

        nextCardId = maxId + 1;
        console.log(`✅ 読み込み完了: ${cardsData.length}件（除外: ${filteredCount}件, 対象地域: ${targetRegion || 'all'}）`);
        
    } catch (error) {
        console.error('Cards load error for target:', error);
        
        if (error.code === 'permission-denied') {
            showToast('このデータを閲覧する権限がありません（Firestoreルール）', 'error');
        }
        
        cardsData = [];
        nextCardId = 1;
    }
}

function hasPermission(action, targetData = null) {
    if (!currentUserRole || !currentUser) return false;
    
    // Master Role: 四国データの閲覧のみ可能
    if (currentUserRole === 'master') {
        if (action === 'view_data') {
            if (targetData) return targetData.region === 'shikoku';
            return currentProfileRegion === 'shikoku';
        }
        return false; // 編集・削除・作成すべて不可
    }
    
    // 現在表示中のユーザーID取得
    const { uid: currentUid } = parseViewTarget(currentViewTarget);
    
    // Admin: 自分（関西）のみ編集可、全員閲覧可
    if (currentUserRole === 'admin') {
        switch (action) {
            case 'view_data':
                return true; // 全データ閲覧可
            case 'edit_data':
            case 'delete_data':
                return targetData && targetData.assignedUserId === currentUser.uid;
            case 'create_data':
                return currentUid === currentUser.uid;
            case 'edit_own_settings':
                return true;
            case 'edit_any_settings':
                return true;
            default:
                return false;
        }
    }
    
    // Manager: 自分のプロファイルのみ編集可、部下は閲覧のみ
    if (currentUserRole === 'manager') {
        const isSelfProfile = currentUid === currentUser.uid;
        
        switch (action) {
            case 'view_data':
                return true; // 自分・部下のデータ閲覧可
            case 'edit_data':
            case 'delete_data':
                return targetData && targetData.assignedUserId === currentUser.uid && isSelfProfile;
            case 'create_data':
                return isSelfProfile;
            case 'edit_own_settings':
                return isSelfProfile;
            case 'edit_any_settings':
                return false;
            default:
                return false;
        }
    }
    
    // Staff: 自分のデータのみ
    if (currentUserRole === 'staff') {
        switch (action) {
            case 'view_data':
                return targetData && targetData.assignedUserId === currentUser.uid;
            case 'edit_data':
            case 'delete_data':
                return targetData && targetData.assignedUserId === currentUser.uid;
            case 'create_data':
                return currentUid === currentUser.uid;
            case 'edit_own_settings':
                return true;
            case 'edit_any_settings':
                return false;
            default:
                return false;
        }
    }
    
    return false;
}

function setupFirebaseAuth() {
    if (window.firebaseImports && window.firebaseAuth && window.db) {
        window.firebaseImports.onAuthStateChanged(window.firebaseAuth, async (user) => {
            currentUser = user;
            
            if (user) {
    console.log('ログイン中 UID:', user.uid, 'メール:', user.email);
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', user.uid)
        );
        
if (userDoc.exists()) {
    currentUserData = userDoc.data();
    currentUserRole = currentUserData.role;
    
    // 初期ビューターゲット設定
    if (currentUserRole === 'master') {
        // Masterは自分を持たないので、マスタービューを初期表示
        currentViewTarget = 'master-shikoku';
        currentProfileRegion = 'shikoku';
    } else if (currentUserRole === 'manager') {
        // Managerはデフォルト関西プロファイル
        currentViewTarget = generateProfileId(user.uid, 'kansai');
        currentProfileRegion = 'kansai';
    } else {
        // Admin・Staff
        currentViewTarget = user.uid;
        currentProfileRegion = currentUserData.region || 'kansai';
    }

// 🆕 起動時は必ず現在月を表示
const fiscalStructure = getFiscalYearStructure();
activeDashboardMonthKey = fiscalStructure.currentMonthKey;

            // グローバル月セレクターを現在月に設定
            const globalSelector = document.getElementById('globalMonthSelector');
            if (globalSelector) {
                globalSelector.value = activeDashboardMonthKey;
            }
            
            // ヘッダーの日付表示を更新
            const monthInfo = fiscalStructure.months.find(m => m.key === activeDashboardMonthKey);
            if (monthInfo) {
                document.getElementById('currentDateDisplay').textContent = monthInfo.label;
            }
            
            // マスタービューが表示中なら通常画面に戻す
            document.getElementById('masterViewContent').style.display = 'none';
            document.getElementById('normalDashboardContent').style.display = 'block';
            
            await loadAvailableViewTargets();
            updateAuthUI();
            updateViewSelector();
            
            // 🆕 Masterは自分のカードや設定を持たないため、読み込みをスキップ
            if (currentUserRole === 'master') {
                console.log('Master Role: 自分のデータ読み込みをスキップ');
                cardsData = [];
                personalSettings = getDefaultSettings();
            } else {
                const { uid: targetUid } = parseViewTarget(currentViewTarget || user.uid);
                await loadCardsDataForTarget(targetUid);
                await syncPersonalSettingsOnLogin();
            }


            // 自分の設定をキャッシュに保存（必須）
            if (user && user.uid) {
                userSettingsCache[user.uid] = { ...personalSettings };
            }

            progressCache = null;
            renderCardsOptimized();
            updateDashboard();
            
            const roleDisplayName = {
    'admin': '管理者',
    'manager': 'マネージャー', 
    'staff': '営業',
    'master': '監査'
}[currentUserRole] || currentUserRole;
showToast(`${currentUserData.name}（${roleDisplayName}）としてログインしました`, 'success');

        }else {
                        showToast('ユーザー情報が未登録です（Step 4を確認）', 'error');
                    }
                } catch (error) {
                    console.error('ユーザーデータ取得エラー:', error);
                    showToast('ユーザーデータの取得に失敗しました', 'error');
                }
            } else {
                console.log('未ログイン状態');
                currentUserData = null;
                currentUserRole = null;
                currentViewTarget = null;
                availableViewTargets = [];
                userSettingsCache = {}; // キャッシュクリア
                progressCache = null;   // 進捗キャッシュクリア
                updateAuthUI();
                cardsData = [];
                renderCardsOptimized();
                updateDashboard();      // 表示リセット
            }
        });
    } else {
        setTimeout(setupFirebaseAuth, 100);
    }
}


let cardsData = [];
let nextCardId = 1;
let progressCache = null;
let searchTimeout;
let renderTimeout;
let scrollPosition = 0;
let currentHistoryCardId = null; // PC版詳細モーダル用：削除対象カードID
let currentEditingMemo = null;
let isComposing = false;
let activeDashboardMonthKey = null; // 追加：ダッシュボードのアクティブ月

let personalSettings = {
    userName: '担当者',
    profitRate: 0,
    yearlyProfitTarget: 0,
    yearlyProfitIncreaseTarget: 0,
    yearlySalesIncreaseTarget: 0,
    personalSalesIncreaseTarget: 0, // 🆕 個人設定売上増目標
    monthlyProfitActuals: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    },
    monthlyProfitTargets: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    },
    cumulativeProfitActual: 0,
    monthlyCumulativeProfitActuals: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    }
};

let activeProbabilityFilter = 'all';
let userSettingsCache = {};

        let currentProfileRegion = 'kansai';

// ターゲットIDからUIDと地域を分離
function parseViewTarget(targetId) {
    if (!targetId) return { uid: null, region: 'kansai' };
    
// マスタービュー特別対応
if (targetId === 'master-kansai') return { uid: 'master', region: 'kansai' };
if (targetId === 'master-shikoku') return { uid: 'master', region: 'shikoku' };
if (targetId === 'master-all') return { uid: 'master', region: 'all' }; // ★追加


    // Manager分裂プロファイル対応
    if (targetId.includes('_kansai')) {
        return { uid: targetId.replace('_kansai', ''), region: 'kansai' };
    }
    if (targetId.includes('_shikoku')) {
        return { uid: targetId.replace('_shikoku', ''), region: 'shikoku' };
    }
    
    // 通常ID（Admin・Staff）
    return { uid: targetId, region: 'kansai' };
}

// プロファイルIDの生成
function generateProfileId(userId, profileType) {
    return `${userId}_${profileType}`;
}

// 現在のプロファイル判定
function getCurrentProfile() {
    return currentProfileRegion;
}

// 自分のプロファイル表示中か判定
function isViewingOwnProfile() {
    const { uid } = parseViewTarget(currentViewTarget);
    return uid === currentUser?.uid;
}
        
const PROBABILITY_CONFIG = {
    options: [
         { value: 0, label: '不明' },
        { value: 40, label: '50未満' },
        { value: 50, label: '50%' },
        { value: 60, label: '60%' },
        { value: 70, label: '70%' },
        { value: 80, label: '80%' },
        { value: 90, label: '90%' },
        { value: 100, label: '100%' }
    ],
    
    filters: [
    { value: 'all', label: '全確率' },
    { value: 'under50', label: '50未満' },
    { value: '50-60', label: '50-70' },  // 表示名を50-70に変更
    { value: '70', label: '70%' },
    { value: '80', label: '80%' },
    { value: '90', label: '90%' },
    { value: '100', label: '100%' }
]

};

function getCurrentMonth() { 
    return new Date().getMonth() + 1; 
}

        function getDefaultSettings() {
    return {
        userName: '担当者',
        profitRate: 0,
        yearlyProfitTarget: 0,
        yearlyProfitIncreaseTarget: 0,
        yearlySalesIncreaseTarget: 0,
        personalSalesIncreaseTarget: 0, // 🆕 追加
        monthlyProfitActuals: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        },
        monthlyProfitTargets: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        },
        cumulativeProfitActual: 0,
        monthlyCumulativeProfitActuals: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        }
    };
}

function getActiveSettings() {
        // 🆕 Masterは設定を持たないため、常にデフォルトを返す
    if (currentUserRole === 'master') {
        return getDefaultSettings();
    }
    const { uid, region } = parseViewTarget(currentViewTarget || currentUser?.uid);
    
    if (!uid) return getDefaultSettings();
    
    // 自分自身を見ている場合
    if (currentUser && uid === currentUser.uid) {
        // 自分がManagerで地域別設定を持つ場合
        if (currentUserRole === 'manager' && (personalSettings.kansai || personalSettings.shikoku)) {
            return personalSettings[region] || getDefaultSettings();
        }
        return personalSettings;
    }
    
    // 🆕 他人を見ている場合（キャッシュから直接取得）
    const cachedSettings = userSettingsCache[uid];
    
    if (!cachedSettings) {
        console.warn(`${uid}の設定がキャッシュにありません`);
        return getDefaultSettings();
    }
    
    // ★重要：キャッシュには処理済み設定が入っているのでそのまま返す
    return cachedSettings;
}

async function loadSettingsForTarget(uid) {
    if (!uid || !window.firebaseImports || !window.db) return;
    if (userSettingsCache[uid]) return; // 既にキャッシュ済み
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', uid)
        );
        
        if (!userDoc.exists()) {
            console.warn(`${uid}のユーザーデータが存在しません`);
            userSettingsCache[uid] = getDefaultSettings();
            return;
        }

        const userData = userDoc.data();
        const cloudSettings = userData.personalSettings;
        
        if (!cloudSettings || typeof cloudSettings !== 'object') {
            console.warn(`${uid}のpersonalSettingsが未設定`);
            userSettingsCache[uid] = getDefaultSettings();
            return;
        }

        // 🆕 重要修正：データの構造で判定（役職ではなく）
        let effectiveSettings;
        
        // Manager型データ構造の場合（kansai/shikokuフォルダが存在）
        if (cloudSettings.kansai || cloudSettings.shikoku) {
            const { region } = parseViewTarget(currentViewTarget);
            effectiveSettings = { 
                ...getDefaultSettings(),
                ...(cloudSettings[region] || cloudSettings.kansai || {})
            };
            console.log(`${uid}の地域別設定(${region})を読み込みました`);
            
        } else {
            // Staff型データ構造の場合（フラット構造）
            effectiveSettings = { 
                ...getDefaultSettings(),
                ...cloudSettings 
            };
            console.log(`${uid}の通常設定を読み込みました`);
        }

        // 🆕 重要：必ずキャッシュに保存
        userSettingsCache[uid] = effectiveSettings;
        
        // 現在表示中のターゲットなら personalSettings も同期
        const { uid: viewingUid } = parseViewTarget(currentViewTarget || '');
        if (viewingUid === uid) {
            personalSettings = effectiveSettings;
        }
        
    } catch (error) {
        console.error(`${uid}の個人設定読み込みエラー:`, error);
        userSettingsCache[uid] = getDefaultSettings();
        showToast('個人設定の読み込みに失敗しました', 'error');
    }
}

function formatManYen(amount, decimals = 1) {
    const absAmount = Math.abs(amount || 0);
    const manYen = absAmount / 10000;
    const sign = amount < 0 ? '-' : '';
    return `${sign}¥${manYen.toFixed(decimals)}万`;
}
        function formatManPlain(amount, decimals = 1) {
    const num = Number(amount) || 0;
    const sign = num < 0 ? '-' : '';
    return `${sign}${(Math.abs(num) / 10000).toFixed(decimals)}万円`;
}

function formatAmount(amount) {
    const num = Number.isFinite(amount) ? amount : 0;
    const rounded = Math.round(num); // 四捨五入で整数化
    const absAmount = Math.abs(rounded);
    const sign = rounded < 0 ? '-' : '';
    return `${sign}¥${absAmount.toLocaleString()}`;
}


        // === 4枚カード用ヘルパー関数群（エラー解消） ===

// 売上フィールドを強制的に編集不可にする防御機能
function lockAutoCalculatedFields() {
    ['monthlySalesActual', 'cumulativeSalesActual'].forEach(id => {
        const element = document.getElementById(id);
        if (!element) return;
        
        element.classList.remove('editable-profit-field');
        element.removeAttribute('onclick');
        element.style.cursor = 'default';
    });
}

// 住所から市区町村を抽出する関数
function extractMunicipality(address) {
    if (!address || typeof address !== 'string') return '';
    
    const cleanAddress = address.trim();
    if (!cleanAddress) return '';

    // 政令指定都市の区（例：大阪市中央区）
    const cityWardMatch = cleanAddress.match(/(.+?市.+?区)/);
    if (cityWardMatch) return cityWardMatch[1];

    // 東京23区（例：新宿区）
    const tokyoWardMatch = cleanAddress.match(/([^都道府県]+区)(?![市町村])/);
    if (tokyoWardMatch) return tokyoWardMatch[1];

    // 一般市（例：豊中市）
    const cityMatch = cleanAddress.match(/(.+?市)/);
    if (cityMatch) return cityMatch[1];

    // 町村（例：○○町）
    const townVillageMatch = cleanAddress.match(/(.+?[町村])/);
    if (townVillageMatch) return townVillageMatch[1];

    // フォールバック処理
    let fallbackAddress = cleanAddress;
    ['都', '道', '府', '県'].forEach(suffix => {
        const index = fallbackAddress.indexOf(suffix);
        if (index !== -1) {
            fallbackAddress = fallbackAddress.substring(index + 1);
        }
    });

    return fallbackAddress.split(/[\s　,、]/)[0] || cleanAddress;
}

        
function formatDifferenceAmount(amount, formatter = formatAmount) {
    if (!Number.isFinite(amount)) amount = 0;
    
    const absAmount = Math.abs(amount);
    const formattedAmount = formatter(absAmount);
    
    if (amount < 0) {
        return { text: `Δ${formattedAmount}`, isNegative: true };
    } else {
        return { text: formattedAmount, isNegative: false };
    }
}

        // カード値更新のヘルパー関数（エラー解決の核心）
function updateCardValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`Element with id '${elementId}' not found`);
    }
}

// カード差額更新のヘルパー関数
function updateCardDifference(elementId, amount, formatter = formatAmount) {
    const element = document.getElementById(elementId);
    if (element) {
        const diff = formatDifferenceAmount(amount, formatter);
        element.textContent = diff.text;
        element.classList.remove('negative', 'positive', 'neutral');
        if (diff.isNegative) {
            element.classList.add('negative');
        } else if (amount > 0) {
            element.classList.add('positive');
        } else {
            element.classList.add('neutral');
        }
    } else {
        console.warn(`Element with id '${elementId}' not found`);
    }
}

function editMonthlyProfitInline(element) {
    if (!currentUser || currentViewTarget !== currentUser.uid) {
        showToast('自分のデータ表示中のみ編集可能です', 'error');
        return;
    }

    const currentMonth = getCurrentMonth();
    const currentValue = personalSettings.monthlyProfitActuals[currentMonth] || 0;
    
    const newValue = prompt('月別粗利実績を入力してください（円）\n\n例: 500000', currentValue);
    if (newValue === null) return;
    
    const parsedValue = parseNumberSafely(newValue);

    // 1) データ更新
    personalSettings.monthlyProfitActuals[currentMonth] = parsedValue;

    // 2) UI即時反映
    element.textContent = formatAmount(parsedValue);

    // 3) 再計算を即時反映（キャッシュ無効化→再描画）
    progressCache = null;
    updateDashboard();

    // 4) 保存はアイドル時間に遅延実行（体感速度を最優先）
    scheduleSavePersonalSettings();

    showToast('月別粗利実績を更新しました', 'success');
}

function editCumulativeProfitInline(element) {
    if (!currentUser || currentViewTarget !== currentUser.uid) {
        showToast('自分のデータ表示中のみ編集可能です', 'error');
        return;
    }

    // 🆕 グローバル月セレクターに連動した対象月を取得
    const { months } = getFiscalYearStructure();
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeMonthInfo = months.find(m => m.key === activeMonthKey);
    const targetMonth = activeMonthInfo ? activeMonthInfo.month : getCurrentMonth();
    
    // 🆕 月ごとの累積粗利実績データ構造を確実に初期化
    if (!personalSettings.monthlyCumulativeProfitActuals) {
        personalSettings.monthlyCumulativeProfitActuals = {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        };
    }

    const currentValue = personalSettings.monthlyCumulativeProfitActuals[targetMonth] || 0;
    
    const newValue = prompt(
        `累積粗利実績を入力してください（円）\n対象月: ${targetMonth}月\n※${targetMonth}月時点での累積粗利の数値を直接入力\n\n例: 5,000,000\n（空欄で削除）`, 
        currentValue
    );
    if (newValue === null) return;
    
    // 🆕 空欄入力で該当月の値を削除（未設定化）
    if (String(newValue).trim() === '') {
        delete personalSettings.monthlyCumulativeProfitActuals[targetMonth];
        element.textContent = formatAmount(0);
        progressCache = null;
        updateDashboard();
        scheduleSavePersonalSettings();
        showToast(`${targetMonth}月の累積粗利実績を削除しました`, 'success');
        return;
    }
    
    const parsedValue = parseNumberSafely(newValue);
    
    // 🆕 選択月の累積粗利実績を直接保存（月別管理）
    personalSettings.monthlyCumulativeProfitActuals[targetMonth] = Number(parsedValue);
    
    // 後方互換性のため旧フィールドも更新（現在月の場合のみ）
    if (targetMonth === getCurrentMonth()) {
        personalSettings.cumulativeProfitActual = Number(parsedValue);
    }
    
    // UIを即時更新
    element.textContent = formatAmount(parsedValue);
    
    // 再計算と描画更新
    progressCache = null;
    updateDashboard();
    
    // 保存処理
    scheduleSavePersonalSettings();
    
    showToast(`${targetMonth}月の累積粗利実績を更新しました`, 'success');
}


function formatDateForDisplay(s) {
    if (!s) return '—';
    
    // Firestore Timestamp対応
    if (s && typeof s.toDate === 'function') {
        const d = s.toDate();
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    }
    
    try {
        const d = new Date(s);
        if (isNaN(d.getTime())) return '—';
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    } catch (e) {
        return '—';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

        // 数値カンマフォーマット関数
function formatWithCommas(value) {
    const num = parseNumberSafely(value);
    return Number.isFinite(num) ? num.toLocaleString() : '';
}

function setupNumberFormatting() {
    const numberFields = [
    'newSalesIncreaseForecast', 'newProfitActual', 
    'editProfitActual', 'yearlyProfitTarget', 'yearlyProfitIncreaseTarget',
    'personalSalesIncreaseTarget'
];

    numberFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        // スマホで数字キーボード表示、type=textでカンマ表示可能に
        field.setAttribute('inputmode', 'numeric');
        field.setAttribute('type', 'text');
        
        // 初期表示時にカンマ付与（0以外の値のみ）
        if (field.value && field.value !== '0') {
            field.value = formatWithCommas(field.value.replace(/[,，\s]/g, ''));
        }
        
        // フォーカス時：カンマ除去＋全選択
        field.addEventListener('focus', function() {
            this.value = this.value.replace(/[,，\s]/g, '');
            setTimeout(() => this.select(), 0);
        });
        
        // ブラー時：カンマ付与
        field.addEventListener('blur', function() {
            if (this.value && this.value !== '0') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
    
    // 月別入力フィールドの処理（個人設定内）
    document.querySelectorAll('.monthly-input').forEach(input => {
        input.setAttribute('inputmode', 'numeric');
        input.setAttribute('type', 'text');
        
        // 初期表示時にカンマ付与
        if (input.value && input.value !== '0') {
            input.value = formatWithCommas(input.value.replace(/[,，\s]/g, ''));
        }
        
        input.addEventListener('focus', function() {
            if (this.value && this.value !== '0') {
                this.value = this.value.replace(/[,，\s]/g, '');
                setTimeout(() => this.select(), 0);
            }
        });
        
        input.addEventListener('blur', function() {
            if (this.value && this.value !== '') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
}

function parseNumberSafely(value) {
    if (value == null || value === '') return 0;
    
    const normalized = String(value)
        .replace(/[０-９]/g, (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0))
        .replace(/[,，\s]/g, '')
        .replace(/[^0-9.-]/g, '');
    
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? Math.max(0, parsed) : 0;
}
       
function getMonthKeyFromTimestamp(ts, fallbackKey) {
    try {
        let d;
        if (ts && typeof ts.toDate === 'function') d = ts.toDate();
        else if (ts) d = new Date(ts);
        else return fallbackKey;
        if (isNaN(d.getTime())) return fallbackKey;
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        return `${y}-${String(m).padStart(2, '0')}`;
    } catch {
        return fallbackKey;
    }
}
        
function getProbabilityLabel(value) {
    if (value === 0 || value === 40) return '50未満';  // ← この条件を変更
    return `${value}%`;
}

function isUnknownOrLowProbability(value) {
    return value === 0 || value < 50;
}

function matchesProbabilityFilter(probability, filterValue) {
    if (filterValue === 'all') return true;
    
    switch (filterValue) {
        case 'under50': return probability < 50;
        case '50-60': return probability >= 50 && probability <= 60;  // 50,60のみ
        case '70': return probability === 70;
        case '80': return probability === 80;
        case '90': return probability === 90;
        case '100': return probability === 100;
        default: return true;
    }
}


function getFiscalYearStructure() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    const fiscalStartYear = currentMonth >= 10 ? currentYear : currentYear - 1;
    
    const months = [];
    for (let i = 0; i < 12; i++) {
        const month = ((10 + i - 1) % 12) + 1;
        const year = month >= 10 ? fiscalStartYear : fiscalStartYear + 1;
        months.push({
            key: `${year}-${String(month).padStart(2, '0')}`,
            year: year,
            month: month,
            label: `${year}年${month}月`
        });
    }
    
    return {
        months: months,
        currentMonthKey: `${currentYear}-${String(currentMonth).padStart(2, '0')}`,
        currentMonthIndex: months.findIndex(m => m.key === `${currentYear}-${String(currentMonth).padStart(2, '0')}`)
    };
}

function getPreviousMonth(monthKey) {
    const fiscalStructure = getFiscalYearStructure();
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === monthKey);
    const prevIndex = currentIndex > 0 ? currentIndex - 1 : 11;
    return fiscalStructure.months[prevIndex];
}

function calculateMonthlyChange(cardData, monthKey) {
    const f = getFiscalYearStructure();
    const m = f.months.find(x => x.key === monthKey);
    const cur = (cardData.monthlyData?.[monthKey] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    if (m && m.month === 10) return { amount: cur, direction: cur > 0 ? 'increase' : 'neutral' };
    const prev = getPreviousMonth(monthKey);
    const p = (cardData.monthlyData?.[prev.key] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    const d = cur - p;
    return { amount: d, direction: d > 0 ? 'increase' : d < 0 ? 'decrease' : 'neutral' };
}

function calculateSalesFromProfit(profitActual) {
    const settings = getActiveSettings();
    const profitRate = (settings.profitRate || 0) / 100;
    if (profitRate <= 0) return 0;
    return Math.round((profitActual || 0) / profitRate);
}


function getCardLevel(v) {
    if (v < 100000) return 0;
    if (v < 300000) return 1;
    if (v < 500000) return 2;
    if (v < 1000000) return 3;
    return 4;
}

function updatePersonalSalesTarget() {
    // フォーム入力中の値を直接取得（リアルタイム計算）
    const profitRateInput = document.getElementById('profitRate');
    const profitIncreaseInput = document.getElementById('yearlyProfitIncreaseTarget');
    
    const currentRate = profitRateInput ? parseFloat(profitRateInput.value) : personalSettings.profitRate;
    const currentIncreaseTarget = profitIncreaseInput ? parseNumberSafely(profitIncreaseInput.value) : personalSettings.yearlyProfitIncreaseTarget;

    const p = currentRate / 100;
    const calculatedTarget = p > 0 ? Math.round(currentIncreaseTarget / p) : 0;
    
    const el = document.getElementById('yearlySalesIncreaseTarget');
    if (el) {
        el.value = formatWithCommas(calculatedTarget);
    }
}


function validateCardData(cardData) {
    const errors = [];
    
    if (!cardData.jukuName || cardData.jukuName.trim().length === 0) {
        errors.push('塾名は必須です');
    }
    
    if (cardData.jukuName && cardData.jukuName.length > 100) {
        errors.push('塾名は100文字以内で入力してください');
    }
    
    if (cardData.annualProfitActual < 0) {
        errors.push('年間粗利実績は0以上で入力してください');
    }
    
    if (cardData.monthlyData) {
        Object.entries(cardData.monthlyData).forEach(([monthKey, monthData]) => {
            if (monthData.salesIncreaseForecast < 0) {
                errors.push(`${monthKey}の売上増見込みは0以上で入力してください`);
            }
            
            if (monthData.probability < 0 || monthData.probability > 100) {
                errors.push(`${monthKey}の確率は0-100%の範囲で入力してください`);
            }
        });
    }
    
    return errors;
}



async function saveCardsData() {
    if (!currentUser || !window.firebaseImports || !window.db) {
        try {
            localStorage.setItem('salesDashboard_cardsData_v9', JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId
            }));
            console.log('LocalStorageに保存しました（未ログイン/オフライン）');
        } catch (e) {
            console.error('LocalStorage save error:', e);
            showToast('ローカル保存に失敗しました', 'error');
        }
        return;
    }

    // 他人表示中は保存しない（権限エラー防止）
    if (currentViewTarget && currentViewTarget !== currentUser.uid) {
        console.log('他人データ表示中のため、Firestore保存をスキップしました');
        return;
    }
    
    try {
        // 自分のカードのみフィルタリング
        const ownCards = cardsData.filter(card => 
            card.assignedUserId === currentUser.uid
        );

        for (const card of ownCards) {
            const assignedId = currentUser.uid;
            
            if (!card.docId) {
                card.docId = `${assignedId}_${card.id}`;
            }
            
            const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', card.docId);
            
            const cardToSave = {
    ...card,
    assignedUserId: assignedId,
    assignedUserName: card.assignedUserName || (currentUserData?.name || personalSettings.userName),
    // lastUpdatedの上書きを削除（各カードの個別時刻を保持）
    updatedBy: currentUser.uid
};

// 互換性確保：古いデータの時刻フォーマット統一
if (!cardToSave.lastUpdated || typeof cardToSave.lastUpdated === 'string') {
    cardToSave.lastUpdated = new Date(cardToSave.lastUpdated || Date.now());
}

            
            await window.firebaseImports.setDoc(cardRef, cardToSave);
        }

        updateAreaFilterOptions();
        showToast('データを保存しました', 'success');
        console.log('Firestoreに保存完了:', ownCards.length, '件');
        
    } catch (error) {
    console.error('Firestore save error:', error);
    
   const isNetworkError = error.code === 'unavailable' || 
                      error.code === 'deadline-exceeded' ||
                      error.code === 'network-request-failed' ||
                      error.message?.includes('net::ERR_QUIC_PROTOCOL_ERROR') ||
                      error.message?.includes('network-request-failed');
    
    if (isNetworkError) {
        console.log('ネットワークエラーを検出：自動回復を開始');
        
        // まずローカルにデータを退避保存
        try {
            const backupKey = `salesDashboard_network_backup_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId,
                timestamp: new Date().toISOString(),
                userInfo: currentUser?.uid || 'unknown',
                errorType: 'network_error'
            }));
            
            showToast('ネットワーク不安定：ローカルに保存しました（5秒後に自動再試行）', 'info');
            
            // 🆕 5秒後に自動でもう一度保存を試す
            setTimeout(() => {
                console.log('自動リトライを実行中...');
                saveCardsData();
            }, 5000);
            
        } catch (backupError) {
            console.error('バックアップ保存失敗:', backupError);
            showToast('保存に失敗しました。重要なデータは手動で控えてください', 'error');
        }
        return; // ネットワークエラーの場合はここで終了
    }
    
    // 通常のエラー（権限不足など）の処理
    const errorMessages = {
        'permission-denied': '保存権限がありません。管理者にお問い合わせください',
        'quota-exceeded': 'ストレージ容量が上限に達しています',
        'unauthenticated': '認証が必要です。再ログインしてください'
    };
    
    const message = errorMessages[error.code] || `保存エラー: ${error.message || 'データ保存に失敗しました'}`;
    showToast(message, 'error');
    
    // 既存のバックアップ機能
    try {
        const backupKey = `salesDashboard_backup_${Date.now()}`;
        localStorage.setItem(backupKey, JSON.stringify({
            cardsData: cardsData,
            nextCardId: nextCardId,
            timestamp: new Date().toISOString(),
            userInfo: currentUser?.uid || 'unknown',
            errorCode: error.code || 'unknown_error'
        }));
        console.log('バックアップ保存完了:', backupKey);
    } catch (backupError) {
        console.error('バックアップ失敗:', backupError);
    }
}
}

function loadCardsData() {
    try {
        const saved = localStorage.getItem('salesDashboard_cardsData_v9');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.cardsData) {
                cardsData = data.cardsData;
                nextCardId = data.nextCardId || 1;
            } else {
                cardsData = data;
                const savedNextId = localStorage.getItem('salesDashboard_nextCardId_v9');
                nextCardId = parseInt(savedNextId) || 1;
            }
        } else {
            cardsData = [];
            nextCardId = 1;
        }
    } catch (e) {
        showToast('データ読み込みエラー', 'error');
        console.error('Load error:', e);
        cardsData = [];
        nextCardId = 1;
    }
}

function savePersonalSettings() {
    try {
        localStorage.setItem('salesDashboard_personalSettings_v9', JSON.stringify(personalSettings));
    } catch (e) {
        showToast('個人設定保存エラー', 'error');
        console.error('Personal settings save error:', e);
    }
}
        
async function savePersonalSettingsComplete() {
    // ローカル保存
    savePersonalSettings();

    // キャッシュ即時更新（自分表示中の反映遅延を解消）
    if (currentUser?.uid) {
        userSettingsCache[currentUser.uid] = { ...personalSettings };
    }
    
    // Firebase保存
    if (currentUser && window.db && window.firebaseImports) {
        try {
let dataToSave = {};

// Manager用地域別保存
if (currentUserRole === 'manager') {
    const { region } = parseViewTarget(currentViewTarget);
    
    // 既存の地域別設定を取得
    const userDoc = await window.firebaseImports.getDoc(
        window.firebaseImports.doc(window.db, 'users', currentUser.uid)
    );
    
    let existingSettings = {};
    if (userDoc.exists() && userDoc.data().personalSettings) {
        const cloudData = userDoc.data().personalSettings;
        if (cloudData.kansai || cloudData.shikoku) {
            existingSettings = cloudData;
        }
    }
    
    // 現在の地域の設定のみ更新
    dataToSave = {
        personalSettings: {
            ...existingSettings,
            [region]: personalSettings
        }
    };
    
    console.log(`${region}設定を保存:`, dataToSave);
} else {
    // 通常ユーザー
    dataToSave = { personalSettings };
}

await window.firebaseImports.setDoc(
    window.firebaseImports.doc(window.db, 'users', currentUser.uid),
    dataToSave,
    { merge: true }
);

            showToast('個人設定をクラウドに保存しました', 'success');
        } catch (error) {
            console.error('Firebase個人設定保存エラー:', error);
            showToast('クラウド保存でエラーが発生しました', 'error');
        }
    }
}
        // 保存処理をブラウザのアイドル時間に遅延実行（重複をまとめる）
let scheduledSaveToken = null;

function scheduleSavePersonalSettings() {
    // 既にスケジュール済みなら何もしない（連打を1回にまとめる）
    if (scheduledSaveToken) return;

    const executeSave = () => {
        scheduledSaveToken = null; // 次のスケジュールを許可
        try {
            savePersonalSettingsComplete();
        } catch (error) {
            console.error('Delayed save failed:', error);
            showToast('保存処理でエラーが発生しました', 'error');
        }
    };

    if ('requestIdleCallback' in window) {
        // Safari等で未実装のことがあるため timeout も設定
        scheduledSaveToken = requestIdleCallback(executeSave, { timeout: 2000 });
    } else {
        // フォールバック（次フレームで実行）
        scheduledSaveToken = setTimeout(executeSave, 0);
    }
}

// ログイン時同期関数
async function syncPersonalSettingsOnLogin() {
    if (!currentUser || !window.db) return;
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', currentUser.uid)
        );
        
                if (userDoc.exists() && userDoc.data().personalSettings) {
    // 🆕 クラウド優先：ローカル設定を完全に置き換え
    personalSettings = { 
        ...getDefaultSettings(),
        ...userDoc.data().personalSettings 
    };
    
    // 🆕 後方互換性の強化：古いcumulativeProfitActualを現在月に移行
if (!personalSettings.monthlyCumulativeProfitActuals) {
    personalSettings.monthlyCumulativeProfitActuals = {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    };
    
    // 古いデータがある場合は現在月に移行
    if (personalSettings.cumulativeProfitActual && personalSettings.cumulativeProfitActual > 0) {
        const currentMonth = getCurrentMonth();
        personalSettings.monthlyCumulativeProfitActuals[currentMonth] = personalSettings.cumulativeProfitActual;
        console.log(`古い累積粗利データ(${personalSettings.cumulativeProfitActual})を${currentMonth}月に移行しました`);
    }
}

    
    // 🆕 ローカルストレージを最新クラウドデータで強制更新
    savePersonalSettings();
    updatePersonalSalesTarget();
    updateDashboard();

    showToast('クラウドから個人設定を同期し、ローカルを更新しました', 'info');

        } else {
            // 初回：ローカル設定をクラウドに保存
            await savePersonalSettingsComplete();
            showToast('個人設定をクラウドに初期保存しました', 'success');
        }
    } catch (error) {
        console.error('個人設定同期エラー:', error);
        showToast('設定同期に失敗（ローカル設定を使用）', 'error');
    }
}

function loadPersonalSettings() {
    try {
        const saved = localStorage.getItem('salesDashboard_personalSettings_v9');
        if (saved) {
            const savedSettings = JSON.parse(saved);
            personalSettings = { ...personalSettings, ...savedSettings };
            
            if (!personalSettings.monthlyProfitTargets) {
                personalSettings.monthlyProfitTargets = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            if (!personalSettings.monthlyProfitActuals) {
                personalSettings.monthlyProfitActuals = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            
            // 🆕 新フィールド（月ごとの累積粗利実績）を初期化
            if (!personalSettings.monthlyCumulativeProfitActuals) {
                personalSettings.monthlyCumulativeProfitActuals = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            
            updatePersonalSalesTarget();
            
            // 🆕 後方互換性：旧データから新構造への一回限りの移行
            const oldCumulativeValue = Number(personalSettings.cumulativeProfitActual || 0);
            if (oldCumulativeValue > 0) {
                const currentMonth = getCurrentMonth();
                const existingValue = Number(personalSettings.monthlyCumulativeProfitActuals[currentMonth] || 0);
                
                // 現在月の新データが未設定の場合のみ移行（重複防止）
                if (!existingValue || existingValue === 0) {
                    personalSettings.monthlyCumulativeProfitActuals[currentMonth] = oldCumulativeValue;
                    
                    // 移行完了をローカルストレージに保存
                    try {
                        savePersonalSettings();
                        console.log(`データ移行完了: cumulativeProfitActual(${oldCumulativeValue}) → monthlyCumulativeProfitActuals[${currentMonth}]`);
                    } catch(e) {
                        console.warn('移行データの保存に失敗:', e);
                    }
                }
            }
        }
    } catch (e) {
        showToast('個人設定読み込みエラー', 'error');
        console.error('Personal settings load error:', e);
    }
}


function migrateToV9Structure() {
    const fiscalStructure = getFiscalYearStructure();
    let migrationCount = 0;
    
    cardsData.forEach(cardData => {
        let needsMigration = false;
        
        if (cardData.hasOwnProperty('annualSalesIncreaseTarget')) {
            delete cardData.annualSalesIncreaseTarget;
            needsMigration = true;
        }
        if (cardData.hasOwnProperty('annualProfitIncreaseExpected')) {
            delete cardData.annualProfitIncreaseExpected;
            needsMigration = true;
        }
        
        if (!cardData.monthlyData) {
            cardData.monthlyData = {};
            needsMigration = true;
            
            fiscalStructure.months.forEach(monthInfo => {
                cardData.monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: 0,
                    probability: 50,
                    memo: ""
                };
            });
            
            if (cardData.memo) {
                cardData.monthlyData[fiscalStructure.currentMonthKey].memo = cardData.memo;
                delete cardData.memo;
            }
            
            if (cardData.probability) {
                let numericProbability = 50;
                switch(cardData.probability) {
                    case '80+': numericProbability = 90; break;
                    case '60-80': numericProbability = 70; break;
                    case '50-60': numericProbability = 60; break;
                    case '50-': numericProbability = 40; break;
                }
                cardData.monthlyData[fiscalStructure.currentMonthKey].probability = numericProbability;
                delete cardData.probability;
            }
        }
        
        if (!cardData.displayMonth) {
            cardData.displayMonth = fiscalStructure.currentMonthKey;
            needsMigration = true;
        }
        
        if (!cardData.annualMaterials) {
            cardData.annualMaterials = {
                yearRound: { hasOrder: false, orderPeriod: "" },
                seasonalExam: { hasUsage: false, usagePeriod: "" }
            };
            needsMigration = true;
        }

        if (!cardData.registeredMonth) {
    cardData.registeredMonth = getMonthKeyFromTimestamp(
        cardData.lastUpdated, 
        fiscalStructure.currentMonthKey
    );
    needsMigration = true;
}


        if (!cardData.hasOwnProperty('area')) {
            cardData.area = "";
            needsMigration = true;
        }

        if (!cardData.hasOwnProperty('assignedUser')) {
    cardData.assignedUser = personalSettings.userName;
    needsMigration = true;
}

// 🆕 地域フィールドの追加（既存データは全て関西に設定）
if (!cardData.hasOwnProperty('region')) {
    cardData.region = "kansai";
    needsMigration = true;
}


        if (needsMigration) {
            migrationCount++;
        }
    });
    
    if (migrationCount > 0) {
        saveCardsData();
        showToast(`${migrationCount}件のデータを新形式に移行しました`, 'info');
    }
}

function initializeDisplayMonth() {
    const fs = getFiscalYearStructure();
    const currentMonthKey = fs.currentMonthKey;
    const validKeys = new Set(fs.months.map(m => m.key));
    
    cardsData.forEach(cardData => {
        // 未設定または無効なキーの場合に自動修正
        if (!cardData.displayMonth || !validKeys.has(cardData.displayMonth)) {
            cardData.displayMonth = currentMonthKey;
        }
    });
    
    const globalSelector = document.getElementById('globalMonthSelector');
    if (globalSelector) {
        globalSelector.value = currentMonthKey;
    }
    
    saveCardsData();
}

function updateAreaFilterOptions() {
    const areaFilter = document.getElementById('areaFilter');
    if (!areaFilter) return;
    
    const currentValue = areaFilter.value || 'all';
    areaFilter.innerHTML = '<option value="all">全地域</option>';
    
    const municipalitySet = new Set();
    
    cardsData.forEach(card => {
        const address = card.address || '';
        if (address.trim()) {
            const municipality = extractMunicipality(address);
            if (municipality) {
                municipalitySet.add(municipality);
            }
        }
    });
    
    const sortedMunicipalities = Array.from(municipalitySet).sort((a, b) => 
        a.localeCompare(b, 'ja', { numeric: true })
    );
    
    sortedMunicipalities.forEach(municipality => {
        const option = document.createElement('option');
        option.value = municipality;
        option.textContent = municipality;
        areaFilter.appendChild(option);
    });
    
    if (sortedMunicipalities.includes(currentValue) || currentValue === 'all') {
        areaFilter.value = currentValue;
    }
}

function updateGlobalMonthSelector() {
    const selector = document.getElementById('globalMonthSelector');
    if (!selector) return;
    
    const fiscalStructure = getFiscalYearStructure();
    const targetMonthKey = activeDashboardMonthKey || fiscalStructure.currentMonthKey;
    
    selector.innerHTML = '';
    
    fiscalStructure.months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.key;
        option.textContent = `${month.month}月`;
        if (month.key === targetMonthKey) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
    
    // セレクター値を確実に設定
    selector.value = targetMonthKey;
    
    // 表示テキストも更新
    const targetMonthInfo = fiscalStructure.months.find(m => m.key === targetMonthKey);
    if (targetMonthInfo) {
        document.getElementById('currentDateDisplay').textContent = targetMonthInfo.label;
    }
}

function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 200);
        }, 2500);
    });
}

function calculateQualifiedProspects() {
    const settings = getActiveSettings();
    const currentMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    const qualifiedProfit = cardsData.reduce((total, card) => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 0 
        };
        
        if (monthData.probability < 80) return total;
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        return total + profit;
    }, 0);
    
    return qualifiedProfit;
}


function calculateAllProgress() {
    const settings = getActiveSettings();
    const now = Date.now();
    const monthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const cacheKey = `${cardsData.length}-${settings.yearlyProfitIncreaseTarget}-${monthKey}-${currentViewTarget || ''}`;
    
    if (progressCache && 
        progressCache.cacheKey === cacheKey && 
        (now - progressCache.timestamp) < 5000) {
        return progressCache.data;
    }

    const currentMonth = getCurrentMonth();
    
    const monthlyTarget = settings.monthlyProfitTargets[currentMonth] || 0;
    const monthlyActual = settings.monthlyProfitActuals[currentMonth] || 0;
    const monthlyDifference = monthlyActual - monthlyTarget;
    const monthlyRate = monthlyTarget > 0 ? (monthlyActual / monthlyTarget) * 100 : 0;
    
    const yearlyTarget = settings.yearlyProfitTarget || 0;
    const yearlyActual = Object.values(settings.monthlyProfitActuals)
                                .reduce((sum, monthlyProfit) => sum + (monthlyProfit || 0), 0);
    const yearlyRate = yearlyTarget > 0 ? (yearlyActual / yearlyTarget) * 100 : 0;
    
    const salesIncreaseTarget = settings.yearlySalesIncreaseTarget || 0;
    const totalSalesProspect = cardsData.reduce((sum, card) => {
        const monthData = card.monthlyData?.[monthKey] || { salesIncreaseForecast: 0 };
        return sum + (monthData.salesIncreaseForecast || 0);
    }, 0);
    const salesTargetRate = salesIncreaseTarget > 0 ? (totalSalesProspect / salesIncreaseTarget) * 100 : 0;
    
    const prospectTotal = calculateQualifiedProspects();
    const prospectRate = (settings.yearlyProfitIncreaseTarget || 0) > 0 ? 
        (prospectTotal / settings.yearlyProfitIncreaseTarget) * 100 : 0;
    
    // 6段階ファネル
    let probUnder50 = 0, prob5060 = 0, prob70 = 0, prob80 = 0, prob90 = 0, prob100 = 0;

    cardsData.forEach(card => {
        const monthData = card.monthlyData?.[monthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 0 
        };
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        if (monthData.probability < 50) {
            probUnder50 += profit;
        } else if (monthData.probability <= 60) {
            prob5060 += profit;
        } else if (monthData.probability === 70) {
            prob70 += profit;
        } else if (monthData.probability === 80) {
            prob80 += profit;
        } else if (monthData.probability === 90) {
            prob90 += profit;
        } else if (monthData.probability === 100) {
            prob100 += profit;
        }
    });
   
    const result = {
        monthly: { target: monthlyTarget, actual: monthlyActual, difference: monthlyDifference, rate: monthlyRate },
        yearly: { target: yearlyTarget, actual: yearlyActual, rate: yearlyRate },
        salesTarget: { target: salesIncreaseTarget, prospect: totalSalesProspect, rate: salesTargetRate },
        prospect: { total: prospectTotal, rate: prospectRate },
        funnel: { probUnder50, prob5060, prob70, prob80, prob90, prob100 }
    };
    
    progressCache = {
        data: result,
        cacheKey: cacheKey,
        timestamp: now
    };
    
    return result;
}

function updateMiddleCards() {
    const elTotal = document.getElementById('totalSalesProspectDisplay'); // === 新規カード追加 ===
    const elSales = document.getElementById('salesProspectDisplay');
    const elProfit = document.getElementById('profitProspectDisplay');
    const elPersonal = document.getElementById('personalIncreaseTargetDisplay');
    
    if (!elTotal || !elSales || !elProfit || !elPersonal) return; // === 新規カードもチェック ===

    const settings = getActiveSettings();
    const currentMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    // === 50%以上と80%以上の両方を計算 ===
    let totalSalesProspect50Plus = 0; // 新規カード用
    let totalSalesProspect80Plus = 0; // 既存ロジック用
    let totalProfitProspect80Plus = 0;
    
    cardsData.forEach(card => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 0 // === デフォルトを不明に変更 ===
        };
        
        const salesAmount = monthData.salesIncreaseForecast || 0;
        const probability = monthData.probability || 0;
        
        // 50%以上の合計（新規カード用）
        if (probability >= 50) {
            totalSalesProspect50Plus += salesAmount;
        }
        
        // 80%以上の合計（既存ロジック）
        if (probability >= 80) {
            totalSalesProspect80Plus += salesAmount;
            totalProfitProspect80Plus += salesAmount * ((settings.profitRate || 0) / 100);
        }
    });
    
    // === 新しい売上見込合計カードを更新 ===
    elTotal.innerHTML = `売上見込合計 <span class="value-emphasis">${formatAmount(totalSalesProspect50Plus)}</span>`;
    
    // 既存カードも更新
    const salesTarget = settings.yearlySalesIncreaseTarget || 0;
    const profitTarget = settings.yearlyProfitIncreaseTarget || 0;
    const salesRate = salesTarget > 0 ? (totalSalesProspect80Plus / salesTarget) * 100 : 0;
    const profitRate = profitTarget > 0 ? (totalProfitProspect80Plus / profitTarget) * 100 : 0;
    
    elSales.innerHTML = `売上増見込 <span class="value-emphasis">${formatAmount(totalSalesProspect80Plus)}</span>/${formatAmount(salesTarget)} (${salesRate.toFixed(1)}%)`;
    elProfit.innerHTML = `粗利増見込 <span class="value-emphasis">${formatAmount(totalProfitProspect80Plus)}</span>/${formatAmount(profitTarget)} (${profitRate.toFixed(1)}%)`;

    const manualTarget = settings.personalSalesIncreaseTarget || settings.yearlySalesIncreaseTarget || 0;
    const pr = Number(settings.profitRate || 0);
    elPersonal.innerHTML = `個人設定売上増目標 <span class="value-emphasis">${formatManPlain(manualTarget)}</span> | 粗利率 ${pr.toFixed(1)}%`;
}

function updateDashboard() {
    // 売上フィールドの編集機能を無効化
    lockAutoCalculatedFields();
    
    if (!document.getElementById('monthlyProfitTarget')) {
        console.log('Dashboard elements not ready yet, skipping update');
        return;
    }

    const settings = getActiveSettings();
    const { months, currentMonthIndex } = getFiscalYearStructure();
    const profitRate = (settings.profitRate || 0) / 100;

    // アクティブ月の取得（グローバル月セレクターに連動）
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeMonthInfo = months.find(m => m.key === activeMonthKey);
    const activeMonth = activeMonthInfo ? activeMonthInfo.month : months[currentMonthIndex].month;
    const activeIndex = activeMonthInfo ? months.indexOf(activeMonthInfo) : currentMonthIndex;

    // 1. 月別粗利（選択月に対応）
    const monthlyProfitTarget = settings.monthlyProfitTargets[activeMonth] || 0;
    const monthlyProfitActual = settings.monthlyProfitActuals[activeMonth] || 0;

    const monthlyProfitDiff = monthlyProfitActual - monthlyProfitTarget;
    const monthlyProfitRate = monthlyProfitTarget > 0 ? (monthlyProfitActual / monthlyProfitTarget) * 100 : 0;

    updateCardValue('monthlyProfitTarget', formatAmount(monthlyProfitTarget));
    updateCardValue('monthlyProfitActual', formatAmount(monthlyProfitActual));
    updateCardDifference('monthlyProfitDiff', monthlyProfitDiff);
    updateCardValue('monthlyProfitRate', `${monthlyProfitRate.toFixed(1)}%`);

    // 2. 月別売上（円表記）
    const monthlySalesTarget = profitRate > 0 ? monthlyProfitTarget / profitRate : 0;
    const monthlySalesActual = profitRate > 0 ? monthlyProfitActual / profitRate : 0;
    const monthlySalesDiff = monthlySalesActual - monthlySalesTarget;
    const monthlySalesRate = monthlySalesTarget > 0 ? (monthlySalesActual / monthlySalesTarget) * 100 : 0;

    updateCardValue('monthlySalesTarget', formatAmount(monthlySalesTarget));
    updateCardValue('monthlySalesActual', formatAmount(monthlySalesActual));
    updateCardDifference('monthlySalesDiff', monthlySalesDiff);
    updateCardValue('monthlySalesRate', `${monthlySalesRate.toFixed(1)}%`);

    // 3. 累積粗利（目標：選択月まで合算、実績：選択月の手入力値）
    let cumulativeProfitTarget = 0;
    for (let i = 0; i <= activeIndex; i++) {
        const monthNum = months[i].month;
        cumulativeProfitTarget += settings.monthlyProfitTargets[monthNum] || 0;
    }
    
    // 月ごとの累積粗利実績から選択月の値を取得（後方互換性あり）
    // 🆕 0を正しい値として扱う：undefined/nullの場合のみフォールバック
const monthCumulativeValue = settings.monthlyCumulativeProfitActuals?.[activeMonth];
const cumulativeProfitActual = (monthCumulativeValue !== undefined && monthCumulativeValue !== null)
    ? monthCumulativeValue
    : (settings.cumulativeProfitActual ?? 0);


    const cumulativeProfitDiff = cumulativeProfitActual - cumulativeProfitTarget;
    const cumulativeProfitRate = cumulativeProfitTarget > 0 ? (cumulativeProfitActual / cumulativeProfitTarget) * 100 : 0;

    updateCardValue('cumulativeProfitTarget', formatAmount(cumulativeProfitTarget));
    updateCardValue('cumulativeProfitActual', formatAmount(cumulativeProfitActual));
    updateCardDifference('cumulativeProfitDiff', cumulativeProfitDiff);
    updateCardValue('cumulativeProfitRate', `${cumulativeProfitRate.toFixed(1)}%`);

    // 4. 累積売上（円表記）
    const cumulativeSalesTarget = profitRate > 0 ? cumulativeProfitTarget / profitRate : 0;
    const cumulativeSalesActual = profitRate > 0 ? cumulativeProfitActual / profitRate : 0;
    const cumulativeSalesDiff = cumulativeSalesActual - cumulativeSalesTarget;
    const cumulativeSalesRate = cumulativeSalesTarget > 0 ? (cumulativeSalesActual / cumulativeSalesTarget) * 100 : 0;

    updateCardValue('cumulativeSalesTarget', formatAmount(cumulativeSalesTarget));
    updateCardValue('cumulativeSalesActual', formatAmount(cumulativeSalesActual));
    updateCardDifference('cumulativeSalesDiff', cumulativeSalesDiff);
    updateCardValue('cumulativeSalesRate', `${cumulativeSalesRate.toFixed(1)}%`);

    // ファネル更新
    const progress = calculateAllProgress();
    const safeUpdateElement = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    };
    
    safeUpdateElement('probUnder50', formatManYen(progress.funnel.probUnder50));
    safeUpdateElement('prob5060', formatManYen(progress.funnel.prob5060));
    safeUpdateElement('prob70', formatManYen(progress.funnel.prob70));
    safeUpdateElement('prob80', formatManYen(progress.funnel.prob80));
    safeUpdateElement('prob90', formatManYen(progress.funnel.prob90));
    safeUpdateElement('prob100', formatManYen(progress.funnel.prob100));

    updateMiddleCards();
}
        
async function displayMasterView() {
    if (currentUserRole !== 'admin' && currentUserRole !== 'master') {
        showToast('権限がありません', 'error');
        return;
    }
    
    const masterViewContentDiv = document.getElementById('masterViewContent');
    masterViewContentDiv.innerHTML = '<div style="text-align: center; padding: 50px;"><p>📊 データ読み込み中...</p></div>';

    try {
        const usersCollection = await window.firebaseImports.getDocs(
            window.firebaseImports.collection(window.db, 'users')
        );
        
        // 🆕 除外対象を明示的に定義
        const EXCLUDED_EMAILS = [
            'yosioka@chuoh-kyouiku.co.jp'
        ];
        
        const staffList = [];
        usersCollection.forEach((doc) => {
            const userData = doc.data();
            const userEmail = userData.email || '';
            const userRole = (userData.role || '').toLowerCase();
            
            // 除外判定（メール・役職の両方）
            if (EXCLUDED_EMAILS.includes(userEmail)) return;
            if (userRole === 'master') return;
            
            staffList.push({
                id: doc.id,
                name: userData.name,
                role: userRole,
                email: userEmail,
                settings: userData.personalSettings || getDefaultSettings(),
                rawUserData: userData
            });
        });
        
        masterViewContentDiv.innerHTML = '';
        const masterContainer = document.createElement('div');
        masterContainer.className = 'master-view-container';
        
        // タイトルと対象地域の決定
        let title = '👑 マスター管理画面';
        let viewMode = 'all';

        if (currentViewTarget === 'master-kansai') {
            title += '（関西統括）';
            viewMode = 'kansai';
        } else if (currentViewTarget === 'master-shikoku') {
            title += '（四国統括）';
            viewMode = 'shikoku';
        } else if (currentViewTarget === 'master-all') {
            title += '（全統括）';
        }
        
        masterContainer.innerHTML = `<h2>${title}</h2>`;
        
        // 🆕 表示対象リストの構築（プロファイル分離対応）
        const displayTargets = [];

        for (const staff of staffList) {
            const isManager = staff.role === 'manager';
            const userRegion = staff.rawUserData?.region || 'kansai';

            if (isManager) {
                // Managerは地域別に分割表示
                const hasKansaiData = staff.settings?.kansai && 
                    (Object.values(staff.settings.kansai.monthlyProfitTargets || {}).some(v => v > 0) ||
                     Object.values(staff.settings.kansai.monthlyProfitActuals || {}).some(v => v > 0));
                
                const hasShikokuData = staff.settings?.shikoku && 
                    (Object.values(staff.settings.shikoku.monthlyProfitTargets || {}).some(v => v > 0) ||
                     Object.values(staff.settings.shikoku.monthlyProfitActuals || {}).some(v => v > 0));

                // 関西プロファイル
                if ((viewMode === 'all' || viewMode === 'kansai') && hasKansaiData) {
                    displayTargets.push({
                        ...staff,
                        displayName: `${staff.name}（関西）`,
                        displayRegion: 'kansai',
                        effectiveSettings: staff.settings.kansai,
                        queryUserId: `${staff.id}_kansai`
                    });
                }

                // 四国プロファイル
                if ((viewMode === 'all' || viewMode === 'shikoku') && hasShikokuData) {
                    displayTargets.push({
                        ...staff,
                        displayName: `${staff.name}（四国）`,
                        displayRegion: 'shikoku',
                        effectiveSettings: staff.settings.shikoku,
                        queryUserId: `${staff.id}_shikoku`
                    });
                }
            } else {
                // 通常Staff：地域で判定
                if (viewMode === 'all' || userRegion === viewMode) {
                    const regionLabel = userRegion === 'shikoku' ? '四国' : '関西';
                    displayTargets.push({
                        ...staff,
                        displayName: `${staff.name}（${regionLabel}）`,
                        displayRegion: userRegion,
                        effectiveSettings: staff.settings,
                        queryUserId: staff.id
                    });
                }
            }
        }

        // ソート: 地域→名前順
        displayTargets.sort((a, b) => {
            if (a.displayRegion !== b.displayRegion) {
                return a.displayRegion === 'kansai' ? -1 : 1;
            }
            return a.name.localeCompare(b.name, 'ja');
        });

        // 各プロファイルの表示処理
        for (const target of displayTargets) {
            const staffSection = document.createElement('div');
            staffSection.className = 'master-staff-section';
            
            try {
                // 🆕 厳密なカード取得クエリ
                const cardsQuery = window.firebaseImports.query(
                    window.firebaseImports.collection(window.db, 'juku_cards'),
                    window.firebaseImports.where('assignedUserId', '==', target.id),
                    window.firebaseImports.where('region', '==', target.displayRegion)
                );

                const staffCards = await window.firebaseImports.getDocs(cardsQuery);
                const staffCardsData = [];
                staffCards.forEach((doc) => {
                    const cardData = doc.data();
                    // 念押しフィルタリング
                    if (cardData.region === target.displayRegion) {
                        staffCardsData.push(cardData);
                    }
                });
                
                const staffWithSettings = {
                    ...target,
                    settings: target.effectiveSettings
                };
                
                staffSection.innerHTML = `
                    <div class="master-staff-name">${target.displayName}</div>
                    <div class="master-main-cards">
                        ${generateMasterMainCards(staffWithSettings, staffCardsData)}
                    </div>
                    <div class="master-middle-cards">
                        ${generateMasterMiddleCards(staffWithSettings, staffCardsData)}
                    </div>
                    <div class="master-funnel">
                        ${generateMasterFunnel(staffWithSettings, staffCardsData)}
                    </div>
                `;
                
            } catch (staffError) {
                console.error(`${target.displayName}のデータ取得エラー:`, staffError);
                staffSection.innerHTML = `
                    <div class="master-staff-name">${target.displayName} - エラー</div>
                    <div style="color: red; padding: 20px; text-align: center;">
                        データの読み込みに失敗しました
                    </div>
                `;
            }
            
            masterContainer.appendChild(staffSection);
        }
        
        // 表示件数が0の場合のメッセージ
        if (displayTargets.length === 0) {
            masterContainer.innerHTML += `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <p>📭 表示するデータがありません</p>
                    <small>対象地域のデータを持つメンバーがいません</small>
                </div>
            `;
        }
        
        masterViewContentDiv.appendChild(masterContainer);

    } catch (error) {
        console.error('マスタービューエラー:', error);
        masterViewContentDiv.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #D32F2F;">
                <h3>⚠️ マスタービューの読み込みに失敗しました</h3>
                <p><strong>エラー:</strong> ${error.message}</p>
                <button class="btn btn-primary" onclick="location.reload()">ページ再読み込み</button>
            </div>
        `;
    }
}

function generateMasterMainCards(staff, cardsData) {
    const s = staff.settings;
    const { months } = getFiscalYearStructure();

    // グローバル月セレクターの値を使用
    const activeKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeIndex = Math.max(0, months.findIndex(m => m.key === activeKey));
    const fallbackIndex = getFiscalYearStructure().currentMonthIndex;
    const idx = activeIndex >= 0 ? activeIndex : fallbackIndex;

    const currentMonth = months[idx].month;
    const profitRate = (s.profitRate || 0) / 100;

    // 月別粗利（選択月）
    const monthlyProfitTarget = s.monthlyProfitTargets?.[currentMonth] || 0;
    const monthlyProfitActual = s.monthlyProfitActuals?.[currentMonth] || 0;
    const monthlyProfitDiff = monthlyProfitActual - monthlyProfitTarget;
    const monthlyProfitRate = monthlyProfitTarget > 0 ? (monthlyProfitActual / monthlyProfitTarget) * 100 : 0;

    // 月別売上（選択月）
    const monthlySalesTarget = profitRate > 0 ? monthlyProfitTarget / profitRate : 0;
    const monthlySalesActual = profitRate > 0 ? monthlyProfitActual / profitRate : 0;
    const monthlySalesDiff = monthlySalesActual - monthlySalesTarget;
    const monthlySalesRate = monthlySalesTarget > 0 ? (monthlySalesActual / monthlySalesTarget) * 100 : 0;

    // 累積粗利（選択月まで目標合算、選択月実績値）
    let cumulativeProfitTarget = 0;
    for (let i = 0; i <= idx; i++) {
        const monthNum = months[i].month;
        cumulativeProfitTarget += s.monthlyProfitTargets?.[monthNum] || 0;
    }

    // 選択月の累積粗利実績を取得（後方互換性あり）
    const selectedMonth = months[idx].month;
    // 🆕 マスタービューでも同様の修正
const monthCumulativeValue = s.monthlyCumulativeProfitActuals?.[selectedMonth];
const cumulativeProfitActual = (monthCumulativeValue !== undefined && monthCumulativeValue !== null)
    ? monthCumulativeValue
    : (s.cumulativeProfitActual ?? 0);


    const cumulativeProfitDiff = cumulativeProfitActual - cumulativeProfitTarget;
    const cumulativeProfitRate = cumulativeProfitTarget > 0 ? (cumulativeProfitActual / cumulativeProfitTarget) * 100 : 0;

    // 累積売上（選択月まで）
    const cumulativeSalesTarget = profitRate > 0 ? cumulativeProfitTarget / profitRate : 0;
    const cumulativeSalesActual = profitRate > 0 ? cumulativeProfitActual / profitRate : 0;
    const cumulativeSalesDiff = cumulativeSalesActual - cumulativeSalesTarget;
    const cumulativeSalesRate = cumulativeSalesTarget > 0 ? (cumulativeSalesActual / cumulativeSalesTarget) * 100 : 0;

    // 差額表示のヘルパー関数
    const formatDiff = (amount) => {
        const diff = formatDifferenceAmount(amount, formatAmount);
        const className = diff.isNegative ? 'negative' : (amount > 0 ? 'positive' : 'neutral');
        return `<span class="metric-value ${className}">${diff.text}</span>`;
    };

    return `
        <!-- 月別粗利カード -->
        <div class="progress-card monthly-profit-card">
            <h3>月別粗利</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(monthlyProfitTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(monthlyProfitActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(monthlyProfitDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${monthlyProfitRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 月別売上カード -->
        <div class="progress-card monthly-sales-card">
            <h3>月別売上</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(monthlySalesTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(monthlySalesActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(monthlySalesDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${monthlySalesRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 累積粗利カード -->
        <div class="progress-card cumulative-profit-card">
            <h3>累積粗利</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(cumulativeProfitTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(cumulativeProfitActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(cumulativeProfitDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${cumulativeProfitRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 累積売上カード -->
        <div class="progress-card cumulative-sales-card">
            <h3>累積売上</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(cumulativeSalesTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(cumulativeSalesActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(cumulativeSalesDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${cumulativeSalesRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>
    `;
}

function generateMasterMiddleCards(staff, cardsData) {
    const s = staff.settings;
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    let totalSalesProspect = 0;
    let totalProfitProspect = 0;
    cardsData.forEach(card => {
        const md = card.monthlyData?.[activeMonthKey] || { salesIncreaseForecast: 0, probability: 0 };
        if (md.probability >= 80) {
            const salesAmount = md.salesIncreaseForecast || 0;
            const profitAmount = salesAmount * ((s.profitRate || 0) / 100);
            totalSalesProspect += salesAmount;
            totalProfitProspect += profitAmount;
        }
    });
    const salesTarget = s.yearlySalesIncreaseTarget || 0;
    const profitTarget = s.yearlyProfitIncreaseTarget || 0;
    const salesRate = salesTarget > 0 ? (totalSalesProspect / salesTarget) * 100 : 0;
    const profitRate = profitTarget > 0 ? (totalProfitProspect / profitTarget) * 100 : 0;
    
    // 🆕 3枚目カード用データ取得
    const manualTarget = s.personalSalesIncreaseTarget || s.yearlySalesIncreaseTarget || 0;
    const pr = Number(s.profitRate || 0);
    
    return `
    <div class="master-middle-card personal-sales-target-card full-width">
        個人設定売上増目標 <span class="value-emphasis">${formatManPlain(manualTarget)}</span> | 粗利率 ${pr.toFixed(1)}%
    </div>
    <div class="master-middle-card">売上増見込 ${formatAmount(totalSalesProspect)}/${formatAmount(salesTarget)} (${salesRate.toFixed(1)}%)</div>
    <div class="master-middle-card">粗利増見込 ${formatAmount(totalProfitProspect)}/${formatAmount(profitTarget)} (${profitRate.toFixed(1)}%)</div>
`;

}

function generateMasterFunnel(staff, cardsData) {
    const s = staff.settings;
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    let probUnder50 = 0, prob5060 = 0, prob70 = 0, prob80 = 0, prob90 = 0, prob100 = 0;
    
    cardsData.forEach(card => {
        const md = card.monthlyData?.[activeMonthKey] || { salesIncreaseForecast: 0, probability: 0 };
        const profit = (md.salesIncreaseForecast || 0) * ((s.profitRate || 0) / 100);
        if (md.probability < 50) probUnder50 += profit;
        else if (md.probability <= 60) prob5060 += profit;   // 50/60%のみ
        else if (md.probability === 70) prob70 += profit;    // 70%ちょうど
        else if (md.probability === 80) prob80 += profit;    // 80%ちょうど
        else if (md.probability === 90) prob90 += profit;    // 90%ちょうど
        else if (md.probability === 100) prob100 += profit;  // 100%
    });
    
    return `
        <div class="funnel-section">
            <div class="funnel-item">
                <div class="funnel-label">50%未満</div>
                <div class="funnel-value">${formatManYen(probUnder50)}</div>
            </div>
            <div class="funnel-item">
                <div class="funnel-label">50%-70%未満</div>
                <div class="funnel-value">${formatManYen(prob5060)}</div>
            </div>
            <div class="funnel-item">
                <div class="funnel-label">70%以上</div>
                <div class="funnel-value">${formatManYen(prob70)}</div>
            </div>
            <div class="funnel-item">
                <div class="funnel-label">80%以上</div>
                <div class="funnel-value">${formatManYen(prob80)}</div>
            </div>
            <div class="funnel-item">
                <div class="funnel-label">90%以上</div>
                <div class="funnel-value">${formatManYen(prob90)}</div>
            </div>
            <div class="funnel-item">
                <div class="funnel-label">100%</div>
                <div class="funnel-value">${formatManYen(prob100)}</div>
            </div>
        </div>
    `;
}

       
function createTableRow(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = getCardActiveMonthKey(cardData);  // 🔧 グローバル月セレクターと連動
    const previousMonth = getPreviousMonth(displayMonth);
    
    // 10月判定を追加
    const displayMonthInfo = fiscalStructure.months.find(m => m.key === displayMonth);
    const isFirstFiscalMonth = displayMonthInfo && displayMonthInfo.month === 10;
    
    // 2ヶ月分のデータ取得
const currentData = cardData.monthlyData?.[displayMonth] || { 
    salesIncreaseForecast: 0, probability: 0, memo: "" 
};
const previousData = isFirstFiscalMonth 
    ? { salesIncreaseForecast: 0, probability: 0, memo: "会計年度開始" }
    : (cardData.monthlyData?.[previousMonth.key] || { salesIncreaseForecast: 0, probability: 0, memo: "" });


    
    const level = getCardLevel(currentData.salesIncreaseForecast || 0);
    const change = calculateMonthlyChange(cardData, displayMonth);
    
    // 編集権限の判定
    const canEdit = hasPermission('edit_data', cardData);
    const isCurrentMonth = displayMonth === fiscalStructure.currentMonthKey;
    
    const row = document.createElement('tr');
    row.dataset.cardId = cardData.id;
    
        const status = cardData.status || 'new'; // === 区分取得 ===
    
    row.innerHTML = `
        <td class="col-level">
            <div class="level-indicator status-${status}"></div>
        </td>

        <td class="col-name">
    <div class="juku-name-cell">
        <a href="#" class="juku-name-link" onclick="onJukuNameClick(${cardData.id}); return false;" style="color: #333; text-decoration: none;">
            ${escapeHtml(cardData.jukuName)}
        </a>
    </div>
</td>

                <td class="col-prev-amount">
            ${isFirstFiscalMonth ? '—' : formatManYen(previousData.salesIncreaseForecast || 0)}
        </td>
        <td class="col-prev-prob">
            ${isFirstFiscalMonth ? '—' : getProbabilityLabel(previousData.probability || 0)}
        </td>

        <td class="col-current-amount">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableForecast(${cardData.id},'${displayMonth}')">
                    ${formatManYen(currentData.salesIncreaseForecast || 0)}
                </div>
            ` : `
                ${formatManYen(currentData.salesIncreaseForecast || 0)}
            `}
        </td>
        <td class="col-current-prob">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableProbability(${cardData.id},'${displayMonth}')">
                    ${getProbabilityLabel(currentData.probability || 0)}
                </div>
            ` : `
                ${getProbabilityLabel(currentData.probability || 0)}
            `}
        </td>
        <td class="col-change">
            <span class="change-${change.direction}">
                ${formatManYen(change.amount)} ${change.direction === 'increase' ? '↗' : change.direction === 'decrease' ? '↘' : '→'}
            </span>
        </td>
                <td class="col-edit">
    ${hasPermission('edit_data', cardData) ? 
        `<button class="detail-btn" onclick="openEditFromTable(${cardData.id})">編集</button>` : 
        `<div class="last-updated-table">${formatDateForDisplay(cardData.lastUpdated)}</div>`
    }
</td>

<td class="col-detail">
    <button class="detail-btn" onclick="openMonthlyHistoryModal(${cardData.id})">詳細</button>
</td>

    `;
    
    // 閲覧専用カードのスタイル適用
    // === PC版：行クリックで根拠モーダル ===
    row.addEventListener('click', (e) => {
        if (e.target.closest('button, a, .editable-cell')) return;
        openEvidenceModal(cardData.id);
    });
    
    // 閲覧専用カードのスタイル適用
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        row.style.cssText = 'opacity: 0.7; background: #fff3cd;';
    }
    
    return row;

}


function editTableName(id) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    const v = prompt('塾名を編集', c.jukuName);
    if (v !== null && v.trim() !== c.jukuName) {
        c.jukuName = v.trim();
         c.lastUpdated = new Date();
        saveCardsData();
        renderCardsOptimized();
        showToast('塾名を更新', 'success');
    }
}

function editTableForecast(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能', 'info');
        return;
    }
    const cur = c.monthlyData?.[key] || { salesIncreaseForecast: 0 };
    const v = prompt('売上増見込を入力（円）', cur.salesIncreaseForecast || 0);
    if (v !== null) {
        const n = parseNumberSafely(v);
        if (!c.monthlyData) c.monthlyData = {};
        if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 0, memo: "" };
        c.monthlyData[key].salesIncreaseForecast = n;
         c.lastUpdated = new Date();
        if (confirm('将来月も更新?')) propagateToFutureMonths(id, n, c.monthlyData[key].probability);
        else saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('売上増見込を更新', 'success');
    }
}

function editTableProbability(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能', 'info');
        return;
    }
      const opts = ['不明', '50未満', '50%', '60%', '70%', '80%', '90%', '100%'], vals = [0, 40, 50, 60, 70, 80, 90, 100];
    const cur = c.monthlyData?.[key] || { probability: 0 };
    const idx = vals.indexOf(cur.probability);
    const choice = prompt(`確率選択:\n0:${opts[0]}\n1:${opts[1]}\n2:${opts[2]}\n3:${opts[3]}\n4:${opts[4]}\n5:${opts[5]}\n6:${opts[6]}\n現在:${opts[idx >= 0 ? idx : 1]}`, idx >= 0 ? idx : 1);
    if (choice !== null) {
        const i = parseInt(choice);
        if (i >= 0 && i < vals.length) {
            const nv = vals[i];
            if (!c.monthlyData) c.monthlyData = {};
            if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 0, memo: "" };
            c.monthlyData[key].probability = nv;
             c.lastUpdated = new Date();
            if (confirm('将来月も更新?')) propagateToFutureMonths(id, c.monthlyData[key].salesIncreaseForecast, nv);
            else saveCardsData();
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
            showToast('確率を更新', 'success');
        }
    }
}

function createNewCardElement(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = getCardActiveMonthKey(cardData);  // 🔧 グローバル月セレクターと連動
    const previousMonth = getPreviousMonth(displayMonth);
    
    // 🔧 追加：10月（会計年度初月）の判定
    const displayMonthInfo = fiscalStructure.months.find(m => m.key === displayMonth);
    const isFirstFiscalMonth = displayMonthInfo && displayMonthInfo.month === 10;
    
    const currentData = cardData.monthlyData?.[displayMonth] || { 
        salesIncreaseForecast: 0, probability: 0, memo: "" 
    };
    // 🔧 修正：10月の場合は前月データを特別扱い
    const previousData = isFirstFiscalMonth 
        ? { salesIncreaseForecast: 0, probability: 0, memo: "会計年度開始" }
        : (cardData.monthlyData?.[previousMonth.key] || { salesIncreaseForecast: 0, probability: 0, memo: "" });
    
    const status = cardData.status || 'new'; // === 区分取得 ===
    
    const card = document.createElement('div');
    card.className = `card card-status-${status}`;
    card.dataset.cardId = cardData.id;
    
    const lastUpdated = formatDateForDisplay(cardData.lastUpdated);
    
    const currentForecast = currentData.salesIncreaseForecast || 0;
    const previousForecast = previousData.salesIncreaseForecast || 0;
    // 🔧 修正：10月の場合は差額計算と表示を特別扱い
    const difference = isFirstFiscalMonth ? currentForecast : (currentForecast - previousForecast);
    const changeIcon = isFirstFiscalMonth ? '🆕' : (difference > 0 ? '📈' : difference < 0 ? '📉' : '➡️');
    const changeClass = difference > 0 ? 'comparison-positive' : difference < 0 ? 'comparison-negative' : 'comparison-neutral';
    
    card.innerHTML = `
        <div class="card-header-new">
            <div class="card-title-clickable" onclick="onJukuNameClick(${cardData.id})">
                ${escapeHtml(cardData.jukuName)}
            </div>
            <select class="month-selector" onchange="changeCardDisplayMonth(${cardData.id}, this.value)">
                ${fiscalStructure.months.map(month => 
                    `<option value="${month.key}" ${month.key === displayMonth ? 'selected' : ''}>${month.month}月</option>`
                ).join('')}
            </select>
        </div>

        <div class="annual-metrics-row">
            <div class="annual-metric">
                <div class="annual-metric-label">売上増見込（${displayMonthInfo?.month || getCurrentMonth()}月時点）</div>
                <div class="annual-metric-value">${formatAmount(currentData.salesIncreaseForecast || 0)}</div>
                <div class="change-indicator ${changeClass}">
                    ${isFirstFiscalMonth ? '🆕' : changeIcon} ${isFirstFiscalMonth ? '新年度開始' : formatAmount(difference)}
                </div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">エリア</div>
                <div class="annual-metric-value">${escapeHtml(cardData.area || '未設定')}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">年間粗利実績</div>
                <div class="annual-metric-value">${formatAmount(cardData.annualProfitActual || 0)}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">年間売上実績</div>
                <div class="annual-metric-value">${formatAmount(calculateSalesFromProfit(cardData.annualProfitActual || 0))}</div>
            </div>
        </div>
        
        <div class="monthly-comparison-section">
            <div class="month-data-column">
                <div class="month-data-header">${isFirstFiscalMonth ? '前年度' : '先月'} (${isFirstFiscalMonth ? '前年9月' : previousMonth.month + '月'})</div>
                <div class="month-data-content">
                    <div class="forecast-amount">売上増見込: ${isFirstFiscalMonth ? '—' : formatAmount(previousData.salesIncreaseForecast)}</div>
                    <div class="forecast-probability">確率: ${isFirstFiscalMonth ? '—' : getProbabilityLabel(previousData.probability)}</div>
                </div>
            </div>
            <div class="month-data-column">
                <div class="month-data-header">今月 (${displayMonthInfo?.month || getCurrentMonth()}月)</div>
                <div class="month-data-content">
                    <div class="editable-field" onclick="editSalesIncreaseForecast(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">売上増見込: ${formatAmount(currentData.salesIncreaseForecast)}</span>
                        <input type="number" class="edit-input" value="${currentData.salesIncreaseForecast}" style="display:none;">
                    </div>
                    <div class="editable-field" onclick="editProbability(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">確率: ${getProbabilityLabel(currentData.probability)}</span>
                        <select class="edit-select" style="display:none;">
                            ${PROBABILITY_CONFIG.options.map(opt => 
                                `<option value="${opt.value}" ${currentData.probability === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="memo-comparison-section">
            <div class="memo-column">
                <div class="memo-header">先月メモ</div>
                <div class="memo-content">${escapeHtml(previousData.memo || '未入力')}</div>
            </div>
            <div class="memo-column">
                <div class="memo-header">今月メモ</div>
                <div class="memo-content" onclick="openMemoDetailModal(${cardData.id}, '${displayMonth}')">${escapeHtml(currentData.memo || '未入力')}</div>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="last-updated">最終更新: ${lastUpdated}</div>
            <div class="card-actions">
                <button class="action-btn" title="履歴" aria-label="履歴" onclick="openMonthlyHistoryModal(${cardData.id})">📊</button>
                ${hasPermission('edit_data', cardData) ? `<button class="action-btn" title="編集" aria-label="編集" onclick="editCard(this)">✏️</button>` : ''}
                ${hasPermission('delete_data', cardData) ? `<button class="action-btn" title="削除" aria-label="削除" onclick="deleteCard(${cardData.id})">🗑️</button>` : ''}
            </div>
        </div>
    `;
    
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        card.style.opacity = '0.8';
        card.classList.add('read-only-card');
        card.style.position = 'relative';
        
        const readOnlyBadge = document.createElement('div');
        readOnlyBadge.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        `;
        readOnlyBadge.textContent = '👁️ 閲覧専用';
        card.appendChild(readOnlyBadge);
        
        const assignedUserName = cardData.assignedUserName || '不明';
        card.title = `担当者: ${assignedUserName}のデータ（閲覧専用）`;
    }

    // === スマホ版：空白部分クリックで根拠モーダル ===
    card.addEventListener('click', (e) => {
        const excludedElements = [
            '.card-title-clickable', '.month-selector', '.editable-field',
            '.memo-content', '.action-btn', 'button', 'select', 'input', 'a'
        ].join(',');
        
        if (e.target.closest(excludedElements)) return;
        openEvidenceModal(cardData.id);
    });

    return card;
}


function propagateToFutureMonths(cardId, newForecast, newProbability) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    const fiscalStructure = getFiscalYearStructure();
    const currentMonthKey = fiscalStructure.currentMonthKey;
    const registeredIndex = fiscalStructure.months.findIndex(m => 
        m.key === (cardData.registeredMonth || currentMonthKey)
    );
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);
    
    fiscalStructure.months.forEach((monthInfo, index) => {
        if (index > Math.max(registeredIndex, currentIndex)) {
            if (!cardData.monthlyData[monthInfo.key]) {
                cardData.monthlyData[monthInfo.key] = { 
                    salesIncreaseForecast: 0, probability: 0, memo: "" 
                };
            }
            cardData.monthlyData[monthInfo.key].salesIncreaseForecast = newForecast;
            cardData.monthlyData[monthInfo.key].probability = newProbability;
        }
    });
    
    cardData.lastUpdated = new Date();
    saveCardsData();
    showToast('将来月のデータを一括更新しました', 'success');
}

function openModal(modalId) {
    scrollPosition = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('modal-open');
    
    const modal = document.getElementById(modalId);
    modal.style.display = 'flex';
    
    // モーダルを開いたら毎回一番上へスクロール
    modal.scrollTop = 0;
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.scrollTop = 0;
    }
    
    // iOS/Safari対策（次フレームでもう一度確実にリセット）
    requestAnimationFrame(() => {
        modal.scrollTop = 0;
        if (modalContent) {
            modalContent.scrollTop = 0;
        }
    });
}

function closeModal(modalId) {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.classList.remove('modal-open');
    window.scrollTo(0, scrollPosition);
    document.getElementById(modalId).style.display = 'none';
}

function filterByProbability(probability) {
    activeProbabilityFilter = probability || 'all';
    applyFilters();
    showToast(`確率${probability === 'all' ? '全体' : probability}で絞り込みました`, 'info');
}


function openNewCardModal() {
    if (!hasPermission('create_data')) {
        showToast('自分のデータ表示中のみ新規登録できます', 'error');
        return;
    }
    
    const form = document.getElementById('newCardForm');
    form.reset();
    
setTimeout(() => {
    const regionSelect = document.getElementById('newJukuRegion');
    
    // ユーザーの所属地域を強制適用（データ混在防止）
    const userRegion = currentUserData?.region || currentProfileRegion || 'kansai';
    regionSelect.value = userRegion;
    regionSelect.disabled = true; // 変更不可
    
    // UI上で非表示にする
    const regionGroup = regionSelect.closest('.form-group');
    if (regionGroup) {
        regionGroup.style.display = 'none';
    }
    
    console.log(`新規登録：地域を${userRegion}に固定しました`);
}, 0);


    // 二重送信防止の初期化
    form.dataset.submitting = 'false';
    const submitBtn = form.querySelector('button[type="submit"]');
    const cancelBtn = form.querySelector('.btn-secondary');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = '登録';
    }
    if (cancelBtn) {
        cancelBtn.disabled = false;
    }
    
    updateActualSales('new');
    document.getElementById('newSalesActual').readOnly = true;
    document.getElementById('newSalesActual').style.background = '#f8f9fa';
    openModal('newCardModal');
setTimeout(() => {
    // 確実にスクロール位置をリセット
    const modalContent = document.querySelector('#newCardModal .modal-content');
    if (modalContent) modalContent.scrollTop = 0;
    setupNumberFormatting();
}, 100);

}


function closeNewCardModal() {
    document.getElementById('newCardForm').reset();
    closeModal('newCardModal');
}

function openPersonalSettingsModal() {
    document.getElementById('userName').value = personalSettings.userName;
    document.getElementById('profitRate').value = personalSettings.profitRate;
    document.getElementById('yearlyProfitTarget').value = personalSettings.yearlyProfitTarget;
    document.getElementById('yearlyProfitIncreaseTarget').value = personalSettings.yearlyProfitIncreaseTarget;
    document.getElementById('yearlySalesIncreaseTarget').value = personalSettings.yearlySalesIncreaseTarget;
document.getElementById('personalSalesIncreaseTarget').value = personalSettings.personalSalesIncreaseTarget || 0;
    
    const monthlyContainer = document.getElementById('monthlyProfitContainer');
    const fiscalMonths = getFiscalYearStructure().months;
    
    monthlyContainer.innerHTML = '';
    
    fiscalMonths.forEach(monthInfo => {
    const monthDiv = document.createElement('div');
    monthDiv.className = 'monthly-row';
    const actualValue = personalSettings.monthlyProfitActuals[monthInfo.month] || 0;
    const targetValue = personalSettings.monthlyProfitTargets[monthInfo.month] || 0;
    const actualDisplay = actualValue === 0 ? '' : actualValue;
    const targetDisplay = targetValue === 0 ? '' : targetValue;
    
    monthDiv.innerHTML = `
        <div class="month-name">${monthInfo.month}月</div>
        <input type="number" class="monthly-input" placeholder="実績" id="monthlyProfitActual${monthInfo.month}" value="${actualDisplay}" title="月別粗利実績（円）">
        <input type="number" class="monthly-input" placeholder="目標" id="monthlyProfitTarget${monthInfo.month}" value="${targetDisplay}" title="月別粗利目標（円）">
    `;
    monthlyContainer.appendChild(monthDiv);
});

    
    setTimeout(() => {
        setupMonthlyInputHandlers('monthlyProfitContainer');
    }, 100);
    
    openModal('personalSettingsModal');
setTimeout(() => {
    // 確実にスクロール位置をリセット
    const modalContent = document.querySelector('#personalSettingsModal .modal-content');
    if (modalContent) modalContent.scrollTop = 0;
    setupNumberFormatting();
}, 100);

}

function closePersonalSettingsModal() {
    closeModal('personalSettingsModal');
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    activeProbabilityFilter = 'all';
    document.getElementById('areaFilter').value = 'all';
    const sortSelect = document.getElementById('sortSelect');
if (sortSelect) {
    sortSelect.value = 'sales-desc';
}
    renderCardsOptimized();
    showToast('フィルタをクリアしました', 'info');
}

function applySorting() {
    renderCardsOptimized();
}

function applyFilters() {
    renderCardsOptimized();
}

function changeCardDisplayMonth(cardId, newMonthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    cardData.displayMonth = newMonthKey;

    // 自分のデータ表示中のときだけ保存
    if (currentUser?.uid && currentViewTarget === currentUser.uid) {
        saveCardsData();
        showToast('表示月を変更し、データを保存しました', 'info');
    } else {
        showToast('表示月を変更しました（閲覧モード）', 'info');
    }

    renderCardsOptimized();
}

function changeAllCardsDisplayMonth(newMonthKey) {
    // UIのアクティブ月を更新
    activeDashboardMonthKey = newMonthKey;

    // 自分表示中のみ displayMonth を保存対象にする
    const selfId = currentUser?.uid || null;
    if (selfId && currentViewTarget === selfId) {
        cardsData.forEach(cardData => {
            cardData.displayMonth = newMonthKey;
        });
        // 表示専用変更のためクラウド保存しない
        showToast('表示月を変更しました', 'info');
    }

    const fiscalStructure = getFiscalYearStructure();
    const monthInfo = fiscalStructure.months.find(m => m.key === newMonthKey);
    if (monthInfo) {
        document.getElementById('currentDateDisplay').textContent = monthInfo.label;
    }

    // マスタービュー表示中なら再描画
if (currentViewTarget === 'master-kansai' || currentViewTarget === 'master-shikoku') {
    displayMasterView();
}

    // 再計算と描画は常に実行
    progressCache = null;
    updateDashboard();
    renderCardsOptimized();
}

function openMonthlyHistoryModal(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    // 対象カードIDを保存
    currentHistoryCardId = cardId;
    
    document.getElementById('historyModalTitle').textContent = `${cardData.jukuName} - 月別履歴（表示専用）`;
    
    // 削除ボタンの表示制御（PCかつ自分のデータのみ）
    const deleteBtn = document.getElementById('historyDeleteBtn');
    const isPC = window.innerWidth >= 1025;
    const canDelete = hasPermission('delete_data', cardData) && isPC;
    
    if (deleteBtn) {
        deleteBtn.style.display = canDelete ? 'inline-block' : 'none';
    }
    
    const container = document.getElementById('monthlyHistoryContainer');
    container.innerHTML = '';
    
    const fiscalStructure = getFiscalYearStructure();

    fiscalStructure.months.forEach(monthInfo => {
        const monthData = cardData.monthlyData?.[monthInfo.key] || { 
            salesIncreaseForecast: 0, probability: 0, memo: "" 
        };

        const monthRow = document.createElement('div');
        monthRow.className = 'compact-month-row past-month';
        
        monthRow.innerHTML = `
            <div class="compact-month-header">
                ${monthInfo.label}
                <span class="readonly-badge">表示のみ</span>
            </div>
            <div class="compact-data-grid">
                <div class="compact-field">
                    <div class="compact-field-label">売上増見込</div>
                    <div class="compact-field-value">${formatManYen(monthData.salesIncreaseForecast)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">確率</div>
                    <div class="compact-field-value">${getProbabilityLabel(monthData.probability)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">メモ</div>
                    <div class="compact-memo">${escapeHtml(monthData.memo || '未入力')}</div>
                </div>
            </div>
        `;
        
        container.appendChild(monthRow);
    });
    
    openModal('monthlyHistoryModal');
}

async function deleteFromHistoryModal() {
    if (!currentHistoryCardId) {
        showToast('削除対象が特定できません', 'error');
        return;
    }
    
    const targetId = currentHistoryCardId;
    
    // 既存のdeleteCard関数を使用（確認ダイアログ含む）
    await deleteCard(targetId);
    
    // 削除が実際に実行されたかをcardsDataで判定
    const stillExists = cardsData.some(card => card.id === targetId);
    if (!stillExists) {
        // 削除成功時のみモーダルを閉じる
        closeMonthlyHistoryModal();
    }
    // ユーザーがキャンセルした場合はモーダルを開いたまま
}
        
function closeMonthlyHistoryModal() {
    
    // 削除ボタンを非表示に戻す
    const deleteBtn = document.getElementById('historyDeleteBtn');
    if (deleteBtn) {
        deleteBtn.style.display = 'none';
    }
    
    closeModal('monthlyHistoryModal');
}

function editCard(button) {
    const card = button.closest('.card');
    const cardId = parseInt(card.dataset.cardId);
    const cardData = cardsData.find(card => card.id === cardId);
    
    if (!cardData) return;

    document.getElementById('editCardId').value = cardData.id;
    document.getElementById('editModalTitle').textContent = `${cardData.jukuName} - 編集`;
    document.getElementById('editJukuName').value = cardData.jukuName;
    document.getElementById('editJukuUrl').value = cardData.jukuUrl || '';
    document.getElementById('editJukuStatus').value = cardData.status;
    document.getElementById('editAddressInput').value = cardData.address;
    document.getElementById('editAreaInput').value = cardData.area || '';
    document.getElementById('editJukuRegion').value = cardData.region || 'kansai'; 
    document.getElementById('editProfitActual').value = cardData.annualProfitActual;
    document.getElementById('editSalesActual').value = calculateSalesFromProfit(cardData.annualProfitActual || 0);
    
const materials = cardData.annualMaterials || {
    yearRound: { hasOrder: false, orderPeriod: "" },
    seasonalExam: { hasUsage: null, usagePeriod: "" }
};

// 安全にアクセスするためにオプショナルチェーン(?.)を使用
document.getElementById('editYearRoundOrder').value = String(materials.yearRound?.hasOrder ?? false);
document.getElementById('editYearRoundPeriod').value = materials.yearRound?.orderPeriod || '';

const hasUsageVal = materials.seasonalExam?.hasUsage;
const seasonalValue = (hasUsageVal === null || typeof hasUsageVal === 'undefined')
    ? 'unknown'
    : String(hasUsageVal);
    
document.getElementById('editSeasonalUsage').value = seasonalValue;
document.getElementById('editSeasonalPeriod').value = materials.seasonalExam?.usagePeriod || '';
    
    openEditCardModal();
}

function openEditCardModal() {
    updateActualSales('edit');
    document.getElementById('editSalesActual').readOnly = true;
    document.getElementById('editSalesActual').style.background = '#f8f9fa';
    
    // 🆕 四国専用ユーザーは地域選択を無効化
    setTimeout(() => {
        const editRegionSelect = document.getElementById('editJukuRegion');
        if (['yosioka@chuoh-kyouiku.co.jp', 'komori@chuoh-kyouiku.co.jp'].includes(currentUser?.email)) {
            editRegionSelect.disabled = true;
        } else {
            editRegionSelect.disabled = false;
        }
    }, 0);
    
    openModal('editCardModal');

setTimeout(() => {
    // 確実にスクロール位置をリセット
    const modalContent = document.querySelector('#editCardModal .modal-content');
    if (modalContent) modalContent.scrollTop = 0;
    setupNumberFormatting();
}, 100);

}

function closeEditCardModal() {
    closeModal('editCardModal');
}

async function deleteCard(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    if (!hasPermission('delete_data', cardData)) {
        showToast('削除権限がありません', 'error');
        return;
    }
    
    const cardName = cardData ? cardData.jukuName : 'この塾';
    
    if (confirm(`『${cardName}』を削除します。この操作は元に戻せません。よろしいですか？`)) {
        cardsData = cardsData.filter(card => card.id !== cardId);
        
        if (currentUser && window.firebaseImports && window.db) {
            try {
                const docId = cardData.docId || `${cardData.assignedUserId || currentUser.uid}_${cardData.id}`;
                const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', docId);
                await window.firebaseImports.deleteDoc(cardRef);
                console.log('Firestoreから削除完了:', docId);
            } catch (error) {

                console.error('Firestore delete error:', error);
                showToast('クラウド削除でエラーが発生しました', 'error');
            }
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('データを削除しました', 'success');
    }
}

function openMemoDetailModal(cardId, monthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    const monthData = cardData.monthlyData?.[monthKey] || { memo: "" };
    const fiscalStructure = getFiscalYearStructure();
    const monthLabel = fiscalStructure.months.find(m => m.key === monthKey)?.label;

    document.getElementById('memoModalTitle').textContent = `メモ詳細 - ${monthLabel}`;
    document.getElementById('memoCardName').textContent = `塾名: ${cardData.jukuName}`;
    document.getElementById('memoContentInput').value = monthData.memo || '';
    
    // 🆕 権限チェック追加
    const canEdit = hasPermission('edit_data', cardData) &&
                    monthKey === getFiscalYearStructure().currentMonthKey;
    
    const textarea = document.getElementById('memoContentInput');
    const saveBtn = document.querySelector('#memoDetailModal .btn-primary');
    
    textarea.readOnly = !canEdit;
    saveBtn.style.display = canEdit ? 'inline-block' : 'none';
    
    if (!canEdit) {
        textarea.style.backgroundColor = '#f8f9fa';
        textarea.style.cursor = 'not-allowed';
        textarea.title = '編集権限がないか、過去月のため編集できません';
    } else {
        textarea.style.backgroundColor = '';
        textarea.style.cursor = '';
        textarea.title = '';
    }
    
    currentEditingMemo = { cardId, monthKey };
    openModal('memoDetailModal');
}


function closeMemoDetailModal() {
    currentEditingMemo = null;
    closeModal('memoDetailModal');
}

function saveMemoContent() {
    if (!currentEditingMemo) return;

    const { cardId, monthKey } = currentEditingMemo;
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    // 🆕 権限チェック追加（この4行を追加）
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    
    if (monthKey !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    // 既存のコードはそのまま
    const newMemoContent = document.getElementById('memoContentInput').value;
    
    if (!cardData.monthlyData) cardData.monthlyData = {};
    if (!cardData.monthlyData[monthKey]) {
        cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 0, memo: "" };
    }

    cardData.monthlyData[monthKey].memo = newMemoContent;
   cardData.lastUpdated = new Date();

    saveCardsData();
    renderCardsOptimized();
    showToast('メモを保存しました', 'success');
    closeMemoDetailModal();
}

function updateActualSales(prefix) {
    const profitActual = parseNumberSafely(document.getElementById(`${prefix}ProfitActual`).value);
    const salesActual = calculateSalesFromProfit(profitActual);
    document.getElementById(`${prefix}SalesActual`).value = salesActual;
}

function setupMonthlyInputHandlers(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const inputs = container.querySelectorAll('.monthly-input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if (this.value === '0') {
                this.value = '';
            }
        });
    });
}

function getCardActiveMonthKey(card) {
    const fiscal = getFiscalYearStructure();
    const globalKey = activeDashboardMonthKey || fiscal.currentMonthKey;
    const validKeys = new Set(fiscal.months.map(m => m.key));
    const viewingOwn = currentUser?.uid && currentViewTarget === currentUser.uid;

    if (viewingOwn) {
        // 自分のデータ：有効なキーなら使用、無効なら現在月
        const candidate = card.displayMonth || globalKey;
        return validKeys.has(candidate) ? candidate : globalKey;
    } else {
        // 部下閲覧時：常にグローバル月を使用（保存はしない）
        return validKeys.has(globalKey) ? globalKey : fiscal.currentMonthKey;
    }
}

// Timestamp/Date/ISO文字列すべてに対応する関数
function getDateMillis(dateValue) {
    if (!dateValue) return 0;
    if (typeof dateValue.toDate === 'function') return dateValue.toDate().getTime(); // Firestore Timestamp
    if (dateValue instanceof Date) return dateValue.getTime(); // Date object
    const parsed = new Date(dateValue);
    return isNaN(parsed.getTime()) ? 0 : parsed.getTime(); // ISO string
}

function getSortedCards(cards) {
    const sortType = document.getElementById('sortSelect').value;
    
    // === 上位・下位グループに分離 ===
    const upperGroup = []; // 50%以上
    const lowerGroup = []; // 不明・50%未満
    
    cards.forEach(card => {
        const activeKey = getCardActiveMonthKey(card);
        const probability = card.monthlyData?.[activeKey]?.probability || 0;
        
        if (isUnknownOrLowProbability(probability)) {
            lowerGroup.push(card);
        } else {
            upperGroup.push(card);
        }
    });
    
    // 上位グループは選択された並び順、下位グループは常に売上見込額順
    const sortedUpper = sortCardGroup(upperGroup, sortType);
    const sortedLower = sortCardGroup(lowerGroup, 'sales-desc');
    
    return [...sortedUpper, ...sortedLower];
}

// === 新規追加：グループ別ソート関数 ===
function sortCardGroup(cards, sortType) {
    const sortedCards = [...cards];
    
    switch (sortType) {
        case 'sales-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                const diff = bForecast - aForecast;
                return diff !== 0 ? diff : (getDateMillis(b.lastUpdated) - getDateMillis(a.lastUpdated));
            });
        case 'sales-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                const diff = aForecast - bForecast;
                return diff !== 0 ? diff : (getDateMillis(a.lastUpdated) - getDateMillis(b.lastUpdated));
            });
        case 'updated-desc':
            return sortedCards.sort((a, b) => {
                const diff = getDateMillis(b.lastUpdated) - getDateMillis(a.lastUpdated);
                return diff !== 0 ? diff : (b.id || 0) - (a.id || 0);
            });
        case 'updated-asc':
            return sortedCards.sort((a, b) => {
                const diff = getDateMillis(a.lastUpdated) - getDateMillis(b.lastUpdated);
                return diff !== 0 ? diff : (a.id || 0) - (b.id || 0);
            });
        case 'probability-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 0;
                const bProb = b.monthlyData?.[bKey]?.probability || 0;
                return bProb - aProb;
            });
        case 'probability-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 0;
                const bProb = b.monthlyData?.[bKey]?.probability || 0;
                return aProb - bProb;
            });
        default:
            return sortedCards;
    }
}

function updateSortInfo() {
    const sortType = document.getElementById('sortSelect').value;
    const sortInfo = document.getElementById('sortInfo');
    
    const sortLabels = {
        'sales-desc': '売上増見込順（大→小）',
        'sales-asc': '売上増見込順（小→大）',
        'updated-desc': '最終更新日順（新→古）',
        'updated-asc': '最終更新日順（古→新）',
        'probability-desc': '受注確率順（高→低）',
        'probability-asc': '受注確率順（低→高）'
    };
    
    sortInfo.textContent = sortLabels[sortType] || '売上増見込順（大→小）';
}

function renderCardsOptimized() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => {
        const startTime = performance.now();
        renderCards();
        const endTime = performance.now();
        if (endTime - startTime > 100) {
            console.warn(`Slow render detected: ${endTime - startTime}ms`);
        }
    }, RENDER_DEBOUNCE_MS);
}
function editSalesIncreaseForecast(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません（閲覧専用）', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const inputField = element.querySelector('.edit-input');

    displaySpan.style.display = 'none';
    inputField.style.display = 'block';
    inputField.focus();
    inputField.select();

    const saveChanges = () => {
        const newValue = parseNumberSafely(inputField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 0, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].salesIncreaseForecast !== newValue) {
    cardData.monthlyData[monthKey].salesIncreaseForecast = newValue;
    cardData.lastUpdated = new Date();
    
    if (confirm('将来月のデータも同じ値に更新しますか？\n（キャンセルすると当月のみ更新されます）')) {
        propagateToFutureMonths(cardId, newValue, cardData.monthlyData[monthKey].probability);
    } else {
        saveCardsData();
        showToast('当月の売上増見込を更新しました', 'success');
    }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            inputField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        inputField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

inputField.onblur = saveChanges;
inputField.onkeydown = (event) => {
    if (event.key === 'Enter') {
        event.preventDefault();
        // 直接保存関数を呼ばず、フォーカスを外すことでonblurを発火させる（二重実行防止）
        inputField.blur();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelEdit();
    }
};

}

function editProbability(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません（閲覧専用）', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const selectField = element.querySelector('.edit-select');

    displaySpan.style.display = 'none';
    selectField.style.display = 'block';
    selectField.focus();

    const saveChanges = () => {
        const newValue = parseInt(selectField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 0, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].probability !== newValue) {
    cardData.monthlyData[monthKey].probability = newValue;
    cardData.lastUpdated = new Date();
    
    if (confirm('将来月のデータも同じ確率に更新しますか？\n（キャンセルすると当月のみ更新されます）')) {
        propagateToFutureMonths(cardId, cardData.monthlyData[monthKey].salesIncreaseForecast, newValue);
    } else {
        saveCardsData();
        showToast('当月の確率を更新しました', 'success');
    }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            selectField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        selectField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

    selectField.onchange = saveChanges;
    selectField.onblur = saveChanges;
    selectField.onkeydown = (event) => {
        if (event.key === 'Escape') {
            event.preventDefault();
            cancelEdit();
        }
    };
}
function renderCards() {
    const tb = document.getElementById('jukuTableBody');
    const mc = document.getElementById('cardsContainer');
    tb.innerHTML = '';
    mc.innerHTML = '';

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const probabilityFilter = activeProbabilityFilter || 'all';
    const areaFilter = document.getElementById('areaFilter').value;
let filteredCards = cardsData.filter(cardData => {
    const title = cardData.jukuName.toLowerCase();
    const status = cardData.status;
    const cardAddress = cardData.address || '';
    const cardMunicipality = extractMunicipality(cardAddress);
    const cardRegion = cardData.region || 'kansai';
    
    // カードの現在表示月の確率を取得
    const activeKey = getCardActiveMonthKey(cardData);
    const cardProbability = cardData.monthlyData?.[activeKey]?.probability || 0;
    
    let show = true;
    if (searchTerm && !title.includes(searchTerm)) show = false;
    if (statusFilter !== 'all' && status !== statusFilter) show = false;
    if (areaFilter !== 'all' && cardMunicipality !== areaFilter) show = false;
    if (probabilityFilter !== 'all' && !matchesProbabilityFilter(cardProbability, probabilityFilter)) show = false;
    
    // 🆕 プロファイル地域による自動フィルタリング
    if (currentProfileRegion && currentProfileRegion !== 'all') {
        if (cardRegion !== currentProfileRegion) show = false;
    }
    
    return show;
});

    // 並び替え処理
    filteredCards = getSortedCards(filteredCards);

    // DocumentFragmentを使用してDOM操作を最適化
const tableFragment = document.createDocumentFragment();
const cardsFragment = document.createDocumentFragment();

filteredCards.forEach((cardData) => {
    const tableRow = createTableRow(cardData);
    tableFragment.appendChild(tableRow);
    
    const cardElement = createNewCardElement(cardData);
    cardsFragment.appendChild(cardElement);
});

// 一度にDOM挿入
tb.innerHTML = '';
tb.appendChild(tableFragment);
mc.innerHTML = '';
mc.appendChild(cardsFragment);
    
    // 並び替え情報の更新
    updateSortInfo();
    
    // 進捗キャッシュの更新判定
    if (Date.now() - (progressCache?.timestamp || 0) > 2000) {
        progressCache = null;
        updateDashboard();
    }
}

function setupSearchWithIMESupport() {
    const searchInput = document.getElementById('searchInput');
    
    searchInput.addEventListener('compositionstart', () => {
        isComposing = true;
    });
    
    searchInput.addEventListener('compositionend', () => {
        isComposing = false;
        applySearchFilter();
    });
    
    searchInput.addEventListener('input', () => {
        if (!isComposing) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applySearchFilter, 300);
        }
    });
    
    function applySearchFilter() {
        applyFilters();
    }
}

// URLバリデーション関数
function isValidHttpUrl(url) {
    try {
        const u = new URL(url);
        return u.protocol === 'http:' || u.protocol === 'https:';
    } catch {
        return false;
    }
}

// 塾名クリック時の処理
function onJukuNameClick(cardId) {
    const cardData = cardsData.find(x => x.id === cardId);
    const url = (cardData && cardData.jukuUrl || '').trim();
    if (url && isValidHttpUrl(url)) {
        window.open(url, '_blank', 'noopener');
    } else {
        showToast('ZOHOを登録して下さい', 'info');
    }
}

// テーブルから編集モーダルを開く
function openEditFromTable(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    
    document.getElementById('editCardId').value = cardData.id;
    document.getElementById('editModalTitle').textContent = `${cardData.jukuName} - 編集`;
    document.getElementById('editJukuName').value = cardData.jukuName;
    document.getElementById('editJukuStatus').value = cardData.status;
    document.getElementById('editAddressInput').value = cardData.address || '';
    document.getElementById('editAreaInput').value = cardData.area || '';
    document.getElementById('editJukuRegion').value = cardData.region || 'kansai';
    document.getElementById('editProfitActual').value = cardData.annualProfitActual || 0;
    document.getElementById('editSalesActual').value = calculateSalesFromProfit(cardData.annualProfitActual || 0);
    
    // URL値の設定
    const editUrlEl = document.getElementById('editJukuUrl');
    if (editUrlEl) editUrlEl.value = cardData.jukuUrl || '';

    const materials = cardData.annualMaterials || {
        yearRound: { hasOrder: false, orderPeriod: "" },
        seasonalExam: { hasUsage: null, usagePeriod: "" }
    };
    document.getElementById('editYearRoundOrder').value = String(materials.yearRound.hasOrder);
    document.getElementById('editYearRoundPeriod').value = materials.yearRound.orderPeriod || '';
    const seasonalValue = (materials.seasonalExam.hasUsage === null || typeof materials.seasonalExam.hasUsage === 'undefined')
        ? 'unknown'
        : String(materials.seasonalExam.hasUsage);
    document.getElementById('editSeasonalUsage').value = seasonalValue;
    document.getElementById('editSeasonalPeriod').value = materials.seasonalExam.usagePeriod || '';
    
    openEditCardModal();
}
        
document.addEventListener('DOMContentLoaded', function() {
    loadPersonalSettings();
    loadCardsData();
    initializeDisplayMonth();
    migrateToV9Structure();
    
    updateAreaFilterOptions();
    
    // グローバル月セレクターの初期化を遅延実行
    setTimeout(() => {
        updateGlobalMonthSelector();
        // 現在月が確実に選択されるよう強制設定
        const fiscalStructure = getFiscalYearStructure();
        activeDashboardMonthKey = fiscalStructure.currentMonthKey;
        const globalSelector = document.getElementById('globalMonthSelector');
        if (globalSelector) {
            globalSelector.value = activeDashboardMonthKey;
        }
    }, 50);
    
    document.getElementById('sortSelect').value = 'sales-desc';
    
    setupSearchWithIMESupport();
    setupFirebaseAuth();
    setupNumberFormatting(); 

    document.addEventListener('click', function(e) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal[style*="flex"]');
            if (openModal) {
                closeModal(openModal.id);
            }
        }
    });

    document.getElementById('personalSettingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        personalSettings.userName = document.getElementById('userName').value;
        personalSettings.profitRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('profitRate').value) || 0));
        personalSettings.yearlyProfitTarget = parseNumberSafely(document.getElementById('yearlyProfitTarget').value);
        personalSettings.yearlyProfitIncreaseTarget = parseNumberSafely(document.getElementById('yearlyProfitIncreaseTarget').value);
personalSettings.personalSalesIncreaseTarget = parseNumberSafely(document.getElementById('personalSalesIncreaseTarget').value);
        
        updatePersonalSalesTarget();
        // 累積粗利実績の互換性確保
if (typeof personalSettings.cumulativeProfitActual === 'undefined') {
    personalSettings.cumulativeProfitActual = 0;
}
        
        const fiscalMonths = getFiscalYearStructure().months;
        fiscalMonths.forEach(monthInfo => {
            const actualInput = document.getElementById(`monthlyProfitActual${monthInfo.month}`);
            const targetInput = document.getElementById(`monthlyProfitTarget${monthInfo.month}`);
            if (actualInput) {
                personalSettings.monthlyProfitActuals[monthInfo.month] = parseNumberSafely(actualInput.value);
            }
            if (targetInput) {
                personalSettings.monthlyProfitTargets[monthInfo.month] = parseNumberSafely(targetInput.value);
            }
        });
        
        await savePersonalSettingsComplete();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast('個人設定を保存しました！', 'success');
        closePersonalSettingsModal();
    });

    document.getElementById('newCardForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
// 二重送信防止チェック
if (this.dataset.submitting === 'true') {
    showToast('処理中です。少々お待ちください', 'info');
    return;
}

// ★1. 先に基本バリデーションを実行（ロック前）★
const jukuName = document.getElementById('newJukuName').value.trim();
const jukuUrlRaw = (document.getElementById('newJukuUrl')?.value || '').trim();

if (!jukuName) {
    showToast('塾名を入力してください', 'error');
    return; // ロック前なので安全
}

if (jukuUrlRaw && !isValidHttpUrl(jukuUrlRaw)) {
    showToast('有効なURLを入力してください（http(s)から始まる必要があります）', 'error');
    return; // ロック前なので安全
}

// ★2. バリデーション通過後にロック開始★
this.dataset.submitting = 'true';
const submitBtn = this.querySelector('button[type="submit"]');
const cancelBtn = this.querySelector('.btn-secondary');

if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = '登録中...';
}
if (cancelBtn) {
    cancelBtn.disabled = true;
}

try {
    // ★3. バリデーション済みの値を使用★
    const jukuUrl = jukuUrlRaw || '';
    const status = document.getElementById('newJukuStatus').value;
    const address = document.getElementById('newAddressInput').value.trim();
    const area = document.getElementById('newAreaInput').value.trim();
    const salesIncreaseForecast = parseNumberSafely(document.getElementById('newSalesIncreaseForecast').value);
const rawProb = document.getElementById('newProbability').value;
const parsedProb = parseInt(rawProb, 10);
const probability = Number.isFinite(parsedProb) ? parsedProb : 50;

    const annualProfitActual = parseNumberSafely(document.getElementById('newProfitActual').value);
    
    const fiscalStructure = getFiscalYearStructure();
    const currentMonthKey = fiscalStructure.currentMonthKey;
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);

    const monthlyData = {};
    fiscalStructure.months.forEach((monthInfo, index) => {
        if (index < currentIndex) {
            monthlyData[monthInfo.key] = {
                salesIncreaseForecast: 0,
                probability: 50,
                memo: ""
            };
        } else {
            monthlyData[monthInfo.key] = {
                salesIncreaseForecast: salesIncreaseForecast,
                probability: probability,
                memo: ""
            };
        }
    });

    const annualMaterials = {
        yearRound: {
            hasOrder: document.getElementById('newYearRoundOrder').value === 'true',
            orderPeriod: document.getElementById('newYearRoundPeriod').value.trim()
        },
        seasonalExam: {
            hasUsage: (value => {
                if (value === 'unknown') return null;
                return value === 'true';
            })(document.getElementById('newSeasonalUsage').value),
            usagePeriod: document.getElementById('newSeasonalPeriod').value.trim()
        }
    };

    // docId生成（ユーザーUID_カードIDで一意性確保）
    const newDocId = `${currentUser.uid}_${nextCardId}`;

    const cardData = {
        id: nextCardId++,
        docId: newDocId,
        jukuName: jukuName,
        jukuUrl: jukuUrl,
        status: status,
        address: address,
        area: area,
        region: document.getElementById('newJukuRegion').value,
        assignedUserId: currentUser.uid,
        assignedUserName: currentUserData.name,
        displayMonth: currentMonthKey,
        monthlyData: monthlyData,
        annualProfitActual: annualProfitActual,
        annualMaterials: annualMaterials,
        registeredMonth: currentMonthKey,
        lastUpdated: new Date()
    };

    const errors = validateCardData(cardData);
    if (errors.length > 0) {
        showToast(errors[0], 'error');
        return;
    }
    
    cardsData.push(cardData);
    await saveCardsData();
    progressCache = null;
    renderCardsOptimized();
    updateDashboard();
    
    this.reset();
    closeNewCardModal();
    showToast(`新規塾「${cardData.jukuName}」を登録しました！`, 'success');
    
} catch (error) {
    console.error('塾登録エラー:', error);
    showToast('登録に失敗しました。通信状態をご確認ください。', 'error');
} finally {
    // ★4. 必ずロック解除★
    this.dataset.submitting = 'false';
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = '登録';
    }
    if (cancelBtn) {
        cancelBtn.disabled = false;
    }
}
}); 
    
       document.getElementById('editCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const cardId = parseInt(document.getElementById('editCardId').value);
        const cardData = cardsData.find(card => card.id === cardId);
        
        if (!cardData) {
            showToast('編集対象のデータが見つかりません', 'error');
            return;
        }

        const annualProfitActual = parseNumberSafely(document.getElementById('editProfitActual').value);
const editUrlRaw = (document.getElementById('editJukuUrl')?.value || '').trim();
let editUrl = '';
if (editUrlRaw) {
    if (!isValidHttpUrl(editUrlRaw)) {
        showToast('有効なURLを入力してください（http(s)から始まる必要があります）', 'error');
        return;
    }
    editUrl = editUrlRaw;
}

cardData.jukuName = document.getElementById('editJukuName').value.trim();
cardData.jukuUrl = editUrl;

        cardData.status = document.getElementById('editJukuStatus').value;
        cardData.address = document.getElementById('editAddressInput').value.trim();
        cardData.area = document.getElementById('editAreaInput').value.trim();
cardData.region = document.getElementById('editJukuRegion').value;
cardData.annualProfitActual = annualProfitActual;

        
        cardData.annualMaterials = {
            yearRound: {
                hasOrder: document.getElementById('editYearRoundOrder').value === 'true',
                orderPeriod: document.getElementById('editYearRoundPeriod').value.trim()
            },
            seasonalExam: {
    hasUsage: (value => {
        if (value === 'unknown') return null;
        return value === 'true';
    })(document.getElementById('editSeasonalUsage').value),
    usagePeriod: document.getElementById('editSeasonalPeriod').value.trim()
}

        };
        
       cardData.lastUpdated = new Date();

        const errors = validateCardData(cardData);
        if (errors.length > 0) {
            showToast(errors[0], 'error');
            return;
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast(`${cardData.jukuName}のデータを更新しました！`, 'success');
        closeEditCardModal();
    });

function handleResponsiveMasterOption() {
    if (currentUserRole === 'admin') {
        updateViewSelector();
        // マスタービュー表示中なら画面幅に関係なく再描画
        if (currentViewTarget === 'master-kansai' || currentViewTarget === 'master-shikoku') {
            displayMasterView();
        }
    }
}

    // リサイズイベント登録
    window.addEventListener('resize', handleResponsiveMasterOption);
    
    // 初期適用（画面幅チェック）
    handleResponsiveMasterOption();

    // === 根拠モーダルの文字数カウント機能初期化 ===
    setTimeout(() => {
        const textarea = document.getElementById('evidenceContentInput');
        if (textarea) {
            textarea.addEventListener('input', updateCharacterCount);
        }
    }, 100);

    // 最後に1回だけ実行
    renderCardsOptimized();
    updateDashboard();
});


        // 🆕 ネットワーク状態の監視機能
window.addEventListener('offline', () => {
    showToast('オフラインになりました（ローカル保存に切替）', 'info');
    console.log('Network status: OFFLINE - Switching to local storage mode');
});

window.addEventListener('online', () => {
    showToast('オンラインに復帰しました', 'success');
    console.log('Network status: ONLINE - Firebase sync available');
});

// 🆕 初期読み込み時のネットワーク状態確認
document.addEventListener('DOMContentLoaded', () => {
    if (!navigator.onLine) {
        console.log('Initial network status: OFFLINE');
        setTimeout(() => {
            showToast('オフラインモードで起動しました', 'info');
        }, 1000); // 他の初期化処理後に表示
    }
});

// === 根拠モーダル機能追加開始 ===
let currentEditingEvidence = null;

function openEvidenceModal(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    currentEditingEvidence = cardId;
    
    document.getElementById('evidenceModalTitle').textContent = `${cardData.jukuName} - 年間営業根拠`;
    document.getElementById('evidenceCardName').textContent = `塾名: ${cardData.jukuName}`;
    
    const textarea = document.getElementById('evidenceContentInput');
    const saveBtn = document.querySelector('#evidenceModal .btn-primary');
    
    textarea.value = cardData.annualEvidence || '';
    
    // 編集権限チェック
    const canEdit = hasPermission('edit_data', cardData);
    textarea.readOnly = !canEdit;
    saveBtn.style.display = canEdit ? 'inline-block' : 'none';
    
    if (!canEdit) {
        textarea.style.backgroundColor = '#f8f9fa';
        textarea.title = '編集権限がないため閲覧専用です';
    } else {
        textarea.style.backgroundColor = '';
        textarea.title = '';
    }
    
    updateCharacterCount();
    openModal('evidenceModal');
}

function closeEvidenceModal() {
    currentEditingEvidence = null;
    closeModal('evidenceModal');
}

async function saveEvidenceContent() {
    if (!currentEditingEvidence) return;

    const cardData = cardsData.find(card => card.id === currentEditingEvidence);
    if (!cardData || !hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    
    const content = document.getElementById('evidenceContentInput').value;
    if (content.length > 1000) {
        showToast('1000文字以内で入力してください', 'error');
        return;
    }

    cardData.annualEvidence = content;
    cardData.lastUpdated = new Date();
    
    await saveCardsData();
    showToast('営業根拠を保存しました', 'success');
    closeEvidenceModal();
}

function updateCharacterCount() {
    const textarea = document.getElementById('evidenceContentInput');
    const countElement = document.getElementById('evidenceCharCount');
    
    if (textarea && countElement) {
        countElement.textContent = textarea.value.length;
    }
}
// === 根拠モーダル機能追加終了 ===

    </script>
    <button class="fab-settings" onclick="openPersonalSettingsModal()" title="個人設定" aria-label="個人設定">⚙️</button>

<button class="fab-add" onclick="openNewCardModal()" title="塾登録" aria-label="塾登録">➕</button>
</body>
</html>
