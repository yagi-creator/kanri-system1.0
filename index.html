<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å–¶æ¥­æ”¯æ´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">
    <meta name="theme-color" content="#007bff">
    <title>å–¶æ¥­æ”¯æ´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v9.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN', Meiryo, sans-serif;
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
            font-size: 16px;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        body.modal-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .user-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .login-user-info {
            font-size: 18px;
            font-weight: bold;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            white-space: nowrap;
        }

        .view-selector-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .view-selector-label {
            color: white;
            font-weight: 500;
        }

        .view-selector {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
            min-width: 180px;
        }

        .view-permission-info {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .permission-edit {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }

        .permission-view {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-auth {
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-auth:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
        }

        .current-date-header {
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-month-selector {
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .global-month-selector option {
            color: #333;
            background: #fff;
        }

        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .progress-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .progress-card {
            background: #e3f2fd !important;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: none !important;
            position: relative;
        }

        .progress-card:hover,
        .progress-card:active,
        .progress-card:focus {
            background: #e3f2fd !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .progress-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            line-height: 1.2;
            min-height: 2.4em;
            font-weight: 600;
            color: #333;
        }

        .progress-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #007bff;
        }

        .progress-detail {
            font-size: 16px;
            margin-bottom: 4px;
            color: #333;
            font-weight: 600;
        }

        .progress-rate {
            font-size: 14px;
            font-weight: bold;
        }

        .rate-positive { color: #2E7D32; }
        .rate-negative { color: #D32F2F; }

        .progress-chart {
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            margin-top: 8px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .funnel-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .funnel-item {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .funnel-item:hover,
        .funnel-item:active {
            background: white !important;
            transform: none !important;
        }

        .funnel-label {
            font-size: 12px;
            margin-bottom: 3px;
            color: #333;
        }

        .funnel-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .control-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 40px 14px 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: #fff;
            color: #333;
        }

        .search-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-size: 18px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .btn:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-settings {
            background: linear-gradient(135deg, #FFD700 0%, #FFEA00 100%);
            color: #333;
        }

        .filter-section {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .filter-select, .sort-select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            min-height: 48px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .sort-section {
            margin-bottom: 16px;
        }

        .sort-select {
            width: 100%;
        }

        .cards-section {
            padding: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 12px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .sort-info {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
        }

        /* PCãƒ†ãƒ¼ãƒ–ãƒ«ç”¨CSS */
        .desktop-table-container {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .juku-table {
    width: 100%;
    table-layout: fixed;
    font-size: 14px;
    border-collapse: collapse;
}

/* åˆ—å¹…ã®æœ€é©åŒ– */
.col-level { width: 8px; padding: 0 !important; }
.col-name { width: 180px; }
.col-prev-amount, .col-current-amount { width: 100px; text-align: center; }
.col-prev-prob, .col-current-prob { width: 80px; text-align: center; }
.col-change { width: 90px; text-align: center; }
.col-detail { width: 70px; text-align: center; }


        .juku-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        .juku-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .juku-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .juku-table tbody tr:nth-child(odd) {
            background: #fff;
        }

        .juku-table tbody tr:hover {
            background: #e3f2fd !important;
        }

        .col-level {
            width: 8px;
            padding: 0 !important;
        }

        .level-indicator {
            width: 8px;
            height: 40px;
            display: block;
        }

        .level-0 { background: #fff; }
        .level-1 { background: #BBDEFB; }
        .level-2 { background: #C8E6C9; }
        .level-3 { background: #FFF9C4; }
        .level-4 { background: #FFCDD2; }

        .editable-cell {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-cell:hover {
            background: rgba(0,123,255,0.1);
        }

        .change-positive { color: #2E7D32; font-weight: bold; }
        .change-negative { color: #D32F2F; font-weight: bold; }
        .change-neutral { color: #666; }

        .detail-btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .detail-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 1024px) {
            .desktop-table-container {
                display: none;
            }
        }

        @media (min-width: 1025px) {
            .mobile-cards-container {
                display: none;
            }
        }

        .card {
            background: #fff !important;
            color: #333 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: none !important;
            position: relative;
        }

        .card:hover,
        .card:active,
        .card:focus {
            background: #fff !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .card-level-0 { background: #fff !important; border-left: 6px solid #fff; }
        .card-level-1 { background: #fff !important; border-left: 6px solid #BBDEFB; }
        .card-level-2 { background: #fff !important; border-left: 6px solid #C8E6C9; }
        .card-level-3 { background: #fff !important; border-left: 6px solid #FFF9C4; }
        .card-level-4 { background: #fff !important; border-left: 6px solid #FFCDD2; }

        .card-header-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .card-title-clickable {
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            color: #333 !important;
            text-decoration: underline;
            text-decoration-color: rgba(0,0,0,0.3);
            transition: text-decoration-color 0.2s ease;
        }

        .card-title-clickable:hover {
            text-decoration-color: #007bff;
        }

        .month-selector {
            display: block;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.8);
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }

        .annual-metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }

        .annual-metric {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .annual-metric-label {
            font-size: 12px;
            margin-bottom: 2px;
            color: #333;
            font-weight: 500;
            line-height: 1.2;
        }

        .annual-metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .monthly-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 6px;
        }

        .month-data-column {
            text-align: center;
        }

        .month-data-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .month-data-content {
            background: rgba(255,255,255,0.4);
            padding: 10px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .forecast-amount {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .forecast-probability {
            font-size: 14px;
            color: #333;
            opacity: 0.9;
            font-weight: 600;
        }

        .memo-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .memo-column {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .memo-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .memo-content {
            font-size: 13px;
            line-height: 1.3;
            color: #333;
            min-height: 2.6em;
            word-wrap: break-word;
            white-space: pre-wrap;
            cursor: pointer;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.2);
        }

        .last-updated {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
            cursor: pointer;
        }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            color: rgba(0,0,0,0.9);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .action-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .action-btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
        }

        .annual-materials-mini {
            background: rgba(255,255,255,0.4);
            border: 1px solid rgba(0,176,255,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .annual-materials-mini-title {
            font-size: 14px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 8px;
            text-align: center;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(25,118,210,0.2);
        }

        .materials-mini-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .materials-mini-item {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            padding: 8px;
        }

        .materials-mini-header {
            font-size: 12px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 6px;
            text-align: center;
        }

        .material-mini-field {
            margin-bottom: 6px;
        }

        .material-mini-label {
            font-size: 11px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .material-mini-select,
        .material-mini-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
            font-size: 12px;
            background: white;
            color: #333;
            box-sizing: border-box;
        }

        .material-mini-input::placeholder {
            color: rgba(0,0,0,0.5);
            font-size: 11px;
        }

        .comparison-positive { color: #2E7D32; }
        .comparison-negative { color: #D32F2F; }
        .comparison-neutral { color: #666; }

        .change-indicator {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
            border-left: 4px solid #c62828;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        .modal-graph {
            max-width: 800px;
            max-height: 90vh;
        }

        .modal-history {
            max-width: 900px;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: white;
            color: #333;
        }

        .form-input:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .form-input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .graph-container {
            margin: 20px 0;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            height: 300px;
        }

        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            color: #E0E0E0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #E0E0E0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            color: #333;
        }
        
        .settings-section h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .monthly-data-section {
            background: rgba(255,255,255,0.6);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .monthly-row {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 20px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .month-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            text-align: center;
        }

        .monthly-input {
            padding: 8px 10px;
            border: 1px solid rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 16px;
            text-align: right;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .monthly-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .monthly-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .monthly-history-container {
            max-height: 32vh;
            overflow-y: auto;
            padding: 10px;
        }

        /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
        .compact-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
        }

        .compact-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .compact-month-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compact-data-grid {
            display: grid;
            grid-template-columns: 1fr 80px 2fr;
            gap: 8px;
            align-items: center;
        }

        .compact-field {
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .compact-field-label {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            margin-bottom: 2px;
        }

        .compact-field-value {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .compact-memo {
            font-size: 12px;
            line-height: 1.3;
            color: #333;
            max-height: 40px;
            overflow: hidden;
            word-wrap: break-word;
        }

        .history-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f9f9f9;
        }

        .history-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .history-month-label {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .readonly-badge {
            background: #9E9E9E;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .history-data-grid {
            display: grid;
            grid-template-columns: 1fr 120px 2fr;
            gap: 12px;
            align-items: start;
        }

        .history-field label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
        }

        .history-input, .history-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .history-memo {
            width: 100%;
            min-height: 60px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .history-input:read-only, 
        .history-select:disabled, 
        .history-memo:read-only {
            background: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,123,255,0.4);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .fab:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,123,255,0.6);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .toast-error { background: linear-gradient(135deg, #F44336, #FF5252); }
        .toast-info { background: linear-gradient(135deg, #2196F3, #007bff); }

        .editable-field {
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-field:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .editable-field .display-value {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .editable-field .edit-input,
        .editable-field .edit-select {
            width: calc(100% - 12px);
            padding: 6px 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: white;
            color: #333;
        }

        @media (prefers-contrast: high) {
            .card {
                border: 2px solid #000;
            }
            
            .progress-bar {
                border: 1px solid #000;
            }
        }
        /* ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ”¹å–„ */
/* æ—¢å­˜ã®card-levelèƒŒæ™¯è‰²æŒ‡å®šã‚’ç„¡åŠ¹åŒ– */
.card-level-0, .card-level-1, .card-level-2, .card-level-3, .card-level-4 {
    background: inherit !important;
}

/* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¸æ¨¡æ§˜ã«çµ±ä¸€ */
.mobile-cards-container .card {
    background: #fff !important;
}

.mobile-cards-container .card:nth-child(even) {
    background: #f8f9fa !important;
}

/* ã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ™ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆå·¦ï¼‹ä¸Šãƒ©ã‚¤ãƒ³ï¼‰ã‚’é®®ã‚„ã‹ã« */
.mobile-cards-container .card.card-level-0 { 
    border-left: 4px solid #9E9E9E !important;
    border-top: 4px solid #9E9E9E !important;
}
.mobile-cards-container .card.card-level-1 { 
    border-left: 4px solid #2196F3 !important;
    border-top: 4px solid #2196F3 !important;
}
.mobile-cards-container .card.card-level-2 { 
    border-left: 4px solid #4CAF50 !important;
    border-top: 4px solid #4CAF50 !important;
}
.mobile-cards-container .card.card-level-3 { 
    border-left: 4px solid #FF9800 !important;
    border-top: 4px solid #FF9800 !important;
}
.mobile-cards-container .card.card-level-4 { 
    border-left: 4px solid #F44336 !important;
    border-top: 4px solid #F44336 !important;
}

/* ã‚¹ãƒãƒ›ç‰ˆå¥‡æ•°ã‚«ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: rgba(173, 216, 230, 0.15);
        border-radius: 12px;
        z-index: 1;
    }
    
    .mobile-cards-container .card > * {
        position: relative;
        z-index: 2;
    }
}

/* é–²è¦§å°‚ç”¨ã‚«ãƒ¼ãƒ‰ã¨ã®ç«¶åˆè§£æ±º */
.read-only-card {
    box-shadow: inset 0 0 0 2px #ffc107 !important;
    border: none !important;
}


        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-right {
                align-items: stretch;
            }
            
            .user-info-section {
                align-items: stretch;
            }
            
            .view-selector-section {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .view-selector {
                min-width: auto;
            }

            .current-date-header {
                margin-top: 12px;
            }

            .progress-cards {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .control-buttons {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin-bottom: 8px;
                min-height: 48px;
                font-size: 16px;
            }

            .filter-section {
                flex-direction: column;
            }

            .cards-section {
                display: block;
            }

            .section-header {
                margin-bottom: 12px;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }

            .monthly-comparison-section {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .materials-mini-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .annual-metrics-row {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }

            .form-input, .form-select {
                font-size: 16px;
                padding: 14px 12px;
            }
        }

        @media (min-width: 1200px) {
            .cards-section .card {
                display: inline-block;
                width: calc(50% - 8px);
                margin-right: 16px;
                vertical-align: top;
            }

            .cards-section .card:nth-child(even) {
                margin-right: 0;
            }
        }
        /* 1. ã‚¹ãƒãƒ›è¡¨ç¤ºã®ã¿ï¼šç·¨é›†å¯èƒ½ç®‡æ‰€ã‚’è–„ã„ç·‘è‰²ã§å¼·èª¿ */
@media (max-width: 1024px) {
    .monthly-comparison-section .month-data-column:nth-child(2) .editable-field {
        background: rgba(76, 175, 80, 0.12) !important;
        border: 1px solid rgba(76, 175, 80, 0.25);
        border-radius: 6px;
        padding: 6px 8px;
    }
    
    .memo-comparison-section .memo-column:nth-child(2) .memo-content {
        background: rgba(76, 175, 80, 0.08) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
        border-radius: 6px;
        padding: 8px;
    }
}

/* 2. ç¸æ¨¡æ§˜ã‚’æ¿ƒã„ã‚ã«èª¿æ•´ */
.juku-table tbody tr:nth-child(even) {
    background: #f0f0f0 !important; /* #f8f9fa â†’ #f0f0f0 */
}

.mobile-cards-container .card:nth-child(even) {
    background: #f0f0f0 !important;
}

@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        background: rgba(173, 216, 230, 0.22); /* 0.15 â†’ 0.22 */
    }
}

/* 3. ãƒ•ã‚¡ãƒãƒ«80/90/100ã®é’è‰²å¼·èª¿ */
.funnel-section .funnel-item:nth-child(4), /* 80 */
.funnel-section .funnel-item:nth-child(5), /* 90 */
.funnel-section .funnel-item:nth-child(6)  /* 100 */ {
    background: rgba(33, 150, 243, 0.1) !important;
    border: 1px solid rgba(33, 150, 243, 0.25);
}

.funnel-section .funnel-item:nth-child(4):hover,
.funnel-section .funnel-item:nth-child(5):hover,
.funnel-section .funnel-item:nth-child(6):hover {
    background: rgba(33, 150, 243, 0.15) !important;
    border-color: rgba(33, 150, 243, 0.35);
}

/* 4. 6é …ç›®ãƒ•ã‚¡ãƒãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .funnel-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 6px;
    }
    
    .funnel-label {
        font-size: 11px;
        margin-bottom: 3px;
        color: #333;
    }
    
    .funnel-value {
        font-size: 13px;
        font-weight: bold;
        color: #333;
    }
}

@media (max-width: 480px) {
    .funnel-section {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(3, 1fr);
    }
}

    </style>
   <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, getDocs, collection, query, where, setDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';


  const firebaseConfig = {
    apiKey: "AIzaSyC_EUgAAVFfk0TonQgKVMxs8TcuvFdXKIQ",
    authDomain: "eigyo-shiendashboard.firebaseapp.com",
    projectId: "eigyo-shiendashboard",
    storageBucket: "eigyo-shiendashboard.firebasestorage.app",
    messagingSenderId: "665404365898",
    appId: "1:665404365898:web:a60374339c99ea5c16dab3"
  };

  const app = initializeApp(firebaseConfig);
  window.firebaseAuth = getAuth(app);
  window.db = getFirestore(app);
window.firebaseImports = {
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    doc,
    getDoc,
    getDocs,      
    collection,   
    query,        
    where,        
    setDoc,
    deleteDoc,
    serverTimestamp
};

</script>
</head>
<body>
    <div class="container">
        <div class="header-section">
    <div class="header-left">
        <div class="header-title">å–¶æ¥­æ”¯æ´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v9.5</div>
        <div class="current-date-header" id="currentDateHeader">
            <span id="currentDateDisplay">2025å¹´8æœˆ</span>
            <select class="global-month-selector" id="globalMonthSelector" onchange="changeAllCardsDisplayMonth(this.value)">
            </select>
        </div>
    </div>
    
    <div class="header-right">
        <div class="user-info-section">
            <div class="login-user-info" id="loginUserInfo">
                <span class="login-status">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
            </div>
            
            <div class="view-selector-section" id="viewSelectorSection" style="display: none;">
                <label class="view-selector-label">ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º:</label>
                <select class="view-selector" id="viewSelector" onchange="changeViewTarget()">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <span class="view-permission-info" id="viewPermissionInfo"></span>
            </div>
        </div>
        
        <div class="auth-buttons" id="authButtons">
            <button class="btn btn-auth" onclick="quickLogin()" id="loginBtn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn btn-auth" onclick="quickLogout()" id="logoutBtn" style="display: none;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>
</div> 
        <div class="progress-section">
            <div class="progress-cards">
                <div class="progress-card" onclick="openProgressGraphModal(0)" aria-label="æœˆåˆ¥ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰ã®é€²æ—ã‚°ãƒ©ãƒ•ã‚’é–‹ã">
                    <h3>æœˆåˆ¥ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰</h3>
                    <div class="progress-value" id="monthlyTargetDisplay">Â¥0ä¸‡</div>
                    <div class="progress-detail" id="monthlyDetail">Â¥0/Â¥0ï¼ˆ0.0%ï¼‰</div>
                    <div class="progress-rate" id="monthlyRate">å·®åˆ†: Â¥0</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="monthlyProgressBar" style="width: 0%; background: #4ade80;"></div>
                    </div>
                </div>
                
                <div class="progress-card" onclick="openProgressGraphModal(1)" aria-label="å¹´é–“ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰ã®é€²æ—ã‚°ãƒ©ãƒ•ã‚’é–‹ã">
                    <h3>å¹´é–“ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰</h3>
                    <div class="progress-value" id="yearlyTargetDisplay">Â¥0ä¸‡</div>
                    <div class="progress-detail" id="yearlyDetail">Â¥0/Â¥0ï¼ˆ0.0%ï¼‰</div>
                    <div class="progress-rate" id="yearlyRate">0.0%é”æˆ</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="yearlyProgressBar" style="width: 0%; background: #4ade80;"></div>
                    </div>
                </div>
                
                <div class="progress-card" onclick="openProgressGraphModal(2)" aria-label="å¹´é–“å£²ä¸Šå¢—ç›®æ¨™ã®é€²æ—ã‚°ãƒ©ãƒ•ã‚’é–‹ã">
                    <h3>å¹´é–“å£²ä¸Šå¢—ç›®æ¨™</h3>
                    <div class="progress-value" id="salesTargetDisplay">Â¥0ä¸‡</div>
                    <div class="progress-detail" id="salesTargetDetail">è‡ªå‹•è¨ˆç®—</div>
                    <div class="progress-rate" id="salesTargetRate">ç²—åˆ©å¢—ç›®æ¨™ã‹ã‚‰é€†ç®—</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="salesTargetBar" style="width: 0%; background: #60a5fa;"></div>
                    </div>
                </div>
                
                <div class="progress-card" onclick="openProgressGraphModal(3)" aria-label="å–¶æ¥­è¦‹è¾¼ï¼ˆç²—åˆ©å¢—ï¼‰ã®é€²æ—ã‚°ãƒ©ãƒ•ã‚’é–‹ã">
                    <h3>å–¶æ¥­è¦‹è¾¼ï¼ˆç²—åˆ©å¢—ï¼‰</h3>
                    <div class="progress-value" id="prospectTotalDisplay">Â¥0ä¸‡</div>
                    <div class="progress-detail" id="prospectDetail">å¯¾ç›®æ¨™0.0%</div>
                    <div class="progress-rate" id="prospectRate">ç¢ºåº¦80%ä»¥ä¸Šã®ã¿é›†è¨ˆ</div>
                    <div class="progress-chart">
                        <div class="progress-bar" id="prospectBar" style="width: 0%; background: #4ade80;"></div>
                    </div>
                </div>
            </div>

           <!-- æ—¢å­˜ã®funnel-sectionå…¨ä½“ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆã¦ãã ã•ã„ -->
<div class="funnel-section">
    <div class="funnel-item" onclick="filterByProbability('under50')" aria-label="ç¢ºç‡50%æœªæº€ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">50%æœªæº€</div>
        <div class="funnel-value" id="probUnder50">Â¥0ä¸‡</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('50-60')" aria-label="ç¢ºç‡50-70%ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">50%-70%æœªæº€</div>
        <div class="funnel-value" id="prob5060">Â¥0ä¸‡</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('70')" aria-label="ç¢ºç‡70%ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">70%ä»¥ä¸Š</div>
        <div class="funnel-value" id="prob70">Â¥0ä¸‡</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('80')" aria-label="ç¢ºç‡80%ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">80%ä»¥ä¸Š</div>
        <div class="funnel-value" id="prob80">Â¥0ä¸‡</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('90')" aria-label="ç¢ºç‡90%ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">90%ä»¥ä¸Š</div>
        <div class="funnel-value" id="prob90">Â¥0ä¸‡</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('100')" aria-label="ç¢ºç‡100%ã§çµã‚Šè¾¼ã¿">
        <div class="funnel-label">100%</div>
        <div class="funnel-value" id="prob100">Â¥0ä¸‡</div>
    </div>
</div>

        </div>

        <div class="control-section">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="ğŸ” å¡¾åã§æ¤œç´¢..." id="searchInput" aria-label="å¡¾åã§æ¤œç´¢">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="openNewCardModal()" aria-label="æ–°è¦å¡¾ç™»éŒ²ã‚’é–‹ã">
                    â• æ–°è¦å¡¾ç™»éŒ²
                </button>
                <button class="btn btn-settings" onclick="openPersonalSettingsModal()" aria-label="å€‹äººè¨­å®šã‚’é–‹ã">
                    âš™ï¸ å€‹äººè¨­å®š
                </button>
            </div>

            <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%; margin-bottom: 16px;" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢">
                ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
            </button>

            <div class="sort-section">
                <select class="sort-select" id="sortSelect" onchange="applySorting()" aria-label="ä¸¦ã³æ›¿ãˆ">
                    <option value="sales-desc">ğŸ’° å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå¤§â†’å°ï¼‰</option>
                    <option value="sales-asc">ğŸ’° å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå°â†’å¤§ï¼‰</option>
                    <option value="updated-desc">ğŸ“… æœ€çµ‚æ›´æ–°æ—¥é †ï¼ˆæ–°â†’å¤ï¼‰</option>
                    <option value="updated-asc">ğŸ“… æœ€çµ‚æ›´æ–°æ—¥é †ï¼ˆå¤â†’æ–°ï¼‰</option>
                    <option value="probability-desc">ğŸ“ˆ å—æ³¨ç¢ºç‡é †ï¼ˆé«˜â†’ä½ï¼‰</option>
                    <option value="probability-asc">ğŸ“ˆ å—æ³¨ç¢ºç‡é †ï¼ˆä½â†’é«˜ï¼‰</option>
                </select>
            </div>

            <div class="filter-section">
                <select class="filter-select" id="statusFilter" onchange="applyFilters()" aria-label="åŒºåˆ†ã§çµã‚Šè¾¼ã¿">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="new">æ–°è¦</option>
                    <option value="existing">æ—¢å­˜</option>
                    <option value="former">å…ƒæ—¢å­˜</option>
                </select>
                <select class="filter-select" id="probabilityFilter" onchange="applyFilters()" aria-label="ç¢ºç‡ã§çµã‚Šè¾¼ã¿">
                </select>
                <select class="filter-select" id="areaFilter" onchange="applyFilters()" aria-label="ã‚¨ãƒªã‚¢ã§çµã‚Šè¾¼ã¿">
                </select>
            </div>
        </div>
    
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">å¡¾ä¸€è¦§</div>
                <div class="sort-info" id="sortInfo">å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå¤§â†’å°ï¼‰</div>
            </div>
            
            <div class="desktop-table-container" id="desktopTableContainer">
                <table class="juku-table">
                    <thead>
    <tr>
        <th class="col-level"></th>
        <th class="col-name">å¡¾å</th>
        <th class="col-prev-amount">å…ˆæœˆè¦‹è¾¼</th>
        <th class="col-prev-prob">å…ˆæœˆç¢ºç‡</th>
        <th class="col-current-amount">ä»Šæœˆè¦‹è¾¼</th>
        <th class="col-current-prob">ä»Šæœˆç¢ºç‡</th>
        <th class="col-change">å¤‰åŒ–</th>
        <th class="col-detail">è©³ç´°</th>
    </tr>
</thead>

                    <tbody id="jukuTableBody"></tbody>
                </table>
            </div>
            
            <div class="mobile-cards-container" id="cardsContainer"></div>
        </div>
    </div>

    <button class="fab" onclick="openNewCardModal()" title="æ–°è¦å¡¾ç™»éŒ²" aria-label="æ–°è¦å¡¾ç™»éŒ²">â•</button>

    <div class="modal" id="personalSettingsModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å€‹äººè¨­å®š</div>
                <button class="close-btn" onclick="closePersonalSettingsModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            
            <form id="personalSettingsForm">
                <div class="settings-section">
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <div class="form-group">
                        <label class="form-label" for="userName">æ‹…å½“è€…å</label>
                        <input type="text" class="form-input" value="æ‹…å½“è€…" id="userName">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="profitRate">å€‹äººç²—åˆ©ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" class="form-input" value="0" step="0.1" id="profitRate" oninput="updatePersonalSalesTarget()">
                    </div>
                </div>

                <div class="settings-section">
                    <h4>å¹´é–“ç›®æ¨™</h4>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitTarget">å¹´é–“ç²—åˆ©ç›®æ¨™</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitTarget">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitIncreaseTarget">ç²—åˆ©å¢—ç›®æ¨™</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitIncreaseTarget" oninput="updatePersonalSalesTarget()">
                        <small>æ˜¨å¹´ã‹ã‚‰ã®ç²—åˆ©å¢—åŠ ç›®æ¨™é¡</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlySalesIncreaseTarget">å¹´é–“å£²ä¸Šå¢—ç›®æ¨™</label>
                        <input type="number" class="form-input" value="0" id="yearlySalesIncreaseTarget" readonly>
                        <small>ç²—åˆ©å¢—ç›®æ¨™ã‚’å€‹äººç²—åˆ©ç‡ã§é€†ç®—ã—ãŸå€¤</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ï¼ˆä¼šè¨ˆå¹´åº¦ï¼š10æœˆã€œ9æœˆï¼‰</h4>
                    <div class="monthly-data-section">
                        <div class="monthly-row" style="font-weight: bold; margin-bottom: 8px;">
                            <div class="month-name">æœˆ</div>
                            <div style="text-align: center; font-size: 13px;">å®Ÿç¸¾</div>
                            <div style="text-align: center; font-size: 13px;">ç›®æ¨™</div>
                            <div></div>
                        </div>
                        <div id="monthlyProfitContainer"></div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closePersonalSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="progressGraphModal" role="dialog" aria-modal="true">
        <div class="modal-content modal-graph">
            <div class="modal-header">
                <div class="modal-title" id="graphModalTitle">å¹´é–“é€²æ—ã‚°ãƒ©ãƒ•</div>
                <button class="close-btn" onclick="closeProgressGraphModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            
            <div class="graph-container">
                <canvas id="progressChart" aria-label="é€²æ—ã‚°ãƒ©ãƒ•" role="img"></canvas>
            </div>
            
            <div class="graph-legend" id="graphLegend"></div>
        </div>
    </div>

    <div class="modal" id="monthlyHistoryModal" role="dialog" aria-modal="true">
        <div class="modal-content modal-history">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">æœˆåˆ¥å±¥æ­´ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰</div>
                <button class="close-btn" onclick="closeMonthlyHistoryModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            
            <div class="monthly-history-container" id="monthlyHistoryContainer"></div>
            
            <div class="control-buttons">
                <button type="button" class="btn btn-primary" onclick="closeMonthlyHistoryModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ–°è¦å¡¾ç™»éŒ²</div>
                <button class="close-btn" onclick="closeNewCardModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            
            <form id="newCardForm">
                <div class="form-group">
                    <label class="form-label" for="newJukuName">å¡¾å *</label>
                    <input type="text" class="form-input" placeholder="ä¾‹ï¼šâ—‹â—‹å­¦ç¿’å¡¾" required maxlength="100" id="newJukuName">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newJukuStatus">åŒºåˆ†</label>
                    <select class="form-select" id="newJukuStatus">
                        <option value="new">æ–°è¦</option>
                        <option value="existing">æ—¢å­˜</option>
                        <option value="former">å…ƒæ—¢å­˜</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newAddressInput">ä½æ‰€ï¼ˆå¸‚åŒºç”ºæ‘ï¼‰</label>
                    <input type="text" class="form-input" id="newAddressInput" placeholder="ä¾‹: è±Šä¸­å¸‚ã€å¤§é˜ªå¸‚ä¸­å¤®åŒº">
                </div>

                <div class="form-group">
                    <label class="form-label" for="newAreaInput">ã‚¨ãƒªã‚¢</label>
                    <input type="text" class="form-input" id="newAreaInput" placeholder="ä¾‹: å¤§é˜ªåŒ—éƒ¨">
                </div>

                <div class="settings-section">
                    <h4>å–¶æ¥­ãƒ‡ãƒ¼ã‚¿</h4>
                    <div class="form-group">
                        <label class="form-label" for="newSalesIncreaseForecast">å£²ä¸Šå¢—è¦‹è¾¼</label>
                        <input type="number" class="form-input" placeholder="3000000" id="newSalesIncreaseForecast">
                        <small>â€»ã“ã®å¡¾ã‹ã‚‰ã®å¹´é–“å£²ä¸Šå¢—è¦‹è¾¼é¡ï¼ˆA+B+Cåˆè¨ˆï¼‰</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProbability">æˆç´„ç¢ºç‡</label>
                        <select class="form-select" id="newProbability">
                            <option value="40">50æœªæº€</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProfitActual">å¹´é–“ç²—åˆ©å®Ÿç¸¾</label>
                        <input type="number" class="form-input" placeholder="0" id="newProfitActual" oninput="updateActualSales('new')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newSalesActual">å¹´é–“å£²ä¸Šå®Ÿç¸¾</label>
                        <input type="number" class="form-input" placeholder="0" id="newSalesActual" readonly>
                    </div>
                    
                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">ğŸ“š å¹´é–“æ•™æç®¡ç†</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">é€šå¹´æ•™æ</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundOrder">æ³¨æ–‡çŠ¶æ³</label>
                                    <select class="material-mini-select" id="newYearRoundOrder">
                                        <option value="false" selected>æ³¨æ–‡ãªã—</option>
                                        <option value="true">æ³¨æ–‡ã‚ã‚Š</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundPeriod">æ³¨æ–‡æ™‚æœŸ</label>
                                    <input type="text" class="material-mini-input" id="newYearRoundPeriod" placeholder="ä¾‹: 4æœˆä¸Šæ—¬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">å­£ç¯€ãƒ»å…¥è©¦æ•™æ</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalUsage">ä½¿ç”¨çŠ¶æ³</label>
                                    <select class="material-mini-select" id="newSeasonalUsage">
    <option value="unknown" selected>ä¸æ˜</option>
    <option value="false">ä½¿ç”¨ãªã—</option>
    <option value="true">ä½¿ç”¨ã‚ã‚Š</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalPeriod">ä½¿ç”¨æ™‚æœŸ</label>
                                    <input type="text" class="material-mini-input" id="newSeasonalPeriod" placeholder="ä¾‹: å¤æœŸè¬›ç¿’">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeNewCardModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">å¡¾ç·¨é›†</div>
                <button class="close-btn" onclick="closeEditCardModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            
            <form id="editCardForm">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label class="form-label" for="editJukuName">å¡¾å</label>
                    <input type="text" class="form-input" id="editJukuName" required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editJukuStatus">åŒºåˆ†</label>
                    <select class="form-select" id="editJukuStatus">
                        <option value="new">æ–°è¦</option>
                        <option value="existing">æ—¢å­˜</option>
                        <option value="former">å…ƒæ—¢å­˜</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editAddressInput">ä½æ‰€ï¼ˆå¸‚åŒºç”ºæ‘ï¼‰</label>
                    <input type="text" class="form-input" id="editAddressInput">
                </div>

                <div class="form-group">
                    <label class="form-label" for="editAreaInput">ã‚¨ãƒªã‚¢</label>
                    <input type="text" class="form-input" id="editAreaInput">
                </div>

                <div class="settings-section">
                    <h4>å¹´é–“ãƒ‡ãƒ¼ã‚¿</h4>
                    <div class="form-group">
                        <label class="form-label" for="editProfitActual">å¹´é–“ç²—åˆ©å®Ÿç¸¾</label>
                        <input type="number" class="form-input" id="editProfitActual" oninput="updateActualSales('edit')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editSalesActual">å¹´é–“å£²ä¸Šå®Ÿç¸¾</label>
                        <input type="number" class="form-input" id="editSalesActual" readonly>
                    </div>

                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">ğŸ“š å¹´é–“æ•™æç®¡ç†</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">é€šå¹´æ•™æ</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundOrder">æ³¨æ–‡çŠ¶æ³</label>
                                    <select class="material-mini-select" id="editYearRoundOrder">
                                        <option value="false">æ³¨æ–‡ãªã—</option>
                                        <option value="true">æ³¨æ–‡ã‚ã‚Š</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundPeriod">æ³¨æ–‡æ™‚æœŸ</label>
                                    <input type="text" class="material-mini-input" id="editYearRoundPeriod" placeholder="ä¾‹: 4æœˆä¸Šæ—¬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">å­£ç¯€ãƒ»å…¥è©¦æ•™æ</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalUsage">ä½¿ç”¨çŠ¶æ³</label>
                                    <select class="material-mini-select" id="editSeasonalUsage">
    <option value="unknown">ä¸æ˜</option>
    <option value="false">ä½¿ç”¨ãªã—</option>
    <option value="true">ä½¿ç”¨ã‚ã‚Š</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalPeriod">ä½¿ç”¨æ™‚æœŸ</label>
                                    <input type="text" class="material-mini-input" id="editSeasonalPeriod" placeholder="ä¾‹: å¤æœŸè¬›ç¿’">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditCardModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">æ›´æ–°</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="memoDetailModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="memoModalTitle">ãƒ¡ãƒ¢è©³ç´°</div>
                <button class="close-btn" onclick="closeMemoDetailModal()" aria-label="é–‰ã˜ã‚‹">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="memoCardName">ãƒ¡ãƒ¢å†…å®¹</label>
                <textarea class="form-input" id="memoContentInput" style="min-height: 150px; resize: vertical;" maxlength="1000" placeholder="ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1000æ–‡å­—ä»¥å†…ï¼‰"></textarea>
            </div>
            <div class="control-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeMemoDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveMemoContent()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
const RENDER_DEBOUNCE_MS = 100;
let currentUser = null;
let currentUserData = null;
let currentUserRole = null;
let currentViewTarget = null;
let availableViewTargets = [];

async function quickLogin() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('FirebaseåˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„', 'info');
        return;
    }
    
    try {
        const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: shimatani@eigyo-team.local');
        const password = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        
        if (!email || !password) return;
          // ğŸ†• ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯
        if (!email.includes('@') || email.trim().length === 0) {
            showToast('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        // ğŸ†• ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ãƒã‚§ãƒƒã‚¯ï¼ˆFirebaseèªè¨¼ã®æœ€å°è¦ä»¶ï¼‰
        if (password.trim().length < 6) {
            showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        await window.firebaseImports.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
       } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        
        // ğŸ†• Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãƒãƒƒãƒ”ãƒ³ã‚°
        const errorMessages = {
            'auth/invalid-credential': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™',
            'auth/user-not-found': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            'auth/wrong-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™',
            'auth/too-many-requests': 'è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„',
            'auth/network-request-failed': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
            'auth/invalid-email': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
            'auth/user-disabled': 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„'
        };
        
        const message = errorMessages[error.code] || (error.code || error.message);
        showToast('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + message, 'error');
    }
}

async function quickLogout() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('FirebaseåˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„', 'info');
        return;
    }
    
    try {
        await window.firebaseImports.signOut(window.firebaseAuth);
        showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
    } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—: ' + (error.code || error.message), 'error');
    }
}

async function loadAvailableViewTargets() {
    if (!currentUser || !currentUserRole) {
        availableViewTargets = [];
        return;
    }
    
    try {
        const usersCollection = await window.firebaseImports.getDocs(
            window.firebaseImports.collection(window.db, 'users')
        );
        
        availableViewTargets = [];
        
        usersCollection.forEach((doc) => {
            const userData = doc.data();
            const userId = doc.id;
            
            if (userId === currentUser.uid) {
                availableViewTargets.push({
                    id: userId,
                    name: userData.name,
                    role: userData.role,
                    canEdit: true
                });
                return;
            }
            
            if (currentUserRole === 'admin') {
                availableViewTargets.push({
                    id: userId,
                    name: userData.name,
                    role: userData.role,
                    canEdit: false
                });
            } else if (currentUserRole === 'manager') {
                if (currentUserData.subordinates && currentUserData.subordinates.includes(userId)) {
                    availableViewTargets.push({
                        id: userId,
                        name: userData.name,
                        role: userData.role,
                        canEdit: false
                    });
                }
            }
        });
        
        availableViewTargets.sort((a, b) => {
            if (a.id === currentUser.uid) return -1;
            if (b.id === currentUser.uid) return 1;
            return a.name.localeCompare(b.name);
        });
        
    } catch (error) {
        console.error('Available view targets load error:', error);
        availableViewTargets = [{
            id: currentUser.uid,
            name: currentUserData.name,
            role: currentUserRole,
            canEdit: true
        }];
    }
}

function updateAuthUI() {
    const loginUserInfo = document.getElementById('loginUserInfo');
    const viewSelectorSection = document.getElementById('viewSelectorSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (currentUser && currentUserData) {
        loginUserInfo.textContent = currentUserData.name;
        
        if (currentUserRole === 'staff') {
            viewSelectorSection.style.display = 'none';
        } else {
            viewSelectorSection.style.display = 'flex';
        }
        
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
    } else {
        loginUserInfo.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
        viewSelectorSection.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
    }
}

function updateViewSelector() {
    const viewSelector = document.getElementById('viewSelector');
    const viewPermissionInfo = document.getElementById('viewPermissionInfo');
    
    if (!availableViewTargets.length) {
        viewSelector.innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿ãªã—</option>';
        viewPermissionInfo.textContent = '';
        return;
    }
    
    viewSelector.innerHTML = '';
    
    availableViewTargets.forEach(target => {
        const option = document.createElement('option');
        option.value = target.id;
        
        if (target.id === currentUser.uid) {
            option.textContent = `${target.name}ã•ã‚“ (è‡ªåˆ†)`;
        } else {
            const roleLabel = {
                'admin': 'ç®¡ç†è€…',
                'manager': 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 
                'staff': 'å–¶æ¥­æ‹…å½“'
            }[target.role] || target.role;
            option.textContent = `${target.name}ã•ã‚“ (${roleLabel})`;
        }
        
        if (target.id === currentViewTarget) {
            option.selected = true;
        }
        
        viewSelector.appendChild(option);
    });
    
    const currentTarget = availableViewTargets.find(t => t.id === currentViewTarget);
    if (currentTarget) {
        if (currentTarget.canEdit) {
            viewPermissionInfo.textContent = 'âœï¸ ç·¨é›†å¯èƒ½';
            viewPermissionInfo.className = 'view-permission-info permission-edit';
        } else {
            viewPermissionInfo.textContent = 'ğŸ‘ï¸ é–²è¦§å°‚ç”¨';
            viewPermissionInfo.className = 'view-permission-info permission-view';
        }
    }
}

async function changeViewTarget() {
    const viewSelector = document.getElementById('viewSelector');
    const newTargetId = viewSelector.value;
    
    if (newTargetId && newTargetId !== currentViewTarget) {
        currentViewTarget = newTargetId;
        updateViewSelector();
        
        // ğŸ†• è¿½åŠ ï¼šè¡¨ç¤ºå¯¾è±¡ã®å€‹äººè¨­å®šã‚’èª­ã¿è¾¼ã¿
        await loadSettingsForTarget(newTargetId);
        
        await loadCardsDataForTarget(newTargetId);
        progressCache = null;
        renderCardsOptimized();
        updateDashboard();
        
        const targetUser = availableViewTargets.find(t => t.id === newTargetId);
        if (targetUser) {
            showToast(`${targetUser.name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­`, 'info');
        }
    }
}


async function loadCardsDataForTarget(targetUserId) {
    if (!currentUser || !targetUserId) {
        cardsData = [];
        return;
    }
    
    try {
        const cardsQuery = window.firebaseImports.query(
            window.firebaseImports.collection(window.db, 'juku_cards'),
            window.firebaseImports.where('assignedUserId', '==', targetUserId)
        );
        
        const cardsCollection = await window.firebaseImports.getDocs(cardsQuery);
        
        cardsData = [];
        let maxId = 0;
        
                cardsCollection.forEach((doc) => {
            const raw = doc.data();
            const docId = doc.id;
            
            // docIdãŒ "uid_123" å½¢å¼ã®å ´åˆã«æ•°å€¤idã‚’æŠ½å‡º
            let numericId = NaN;
            if (docId.includes('_')) {
                const parts = docId.split('_');
                numericId = parseInt(parts[1], 10);
            } else {
                numericId = parseInt(docId, 10);
            }
            
            const cardData = { 
                id: Number.isFinite(numericId) ? numericId : (raw.id || 0),
                docId,
                ...raw
            };
            
            cardsData.push(cardData);
            if (Number.isFinite(cardData.id) && cardData.id > maxId) {
                maxId = cardData.id;
            }
        });

        
        nextCardId = maxId + 1;
        
    } catch (error) {
        console.error('Cards load error for target:', error);
        cardsData = [];
        nextCardId = 1;
    }
}

function hasPermission(action, targetData = null) {
    if (!currentUserRole || !currentUser) return false;
    
    switch (action) {
        case 'view_data':
            return targetData ? targetData.assignedUserId === currentViewTarget : false;
        case 'edit_data':
            return targetData ? targetData.assignedUserId === currentUser.uid : false;
        case 'delete_data':
            return targetData ? targetData.assignedUserId === currentUser.uid : false;
        case 'create_data':
            return currentViewTarget === currentUser.uid;
        case 'edit_own_settings':
            return true;
        case 'edit_any_settings':
            return currentUserRole === 'admin';
        default:
            return false;
    }
}

function setupFirebaseAuth() {
    if (window.firebaseImports && window.firebaseAuth && window.db) {
        window.firebaseImports.onAuthStateChanged(window.firebaseAuth, async (user) => {
            currentUser = user;
            
            if (user) {
                console.log('ãƒ­ã‚°ã‚¤ãƒ³ä¸­ UID:', user.uid, 'ãƒ¡ãƒ¼ãƒ«:', user.email);
                
                try {
                    const userDoc = await window.firebaseImports.getDoc(
                        window.firebaseImports.doc(window.db, 'users', user.uid)
                    );
                    
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data();
                        currentUserRole = currentUserData.role;
                        currentViewTarget = user.uid;
                        
                        await loadAvailableViewTargets();
                        updateAuthUI();
                        updateViewSelector();
                        
                        await loadCardsDataForTarget(currentViewTarget);
                        await syncPersonalSettingsOnLogin();

                        // è‡ªåˆ†ã®è¨­å®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆå¿…é ˆï¼‰
                        if (user && user.uid) {
                            userSettingsCache[user.uid] = { ...personalSettings };
                        }

                        progressCache = null;
                        renderCardsOptimized();
                        updateDashboard();
                        
                        showToast(`${currentUserData.name}ã•ã‚“ï¼ˆ${currentUserRole}ï¼‰ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã—ãŸ`, 'success');
                    } else {
                        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæœªç™»éŒ²ã§ã™ï¼ˆStep 4ã‚’ç¢ºèªï¼‰', 'error');
                    }
                } catch (error) {
                    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } else {
                console.log('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
                currentUserData = null;
                currentUserRole = null;
                currentViewTarget = null;
                availableViewTargets = [];
                userSettingsCache = {}; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                progressCache = null;   // é€²æ—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                updateAuthUI();
                cardsData = [];
                renderCardsOptimized();
                updateDashboard();      // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
            }
        });
    } else {
        setTimeout(setupFirebaseAuth, 100);
    }
}


let cardsData = [];
let nextCardId = 1;
let progressCache = null;
let progressChart = null;
let searchTimeout;
let renderTimeout;
let scrollPosition = 0;
let currentEditingMemo = null;
let isComposing = false;

let personalSettings = {
    userName: 'æ‹…å½“è€…',
    profitRate: 0,
    yearlyProfitTarget: 0,
    yearlyProfitIncreaseTarget: 0,
    yearlySalesIncreaseTarget: 0,
    monthlyProfitActuals: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    },
    monthlyProfitTargets: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    }
};
let userSettingsCache = {};
        
const PROBABILITY_CONFIG = {
    options: [
        { value: 40, label: '50æœªæº€' },
        { value: 50, label: '50%' },
        { value: 60, label: '60%' },
        { value: 70, label: '70%' },
        { value: 80, label: '80%' },
        { value: 90, label: '90%' },
        { value: 100, label: '100%' }
    ],
    
    filters: [
    { value: 'all', label: 'å…¨ç¢ºç‡' },
    { value: 'under50', label: '50æœªæº€' },
    { value: '50-60', label: '50-70' },  // è¡¨ç¤ºåã‚’50-70ã«å¤‰æ›´
    { value: '70', label: '70%' },
    { value: '80', label: '80%' },
    { value: '90', label: '90%' },
    { value: '100', label: '100%' }
]

};

function getCurrentMonth() { 
    return new Date().getMonth() + 1; 
}
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getDefaultSettings() {
    return {
        userName: 'æ‹…å½“è€…',
        profitRate: 0,
        yearlyProfitTarget: 0,
        yearlyProfitIncreaseTarget: 0,
        yearlySalesIncreaseTarget: 0,
        monthlyProfitActuals: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        },
        monthlyProfitTargets: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        }
    };
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå€‹äººè¨­å®šã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getActiveSettings() {
    const targetId = currentViewTarget || (currentUser?.uid || null);
    return (targetId && userSettingsCache[targetId]) ? 
           userSettingsCache[targetId] : 
           personalSettings;
}

// æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººè¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadSettingsForTarget(uid) {
    if (!uid || !window.firebaseImports || !window.db) return;
    if (userSettingsCache[uid]) return; // æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', uid)
        );
        
        if (userDoc.exists() && userDoc.data().personalSettings) {
            userSettingsCache[uid] = { 
                ...getDefaultSettings(), 
                ...userDoc.data().personalSettings 
            };
            console.log(`${uid}ã®å€‹äººè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        } else {
            userSettingsCache[uid] = getDefaultSettings();
            console.warn(`${uid}ã®å€‹äººè¨­å®šãŒæœªè¨­å®šã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨`);
        }
    } catch (error) {
        console.error('å€‹äººè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        userSettingsCache[uid] = getDefaultSettings();
        showToast('å€‹äººè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}


function formatManYen(amount, decimals = 1) {
    const absAmount = Math.abs(amount || 0);
    const manYen = absAmount / 10000;
    const sign = amount < 0 ? '-' : '';
    return `${sign}Â¥${manYen.toFixed(decimals)}ä¸‡`;
}

function formatAmount(amount) { 
    const absAmount = Math.abs(amount || 0);
    const sign = amount < 0 ? '-' : '';
    return `${sign}Â¥${absAmount.toLocaleString()}`;
}

function formatDateForDisplay(s) {
    if (!s) return 'â€”';
    
    // Firestore Timestampå¯¾å¿œ
    if (s && typeof s.toDate === 'function') {
        const d = s.toDate();
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    }
    
    try {
        const d = new Date(s);
        if (isNaN(d.getTime())) return 'â€”';
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    } catch (e) {
        return 'â€”';
    }
}


function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

        // æ•°å€¤ã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
function formatWithCommas(value) {
    const num = parseNumberSafely(value);
    return Number.isFinite(num) ? num.toLocaleString() : '';
}

// æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ãƒ–ãƒ©ãƒ¼å‡¦ç†
function setupNumberFormatting() {
    const numberFields = [
        'newSalesIncreaseForecast', 'newProfitActual', 
        'editProfitActual', 'yearlyProfitTarget', 'yearlyProfitIncreaseTarget'
    ];
    
    numberFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        // ã‚¹ãƒãƒ›ã§æ•°å­—ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã€type=textã§ã‚«ãƒ³ãƒè¡¨ç¤ºå¯èƒ½ã«
        field.setAttribute('inputmode', 'numeric');
        field.setAttribute('type', 'text');
        
        // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚«ãƒ³ãƒä»˜ä¸ï¼ˆ0ä»¥å¤–ã®å€¤ã®ã¿ï¼‰
        if (field.value && field.value !== '0') {
            field.value = formatWithCommas(field.value.replace(/[,ï¼Œ\s]/g, ''));
        }
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ï¼šã‚«ãƒ³ãƒé™¤å»ï¼‹å…¨é¸æŠ
        field.addEventListener('focus', function() {
            this.value = this.value.replace(/[,ï¼Œ\s]/g, '');
            setTimeout(() => this.select(), 0);
        });
        
        // ãƒ–ãƒ©ãƒ¼æ™‚ï¼šã‚«ãƒ³ãƒä»˜ä¸
        field.addEventListener('blur', function() {
            if (this.value && this.value !== '0') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
    
    // æœˆåˆ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†ï¼ˆå€‹äººè¨­å®šå†…ï¼‰
    document.querySelectorAll('.monthly-input').forEach(input => {
        input.setAttribute('inputmode', 'numeric');
        input.setAttribute('type', 'text');
        
        // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚«ãƒ³ãƒä»˜ä¸
        if (input.value && input.value !== '0') {
            input.value = formatWithCommas(input.value.replace(/[,ï¼Œ\s]/g, ''));
        }
        
        input.addEventListener('focus', function() {
            if (this.value && this.value !== '0') {
                this.value = this.value.replace(/[,ï¼Œ\s]/g, '');
                setTimeout(() => this.select(), 0);
            }
        });
        
        input.addEventListener('blur', function() {
            if (this.value && this.value !== '') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
}

function parseNumberSafely(value) {
    if (value == null || value === '') return 0;
    
    const normalized = String(value)
        .replace(/[ï¼-ï¼™]/g, (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0))
        .replace(/[,ï¼Œ\s]/g, '')
        .replace(/[^0-9.-]/g, '');
    
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? Math.max(0, parsed) : 0;
}

function getProbabilityLabel(value) {
    if (value === 40) return '50æœªæº€';
    return `${value}%`;
}

function getProbabilityFilterGroup(value) {
    if (value < 50) return 'under50';
    if (value < 70) return '50-70';
    if (value < 90) return '70-90';
    return '90-100';
}

function matchesProbabilityFilter(probability, filterValue) {
    if (filterValue === 'all') return true;
    
    switch (filterValue) {
        case 'under50': return probability < 50;
        case '50-60': return probability >= 50 && probability <= 60;  // 50,60ã®ã¿
        case '70': return probability === 70;
        case '80': return probability === 80;
        case '90': return probability === 90;
        case '100': return probability === 100;
        default: return true;
    }
}


function getFiscalYearStructure() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    const fiscalStartYear = currentMonth >= 10 ? currentYear : currentYear - 1;
    
    const months = [];
    for (let i = 0; i < 12; i++) {
        const month = ((10 + i - 1) % 12) + 1;
        const year = month >= 10 ? fiscalStartYear : fiscalStartYear + 1;
        months.push({
            key: `${year}-${String(month).padStart(2, '0')}`,
            year: year,
            month: month,
            label: `${year}å¹´${month}æœˆ`
        });
    }
    
    return {
        months: months,
        currentMonthKey: `${currentYear}-${String(currentMonth).padStart(2, '0')}`,
        currentMonthIndex: months.findIndex(m => m.key === `${currentYear}-${String(currentMonth).padStart(2, '0')}`)
    };
}

function getPreviousMonth(monthKey) {
    const fiscalStructure = getFiscalYearStructure();
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === monthKey);
    const prevIndex = currentIndex > 0 ? currentIndex - 1 : 11;
    return fiscalStructure.months[prevIndex];
}

function calculateMonthlyChange(cardData, monthKey) {
    const f = getFiscalYearStructure();
    const m = f.months.find(x => x.key === monthKey);
    const cur = (cardData.monthlyData?.[monthKey] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    if (m && m.month === 10) return { amount: cur, direction: cur > 0 ? 'increase' : 'neutral' };
    const prev = getPreviousMonth(monthKey);
    const p = (cardData.monthlyData?.[prev.key] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    const d = cur - p;
    return { amount: d, direction: d > 0 ? 'increase' : d < 0 ? 'decrease' : 'neutral' };
}

function calculateSalesFromProfit(profitActual) {
    const settings = getActiveSettings();
    const profitRate = (settings.profitRate || 0) / 100;
    if (profitRate <= 0) return 0;
    return Math.round((profitActual || 0) / profitRate);
}


function getCardLevel(v) {
    if (v < 100000) return 0;
    if (v < 300000) return 1;
    if (v < 500000) return 2;
    if (v < 1000000) return 3;
    return 4;
}

function updatePersonalSalesTarget() {
    const p = personalSettings.profitRate / 100;
    personalSettings.yearlySalesIncreaseTarget = p > 0 ? Math.round(personalSettings.yearlyProfitIncreaseTarget / p) : 0;
    const el = document.getElementById('yearlySalesIncreaseTarget');
    if (el) el.value = personalSettings.yearlySalesIncreaseTarget;
}

function validateCardData(cardData) {
    const errors = [];
    
    if (!cardData.jukuName || cardData.jukuName.trim().length === 0) {
        errors.push('å¡¾åã¯å¿…é ˆã§ã™');
    }
    
    if (cardData.jukuName && cardData.jukuName.length > 100) {
        errors.push('å¡¾åã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    
    if (cardData.annualProfitActual < 0) {
        errors.push('å¹´é–“ç²—åˆ©å®Ÿç¸¾ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    
    if (cardData.monthlyData) {
        Object.entries(cardData.monthlyData).forEach(([monthKey, monthData]) => {
            if (monthData.salesIncreaseForecast < 0) {
                errors.push(`${monthKey}ã®å£²ä¸Šå¢—è¦‹è¾¼ã¿ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„`);
            }
            
            if (monthData.probability < 0 || monthData.probability > 100) {
                errors.push(`${monthKey}ã®ç¢ºç‡ã¯0-100%ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„`);
            }
        });
    }
    
    return errors;
}

function saveBackup(data) {
    try {
        const backups = JSON.parse(localStorage.getItem('salesDashboard_backups') || '[]');
        backups.unshift({ ...data, backupTime: Date.now() });
        backups.splice(3);
        localStorage.setItem('salesDashboard_backups', JSON.stringify(backups));
    } catch (e) {
        console.warn('Backup save failed:', e);
    }
}

function cleanupOldBackups() {
    try {
        localStorage.removeItem('salesDashboard_backups');
        for (let key in localStorage) {
            if (key.startsWith('salesDashboard_') && key.includes('_old')) {
                localStorage.removeItem(key);
            }
        }
    } catch (e) {
        console.warn('Cleanup failed:', e);
    }
}

async function saveCardsData() {
    if (!currentUser || !window.firebaseImports || !window.db) {
        try {
            localStorage.setItem('salesDashboard_cardsData_v9', JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId
            }));
            console.log('LocalStorageã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰');
        } catch (e) {
            console.error('LocalStorage save error:', e);
            showToast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
        return;
    }
    
    try {
        for (const card of cardsData) {
            const assignedId = card.assignedUserId || currentUser.uid;
            
            if (!card.docId) {
                card.docId = `${assignedId}_${card.id}`;
            }
            
            const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', card.docId);
            
            const cardToSave = {
                ...card,
                assignedUserId: assignedId,
                assignedUserName: card.assignedUserName || (currentUserData?.name || personalSettings.userName),
                lastUpdated: window.firebaseImports.serverTimestamp(),
                updatedBy: currentUser.uid
            };
            
            await window.firebaseImports.setDoc(cardRef, cardToSave);
        }

        updateAreaFilterOptions();
        showToast('ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        console.log('Firestoreã«ä¿å­˜å®Œäº†:', cardsData.length, 'ä»¶');
        
    } catch (error) {
        console.error('Firestore save error:', error);
        
        // ğŸ†• è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒƒãƒ”ãƒ³ã‚°
        const errorMessages = {
            'permission-denied': 'ä¿å­˜æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„',
            'quota-exceeded': 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸Šé™ã«é”ã—ã¦ã„ã¾ã™',
            'unavailable': 'ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„',
            'deadline-exceeded': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒä¸å®‰å®šã§ã™ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
            'cancelled': 'ä¿å­˜æ“ä½œãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ',
            'internal': 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            'unauthenticated': 'èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'
        };
        
        const message = errorMessages[error.code] || `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message || 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
        showToast(message, 'error');
        
        // ğŸ†• è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        try {
            const backupKey = `salesDashboard_backup_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId,
                timestamp: new Date().toISOString(),
                userInfo: currentUser?.uid || 'unknown',
                errorCode: error.code || 'unknown_error'
            }));
            showToast('ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå¾©æ—§å¯èƒ½ï¼‰', 'info');
            console.log('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å®Œäº†:', backupKey);
        } catch (backupError) {
            console.error('Backup failed:', backupError);
            showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã¯æ‰‹å‹•ã§æ§ãˆã¦ãã ã•ã„', 'error');
        }
    }
}


function loadCardsData() {
    try {
        const saved = localStorage.getItem('salesDashboard_cardsData_v9');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.cardsData) {
                cardsData = data.cardsData;
                nextCardId = data.nextCardId || 1;
            } else {
                cardsData = data;
                const savedNextId = localStorage.getItem('salesDashboard_nextCardId_v9');
                nextCardId = parseInt(savedNextId) || 1;
            }
        } else {
            cardsData = [];
            nextCardId = 1;
        }
    } catch (e) {
        showToast('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
        console.error('Load error:', e);
        cardsData = [];
        nextCardId = 1;
    }
}

function savePersonalSettings() {
    try {
        localStorage.setItem('salesDashboard_personalSettings_v9', JSON.stringify(personalSettings));
    } catch (e) {
        showToast('å€‹äººè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
        console.error('Personal settings save error:', e);
    }
}
        
// Firebaseé€£æºä¿å­˜é–¢æ•°
async function savePersonalSettingsComplete() {
    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
    savePersonalSettings();
    
    // Firebaseä¿å­˜
    if (currentUser && window.db && window.firebaseImports) {
        try {
            await window.firebaseImports.setDoc(
                window.firebaseImports.doc(window.db, 'users', currentUser.uid),
                { personalSettings },
                { merge: true }
            );
            showToast('å€‹äººè¨­å®šã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        } catch (error) {
            console.error('Firebaseå€‹äººè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        }
    }
}

// ãƒ­ã‚°ã‚¤ãƒ³æ™‚åŒæœŸé–¢æ•°
async function syncPersonalSettingsOnLogin() {
    if (!currentUser || !window.db) return;
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', currentUser.uid)
        );
        
        if (userDoc.exists() && userDoc.data().personalSettings) {
            // ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã§ä¸Šæ›¸ã
            personalSettings = { 
                ...personalSettings, 
                ...userDoc.data().personalSettings 
            };
            savePersonalSettings();
            updatePersonalSalesTarget();
            updateDashboard();
            showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å€‹äººè¨­å®šã‚’åŒæœŸã—ã¾ã—ãŸ', 'info');
        } else {
            // åˆå›ï¼šãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
            await savePersonalSettingsComplete();
            showToast('å€‹äººè¨­å®šã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«åˆæœŸä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }
    } catch (error) {
        console.error('å€‹äººè¨­å®šåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        showToast('è¨­å®šåŒæœŸã«å¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ä½¿ç”¨ï¼‰', 'error');
    }
}

function loadPersonalSettings() {
    try {
        const saved = localStorage.getItem('salesDashboard_personalSettings_v9');
        if (saved) {
            const savedSettings = JSON.parse(saved);
            personalSettings = { ...personalSettings, ...savedSettings };
            
            if (!personalSettings.monthlyProfitTargets) {
                personalSettings.monthlyProfitTargets = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            if (!personalSettings.monthlyProfitActuals) {
                personalSettings.monthlyProfitActuals = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            updatePersonalSalesTarget();
        }
    } catch (e) {
        showToast('å€‹äººè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
        console.error('Personal settings load error:', e);
    }
}

function migrateToV9Structure() {
    const fiscalStructure = getFiscalYearStructure();
    let migrationCount = 0;
    
    cardsData.forEach(cardData => {
        let needsMigration = false;
        
        if (cardData.hasOwnProperty('annualSalesIncreaseTarget')) {
            delete cardData.annualSalesIncreaseTarget;
            needsMigration = true;
        }
        if (cardData.hasOwnProperty('annualProfitIncreaseExpected')) {
            delete cardData.annualProfitIncreaseExpected;
            needsMigration = true;
        }
        
        if (!cardData.monthlyData) {
            cardData.monthlyData = {};
            needsMigration = true;
            
            fiscalStructure.months.forEach(monthInfo => {
                cardData.monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: 0,
                    probability: 50,
                    memo: ""
                };
            });
            
            if (cardData.memo) {
                cardData.monthlyData[fiscalStructure.currentMonthKey].memo = cardData.memo;
                delete cardData.memo;
            }
            
            if (cardData.probability) {
                let numericProbability = 50;
                switch(cardData.probability) {
                    case '80+': numericProbability = 90; break;
                    case '60-80': numericProbability = 70; break;
                    case '50-60': numericProbability = 60; break;
                    case '50-': numericProbability = 40; break;
                }
                cardData.monthlyData[fiscalStructure.currentMonthKey].probability = numericProbability;
                delete cardData.probability;
            }
        }
        
        if (!cardData.displayMonth) {
            cardData.displayMonth = fiscalStructure.currentMonthKey;
            needsMigration = true;
        }
        
        if (!cardData.annualMaterials) {
            cardData.annualMaterials = {
                yearRound: { hasOrder: false, orderPeriod: "" },
                seasonalExam: { hasUsage: false, usagePeriod: "" }
            };
            needsMigration = true;
        }

        if (!cardData.registeredMonth) {
    cardData.registeredMonth = getMonthKeyFromTimestamp(
        cardData.lastUpdated, 
        fiscalStructure.currentMonthKey
    );
    needsMigration = true;
}


        if (!cardData.hasOwnProperty('area')) {
            cardData.area = "";
            needsMigration = true;
        }

        if (!cardData.hasOwnProperty('assignedUser')) {
            cardData.assignedUser = personalSettings.userName;
            needsMigration = true;
        }

        if (needsMigration) {
            migrationCount++;
        }
    });
    
    if (migrationCount > 0) {
        saveCardsData();
        showToast(`${migrationCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’v9.5å½¢å¼ã«ç§»è¡Œã—ã¾ã—ãŸ`, 'info');
    }
}

function initializeDisplayMonth() {
    const currentMonthKey = getFiscalYearStructure().currentMonthKey;
    
    cardsData.forEach(cardData => {
        if (!cardData.displayMonth) {
            cardData.displayMonth = currentMonthKey;
        }
    });
    
    const globalSelector = document.getElementById('globalMonthSelector');
    if (globalSelector) {
        globalSelector.value = currentMonthKey;
    }
    
    saveCardsData();
}

function updateAreaFilterOptions() {
    const areaFilter = document.getElementById('areaFilter');
    if (!areaFilter) return;
    
    const currentValue = areaFilter.value || 'all';
    areaFilter.innerHTML = '<option value="all">å…¨åœ°åŸŸ</option>';
    
    const uniqueAreas = [...new Set(cardsData.map(card => card.area).filter(area => area && area.trim()))];
    uniqueAreas.sort().forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaFilter.appendChild(option);
    });
    
    if (uniqueAreas.includes(currentValue) || currentValue === 'all') {
        areaFilter.value = currentValue;
    } else {
        areaFilter.value = 'all';
    }
}

function updateProbabilityFilterOptions() {
    const probabilityFilter = document.getElementById('probabilityFilter');
    if (!probabilityFilter) return;
    
    probabilityFilter.innerHTML = '';
    
    PROBABILITY_CONFIG.filters.forEach(filter => {
        const option = document.createElement('option');
        option.value = filter.value;
        option.textContent = filter.label;
        probabilityFilter.appendChild(option);
    });
}

function updateGlobalMonthSelector() {
    const selector = document.getElementById('globalMonthSelector');
    if (!selector) return;
    
    const fiscalStructure = getFiscalYearStructure();
    selector.innerHTML = '';
    
    fiscalStructure.months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.key;
        option.textContent = `${month.month}æœˆ`;
        if (month.key === fiscalStructure.currentMonthKey) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
    
    const currentMonthInfo = fiscalStructure.months.find(m => m.key === fiscalStructure.currentMonthKey);
    if (currentMonthInfo) {
        document.getElementById('currentDateDisplay').textContent = currentMonthInfo.label;
    }
}

function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 200);
        }, 2500);
    });
}

function calculateQualifiedProspects() {
    const settings = getActiveSettings();
    const currentMonthKey = getFiscalYearStructure().currentMonthKey;
    
    const qualifiedProfit = cardsData.reduce((total, card) => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 50 
        };
        
        if (monthData.probability < 80) return total;
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        return total + profit;
    }, 0);
    
    return qualifiedProfit;
}


function calculateAllProgress() {
    const settings = getActiveSettings();
    const now = Date.now();
    const cacheKey = `${cardsData.length}-${settings.yearlyProfitIncreaseTarget}-${getCurrentMonth()}-${currentViewTarget || ''}`;
    
    if (progressCache && 
        progressCache.cacheKey === cacheKey && 
        (now - progressCache.timestamp) < 5000) {
        return progressCache.data;
    }

    const currentMonth = getCurrentMonth();
    
    const monthlyTarget = settings.monthlyProfitTargets[currentMonth] || 0;
    const monthlyActual = settings.monthlyProfitActuals[currentMonth] || 0;
    const monthlyDifference = monthlyActual - monthlyTarget;
    const monthlyRate = monthlyTarget > 0 ? (monthlyActual / monthlyTarget) * 100 : 0;
    
    const yearlyTarget = settings.yearlyProfitTarget || 0;
    const yearlyActual = Object.values(settings.monthlyProfitActuals)
                                .reduce((sum, monthlyProfit) => sum + (monthlyProfit || 0), 0);
    const yearlyRate = yearlyTarget > 0 ? (yearlyActual / yearlyTarget) * 100 : 0;
    
    const salesIncreaseTarget = settings.yearlySalesIncreaseTarget || 0;
    const currentMonthKey = getFiscalYearStructure().currentMonthKey;
    const totalSalesProspect = cardsData.reduce((sum, card) => {
        const monthData = card.monthlyData?.[currentMonthKey] || { salesIncreaseForecast: 0 };
        return sum + (monthData.salesIncreaseForecast || 0);
    }, 0);
    const salesTargetRate = salesIncreaseTarget > 0 ? (totalSalesProspect / salesIncreaseTarget) * 100 : 0;
    
    const prospectTotal = calculateQualifiedProspects();
    const prospectRate = (settings.yearlyProfitIncreaseTarget || 0) > 0 ? 
        (prospectTotal / settings.yearlyProfitIncreaseTarget) * 100 : 0;
    
    // 6æ®µéšãƒ•ã‚¡ãƒãƒ«
    let probUnder50 = 0, prob5060 = 0, prob70 = 0, prob80 = 0, prob90 = 0, prob100 = 0;

    cardsData.forEach(card => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 50 
        };
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        if (monthData.probability < 50) {
            probUnder50 += profit;
        } else if (monthData.probability <= 60) {
            prob5060 += profit;
        } else if (monthData.probability === 70) {
            prob70 += profit;
        } else if (monthData.probability === 80) {
            prob80 += profit;
        } else if (monthData.probability === 90) {
            prob90 += profit;
        } else if (monthData.probability === 100) {
            prob100 += profit;
        }
    });
   
    const result = {
        monthly: { target: monthlyTarget, actual: monthlyActual, difference: monthlyDifference, rate: monthlyRate },
        yearly: { target: yearlyTarget, actual: yearlyActual, rate: yearlyRate },
        salesTarget: { target: salesIncreaseTarget, prospect: totalSalesProspect, rate: salesTargetRate },
        prospect: { total: prospectTotal, rate: prospectRate },
        funnel: { probUnder50, prob5060, prob70, prob80, prob90, prob100 }
    };
    
    progressCache = {
        data: result,
        cacheKey: cacheKey,
        timestamp: now
    };
    
    return result;
}


function updateDashboard() {
    const progress = calculateAllProgress();
    
    document.getElementById('monthlyTargetDisplay').textContent = formatManYen(progress.monthly.target);
    document.getElementById('monthlyDetail').textContent = 
        `${formatAmount(progress.monthly.actual)}/${formatAmount(progress.monthly.target)}ï¼ˆ${progress.monthly.rate.toFixed(1)}%ï¼‰`;
    
    const monthlyDiffText = formatAmount(progress.monthly.difference);
    document.getElementById('monthlyRate').textContent = `å·®åˆ†: ${monthlyDiffText}`;
    document.getElementById('monthlyRate').className = 
        progress.monthly.difference >= 0 ? 'progress-rate rate-positive' : 'progress-rate rate-negative';
    
    document.getElementById('monthlyProgressBar').style.width = `${Math.min(progress.monthly.rate, 100)}%`;
    
    document.getElementById('yearlyTargetDisplay').textContent = formatManYen(progress.yearly.target);
    document.getElementById('yearlyDetail').textContent = 
        `${formatAmount(progress.yearly.actual)}/${formatAmount(progress.yearly.target)}ï¼ˆ${progress.yearly.rate.toFixed(1)}%ï¼‰`;
    document.getElementById('yearlyRate').textContent = `${progress.yearly.rate.toFixed(1)}%é”æˆ`;
    document.getElementById('yearlyProgressBar').style.width = `${Math.min(progress.yearly.rate, 100)}%`;
    
    document.getElementById('salesTargetDisplay').textContent = formatManYen(progress.salesTarget.target);
    document.getElementById('salesTargetDetail').textContent = 'è‡ªå‹•è¨ˆç®—';
    document.getElementById('salesTargetRate').textContent = 'ç²—åˆ©å¢—ç›®æ¨™ã‹ã‚‰é€†ç®—';
    document.getElementById('salesTargetBar').style.width = `${Math.min(progress.salesTarget.rate, 100)}%`;
    
    document.getElementById('prospectTotalDisplay').textContent = formatManYen(progress.prospect.total);
    document.getElementById('prospectDetail').textContent = `å¯¾ç›®æ¨™${progress.prospect.rate.toFixed(1)}%`;
    document.getElementById('prospectRate').textContent = 'ç¢ºåº¦80%ä»¥ä¸Šã®ã¿é›†è¨ˆ';    
    document.getElementById('prospectBar').style.width = `${Math.min(progress.prospect.rate, 100)}%`;
    
    // 6æ®µéšãƒ•ã‚¡ãƒãƒ«ã®è¡¨ç¤ºæ›´æ–°
document.getElementById('probUnder50').textContent = formatManYen(progress.funnel.probUnder50);
document.getElementById('prob5060').textContent = formatManYen(progress.funnel.prob5060);
document.getElementById('prob70').textContent = formatManYen(progress.funnel.prob70);
document.getElementById('prob80').textContent = formatManYen(progress.funnel.prob80);
document.getElementById('prob90').textContent = formatManYen(progress.funnel.prob90);
document.getElementById('prob100').textContent = formatManYen(progress.funnel.prob100);
}

function createTableRow(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = cardData.displayMonth || fiscalStructure.currentMonthKey;
    const previousMonth = getPreviousMonth(displayMonth);
    
    // 2ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
    const currentData = cardData.monthlyData?.[displayMonth] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    const previousData = cardData.monthlyData?.[previousMonth.key] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    
    const level = getCardLevel(currentData.salesIncreaseForecast || 0);
    const change = calculateMonthlyChange(cardData, displayMonth);
    
    // ç·¨é›†æ¨©é™ã®åˆ¤å®š
    const canEdit = hasPermission('edit_data', cardData);
    const isCurrentMonth = displayMonth === fiscalStructure.currentMonthKey;
    
    const row = document.createElement('tr');
    row.dataset.cardId = cardData.id;
    
    row.innerHTML = `
        <td class="col-level">
            <div class="level-indicator level-${level}"></div>
        </td>
        <td class="col-name">
            ${canEdit ? `
                <div class="editable-cell" onclick="editTableName(${cardData.id})">
                    ${escapeHtml(cardData.jukuName)}
                </div>
            ` : `
                <div>${escapeHtml(cardData.jukuName)}</div>
            `}
        </td>
        <td class="col-prev-amount">
            ${formatManYen(previousData.salesIncreaseForecast || 0)}
        </td>
        <td class="col-prev-prob">
            ${getProbabilityLabel(previousData.probability || 50)}
        </td>
        <td class="col-current-amount">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableForecast(${cardData.id},'${displayMonth}')">
                    ${formatManYen(currentData.salesIncreaseForecast || 0)}
                </div>
            ` : `
                ${formatManYen(currentData.salesIncreaseForecast || 0)}
            `}
        </td>
        <td class="col-current-prob">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableProbability(${cardData.id},'${displayMonth}')">
                    ${getProbabilityLabel(currentData.probability || 50)}
                </div>
            ` : `
                ${getProbabilityLabel(currentData.probability || 50)}
            `}
        </td>
        <td class="col-change">
            <span class="change-${change.direction}">
                ${formatManYen(change.amount)} ${change.direction === 'increase' ? 'â†—' : change.direction === 'decrease' ? 'â†˜' : 'â†’'}
            </span>
        </td>
        <td class="col-detail">
            <button class="detail-btn" onclick="openMonthlyHistoryModal(${cardData.id})">è©³ç´°</button>
        </td>
    `;
    
    // é–²è¦§å°‚ç”¨ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        row.style.cssText = 'opacity: 0.7; background: #fff3cd;';
    }
    
    return row;
}


function editTableName(id) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    const v = prompt('å¡¾åã‚’ç·¨é›†', c.jukuName);
    if (v !== null && v.trim() !== c.jukuName) {
        c.jukuName = v.trim();
        c.lastUpdated = new Date().toISOString();
        saveCardsData();
        renderCardsOptimized();
        showToast('å¡¾åã‚’æ›´æ–°', 'success');
    }
}

function editTableForecast(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('å½“æœˆåˆ†ã®ã¿ç·¨é›†å¯èƒ½', 'info');
        return;
    }
    const cur = c.monthlyData?.[key] || { salesIncreaseForecast: 0 };
    const v = prompt('å£²ä¸Šå¢—è¦‹è¾¼ã‚’å…¥åŠ›ï¼ˆå††ï¼‰', cur.salesIncreaseForecast || 0);
    if (v !== null) {
        const n = parseNumberSafely(v);
        if (!c.monthlyData) c.monthlyData = {};
        if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        c.monthlyData[key].salesIncreaseForecast = n;
        c.lastUpdated = new Date().toISOString();
        if (confirm('å°†æ¥æœˆã‚‚æ›´æ–°?')) propagateToFutureMonths(id, n, c.monthlyData[key].probability);
        else saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('å£²ä¸Šå¢—è¦‹è¾¼ã‚’æ›´æ–°', 'success');
    }
}

function editTableProbability(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('å½“æœˆåˆ†ã®ã¿ç·¨é›†å¯èƒ½', 'info');
        return;
    }
    const opts = ['50æœªæº€', '50%', '60%', '70%', '80%', '90%', '100%'], vals = [40, 50, 60, 70, 80, 90, 100];
    const cur = c.monthlyData?.[key] || { probability: 50 };
    const idx = vals.indexOf(cur.probability);
    const choice = prompt(`ç¢ºç‡é¸æŠ:\n0:${opts[0]}\n1:${opts[1]}\n2:${opts[2]}\n3:${opts[3]}\n4:${opts[4]}\n5:${opts[5]}\n6:${opts[6]}\nç¾åœ¨:${opts[idx >= 0 ? idx : 1]}`, idx >= 0 ? idx : 1);
    if (choice !== null) {
        const i = parseInt(choice);
        if (i >= 0 && i < vals.length) {
            const nv = vals[i];
            if (!c.monthlyData) c.monthlyData = {};
            if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
            c.monthlyData[key].probability = nv;
            c.lastUpdated = new Date().toISOString();
            if (confirm('å°†æ¥æœˆã‚‚æ›´æ–°?')) propagateToFutureMonths(id, c.monthlyData[key].salesIncreaseForecast, nv);
            else saveCardsData();
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
            showToast('ç¢ºç‡ã‚’æ›´æ–°', 'success');
        }
    }
}

function createNewCardElement(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = cardData.displayMonth || fiscalStructure.currentMonthKey;
    const previousMonth = getPreviousMonth(displayMonth);
    
    const currentData = cardData.monthlyData?.[displayMonth] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    const previousData = cardData.monthlyData?.[previousMonth.key] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    
    const cardLevel = getCardLevel(currentData.salesIncreaseForecast || 0);
    
    const card = document.createElement('div');
    card.className = `card card-level-${cardLevel}`;
    card.dataset.cardId = cardData.id;
    
    const lastUpdated = formatDateForDisplay(cardData.lastUpdated);
    
    const currentForecast = currentData.salesIncreaseForecast || 0;
    const previousForecast = previousData.salesIncreaseForecast || 0;
    const difference = currentForecast - previousForecast;
    const changeIcon = difference > 0 ? 'ğŸ“ˆ' : difference < 0 ? 'ğŸ“‰' : 'â¡ï¸';
    const changeClass = difference > 0 ? 'comparison-positive' : difference < 0 ? 'comparison-negative' : 'comparison-neutral';
    
    card.innerHTML = `
        <div class="card-header-new">
            <div class="card-title-clickable" onclick="openMonthlyHistoryModal(${cardData.id})">
                ${escapeHtml(cardData.jukuName)}
            </div>
            <select class="month-selector" onchange="changeCardDisplayMonth(${cardData.id}, this.value)">
                ${fiscalStructure.months.map(month => 
                    `<option value="${month.key}" ${month.key === displayMonth ? 'selected' : ''}>${month.month}æœˆ</option>`                ).join('')}
            </select>
        </div>
        
        <div class="annual-metrics-row">
            <div class="annual-metric">
                <div class="annual-metric-label">å£²ä¸Šå¢—è¦‹è¾¼ï¼ˆ${fiscalStructure.months.find(m => m.key === displayMonth)?.month}æœˆæ™‚ç‚¹ï¼‰</div>
                <div class="annual-metric-value">${formatAmount(currentData.salesIncreaseForecast || 0)}</div>
                <div class="change-indicator ${changeClass}">
                    ${changeIcon} ${formatAmount(difference)}
                </div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">ã‚¨ãƒªã‚¢</div>
                <div class="annual-metric-value">${escapeHtml(cardData.area || 'æœªè¨­å®š')}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">å¹´é–“ç²—åˆ©å®Ÿç¸¾</div>
                <div class="annual-metric-value">${formatAmount(cardData.annualProfitActual || 0)}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">å¹´é–“å£²ä¸Šå®Ÿç¸¾</div>
                <div class="annual-metric-value">${formatAmount(calculateSalesFromProfit(cardData.annualProfitActual || 0))}</div>
            </div>
        </div>
        
        <div class="monthly-comparison-section">
            <div class="month-data-column">
                <div class="month-data-header">å…ˆæœˆ (${previousMonth.month}æœˆ)</div>
                <div class="month-data-content">
                    <div class="forecast-amount">å£²ä¸Šå¢—è¦‹è¾¼: ${formatAmount(previousData.salesIncreaseForecast)}</div>
                    <div class="forecast-probability">ç¢ºç‡: ${getProbabilityLabel(previousData.probability)}</div>
                </div>
            </div>
            <div class="month-data-column">
                <div class="month-data-header">ä»Šæœˆ (${fiscalStructure.months.find(m => m.key === displayMonth)?.month}æœˆ)</div>
                <div class="month-data-content">
                    <div class="editable-field" onclick="editSalesIncreaseForecast(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">å£²ä¸Šå¢—è¦‹è¾¼: ${formatAmount(currentData.salesIncreaseForecast)}</span>
                        <input type="number" class="edit-input" value="${currentData.salesIncreaseForecast}" style="display:none;">
                    </div>
                    <div class="editable-field" onclick="editProbability(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">ç¢ºç‡: ${getProbabilityLabel(currentData.probability)}</span>
                        <select class="edit-select" style="display:none;">
                            ${PROBABILITY_CONFIG.options.map(opt => 
                                `<option value="${opt.value}" ${currentData.probability === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="memo-comparison-section">
            <div class="memo-column">
                <div class="memo-header">å…ˆæœˆãƒ¡ãƒ¢</div>
                <div class="memo-content">${escapeHtml(previousData.memo || 'æœªå…¥åŠ›')}</div>
            </div>
            <div class="memo-column">
                <div class="memo-header">ä»Šæœˆãƒ¡ãƒ¢</div>
                <div class="memo-content" onclick="openMemoDetailModal(${cardData.id}, '${displayMonth}')">${escapeHtml(currentData.memo || 'æœªå…¥åŠ›')}</div>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="last-updated">æœ€çµ‚æ›´æ–°: ${lastUpdated}</div>
            <div class="card-actions">
                <button class="action-btn" title="å±¥æ­´" aria-label="å±¥æ­´" onclick="openMonthlyHistoryModal(${cardData.id})">ğŸ“Š</button>
                ${hasPermission('edit_data', cardData) ? `<button class="action-btn" title="ç·¨é›†" aria-label="ç·¨é›†" onclick="editCard(this)">âœï¸</button>` : ''}
                ${hasPermission('delete_data', cardData) ? `<button class="action-btn" title="å‰Šé™¤" aria-label="å‰Šé™¤" onclick="deleteCard(${cardData.id})">ğŸ—‘ï¸</button>` : ''}
            </div>
        </div>
    `;
    
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        card.style.opacity = '0.8';
        card.classList.add('read-only-card');
        card.style.position = 'relative';
        
        const readOnlyBadge = document.createElement('div');
        readOnlyBadge.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        `;
        readOnlyBadge.textContent = 'ğŸ‘ï¸ é–²è¦§å°‚ç”¨';
        card.appendChild(readOnlyBadge);
        
        const assignedUserName = cardData.assignedUserName || 'ä¸æ˜';
        card.title = `æ‹…å½“è€…: ${assignedUserName}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé–²è¦§å°‚ç”¨ï¼‰`;
    }

    return card;
}

function propagateToFutureMonths(cardId, newForecast, newProbability) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    const fiscalStructure = getFiscalYearStructure();
    const currentMonthKey = fiscalStructure.currentMonthKey;
    const registeredIndex = fiscalStructure.months.findIndex(m => 
        m.key === (cardData.registeredMonth || currentMonthKey)
    );
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);
    
    fiscalStructure.months.forEach((monthInfo, index) => {
        if (index > Math.max(registeredIndex, currentIndex)) {
            if (!cardData.monthlyData[monthInfo.key]) {
                cardData.monthlyData[monthInfo.key] = { 
                    salesIncreaseForecast: 0, probability: 50, memo: "" 
                };
            }
            cardData.monthlyData[monthInfo.key].salesIncreaseForecast = newForecast;
            cardData.monthlyData[monthInfo.key].probability = newProbability;
        }
    });
    
    saveCardsData();
    showToast('å°†æ¥æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸ', 'success');
}

function openModal(modalId) {
    scrollPosition = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('modal-open');
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.classList.remove('modal-open');
    window.scrollTo(0, scrollPosition);
    document.getElementById(modalId).style.display = 'none';
}

function openProgressGraphModal(cardIndex) {
    const cardTitles = ['æœˆåˆ¥ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰', 'å¹´é–“ç›®æ¨™ï¼ˆç²—åˆ©ï¼‰', 'å¹´é–“å£²ä¸Šå¢—ç›®æ¨™', 'å–¶æ¥­è¦‹è¾¼ï¼ˆç²—åˆ©å¢—ï¼‰'];
    document.getElementById('graphModalTitle').textContent = `${cardTitles[cardIndex]} - å¹´é–“é€²æ—ã‚°ãƒ©ãƒ•`;
    
    generateProgressChart(cardIndex);
    openModal('progressGraphModal');
}

function closeProgressGraphModal() {
    if (progressChart) {
        progressChart.destroy();
        progressChart = null;
    }
    closeModal('progressGraphModal');
}

function generateProgressChart(graphType) {
    const ctx = document.getElementById('progressChart').getContext('2d');
    const data = generateFiscalYearData(graphType);
    
    if (progressChart) {
        progressChart.destroy();
    }
    
    const chartColors = {
        actual: '#00E5FF',
        target: '#FFEA00',
        positive: '#00E676',
        negative: '#FF1744',
        line: '#E040FB'
    };

    const chartConfigs = {
        0: {
            type: 'bar',
            datasets: [
                {
                    label: 'å®Ÿç¸¾å€¤',
                    data: data.actualData,
                    backgroundColor: chartColors.actual,
                    borderColor: chartColors.actual,
                    borderWidth: 2
                },
                {
                    label: 'ç›®æ¨™å€¤',
                    data: data.targetData,
                    backgroundColor: chartColors.target,
                    borderColor: chartColors.target,
                    borderWidth: 2
                }
            ]
        },
        1: {
            type: 'bar',
            datasets: [
                {
                    label: 'ç´¯ç©å®Ÿç¸¾',
                    data: data.actualData,
                    backgroundColor: chartColors.actual,
                    borderColor: chartColors.actual,
                    borderWidth: 2
                },
                {
                    label: 'ç´¯ç©ç›®æ¨™',
                    data: data.targetData,
                    backgroundColor: chartColors.target,
                    borderColor: chartColors.target,
                    borderWidth: 2
                }
            ]
        },
        2: {
    type: 'bar',
    datasets: [
        {
            label: 'å£²ä¸Šå¢—è¦‹è¾¼ï¼ˆç´¯è¨ˆï¼‰',
            data: data.actualData,
            backgroundColor: chartColors.actual,
            borderColor: chartColors.actual,
            borderWidth: 2,
            type: 'bar'
        },
        {
            label: 'å£²ä¸Šå¢—ç›®æ¨™ãƒ©ã‚¤ãƒ³',
            data: data.targetData,
            borderColor: chartColors.target,
            borderWidth: 3,
            borderDash: [8, 8],
            type: 'line',
            fill: false,
            pointRadius: 0,
            tension: 0
        }
    ]
},
        3: {
            type: 'line',
            datasets: [
                {
                    label: 'å–¶æ¥­è¦‹è¾¼é”æˆç‡ï¼ˆ%ï¼‰',
                    data: data.actualData,
                    borderColor: chartColors.line,
                    backgroundColor: 'rgba(224, 64, 251, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 6,
                    pointBackgroundColor: chartColors.line,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                },
                {
                    label: '100%ãƒ©ã‚¤ãƒ³',
                    data: data.targetData,
                    borderColor: chartColors.target,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                }
            ]
        }
    };
    
    const config = chartConfigs[graphType];
    
    progressChart = new Chart(ctx, {
        type: config.type,
        data: {
            labels: data.labels,
            datasets: config.datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(0,176,255,0.7)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === null) return null;
                            if (graphType === 3) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                            }
                            return `${context.dataset.label}: ${formatAmount(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255,255,255,0.2)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#E0E0E0'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255,255,255,0.2)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#E0E0E0',
                        callback: function(value) {
                            if (graphType === 3) {
                                return value + '%';
                            }
                            return formatManYen(value, 0);
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    updateGraphLegend(config.datasets);
}

function generateFiscalYearData(graphType) {
    const settings = getActiveSettings();
    const { months, currentMonthIndex } = getFiscalYearStructure();
    
    const actualData = [];
    const targetData = [];
    const labels = months.map(m => m.label.substring(m.label.indexOf('å¹´') + 1));
    
    let cumActual = 0;
    let cumTarget = 0;
    
    months.forEach((monthInfo, index) => {
        const isPastMonth = index <= currentMonthIndex;
        const monthNum = monthInfo.month;
        
        switch(graphType) {
            case 0: {
                const monthlyTarget = settings.monthlyProfitTargets[monthNum] || 0;
                const monthlyActual = isPastMonth ? (settings.monthlyProfitActuals[monthNum] || 0) : 0;
                targetData.push(monthlyTarget);
                actualData.push(isPastMonth ? monthlyActual : null);
                break;
            }
            case 1: {
                const t = settings.monthlyProfitTargets[monthNum] || 0;
                const a = isPastMonth ? (settings.monthlyProfitActuals[monthNum] || 0) : 0;
                cumTarget += t;
                cumActual += isPastMonth ? a : 0;
                targetData.push(cumTarget);
                actualData.push(isPastMonth ? cumActual : null);
                break;
            }
            case 2: {
                const salesIncreaseTarget = settings.yearlySalesIncreaseTarget || 0;
                let cumSalesProspect = 0;
                for (let j = 0; j <= index; j++) {
                    const key = months[j].key;
                    cardsData.forEach(card => {
                        const md = card.monthlyData?.[key] || { salesIncreaseForecast: 0 };
                        cumSalesProspect += md.salesIncreaseForecast || 0;
                    });
                }
                targetData.push(salesIncreaseTarget);
                actualData.push(isPastMonth ? cumSalesProspect : null);
                break;
            }
            case 3: {
                let cumProspectProfit = 0;
                for (let j = 0; j <= index; j++) {
                    const key = months[j].key;
                    cardsData.forEach(card => {
                        const md = card.monthlyData?.[key] || { 
                            salesIncreaseForecast: 0, 
                            probability: 50 
                        };
                        if (md.probability >= 80) {
                            cumProspectProfit += (md.salesIncreaseForecast || 0) 
                                               * ((settings.profitRate || 0) / 100);
                        }
                    });
                }
                const profitIncreaseTarget = settings.yearlyProfitIncreaseTarget || 0;
                const rate = profitIncreaseTarget > 0 ? 
                    (cumProspectProfit / profitIncreaseTarget) * 100 : 0;
                actualData.push(isPastMonth ? rate : null);
                targetData.push(100);
                break;
            }
        }
    });
    
    return { labels, actualData, targetData };
}


function updateGraphLegend(datasets) {
    const legendContainer = document.getElementById('graphLegend');
    legendContainer.innerHTML = '';

    datasets.forEach(dataset => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        const legendColor = Array.isArray(dataset.backgroundColor) ? 
                            dataset.backgroundColor[0] : 
                            (dataset.backgroundColor || dataset.borderColor);
        
        legendItem.innerHTML = `
            <span class="legend-color" style="background: ${legendColor};"></span>
            <span>${dataset.label}</span>
        `;
        legendContainer.appendChild(legendItem);
    });
}

function filterByProbability(probability) {
    document.getElementById('probabilityFilter').value = probability;
    applyFilters();
}

function openNewCardModal() {
    if (!hasPermission('create_data')) {
        showToast('è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­ã®ã¿æ–°è¦ç™»éŒ²ã§ãã¾ã™', 'error');
        return;
    }
    
    document.getElementById('newCardForm').reset();
    updateActualSales('new');
    document.getElementById('newSalesActual').readOnly = true;
    document.getElementById('newSalesActual').style.background = '#f8f9fa';
    openModal('newCardModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closeNewCardModal() {
    document.getElementById('newCardForm').reset();
    closeModal('newCardModal');
}

function openPersonalSettingsModal() {
    document.getElementById('userName').value = personalSettings.userName;
    document.getElementById('profitRate').value = personalSettings.profitRate;
    document.getElementById('yearlyProfitTarget').value = personalSettings.yearlyProfitTarget;
    document.getElementById('yearlyProfitIncreaseTarget').value = personalSettings.yearlyProfitIncreaseTarget;
    document.getElementById('yearlySalesIncreaseTarget').value = personalSettings.yearlySalesIncreaseTarget;
    
    const monthlyContainer = document.getElementById('monthlyProfitContainer');
    const fiscalMonths = getFiscalYearStructure().months;
    
    monthlyContainer.innerHTML = '';
    
    fiscalMonths.forEach(monthInfo => {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'monthly-row';
        const actualValue = personalSettings.monthlyProfitActuals[monthInfo.month] || 0;
        const targetValue = personalSettings.monthlyProfitTargets[monthInfo.month] || 0;
        const actualDisplay = actualValue === 0 ? '' : actualValue;
        const targetDisplay = targetValue === 0 ? '' : targetValue;
        
        monthDiv.innerHTML = `
            <div class="month-name">${monthInfo.label.substring(monthInfo.label.indexOf('å¹´') + 1)}</div>
            <input type="number" class="monthly-input" placeholder="å®Ÿç¸¾" id="monthlyProfitActual${monthInfo.month}" value="${actualDisplay}">
            <input type="number" class="monthly-input" placeholder="ç›®æ¨™" id="monthlyProfitTarget${monthInfo.month}" value="${targetDisplay}">
            <div style="font-size: 10px; color: rgba(0,0,0,0.7); text-align: center;"></div>
        `;
        monthlyContainer.appendChild(monthDiv);
    });
    
    setTimeout(() => {
        setupMonthlyInputHandlers('monthlyProfitContainer');
    }, 100);
    
    openModal('personalSettingsModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closePersonalSettingsModal() {
    closeModal('personalSettingsModal');
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('probabilityFilter').value = 'all';
    document.getElementById('areaFilter').value = 'all';
    document.getElementById('sortSelect').value = 'sales-desc';
    renderCardsOptimized();
    showToast('ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
}

function applySorting() {
    renderCardsOptimized();
}

function applyFilters() {
    renderCardsOptimized();
}

function changeCardDisplayMonth(cardId, newMonthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    cardData.displayMonth = newMonthKey;
    saveCardsData();
    renderCardsOptimized();
}

function changeAllCardsDisplayMonth(newMonthKey) {
    cardsData.forEach(cardData => {
        cardData.displayMonth = newMonthKey;
    });
    saveCardsData();
    
    const fiscalStructure = getFiscalYearStructure();
    const monthInfo = fiscalStructure.months.find(m => m.key === newMonthKey);
    if (monthInfo) {
        document.getElementById('currentDateDisplay').textContent = monthInfo.label;
    }
    
    renderCardsOptimized();
    showToast('å…¨ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºæœˆã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'info');
}

function openMonthlyHistoryModal(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    document.getElementById('historyModalTitle').textContent = `${cardData.jukuName} - æœˆåˆ¥å±¥æ­´ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰`;
    
    const container = document.getElementById('monthlyHistoryContainer');
    container.innerHTML = '';
    
    const fiscalStructure = getFiscalYearStructure();

    fiscalStructure.months.forEach(monthInfo => {
        const monthData = cardData.monthlyData?.[monthInfo.key] || { 
            salesIncreaseForecast: 0, probability: 50, memo: "" 
        };

        const monthRow = document.createElement('div');
        monthRow.className = 'compact-month-row past-month';
        
        monthRow.innerHTML = `
            <div class="compact-month-header">
                ${monthInfo.label}
                <span class="readonly-badge">è¡¨ç¤ºã®ã¿</span>
            </div>
            <div class="compact-data-grid">
                <div class="compact-field">
                    <div class="compact-field-label">å£²ä¸Šå¢—è¦‹è¾¼</div>
                    <div class="compact-field-value">${formatManYen(monthData.salesIncreaseForecast)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">ç¢ºç‡</div>
                    <div class="compact-field-value">${getProbabilityLabel(monthData.probability)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">ãƒ¡ãƒ¢</div>
                    <div class="compact-memo">${escapeHtml(monthData.memo || 'æœªå…¥åŠ›')}</div>
                </div>
            </div>
        `;
        
        container.appendChild(monthRow);
    });
    
    openModal('monthlyHistoryModal');
}

function closeMonthlyHistoryModal() {
    closeModal('monthlyHistoryModal');
}

function editCard(button) {
    const card = button.closest('.card');
    const cardId = parseInt(card.dataset.cardId);
    const cardData = cardsData.find(card => card.id === cardId);
    
    if (!cardData) return;

    document.getElementById('editCardId').value = cardData.id;
    document.getElementById('editModalTitle').textContent = `${cardData.jukuName} - ç·¨é›†`;
    document.getElementById('editJukuName').value = cardData.jukuName;
    document.getElementById('editJukuStatus').value = cardData.status;
    document.getElementById('editAddressInput').value = cardData.address;
    document.getElementById('editAreaInput').value = cardData.area || '';
    document.getElementById('editProfitActual').value = cardData.annualProfitActual;
    document.getElementById('editSalesActual').value = calculateSalesFromProfit(cardData.annualProfitActual || 0);
    
    const materials = cardData.annualMaterials || {
        yearRound: { hasOrder: false, orderPeriod: "" },
        seasonalExam: { hasUsage: null, usagePeriod: "" }
    };
    document.getElementById('editYearRoundOrder').value = String(materials.yearRound.hasOrder);
    document.getElementById('editYearRoundPeriod').value = materials.yearRound.orderPeriod || '';
    const seasonalValue = (materials.seasonalExam.hasUsage === null || typeof materials.seasonalExam.hasUsage === 'undefined')
    ? 'unknown'
    : String(materials.seasonalExam.hasUsage);
document.getElementById('editSeasonalUsage').value = seasonalValue;

    document.getElementById('editSeasonalPeriod').value = materials.seasonalExam.usagePeriod || '';
    
    openEditCardModal();
}

function openEditCardModal() {
    updateActualSales('edit');
    document.getElementById('editSalesActual').readOnly = true;
    document.getElementById('editSalesActual').style.background = '#f8f9fa';
    openModal('editCardModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closeEditCardModal() {
    closeModal('editCardModal');
}

async function deleteCard(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    if (!hasPermission('delete_data', cardData)) {
        showToast('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    
    const cardName = cardData ? cardData.jukuName : 'ã“ã®å¡¾';
    
    if (confirm(`ã€${cardName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        cardsData = cardsData.filter(card => card.id !== cardId);
        
        if (currentUser && window.firebaseImports && window.db) {
            try {
                const docId = cardData.docId || `${cardData.assignedUserId || currentUser.uid}_${cardData.id}`;
                const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', docId);
                await window.firebaseImports.deleteDoc(cardRef);
                console.log('Firestoreã‹ã‚‰å‰Šé™¤å®Œäº†:', docId);
            } catch (error) {

                console.error('Firestore delete error:', error);
                showToast('ã‚¯ãƒ©ã‚¦ãƒ‰å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

function openMemoDetailModal(cardId, monthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    const monthData = cardData.monthlyData?.[monthKey] || { memo: "" };
    const fiscalStructure = getFiscalYearStructure();
    const monthLabel = fiscalStructure.months.find(m => m.key === monthKey)?.label;

    document.getElementById('memoModalTitle').textContent = `ãƒ¡ãƒ¢è©³ç´° - ${monthLabel}`;
    document.getElementById('memoCardName').textContent = `å¡¾å: ${cardData.jukuName}`;
    document.getElementById('memoContentInput').value = monthData.memo || '';
    
    // ğŸ†• æ¨©é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
    const canEdit = hasPermission('edit_data', cardData) &&
                    monthKey === getFiscalYearStructure().currentMonthKey;
    
    const textarea = document.getElementById('memoContentInput');
    const saveBtn = document.querySelector('#memoDetailModal .btn-primary');
    
    textarea.readOnly = !canEdit;
    saveBtn.style.display = canEdit ? 'inline-block' : 'none';
    
    if (!canEdit) {
        textarea.style.backgroundColor = '#f8f9fa';
        textarea.style.cursor = 'not-allowed';
        textarea.title = 'ç·¨é›†æ¨©é™ãŒãªã„ã‹ã€éå»æœˆã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“';
    } else {
        textarea.style.backgroundColor = '';
        textarea.style.cursor = '';
        textarea.title = '';
    }
    
    currentEditingMemo = { cardId, monthKey };
    openModal('memoDetailModal');
}


function closeMemoDetailModal() {
    currentEditingMemo = null;
    closeModal('memoDetailModal');
}

function saveMemoContent() {
    if (!currentEditingMemo) return;

    const { cardId, monthKey } = currentEditingMemo;
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    // ğŸ†• æ¨©é™ãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼ˆã“ã®4è¡Œã‚’è¿½åŠ ï¼‰
    if (!hasPermission('edit_data', cardData)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    
    if (monthKey !== getFiscalYearStructure().currentMonthKey) {
        showToast('å½“æœˆåˆ†ã®ã¿ç·¨é›†å¯èƒ½ã§ã™', 'info');
        return;
    }

    // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾
    const newMemoContent = document.getElementById('memoContentInput').value;
    
    if (!cardData.monthlyData) cardData.monthlyData = {};
    if (!cardData.monthlyData[monthKey]) {
        cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
    }

    cardData.monthlyData[monthKey].memo = newMemoContent;
    cardData.lastUpdated = new Date().toISOString();

    saveCardsData();
    renderCardsOptimized();
    showToast('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    closeMemoDetailModal();
}

function updateActualSales(prefix) {
    const profitActual = parseNumberSafely(document.getElementById(`${prefix}ProfitActual`).value);
    const salesActual = calculateSalesFromProfit(profitActual);
    document.getElementById(`${prefix}SalesActual`).value = salesActual;
}

function setupMonthlyInputHandlers(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const inputs = container.querySelectorAll('.monthly-input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if (this.value === '0') {
                this.value = '';
            }
        });
    });
}

function getCardActiveMonthKey(card) {
    const globalSel = document.getElementById('globalMonthSelector');
    const globalKey = globalSel && globalSel.value ? globalSel.value : getFiscalYearStructure().currentMonthKey;
    return card.displayMonth || globalKey;
}

function getSortedCards(cards) {
    const sortType = document.getElementById('sortSelect').value;
    const sortedCards = [...cards];
    
    switch (sortType) {
        case 'sales-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                return bForecast - aForecast;
            });
        case 'sales-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                return aForecast - bForecast;
            });
        case 'updated-desc':
            return sortedCards.sort((a, b) => new Date(b.lastUpdated || '1970-01-01') - new Date(a.lastUpdated || '1970-01-01'));
        case 'updated-asc':
            return sortedCards.sort((a, b) => new Date(a.lastUpdated || '1970-01-01') - new Date(b.lastUpdated || '1970-01-01'));
        case 'probability-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 50;
                const bProb = b.monthlyData?.[bKey]?.probability || 50;
                return bProb - aProb;
            });
        case 'probability-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 50;
                const bProb = b.monthlyData?.[bKey]?.probability || 50;
                return aProb - bProb;
            });
        default:
            return sortedCards;
    }
}

function updateSortInfo() {
    const sortType = document.getElementById('sortSelect').value;
    const sortInfo = document.getElementById('sortInfo');
    
    const sortLabels = {
        'sales-desc': 'å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå¤§â†’å°ï¼‰',
        'sales-asc': 'å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå°â†’å¤§ï¼‰',
        'updated-desc': 'æœ€çµ‚æ›´æ–°æ—¥é †ï¼ˆæ–°â†’å¤ï¼‰',
        'updated-asc': 'æœ€çµ‚æ›´æ–°æ—¥é †ï¼ˆå¤â†’æ–°ï¼‰',
        'probability-desc': 'å—æ³¨ç¢ºç‡é †ï¼ˆé«˜â†’ä½ï¼‰',
        'probability-asc': 'å—æ³¨ç¢ºç‡é †ï¼ˆä½â†’é«˜ï¼‰'
    };
    
    sortInfo.textContent = sortLabels[sortType] || 'å£²ä¸Šå¢—è¦‹è¾¼é †ï¼ˆå¤§â†’å°ï¼‰';
}

function renderCardsOptimized() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => {
        const startTime = performance.now();
        renderCards();
        const endTime = performance.now();
        if (endTime - startTime > 100) {
            console.warn(`Slow render detected: ${endTime - startTime}ms`);
        }
    }, RENDER_DEBOUNCE_MS);
}

function renderCards() {
    const tb = document.getElementById('jukuTableBody');
    const mc = document.getElementById('cardsContainer');
    tb.innerHTML = '';
    mc.innerHTML = '';

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const probabilityFilter = document.getElementById('probabilityFilter').value;
    const areaFilter = document.getElementById('areaFilter').value;

    let filteredCards = cardsData.filter(cardData => {
        const title = cardData.jukuName.toLowerCase();
        const status = cardData.status;
        const area = cardData.area || '';
        
        const displayMonth = cardData.displayMonth || getFiscalYearStructure().currentMonthKey;
        const monthData = cardData.monthlyData?.[displayMonth] || { probability: 50 };
        
        let show = true;
        if (searchTerm && !title.includes(searchTerm)) show = false;
        if (statusFilter !== 'all' && status !== statusFilter) show = false;
        if (probabilityFilter !== 'all' && !matchesProbabilityFilter(monthData.probability, probabilityFilter)) show = false;
        if (areaFilter !== 'all' && (!area || !area.includes(areaFilter))) show = false;
        return show;
    });

    filteredCards = getSortedCards(filteredCards);

    filteredCards.forEach((cardData) => {
        const tableRow = createTableRow(cardData);
        tb.appendChild(tableRow);
        
        const cardElement = createNewCardElement(cardData);
        mc.appendChild(cardElement);
    });
    
    updateSortInfo();
    
    if (Date.now() - (progressCache?.timestamp || 0) > 2000) {
        progressCache = null;
        updateDashboard();
    }
}

function editSalesIncreaseForecast(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆé–²è¦§å°‚ç”¨ï¼‰', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('å½“æœˆåˆ†ã®ã¿ç·¨é›†å¯èƒ½ã§ã™', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const inputField = element.querySelector('.edit-input');

    displaySpan.style.display = 'none';
    inputField.style.display = 'block';
    inputField.focus();
    inputField.select();

    const saveChanges = () => {
        const newValue = parseNumberSafely(inputField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].salesIncreaseForecast !== newValue) {
            cardData.monthlyData[monthKey].salesIncreaseForecast = newValue;
            cardData.lastUpdated = new Date().toISOString();
            
            if (confirm('å°†æ¥æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚‚åŒã˜å€¤ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨å½“æœˆã®ã¿æ›´æ–°ã•ã‚Œã¾ã™ï¼‰')) {
                propagateToFutureMonths(cardId, newValue, cardData.monthlyData[monthKey].probability);
            } else {
                saveCardsData();
                showToast('å½“æœˆã®å£²ä¸Šå¢—è¦‹è¾¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            inputField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        inputField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

    inputField.onblur = saveChanges;
    inputField.onkeydown = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            saveChanges();
        } else if (event.key === 'Escape') {
            event.preventDefault();
            cancelEdit();
        }
    };
}

function editProbability(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆé–²è¦§å°‚ç”¨ï¼‰', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('å½“æœˆåˆ†ã®ã¿ç·¨é›†å¯èƒ½ã§ã™', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const selectField = element.querySelector('.edit-select');

    displaySpan.style.display = 'none';
    selectField.style.display = 'block';
    selectField.focus();

    const saveChanges = () => {
        const newValue = parseInt(selectField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].probability !== newValue) {
            cardData.monthlyData[monthKey].probability = newValue;
            cardData.lastUpdated = new Date().toISOString();
            
            if (confirm('å°†æ¥æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚‚åŒã˜ç¢ºç‡ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨å½“æœˆã®ã¿æ›´æ–°ã•ã‚Œã¾ã™ï¼‰')) {
                propagateToFutureMonths(cardId, cardData.monthlyData[monthKey].salesIncreaseForecast, newValue);
            } else {
                saveCardsData();
                showToast('å½“æœˆã®ç¢ºç‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            selectField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        selectField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

    selectField.onchange = saveChanges;
    selectField.onblur = saveChanges;
    selectField.onkeydown = (event) => {
        if (event.key === 'Escape') {
            event.preventDefault();
            cancelEdit();
        }
    };
}

function setupSearchWithIMESupport() {
    const searchInput = document.getElementById('searchInput');
    
    searchInput.addEventListener('compositionstart', () => {
        isComposing = true;
    });
    
    searchInput.addEventListener('compositionend', () => {
        isComposing = false;
        applySearchFilter();
    });
    
    searchInput.addEventListener('input', () => {
        if (!isComposing) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applySearchFilter, 300);
        }
    });
    
    function applySearchFilter() {
        applyFilters();
    }
}

function enhanceAccessibility() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
    });
    
    document.querySelectorAll('.action-btn').forEach((btn, index) => {
        const actions = ['ç·¨é›†', 'å±¥æ­´', 'å‰Šé™¤'];
        btn.setAttribute('aria-label', actions[index % 3]);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadPersonalSettings();
    loadCardsData();
    initializeDisplayMonth();
    migrateToV9Structure();
    
    updateProbabilityFilterOptions();
    updateAreaFilterOptions();
    updateGlobalMonthSelector();
    
    document.getElementById('sortSelect').value = 'sales-desc';
    
    setupSearchWithIMESupport();
    enhanceAccessibility();
    setupFirebaseAuth();
    setupNumberFormatting(); 

    document.addEventListener('click', function(e) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal[style*="flex"]');
            if (openModal) {
                closeModal(openModal.id);
            }
        }
    });

    document.getElementById('personalSettingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        personalSettings.userName = document.getElementById('userName').value;
        personalSettings.profitRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('profitRate').value) || 0));
        personalSettings.yearlyProfitTarget = parseNumberSafely(document.getElementById('yearlyProfitTarget').value);
        personalSettings.yearlyProfitIncreaseTarget = parseNumberSafely(document.getElementById('yearlyProfitIncreaseTarget').value);
        
        updatePersonalSalesTarget();
        
        const fiscalMonths = getFiscalYearStructure().months;
        fiscalMonths.forEach(monthInfo => {
            const actualInput = document.getElementById(`monthlyProfitActual${monthInfo.month}`);
            const targetInput = document.getElementById(`monthlyProfitTarget${monthInfo.month}`);
            if (actualInput) {
                personalSettings.monthlyProfitActuals[monthInfo.month] = parseNumberSafely(actualInput.value);
            }
            if (targetInput) {
                personalSettings.monthlyProfitTargets[monthInfo.month] = parseNumberSafely(targetInput.value);
            }
        });
        
        await savePersonalSettingsComplete();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast('å€‹äººè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        closePersonalSettingsModal();
    });

    document.getElementById('newCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const jukuName = document.getElementById('newJukuName').value.trim();
        const status = document.getElementById('newJukuStatus').value;
        const address = document.getElementById('newAddressInput').value.trim();
        const area = document.getElementById('newAreaInput').value.trim();
        const salesIncreaseForecast = parseNumberSafely(document.getElementById('newSalesIncreaseForecast').value);
        const probability = parseInt(document.getElementById('newProbability').value) || 50;
        const annualProfitActual = parseNumberSafely(document.getElementById('newProfitActual').value);
        
        if (!jukuName) {
            showToast('å¡¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        const fiscalStructure = getFiscalYearStructure();
        const currentMonthKey = fiscalStructure.currentMonthKey;
        const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);

        const monthlyData = {};
        fiscalStructure.months.forEach((monthInfo, index) => {
            if (index < currentIndex) {
                monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: 0,
                    probability: 50,
                    memo: ""
                };
            } else {
                monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: salesIncreaseForecast,
                    probability: probability,
                    memo: ""
                };
            }
        });

        const annualMaterials = {
            yearRound: {
                hasOrder: document.getElementById('newYearRoundOrder').value === 'true',
                orderPeriod: document.getElementById('newYearRoundPeriod').value.trim()
            },
            seasonalExam: {
                hasUsage: (value => {
        if (value === 'unknown') return null;
        return value === 'true';
    })(document.getElementById('newSeasonalUsage').value),
                usagePeriod: document.getElementById('newSeasonalPeriod').value.trim()
            }
        };

                // docIdç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼UID_ã‚«ãƒ¼ãƒ‰IDã§ä¸€æ„æ€§ç¢ºä¿ï¼‰
        const newDocId = `${currentUser.uid}_${nextCardId}`;

        const cardData = {
            id: nextCardId++,
            docId: newDocId,  // ã“ã®è¡Œã‚’è¿½åŠ 
            jukuName: jukuName,
            status: status,
            address: address,
            area: area,
            assignedUserId: currentUser.uid,
            assignedUserName: currentUserData.name,

            displayMonth: currentMonthKey,
            monthlyData: monthlyData,
            annualProfitActual: annualProfitActual,
            annualMaterials: annualMaterials,
            registeredMonth: currentMonthKey,
            lastUpdated: new Date().toISOString()
        };

        const errors = validateCardData(cardData);
        if (errors.length > 0) {
            showToast(errors[0], 'error');
            return;
        }
        
        cardsData.push(cardData);
        await saveCardsData();
        progressCache = null;
        renderCardsOptimized();
        updateDashboard();
        
        document.getElementById('newCardForm').reset();
        closeNewCardModal();
        showToast(`æ–°è¦å¡¾ã€Œ${cardData.jukuName}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`, 'success');
    });

    document.getElementById('editCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const cardId = parseInt(document.getElementById('editCardId').value);
        const cardData = cardsData.find(card => card.id === cardId);
        
        if (!cardData) {
            showToast('ç·¨é›†å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }

        const annualProfitActual = parseNumberSafely(document.getElementById('editProfitActual').value);
        
        cardData.jukuName = document.getElementById('editJukuName').value.trim();
        cardData.status = document.getElementById('editJukuStatus').value;
        cardData.address = document.getElementById('editAddressInput').value.trim();
        cardData.area = document.getElementById('editAreaInput').value.trim();
        cardData.annualProfitActual = annualProfitActual;
        
        cardData.annualMaterials = {
            yearRound: {
                hasOrder: document.getElementById('editYearRoundOrder').value === 'true',
                orderPeriod: document.getElementById('editYearRoundPeriod').value.trim()
            },
            seasonalExam: {
    hasUsage: (value => {
        if (value === 'unknown') return null;
        return value === 'true';
    })(document.getElementById('editSeasonalUsage').value),
    usagePeriod: document.getElementById('editSeasonalPeriod').value.trim()
}

        };
        
        cardData.lastUpdated = new Date().toISOString();

        const errors = validateCardData(cardData);
        if (errors.length > 0) {
            showToast(errors[0], 'error');
            return;
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast(`${cardData.jukuName}ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`, 'success');
        closeEditCardModal();
    });

    renderCardsOptimized();
    updateDashboard();
});
        // ğŸ†• ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã®ç›£è¦–æ©Ÿèƒ½
window.addEventListener('offline', () => {
    showToast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«åˆ‡æ›¿ï¼‰', 'info');
    console.log('Network status: OFFLINE - Switching to local storage mode');
});

window.addEventListener('online', () => {
    showToast('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ', 'success');
    console.log('Network status: ONLINE - Firebase sync available');
});

// ğŸ†• åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ç¢ºèª
document.addEventListener('DOMContentLoaded', () => {
    if (!navigator.onLine) {
        console.log('Initial network status: OFFLINE');
        setTimeout(() => {
            showToast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸ', 'info');
        }, 1000); // ä»–ã®åˆæœŸåŒ–å‡¦ç†å¾Œã«è¡¨ç¤º
    }
});

    </script>
</body>
</html>
