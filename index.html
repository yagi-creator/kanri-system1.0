<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="営業支援システム">
    <meta name="theme-color" content="#005BAC">
    <title>営業支援システム v11.1</title>
    
    <!-- favicon（ブラウザタブ用・SVG） -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwMDVCQUMiLz4KICA8ZyBmaWxsPSIjRkZGRkZGIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MCwzMCkgc2NhbGUoMC43NSkiPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNjQsMTI4KSBzY2FsZSgxLjIpIj4KICAgICAgPHJlY3QgeD0iMCIgeT0iMjU2IiB3aWR0aD0iMTkyIiBoZWlnaHQ9IjgiIHJ4PSI0Ii8+CiAgICAgIDxyZWN0IHg9IjI0IiB5PSIxOTIiIHdpZHRoPSIzMiIgaGVpZ2h0PSI2NCIgcng9IjYiLz4KICAgICAgPHJlY3QgeD0iNzIiIHk9IjE2MCIgd2lkdGg9IjMyIiBoZWlnaHQ9Ijk2IiByeD0iNiIvPgogICAgICA8cmVjdCB4PSIxMjAiIHk9IjEyOCIgd2lkdGg9IjMyIiBoZWlnaHQ9IjEyOCIgcng9IjYiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMwMCwyNDApIiBvcGFjaXR5PSIwLjkiPgogICAgICA8cmVjdCB4PSItOCIgeT0iLTY0IiB3aWR0aD0iMTYiIGhlaWdodD0iMjAiIHJ4PSIzIi8+CiAgICAgIDxyZWN0IHg9Ii04IiB5PSItNjQiIHdpZHRoPSIxNiIgaGVpZ2h0PSIyMCIgcng9IjMiIHRyYW5zZm9ybT0icm90YXRlKDQ1KSIvPgogICAgICA8cmVjdCB4PSItOCIgeT0iLTY0IiB3aWR0aD0iMTYiIGhlaWdodD0iMjAiIHJ4PSIzIiB0cmFuc2Zvcm09InJvdGF0ZSg5MCkiLz4KICAgICAgPHJlY3QgeD0iLTgiIHk9Ii02NCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjIwIiByeD0iMyIgdHJhbnNmb3JtPSJyb3RhdGUoMTM1KSIvPgogICAgICA8cmVjdCB4PSItOCIgeT0iLTY0IiB3aWR0aD0iMTYiIGhlaWdodD0iMjAiIHJ4PSIzIiB0cmFuc2Zvcm09InJvdGF0ZSgxODApIi8+CiAgICAgIDxyZWN0IHg9Ii04IiB5PSItNjQiIHdpZHRoPSIxNiIgaGVpZ2h0PSIyMCIgcng9IjMiIHRyYW5zZm9ybT0icm90YXRlKDIyNSkiLz4KICAgICAgPHJlY3QgeD0iLTgiIHk9Ii02NCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjIwIiByeD0iMyIgdHJhbnNmb3JtPSJyb3RhdGUoMjcwKSIvPgogICAgICA8cmVjdCB4PSItOCIgeT0iLTY0IiB3aWR0aD0iMTYiIGhlaWdodD0iMjAiIHJ4PSIzIiB0cmFuc2Zvcm09InJvdGF0ZSgzMTUpIi8+CiAgICAgIDxjaXJjbGUgcj0iNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLXdpZHRoPSIxNiIvPgogICAgPC9nPgogIDwvZz4KICA8ZyBmaWxsPSIjRkZGRkZGIiBmb250LWZhbWlseT0iJ05vdG8gU2FucyBKUCcsJ0hpcmFnaW5vIFNhbnMnLCdZdSBHb3RoaWMnLHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI3MDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPgogICAgPHRleHQgeD0iMjU2IiB5PSIzODAiIGZvbnQtc2l6ZT0iNTAiPuWWtuS4muaUr+aPtDwvdGV4dD4KICAgIDx0ZXh0IHg9IjI1NiIgeT0iNDQwIiBmb250LXNpemU9IjQ2Ij7jgrfjgrnjg4bjg6A8L3RleHQ+CiAgPC9nPgo8L3N2Zz4K">
    
    <!-- iPhone用アイコン（動的生成） -->
    <link id="apple-touch-icon" rel="apple-touch-icon" sizes="180x180">
    
    <!-- PWA manifest（動的生成） -->
    <link id="app-manifest" rel="manifest">
    
    <!-- アイコン自動生成スクリプト -->
    <script>
    (function() {
        const SVG_SOURCE = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="512" height="512">
  <!-- 白背景 -->
  <rect width="512" height="512" fill="#FFFFFF"/>

  <!-- 左側：グラフィック部分（絶対座標・中央配置） -->
  <g fill="#005BAC">
    <!-- ベースライン -->
    <rect x="60" y="320" width="160" height="8" rx="4"/>
    
    <!-- 棒グラフ（3本・適切なサイズ） -->
    <rect x="75" y="270" width="28" height="50" rx="4"/>
    <rect x="115" y="240" width="28" height="80" rx="4"/>
    <rect x="155" y="210" width="28" height="110" rx="4"/>

    <!-- 歯車（右上・バランス良い配置） -->
    <g transform="translate(140,180)">
      <!-- 歯車の突起（8本） -->
      <rect x="-4" y="-32" width="8" height="16" rx="2"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(45)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(90)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(135)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(180)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(225)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(270)"/>
      <rect x="-4" y="-32" width="8" height="16" rx="2" transform="rotate(315)"/>
      
      <!-- 歯車本体 -->
      <circle r="24" fill="#005BAC"/>
      <!-- 中心穴 -->
      <circle r="9" fill="#FFFFFF"/>
    </g>
  </g>

  <!-- 右側：テキスト部分（見切れ対策済み） -->
  <g fill="#005BAC" font-family="system-ui, -apple-system, 'Hiragino Sans', 'Noto Sans JP', sans-serif" font-weight="bold">
    <!-- x=240, font-size=70 → 右端約240+280=520px → 安全域なし -->
    <!-- x=220, font-size=70 → 右端約220+280=500px → 12pxの安全域 -->
    <text x="220" y="250" font-size="70" text-anchor="start">営業支援</text>
    <text x="220" y="320" font-size="70" text-anchor="start">システム</text>
  </g>
</svg>`;


        function svgToPng(svgText, size) {
            return new Promise((resolve) => {
                const img = new Image();
                const svgBlob = new Blob([svgText], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, size, size);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = url;
            });
        }

        async function setupIcons() {
            try {
                // iPhone用180x180 PNG生成
                const png180 = await svgToPng(SVG_SOURCE, 180);
                document.getElementById('apple-touch-icon').href = png180;

                // PWA用PNG生成
                const png192 = await svgToPng(SVG_SOURCE, 192);
                const png512 = await svgToPng(SVG_SOURCE, 512);

                // PWA manifest生成
                const manifest = {
                    name: '営業支援システム',
                    short_name: '営業支援',
                    start_url: './',
                    display: 'standalone',
                    background_color: '#005BAC',
                    theme_color: '#005BAC',
                    icons: [
                        { src: png192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
                        { src: png512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' },
                        { src: png180, sizes: '180x180', type: 'image/png' }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
                const manifestUrl = URL.createObjectURL(manifestBlob);
                document.getElementById('app-manifest').href = manifestUrl;

                console.log('アプリアイコンの設定完了');
            } catch (error) {
                console.warn('アイコン生成エラー:', error);
            }
        }

        // ページ読み込み後に実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupIcons);
        } else {
            setupIcons();
        }
    })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'ヒラギノ角ゴ ProN', Meiryo, sans-serif;
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
            font-size: 16px;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        body.modal-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .user-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .login-user-info {
            font-size: 18px;
            font-weight: bold;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            white-space: nowrap;
        }

        .view-selector-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .view-selector-label {
            color: white;
            font-weight: 500;
        }

        .view-selector {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
            min-width: 180px;
        }

        .view-permission-info {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .permission-edit {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }

        .permission-view {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-auth {
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-auth:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
        }

        .current-date-header {
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-month-selector {
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .global-month-selector option {
            color: #333;
            background: #fff;
        }

        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .progress-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .progress-card {
            background: #e3f2fd !important;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: none !important;
            position: relative;
        }

        .progress-card:hover,
        .progress-card:active,
        .progress-card:focus {
            background: #e3f2fd !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .progress-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            line-height: 1.2;
            min-height: 2.4em;
            font-weight: 600;
            color: #333;
        }

        .progress-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #007bff;
        }

        .progress-detail {
            font-size: 16px;
            margin-bottom: 4px;
            color: #333;
            font-weight: 600;
        }

        .progress-rate {
            font-size: 14px;
            font-weight: bold;
        }

        .rate-positive { color: #2E7D32; }
        .rate-negative { color: #D32F2F; }

        .progress-chart {
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            margin-top: 8px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .funnel-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .funnel-item {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .funnel-item:hover,
        .funnel-item:active {
            background: white !important;
            transform: none !important;
        }

        .funnel-label {
            font-size: 12px;
            margin-bottom: 3px;
            color: #333;
        }

        .funnel-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .control-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 40px 14px 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: #fff;
            color: #333;
        }

        .search-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-size: 18px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .btn:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-settings {
            background: linear-gradient(135deg, #FFD700 0%, #FFEA00 100%);
            color: #333;
        }

        .filter-section {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .filter-select, .sort-select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            min-height: 48px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .sort-section {
            margin-bottom: 16px;
        }

        .sort-select {
            width: 100%;
        }

        .cards-section {
            padding: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 12px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .sort-info {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
        }

        /* PCテーブル用CSS */
        .desktop-table-container {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .juku-table {
    width: 100%;
    table-layout: fixed;
    font-size: 14px;
    border-collapse: collapse;
}

/* 列幅の最適化 */
.col-level { width: 8px; padding: 0 !important; }
.col-name { width: 180px; }
.col-prev-amount, .col-current-amount { width: 100px; text-align: center; }
.col-prev-prob, .col-current-prob { width: 80px; text-align: center; }
.col-change { width: 90px; text-align: center; }
.col-detail { width: 70px; text-align: center; }


        .juku-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        .juku-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .juku-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .juku-table tbody tr:nth-child(odd) {
            background: #fff;
        }

        .juku-table tbody tr:hover {
            background: #e3f2fd !important;
        }

        .col-level {
            width: 8px;
            padding: 0 !important;
        }

        .level-indicator {
            width: 8px;
            height: 40px;
            display: block;
        }

        .level-0 { background: #fff; }
        .level-1 { background: #BBDEFB; }
        .level-2 { background: #C8E6C9; }
        .level-3 { background: #FFF9C4; }
        .level-4 { background: #FFCDD2; }

        .editable-cell {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-cell:hover {
            background: rgba(0,123,255,0.1);
        }

        .change-positive { color: #2E7D32; font-weight: bold; }
        .change-negative { color: #D32F2F; font-weight: bold; }
        .change-neutral { color: #666; }

        .detail-btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .detail-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 1024px) {
            .desktop-table-container {
                display: none;
            }
        }

        @media (min-width: 1025px) {
            .mobile-cards-container {
                display: none;
            }
        }

        .card {
            background: #fff !important;
            color: #333 !important;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: none !important;
            position: relative;
        }

        .card:hover,
        .card:active,
        .card:focus {
            background: #fff !important;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
        }

        .card-level-0 { background: #fff !important; border-left: 6px solid #fff; }
        .card-level-1 { background: #fff !important; border-left: 6px solid #BBDEFB; }
        .card-level-2 { background: #fff !important; border-left: 6px solid #C8E6C9; }
        .card-level-3 { background: #fff !important; border-left: 6px solid #FFF9C4; }
        .card-level-4 { background: #fff !important; border-left: 6px solid #FFCDD2; }

        .card-header-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .card-title-clickable {
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            color: #333 !important;
            text-decoration: underline;
            text-decoration-color: rgba(0,0,0,0.3);
            transition: text-decoration-color 0.2s ease;
        }

        .card-title-clickable:hover {
            text-decoration-color: #007bff;
        }

        .month-selector {
            display: block;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.8);
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }

        .annual-metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }

        .annual-metric {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .annual-metric-label {
            font-size: 12px;
            margin-bottom: 2px;
            color: #333;
            font-weight: 500;
            line-height: 1.2;
        }

        .annual-metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .monthly-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 6px;
        }

        .month-data-column {
            text-align: center;
        }

        .month-data-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .month-data-content {
            background: rgba(255,255,255,0.4);
            padding: 10px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .forecast-amount {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .forecast-probability {
            font-size: 14px;
            color: #333;
            opacity: 0.9;
            font-weight: 600;
        }

        .memo-comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .memo-column {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .memo-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .memo-content {
            font-size: 13px;
            line-height: 1.3;
            color: #333;
            min-height: 2.6em;
            word-wrap: break-word;
            white-space: pre-wrap;
            cursor: pointer;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.2);
        }

        .last-updated {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
            cursor: pointer;
        }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            color: rgba(0,0,0,0.9);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .action-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .action-btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
        }

        .annual-materials-mini {
            background: rgba(255,255,255,0.4);
            border: 1px solid rgba(0,176,255,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .annual-materials-mini-title {
            font-size: 14px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 8px;
            text-align: center;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(25,118,210,0.2);
        }

        .materials-mini-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .materials-mini-item {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            padding: 8px;
        }

        .materials-mini-header {
            font-size: 12px;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 6px;
            text-align: center;
        }

        .material-mini-field {
            margin-bottom: 6px;
        }

        .material-mini-label {
            font-size: 11px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .material-mini-select,
        .material-mini-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
            font-size: 12px;
            background: white;
            color: #333;
            box-sizing: border-box;
        }

        .material-mini-input::placeholder {
            color: rgba(0,0,0,0.5);
            font-size: 11px;
        }

        .comparison-positive { color: #2E7D32; }
        .comparison-negative { color: #D32F2F; }
        .comparison-neutral { color: #666; }

        .change-indicator {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
            border-left: 4px solid #c62828;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        .modal-graph {
            max-width: 800px;
            max-height: 90vh;
        }

        .modal-history {
            max-width: 900px;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: white;
            color: #333;
        }

        .form-input:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .form-input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .graph-container {
            margin: 20px 0;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            height: 300px;
        }

        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            color: #E0E0E0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #E0E0E0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            color: #333;
        }
        
        .settings-section h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .monthly-data-section {
            background: rgba(255,255,255,0.6);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .monthly-row {
    display: grid;
    grid-template-columns: 70px 1fr 1fr 20px; /* 月名欄縮小 */
    gap: 8px; /* ギャップ縮小 */
    align-items: center;
    margin-bottom: 8px;
}


        .month-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            text-align: center;
        }

        .monthly-input {
    padding: 6px 8px; /* パディング縮小 */
    border: 1px solid rgba(0,0,0,0.3);
    border-radius: 4px;
    font-size: 14px; /* フォントサイズ縮小 */
    text-align: right;
    background: rgba(255,255,255,0.9);
    color: #333;
    box-sizing: border-box;
    width: 100%;
    max-width: 120px; /* 最大幅制限 */
}


        .monthly-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .monthly-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .monthly-history-container {
            max-height: 32vh;
            overflow-y: auto;
            padding: 10px;
        }

        /* コンパクトモーダル用CSS */
        .compact-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
        }

        .compact-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .compact-month-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compact-data-grid {
            display: grid;
            grid-template-columns: 1fr 80px 2fr;
            gap: 8px;
            align-items: center;
        }

        .compact-field {
            background: rgba(255,255,255,0.8);
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .compact-field-label {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            margin-bottom: 2px;
        }

        .compact-field-value {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .compact-memo {
            font-size: 12px;
            line-height: 1.3;
            color: #333;
            max-height: 40px;
            overflow: hidden;
            word-wrap: break-word;
        }

        .history-month-row {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f9f9f9;
        }

        .history-month-row.past-month {
            opacity: 0.75;
            background: #f5f5f5;
        }

        .history-month-label {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .readonly-badge {
            background: #9E9E9E;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .history-data-grid {
            display: grid;
            grid-template-columns: 1fr 120px 2fr;
            gap: 12px;
            align-items: start;
        }

        .history-field label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
        }

        .history-input, .history-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .history-memo {
            width: 100%;
            min-height: 60px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .history-input:read-only, 
        .history-select:disabled, 
        .history-memo:read-only {
            background: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.7;
        }
      
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .toast-error { background: linear-gradient(135deg, #F44336, #FF5252); }
        .toast-info { background: linear-gradient(135deg, #2196F3, #007bff); }

        .editable-field {
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-field:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .editable-field .display-value {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .editable-field .edit-input,
        .editable-field .edit-select {
            width: calc(100% - 12px);
            padding: 6px 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: white;
            color: #333;
        }

        @media (prefers-contrast: high) {
            .card {
                border: 2px solid #000;
            }
            
            .progress-bar {
                border: 1px solid #000;
            }
        }
        /* カード表示改善 */
/* 既存のcard-level背景色指定を無効化 */
.card-level-0, .card-level-1, .card-level-2, .card-level-3, .card-level-4 {
    background: inherit !important;
}

/* カード背景をテーブルの縞模様に統一 */
.mobile-cards-container .card {
    background: #fff !important;
}

.mobile-cards-container .card:nth-child(even) {
    background: #f8f9fa !important;
}

/* カードのレベルインジケーター（左＋上ライン）を鮮やかに */
.mobile-cards-container .card.card-level-0 { 
    border-left: 4px solid #9E9E9E !important;
    border-top: 4px solid #9E9E9E !important;
}
.mobile-cards-container .card.card-level-1 { 
    border-left: 4px solid #2196F3 !important;
    border-top: 4px solid #2196F3 !important;
}
.mobile-cards-container .card.card-level-2 { 
    border-left: 4px solid #4CAF50 !important;
    border-top: 4px solid #4CAF50 !important;
}
.mobile-cards-container .card.card-level-3 { 
    border-left: 4px solid #FF9800 !important;
    border-top: 4px solid #FF9800 !important;
}
.mobile-cards-container .card.card-level-4 { 
    border-left: 4px solid #F44336 !important;
    border-top: 4px solid #F44336 !important;
}

/* スマホ版奇数カードオーバーレイ */
@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: rgba(173, 216, 230, 0.15);
        border-radius: 12px;
        z-index: 1;
    }
    
    .mobile-cards-container .card > * {
        position: relative;
        z-index: 2;
    }
}

/* 閲覧専用カードとの競合解決 */
.read-only-card {
    box-shadow: inset 0 0 0 2px #ffc107 !important;
    border: none !important;
}


        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-right {
                align-items: stretch;
            }
            
            .user-info-section {
                align-items: stretch;
            }
            
            .view-selector-section {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .view-selector {
                min-width: auto;
            }

            .current-date-header {
                margin-top: 12px;
            }

            .progress-cards {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .control-buttons {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin-bottom: 8px;
                min-height: 48px;
                font-size: 16px;
            }

            .filter-section {
                flex-direction: column;
            }

            .cards-section {
                display: block;
            }

            .section-header {
                margin-bottom: 12px;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }

            .monthly-comparison-section {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .materials-mini-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .annual-metrics-row {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }

            .form-input, .form-select {
                font-size: 16px;
                padding: 14px 12px;
            }
        }

        @media (min-width: 1200px) {
            .cards-section .card {
                display: inline-block;
                width: calc(50% - 8px);
                margin-right: 16px;
                vertical-align: top;
            }

            .cards-section .card:nth-child(even) {
                margin-right: 0;
            }
        }
        /* 1. スマホ表示のみ：編集可能箇所を薄い緑色で強調 */
@media (max-width: 1024px) {
    .monthly-comparison-section .month-data-column:nth-child(2) .editable-field {
        background: rgba(76, 175, 80, 0.12) !important;
        border: 1px solid rgba(76, 175, 80, 0.25);
        border-radius: 6px;
        padding: 6px 8px;
    }
    
    .memo-comparison-section .memo-column:nth-child(2) .memo-content {
        background: rgba(76, 175, 80, 0.08) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
        border-radius: 6px;
        padding: 8px;
    }
}

/* 2. 縞模様を濃いめに調整 */
.juku-table tbody tr:nth-child(even) {
    background: #f0f0f0 !important; /* #f8f9fa → #f0f0f0 */
}

.mobile-cards-container .card:nth-child(even) {
    background: #f0f0f0 !important;
}

@media (max-width: 1024px) {
    .mobile-cards-container .card:nth-child(odd)::after {
        background: rgba(173, 216, 230, 0.22); /* 0.15 → 0.22 */
    }
}

/* 3. ファネル80/90/100の青色強調 */
.funnel-section .funnel-item:nth-child(4), /* 80 */
.funnel-section .funnel-item:nth-child(5), /* 90 */
.funnel-section .funnel-item:nth-child(6)  /* 100 */ {
    background: rgba(33, 150, 243, 0.1) !important;
    border: 1px solid rgba(33, 150, 243, 0.25);
}

.funnel-section .funnel-item:nth-child(4):hover,
.funnel-section .funnel-item:nth-child(5):hover,
.funnel-section .funnel-item:nth-child(6):hover {
    background: rgba(33, 150, 243, 0.15) !important;
    border-color: rgba(33, 150, 243, 0.35);
}

/* 4. 6項目ファネルのレスポンシブ対応 */
@media (max-width: 768px) {
    .funnel-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 6px;
    }
    
    .funnel-label {
        font-size: 11px;
        margin-bottom: 3px;
        color: #333;
    }
    
    .funnel-value {
        font-size: 13px;
        font-weight: bold;
        color: #333;
    }
}

@media (max-width: 480px) {
    .funnel-section {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(3, 1fr);
    }
}

        /* PC版レイアウト（1025px以上） */
@media (min-width: 1025px) {
    .container {
        display: flex;
        flex-direction: column;
    }
    .header-section { order: 0; }
    #normalDashboardContent { order: 1; display: flex; flex-direction: column; }
    #masterViewContent { order: 2; }
    
    /* 4枚カードを確実に2×2グリッドレイアウトに設定 */
    .progress-main-cards {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        margin-bottom: 16px;
    }
    
    /* 内側セクションの順序制御 */
    #normalDashboardContent .progress-main-cards { order: 1; }
    #normalDashboardContent .progress-middle-section { order: 2; }
    #normalDashboardContent .funnel-section { order: 3; }
    #normalDashboardContent .control-section { order: 4; }
    #normalDashboardContent .cards-section { order: 5; }
}

/* スマホ版レイアウト（1024px以下） */
@media (max-width: 1024px) {
    .container {
        padding: 12px;
        display: flex;
        flex-direction: column;
    }
    .header-section { order: 0; }  /* ヘッダーを最優先 */
    #normalDashboardContent { order: 1; display: flex; flex-direction: column; }
    #masterViewContent { order: 2; }
    
    /* スマホ版の内側セクション順序 */
    #normalDashboardContent .progress-middle-section { order: 1; }
    #normalDashboardContent .funnel-section { order: 2; }
    #normalDashboardContent .control-section { order: 3; }
    #normalDashboardContent .cards-section { order: 4; }
    #normalDashboardContent .progress-main-cards { order: 5; }
}

        /* カード色分け */
.progress-card-monthly-profit {
    background: #2E7D32 !important;
    color: #FFFFFF !important;
}
.progress-card-yearly-profit {
    background: #0D47A1 !important;
    color: #FFFFFF !important;
}
.progress-card-yearly-sales {
    background: #BBDEFB !important;
    color: #0D47A1 !important;
}
.progress-card-prospect {
    background: #E3F2FD !important;
    color: #0D47A1 !important;
}

/* 新4枚カードの基本レイアウト */
.card-metrics {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    line-height: 1.4;
}

.metric-label {
    font-weight: 600;
    color: inherit;
    min-width: 60px;
}

.metric-value {
    font-weight: bold;
    text-align: right;
    flex: 1;
}

/* カードタイトルを少し大きく */
.progress-card h3 {
    font-size: 19px !important;
    font-weight: 700 !important;
    margin-bottom: 8px;
    text-align: center;
    color: inherit;
}

/* 視認性重視の色分け（淡色背景＋黒文字） */
.new-monthly-profit-card {
    background: #E8F5E8 !important; /* 緑系・濃い */
    color: #1B5E20 !important;
}

.new-monthly-sales-card {
    background: #F1F8E9 !important; /* 緑系・薄い */
    color: #2E7D32 !important;
}

.new-cumulative-profit-card {
    background: #E3F2FD !important; /* 水色系・濃い */
    color: #0D47A1 !important;
}

.new-cumulative-sales-card {
    background: #E8F4FD !important; /* 水色系・薄い */
    color: #1565C0 !important;
}
        /* 自動計算フィールド（手入力不可）の背景色 */
.auto-calculated-field {
    background: #F8F9FA !important;
    border: 1px solid #DEE2E6 !important;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: default;
    color: #495057 !important;
}

.auto-calculated-field:hover {
    background: #E9ECEF !important;
}

/* 差額のマイナス表示（赤字） */
.metric-value.negative {
    color: #D32F2F !important;
    font-weight: bold;
}

.metric-value.positive {
    color: inherit;
}

.metric-value.neutral {
    color: inherit;
}
        
/* 中段カード */
.progress-middle-card {
    background: #FFF3CD;
    border: 1px solid #FFE082;
    border-radius: 12px;
    padding: 12px 20px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.progress-middle-content {
    font-size: 13px;
    font-weight: 600;
    color: #333;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
@media (max-width: 1024px) {
    .progress-middle-content {
        font-size: 12px;
        color: #333; /* 黒色で統一 */
    }
}

/* FABボタン */
.fab-settings {
    position: fixed;
    bottom: 100px;
    left: 20px;
    width: 56px;
    height: 56px;
    background: #CD853F;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(205, 133, 63, 0.4);
    z-index: 100;
    transition: all 0.2s ease;
}
.fab-add {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 56px;
    height: 56px;
    background: #007bff;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    z-index: 100;
    transition: all 0.2s ease;
}
.fab-settings:hover, .fab-add:hover {
    transform: scale(1.05);
}
@media (min-width: 1025px) {
    .fab-settings, .fab-add {
        display: none;
    }
}
        .editable-profit-field {
    background: #FCE4EC !important;
    border: 1px solid #E91E63 !important;
    color: #880E4F !important;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-block;
    min-width: 60px;
    text-align: right;
    font-weight: bold;
}
.editable-profit-field:hover {
    background: #F8BBD9 !important;
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

        .master-view-container { padding: 20px; }
.master-staff-section {
    margin-bottom: 32px;
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    background: #fafafa;
}
.master-staff-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 16px;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
}
.master-main-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}
.master-middle-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}
.master-middle-card {
    background: #FFF3CD;
    border: 1px solid #FFE082;
    border-radius: 8px;
    padding: 12px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #333; /* 黒色に変更 */
    text-align: center;
}
@media (max-width: 1024px) {
    .master-view-container { display: none !important; }
    .master-view-option { display: none !important; }
}
/* 中段黄色カードの見込み値強調 */
.value-emphasis {
    font-size: 18px !important;
    font-weight: 800 !important;
    color: #333 !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

@media (max-width: 1024px) {
    .value-emphasis {
        font-size: 16px !important;
    }
}

/* 売上カードの編集機能を完全無効化 */
.monthly-sales-card .editable-profit-field,
.cumulative-sales-card .editable-profit-field {
    background: transparent !important;
    border: none !important;
    color: inherit !important;
    cursor: default !important;
    pointer-events: none !important;
}

/* モーダル内のボタン表示確保 */
.modal .control-buttons {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 12px !important;
}

/* 4枚カードの色分け */
.monthly-profit-card {
    background: #E8F5E8 !important;
    color: #1B5E20 !important;
}

.monthly-sales-card {
    background: #F1F8E9 !important;
    color: #2E7D32 !important;
}

.cumulative-profit-card {
    background: #E3F2FD !important;
    color: #0D47A1 !important;
}

.cumulative-sales-card {
    background: #E8F4FD !important;
    color: #1565C0 !important;
}
/* 追加：個人設定モーダルの月別入力欄をスマホ対応（影響範囲を限定） */
#personalSettingsModal .monthly-row {
    display: grid;
    grid-template-columns: 70px 130px 130px 1fr; /* 固定幅で横スクロール防止 */
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
}

#personalSettingsModal .monthly-input {
    padding: 6px 8px;
    border: 1px solid rgba(0,0,0,0.3);
    border-radius: 4px;
    font-size: 14px;
    text-align: right;
    background: rgba(255,255,255,0.9);
    color: #333;
    width: 100%;
    max-width: 130px;
    box-sizing: border-box;
}

/* スマホ専用：さらに小さく調整 */
@media (max-width: 768px) {
    #personalSettingsModal .monthly-data-section {
        padding: 12px;
        overflow-x: hidden; /* 横スクロール完全防止 */
    }
    
    #personalSettingsModal .monthly-row {
        grid-template-columns: 60px 110px 110px 1fr; /* スマホでさらに縮小 */
        gap: 6px;
        margin-bottom: 6px;
    }
    
    #personalSettingsModal .monthly-row > :nth-child(4) {
        display: none; /* 4番目の空セルを非表示 */
    }
    
    #personalSettingsModal .monthly-input {
        font-size: 13px;
        padding: 4px 6px;
        max-width: 110px;
    }
    
    #personalSettingsModal .month-name {
        font-size: 12px;
    }
}
        /* スマホ表示での確実な順序制御 */
@media (max-width: 1024px) {
    /* コンテナのflex設定を確実に適用 */
    #normalDashboardContent {
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* 順序の確実な適用（既存設定の強化） */
    #normalDashboardContent .progress-middle-section { 
        order: 10 !important; 
    }
    #normalDashboardContent .funnel-section { 
        order: 20 !important; 
    }
    #normalDashboardContent .control-section { 
        order: 30 !important; 
    }
    #normalDashboardContent .cards-section { 
        order: 40 !important; 
    }
    #normalDashboardContent .progress-main-cards { 
        order: 50 !important; 
    }
}
/* スマホ版で四角ボタンを非表示 */
@media (max-width: 1024px) {
    .control-buttons {
        display: none !important;
    }
    
    /* FABボタンを確実に表示 */
    .fab-settings, .fab-add {
        display: block !important;
    }
}

/* PC版でFABボタンを非表示（既存の設定を強化） */
@media (min-width: 1025px) {
    .fab-settings, .fab-add {
        display: none !important;
    }
    
    /* 四角ボタンを確実に表示 */
    .control-buttons {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
    }
}

        /* === レイアウト重なり問題の完全解消 === */

/* 4枚カードの安定配置 */
.progress-main-cards {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
    align-items: stretch !important;
}

/* 中段カードを3枚対応のグリッド配置 */
.progress-middle-section {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
    align-items: stretch !important;
}

/* 3枚目カードを下段全幅表示 */
.progress-middle-card.full-width {
    grid-column: 1 / -1 !important;
}

/* ファネルの6項目安定配置 */
.funnel-section {
    display: grid !important;
    grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
    gap: 8px !important;
    margin-bottom: 16px !important;
}

/* 各セクション間の確実な余白確保 */
.header-section,
.progress-main-cards,
.progress-middle-section,
.funnel-section,
.control-section,
.cards-section {
    margin-bottom: 16px !important;
    position: relative !important;
    z-index: auto !important;
}

/* スマホ版レイアウト調整 */
@media (max-width: 1024px) {
    .progress-main-cards {
        grid-template-columns: 1fr !important;
    }
    
    .progress-middle-section {
        grid-template-columns: 1fr !important;
    }
    
    .progress-middle-card.full-width {
        grid-column: auto !important;
    }
    
    .funnel-section {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

@media (max-width: 480px) {
    .funnel-section {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

/* マスタービューの中段カードも同様に調整 */
.master-middle-cards {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px !important;
    margin-bottom: 16px !important;
}

.master-middle-card.full-width {
    grid-column: 1 / -1 !important;
}

@media (max-width: 1024px) {
    .master-middle-cards {
        grid-template-columns: 1fr !important;
    }
    
    .master-middle-card.full-width {
        grid-column: auto !important;
    }
}
        
    </style>
  <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { initializeFirestore, doc, getDoc, getDocs, collection, query, where, setDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Firebase設定情報（確実に定義）
  const firebaseConfig = {
    apiKey: "AIzaSyC_EUgAAVFfk0TonQgKVMxs8TcuvFdXKIQ",
    authDomain: "eigyo-shiendashboard.firebaseapp.com",
    projectId: "eigyo-shiendashboard",
    storageBucket: "eigyo-shiendashboard.firebasestorage.app",
    messagingSenderId: "665404365898",
    appId: "1:665404365898:web:a60374339c99ea5c16dab3"
  };

  const app = initializeApp(firebaseConfig);
  window.firebaseAuth = getAuth(app);
  
 // 🆕 企業ネットワーク対応：HTTP 400エラー解消（修正版）
window.db = initializeFirestore(app, {
  experimentalForceLongPolling: true,       // 企業ネットワーク対応（これだけで十分）
  useFetchStreams: false                    // プロキシ環境対応
});


  window.firebaseImports = {
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    doc,
    getDoc,
    getDocs,      
    collection,   
    query,        
    where,        
    setDoc,
    deleteDoc,
    serverTimestamp
  };
</script>

</head>
<body>
    <div class="container">
        <div class="header-section">
    <div class="header-left">
        <div class="header-title">上半期営業支援ダッシュボード</div>
        <div class="current-date-header" id="currentDateHeader">
            <span id="currentDateDisplay">2025年8月</span>
            <select class="global-month-selector" id="globalMonthSelector" onchange="changeAllCardsDisplayMonth(this.value)">
            </select>
        </div>
    </div>
    
    <div class="header-right">
        <div class="user-info-section">
            <div class="login-user-info" id="loginUserInfo">
                <span class="login-status">未ログイン</span>
            </div>
            
            <div class="view-selector-section" id="viewSelectorSection" style="display: none;">
                <label class="view-selector-label">データ表示:</label>
                <select class="view-selector" id="viewSelector" onchange="changeViewTarget()">
                    <option value="">選択してください</option>
                </select>
                <span class="view-permission-info" id="viewPermissionInfo"></span>
            </div>
        </div>
        
        <div class="auth-buttons" id="authButtons">
            <button class="btn btn-auth" onclick="quickLogin()" id="loginBtn">🔐 ログイン</button>
            <button class="btn btn-auth" onclick="quickLogout()" id="logoutBtn" style="display: none;">🚪 ログアウト</button>
        </div>
    </div>
</div>
        
        <!-- progress-sectionラッパーを削除し、各セクションをcontainerの直接の子に -->
        <div id="normalDashboardContent">
<div class="progress-main-cards">
    <!-- 月別粗利カード -->
    <div class="progress-card monthly-profit-card">
        <h3>月別粗利</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="monthlyProfitTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value editable-profit-field" onclick="editMonthlyProfitInline(this)" id="monthlyProfitActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="monthlyProfitDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="monthlyProfitRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 月別売上カード -->
    <div class="progress-card monthly-sales-card">
        <h3>月別売上</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="monthlySalesTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value" id="monthlySalesActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="monthlySalesDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="monthlySalesRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 累積粗利カード -->
    <div class="progress-card cumulative-profit-card">
        <h3>累積粗利</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="cumulativeProfitTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value editable-profit-field" onclick="editCumulativeProfitInline(this)" id="cumulativeProfitActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="cumulativeProfitDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="cumulativeProfitRate">0.0%</span>
            </div>
        </div>
    </div>

    <!-- 累積売上カード -->
    <div class="progress-card cumulative-sales-card">
        <h3>累積売上</h3>
        <div class="card-metrics">
            <div class="metric-row">
                <span class="metric-label">目標:</span>
                <span class="metric-value" id="cumulativeSalesTarget">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">実績:</span>
                <span class="metric-value" id="cumulativeSalesActual">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">差額:</span>
                <span class="metric-value" id="cumulativeSalesDiff">¥0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">達成率:</span>
                <span class="metric-value" id="cumulativeSalesRate">0.0%</span>
            </div>
        </div>
    </div>
</div>

<div class="progress-middle-section">
    <div class="progress-middle-card">
        <div class="progress-middle-content" id="salesProspectDisplay">
            売上増見込 ¥0/¥0 (0.0%)
        </div>
    </div>
    <div class="progress-middle-card">
        <div class="progress-middle-content" id="profitProspectDisplay">
            粗利増見込 ¥0/¥0 (0.0%)
        </div>
    </div>
    <!-- 🆕 3枚目カード追加 -->
    <div class="progress-middle-card full-width">
        <div class="progress-middle-content" id="personalIncreaseTargetDisplay">
            個人設定売上増目標 0.0万円 | 粗利率 0.0%
        </div>
    </div>
</div>


<div class="funnel-section">
    <div class="funnel-item" onclick="filterByProbability('under50')" aria-label="確率50%未満で絞り込み">
        <div class="funnel-label">50%未満</div>
        <div class="funnel-value" id="probUnder50">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('50-60')" aria-label="確率50-70%で絞り込み">
        <div class="funnel-label">50%-70%未満</div>
        <div class="funnel-value" id="prob5060">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('70')" aria-label="確率70%で絞り込み">
        <div class="funnel-label">70%以上</div>
        <div class="funnel-value" id="prob70">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('80')" aria-label="確率80%で絞り込み">
        <div class="funnel-label">80%以上</div>
        <div class="funnel-value" id="prob80">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('90')" aria-label="確率90%で絞り込み">
        <div class="funnel-label">90%以上</div>
        <div class="funnel-value" id="prob90">¥0万</div>
    </div>
    <div class="funnel-item" onclick="filterByProbability('100')" aria-label="確率100%で絞り込み">
        <div class="funnel-label">100%</div>
        <div class="funnel-value" id="prob100">¥0万</div>
    </div>
</div>


        <div class="control-section">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 塾名で検索..." id="searchInput" aria-label="塾名で検索">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="openNewCardModal()" aria-label="塾登録を開く">
    ➕ 塾登録
</button>
<button class="btn btn-settings" onclick="openPersonalSettingsModal()" aria-label="個人設定を開く">
    ⚙️ 個人設定
</button>
            </div>

            <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%; margin-bottom: 16px;" aria-label="フィルタをクリア">
                🔄 フィルタクリア
            </button>

            <div class="sort-section">
                <select class="sort-select" id="sortSelect" onchange="applySorting()" aria-label="並び替え">
                    <option value="sales-desc">💰 売上増見込順（大→小）</option>
                    <option value="sales-asc">💰 売上増見込順（小→大）</option>
                    <option value="updated-desc">📅 最終更新日順（新→古）</option>
                    <option value="updated-asc">📅 最終更新日順（古→新）</option>
                    <option value="probability-desc">📈 受注確率順（高→低）</option>
                    <option value="probability-asc">📈 受注確率順（低→高）</option>
                </select>
            </div>

            <div class="filter-section">
                <select class="filter-select" id="statusFilter" onchange="applyFilters()" aria-label="区分で絞り込み">
                    <option value="all">すべて</option>
                    <option value="new">新規</option>
                    <option value="existing">既存</option>
                    <option value="former">元既存</option>
                </select>
               
                <select class="filter-select" id="areaFilter" onchange="applyFilters()" aria-label="エリアで絞り込み">
                </select>
            </div>
        </div>
    
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">塾一覧</div>
                <div class="sort-info" id="sortInfo">売上増見込順（大→小）</div>
            </div>
            
            <div class="desktop-table-container" id="desktopTableContainer">
                <table class="juku-table">
                    <thead>
    <tr>
        <th class="col-level"></th>
        <th class="col-name">塾名</th>
        <th class="col-prev-amount">先月見込</th>
        <th class="col-prev-prob">先月確率</th>
        <th class="col-current-amount">今月見込</th>
        <th class="col-current-prob">今月確率</th>
        <th class="col-change">変化</th>
        <th class="col-detail">詳細</th>
    </tr>
</thead>

                    <tbody id="jukuTableBody"></tbody>
                </table>
            </div>
            
            <div class="mobile-cards-container" id="cardsContainer"></div>
        </div>
    </div>
      <!-- マスタービューコンテンツ（初期は非表示） -->
    <div id="masterViewContent" style="display: none;">
    </div>
    </div>
  
    <div class="modal" id="personalSettingsModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">個人設定</div>
                <button class="close-btn" onclick="closePersonalSettingsModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="personalSettingsForm">
                <div class="settings-section">
                    <h4>基本情報</h4>
                    <div class="form-group">
                        <label class="form-label" for="userName">担当者名</label>
                        <input type="text" class="form-input" value="担当者" id="userName">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="profitRate">個人粗利率（%）</label>
                        <input type="number" class="form-input" value="0" step="0.1" id="profitRate" oninput="updatePersonalSalesTarget()">
                    </div>
                </div>

                <div class="settings-section">
                    <h4>年間目標</h4>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitTarget">年間粗利目標</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitTarget">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlyProfitIncreaseTarget">粗利増目標</label>
                        <input type="number" class="form-input" value="0" id="yearlyProfitIncreaseTarget" oninput="updatePersonalSalesTarget()">
                        <small>昨年からの粗利増加目標額</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="yearlySalesIncreaseTarget">年間売上増目標</label>
                        <input type="number" class="form-input" value="0" id="yearlySalesIncreaseTarget" readonly>
                        <small>粗利増目標を個人粗利率で逆算した値</small>
                    </div>
                    <!-- 🆕 個人設定売上増目標の追加 -->
                    <div class="form-group">
                        <label class="form-label" for="personalSalesIncreaseTarget">個人設定売上増目標</label>
                        <input type="number" class="form-input" value="0" id="personalSalesIncreaseTarget" placeholder="例: 5000000">
                        <small>自由設定の売上増加目標（中段カードに万円表示されます）</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>月別データ（会計年度：10月〜9月）</h4>
                    <div class="monthly-data-section">
                        <div class="monthly-row" style="font-weight: bold; margin-bottom: 8px;">
                            <div class="month-name">月</div>
                            <div style="text-align: center; font-size: 13px;">実績</div>
                            <div style="text-align: center; font-size: 13px;">目標</div>
                            <div></div>
                        </div>
                        <div id="monthlyProfitContainer"></div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closePersonalSettingsModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="progressGraphModal" role="dialog" aria-modal="true">
        <div class="modal-content modal-graph">
            <div class="modal-header">
                <div class="modal-title" id="graphModalTitle">年間進捗グラフ</div>
                <button class="close-btn" onclick="closeProgressGraphModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <div class="graph-container">
                <canvas id="progressChart" aria-label="進捗グラフ" role="img"></canvas>
            </div>
            
            <div class="graph-legend" id="graphLegend"></div>
        </div>
    </div>

    <div class="modal" id="monthlyHistoryModal" role="dialog" aria-modal="true">
        <div class="modal-content modal-history">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">月別履歴（表示専用）</div>
                <button class="close-btn" onclick="closeMonthlyHistoryModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <div class="monthly-history-container" id="monthlyHistoryContainer"></div>
            
            <div class="control-buttons">
                <button type="button" class="btn btn-primary" onclick="closeMonthlyHistoryModal()">閉じる</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">塾登録</div>
                <button class="close-btn" onclick="closeNewCardModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="newCardForm">
                <div class="form-group">
                    <label class="form-label" for="newJukuName">塾名 *</label>
                    <input type="text" class="form-input" placeholder="例：○○学習塾" required maxlength="100" id="newJukuName">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newJukuStatus">区分</label>
                    <select class="form-select" id="newJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">元既存</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newAddressInput">住所（市区町村）</label>
                    <input type="text" class="form-input" id="newAddressInput" placeholder="例: 豊中市、大阪市中央区">
                </div>

                <div class="form-group">
                    <label class="form-label" for="newAreaInput">エリア</label>
                    <input type="text" class="form-input" id="newAreaInput" placeholder="例: 大阪北部">
                </div>

                <div class="settings-section">
                    <h4>営業データ</h4>
                    <div class="form-group">
                        <label class="form-label" for="newSalesIncreaseForecast">売上増見込</label>
                        <input type="number" class="form-input" placeholder="3000000" id="newSalesIncreaseForecast">
                        <small>※この塾からの年間売上増見込額（A+B+C合計）</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProbability">成約確率</label>
                        <select class="form-select" id="newProbability">
                            <option value="40">50未満</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newProfitActual">年間粗利実績</label>
                        <input type="number" class="form-input" placeholder="0" id="newProfitActual" oninput="updateActualSales('new')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newSalesActual">年間売上実績</label>
                        <input type="number" class="form-input" placeholder="0" id="newSalesActual" readonly>
                    </div>
                    
                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">📚 年間教材管理</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">通年教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundOrder">注文状況</label>
                                    <select class="material-mini-select" id="newYearRoundOrder">
                                        <option value="false" selected>注文なし</option>
                                        <option value="true">注文あり</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newYearRoundPeriod">注文時期</label>
                                    <input type="text" class="material-mini-input" id="newYearRoundPeriod" placeholder="例: 4月上旬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">季節・入試教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalUsage">使用状況</label>
                                    <select class="material-mini-select" id="newSeasonalUsage">
    <option value="unknown" selected>不明</option>
    <option value="false">使用なし</option>
    <option value="true">使用あり</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="newSeasonalPeriod">使用時期</label>
                                    <input type="text" class="material-mini-input" id="newSeasonalPeriod" placeholder="例: 夏期講習">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeNewCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">登録</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editCardModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">塾編集</div>
                <button class="close-btn" onclick="closeEditCardModal()" aria-label="閉じる">&times;</button>
            </div>
            
            <form id="editCardForm">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label class="form-label" for="editJukuName">塾名</label>
                    <input type="text" class="form-input" id="editJukuName" required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editJukuStatus">区分</label>
                    <select class="form-select" id="editJukuStatus">
                        <option value="new">新規</option>
                        <option value="existing">既存</option>
                        <option value="former">元既存</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editAddressInput">住所（市区町村）</label>
                    <input type="text" class="form-input" id="editAddressInput">
                </div>

                <div class="form-group">
                    <label class="form-label" for="editAreaInput">エリア</label>
                    <input type="text" class="form-input" id="editAreaInput">
                </div>

                <div class="settings-section">
                    <h4>年間データ</h4>
                    <div class="form-group">
                        <label class="form-label" for="editProfitActual">年間粗利実績</label>
                        <input type="number" class="form-input" id="editProfitActual" oninput="updateActualSales('edit')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editSalesActual">年間売上実績</label>
                        <input type="number" class="form-input" id="editSalesActual" readonly>
                    </div>

                    <div class="annual-materials-mini">
                        <div class="annual-materials-mini-title">📚 年間教材管理</div>
                        <div class="materials-mini-grid">
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">通年教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundOrder">注文状況</label>
                                    <select class="material-mini-select" id="editYearRoundOrder">
                                        <option value="false">注文なし</option>
                                        <option value="true">注文あり</option>
                                    </select>
                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editYearRoundPeriod">注文時期</label>
                                    <input type="text" class="material-mini-input" id="editYearRoundPeriod" placeholder="例: 4月上旬">
                                </div>
                            </div>
                            <div class="materials-mini-item">
                                <div class="materials-mini-header">季節・入試教材</div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalUsage">使用状況</label>
                                    <select class="material-mini-select" id="editSeasonalUsage">
    <option value="unknown">不明</option>
    <option value="false">使用なし</option>
    <option value="true">使用あり</option>
</select>

                                </div>
                                <div class="material-mini-field">
                                    <label class="material-mini-label" for="editSeasonalPeriod">使用時期</label>
                                    <input type="text" class="material-mini-input" id="editSeasonalPeriod" placeholder="例: 夏期講習">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditCardModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="memoDetailModal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="memoModalTitle">メモ詳細</div>
                <button class="close-btn" onclick="closeMemoDetailModal()" aria-label="閉じる">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="memoCardName">メモ内容</label>
                <textarea class="form-input" id="memoContentInput" style="min-height: 150px; resize: vertical;" maxlength="1000" placeholder="メモ内容を入力してください（1000文字以内）"></textarea>
            </div>
            <div class="control-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeMemoDetailModal()">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveMemoContent()">保存</button>
            </div>
        </div>
    </div>

    <script>
const RENDER_DEBOUNCE_MS = 100;
let currentUser = null;
let currentUserData = null;
let currentUserRole = null;
let currentViewTarget = null;
let availableViewTargets = [];

async function quickLogin() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('Firebase初期化中です。数秒後に再度お試しください', 'info');
        return;
    }
    
    try {
        const email = prompt('メールアドレスを入力してください\n例: shimatani@eigyo-team.local');
        const password = prompt('パスワードを入力してください');
        
        if (!email || !password) return;
          // 🆕 メールアドレス形式チェック
        if (!email.includes('@') || email.trim().length === 0) {
            showToast('正しいメールアドレスを入力してください', 'error');
            return;
        }
        
        // 🆕 パスワード長チェック（Firebase認証の最小要件）
        if (password.trim().length < 6) {
            showToast('パスワードは6文字以上で入力してください', 'error');
            return;
        }
        
        await window.firebaseImports.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        showToast('ログインしました', 'success');
       } catch (error) {
        console.error('ログインエラー:', error);
        
        // 🆕 Firebase認証エラーの詳細マッピング
        const errorMessages = {
            'auth/invalid-credential': 'メールアドレスまたはパスワードが違います',
            'auth/user-not-found': 'ユーザーが見つかりません',
            'auth/wrong-password': 'パスワードが違います',
            'auth/too-many-requests': '試行回数が多すぎます。しばらく待ってから再度お試しください',
            'auth/network-request-failed': 'ネットワークエラーです。インターネット接続を確認してください',
            'auth/invalid-email': 'メールアドレスの形式が正しくありません',
            'auth/user-disabled': 'このアカウントは無効化されています。管理者にお問い合わせください'
        };
        
        const message = errorMessages[error.code] || (error.code || error.message);
        showToast('ログイン失敗: ' + message, 'error');
    }
}

async function quickLogout() {
    if (!window.firebaseImports || !window.firebaseAuth) {
        showToast('Firebase初期化中です。数秒後に再度お試しください', 'info');
        return;
    }
    
    try {
        await window.firebaseImports.signOut(window.firebaseAuth);
        showToast('ログアウトしました', 'info');
    } catch (error) {
        console.error('ログアウトエラー:', error);
        showToast('ログアウト失敗: ' + (error.code || error.message), 'error');
    }
}

async function loadAvailableViewTargets() {
    if (!currentUser || !currentUserRole) {
        availableViewTargets = [];
        return;
    }
    
    try {
        const usersCollection = await window.firebaseImports.getDocs(
            window.firebaseImports.collection(window.db, 'users')
        );
        
        availableViewTargets = [];
        
        usersCollection.forEach((doc) => {
            const userData = doc.data();
            const userId = doc.id;
            
            if (userId === currentUser.uid) {
                availableViewTargets.push({
                    id: userId,
                    name: userData.name,
                    role: userData.role,
                    canEdit: true
                });
                return;
            }
            
            if (currentUserRole === 'admin') {
                availableViewTargets.push({
                    id: userId,
                    name: userData.name,
                    role: userData.role,
                    canEdit: false
                });
            } else if (currentUserRole === 'manager') {
                if (currentUserData.subordinates && currentUserData.subordinates.includes(userId)) {
                    availableViewTargets.push({
                        id: userId,
                        name: userData.name,
                        role: userData.role,
                        canEdit: false
                    });
                }
            }
        });
        
        availableViewTargets.sort((a, b) => {
            if (a.id === currentUser.uid) return -1;
            if (b.id === currentUser.uid) return 1;
            return a.name.localeCompare(b.name);
        });
        
    } catch (error) {
        console.error('Available view targets load error:', error);
        availableViewTargets = [{
            id: currentUser.uid,
            name: currentUserData.name,
            role: currentUserRole,
            canEdit: true
        }];
    }
}

function updateAuthUI() {
    const loginUserInfo = document.getElementById('loginUserInfo');
    const viewSelectorSection = document.getElementById('viewSelectorSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (currentUser && currentUserData) {
        loginUserInfo.textContent = currentUserData.name;
        
        if (currentUserRole === 'staff') {
            viewSelectorSection.style.display = 'none';
        } else {
            viewSelectorSection.style.display = 'flex';
        }
        
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
    } else {
        loginUserInfo.textContent = '未ログイン';
        viewSelectorSection.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
    }
}

function updateViewSelector() {
    const viewSelector = document.getElementById('viewSelector');
    const viewPermissionInfo = document.getElementById('viewPermissionInfo');
    
    if (!availableViewTargets.length) {
        viewSelector.innerHTML = '<option value="">データなし</option>';
        if (viewPermissionInfo) viewPermissionInfo.textContent = '';
        return;
    }
    
    viewSelector.innerHTML = '';
    
    availableViewTargets.forEach(target => {
        const option = document.createElement('option');
        option.value = target.id;
        
        if (target.id === currentUser.uid) {
            option.textContent = `${target.name}さん (自分)`;
        } else {
            const roleLabel = {
                'admin': '管理者',
                'manager': 'マネージャー', 
                'staff': '営業担当'
            }[target.role] || target.role;
            option.textContent = `${target.name}さん (${roleLabel})`;
        }
        
        if (target.id === currentViewTarget) option.selected = true;
        viewSelector.appendChild(option);
    });
    
    // Admin権限があれば「マスター」を追加（PC幅条件を撤廃）
if (currentUserRole === 'admin') {
    const masterOption = document.createElement('option');
    masterOption.value = 'master';
    masterOption.textContent = 'マスター';
    masterOption.className = 'master-view-option';
    if (currentViewTarget === 'master') masterOption.selected = true;
    viewSelector.appendChild(masterOption);
}

    
    const currentTarget = availableViewTargets.find(t => t.id === currentViewTarget);
    if (viewPermissionInfo) {
        if (currentTarget) {
            if (currentTarget.canEdit) {
                viewPermissionInfo.textContent = '✏️ 編集可能';
                viewPermissionInfo.className = 'view-permission-info permission-edit';
            } else {
                viewPermissionInfo.textContent = '👁️ 閲覧専用';
                viewPermissionInfo.className = 'view-permission-info permission-view';
            }
        } else if (currentViewTarget === 'master') {
            viewPermissionInfo.textContent = '👑 管理者ビュー';
            viewPermissionInfo.className = 'view-permission-info permission-edit';
        } else {
            viewPermissionInfo.textContent = '';
        }
    }
}


async function changeViewTarget() {
    const viewSelector = document.getElementById('viewSelector');
    const newTargetId = viewSelector.value;
    
    // コンテンツ表示領域のDOM要素を取得
    const normalContent = document.getElementById('normalDashboardContent');
    const masterContent = document.getElementById('masterViewContent');
    
    // 「マスター」ビューへの切り替え
    if (newTargetId === 'master') {
        currentViewTarget = 'master';
        updateViewSelector();
        
        // ヘッダーを維持したまま、通常コンテンツを非表示にしてマスターコンテンツを表示
        normalContent.style.display = 'none';
        masterContent.style.display = 'block';
        
        await displayMasterView();
        showToast('マスター管理画面を表示中', 'info');
        return;
    }
    
    // 通常ビューへの切り替え（自分または他のスタッフのデータ表示）
    if (newTargetId && newTargetId !== currentViewTarget) {
        currentViewTarget = newTargetId;
        updateViewSelector();
        
        // マスタービューから戻る場合のコンテンツ切り替え
        if (masterContent.style.display === 'block') {
            masterContent.style.display = 'none';
            normalContent.style.display = 'block';
        }
        
        // 選択されたユーザーの個人設定とカードデータを読み込み
        await loadSettingsForTarget(newTargetId);
        await loadCardsDataForTarget(newTargetId);
        
        // キャッシュをクリアしてダッシュボードを更新
        progressCache = null;
        renderCardsOptimized();
        updateDashboard();
        
        const targetUser = availableViewTargets.find(t => t.id === newTargetId);
        if (targetUser) {
            showToast(`${targetUser.name}さんのデータを表示中`, 'info');
        }
    }
}


function restoreNormalDashboard() {
    // マスタービュー表示後に通常画面へ戻す最短手段：リロード
    const mainContainer = document.querySelector('.container');
    if (mainContainer && mainContainer.querySelector('.master-view-container')) {
        location.reload();
    }
}



async function loadCardsDataForTarget(targetUserId) {
    if (!currentUser || !targetUserId) {
        cardsData = [];
        return;
    }
    
    try {
        const cardsQuery = window.firebaseImports.query(
            window.firebaseImports.collection(window.db, 'juku_cards'),
            window.firebaseImports.where('assignedUserId', '==', targetUserId)
        );
        
        const cardsCollection = await window.firebaseImports.getDocs(cardsQuery);
        
        cardsData = [];
        let maxId = 0;
        
                cardsCollection.forEach((doc) => {
            const raw = doc.data();
            const docId = doc.id;
            
            // docIdが "uid_123" 形式の場合に数値idを抽出
            let numericId = NaN;
            if (docId.includes('_')) {
                const parts = docId.split('_');
                numericId = parseInt(parts[1], 10);
            } else {
                numericId = parseInt(docId, 10);
            }
            
            const cardData = { 
                id: Number.isFinite(numericId) ? numericId : (raw.id || 0),
                docId,
                ...raw
            };
            
            cardsData.push(cardData);
            if (Number.isFinite(cardData.id) && cardData.id > maxId) {
                maxId = cardData.id;
            }
        });

        
        nextCardId = maxId + 1;
        
    } catch (error) {
        console.error('Cards load error for target:', error);
        cardsData = [];
        nextCardId = 1;
    }
}

function hasPermission(action, targetData = null) {
    if (!currentUserRole || !currentUser) return false;
    
    switch (action) {
        case 'view_data':
            return targetData ? targetData.assignedUserId === currentViewTarget : false;
        case 'edit_data':
            return targetData ? targetData.assignedUserId === currentUser.uid : false;
        case 'delete_data':
            return targetData ? targetData.assignedUserId === currentUser.uid : false;
        case 'create_data':
            return currentViewTarget === currentUser.uid;
        case 'edit_own_settings':
            return true;
        case 'edit_any_settings':
            return currentUserRole === 'admin';
        default:
            return false;
    }
}

function setupFirebaseAuth() {
    if (window.firebaseImports && window.firebaseAuth && window.db) {
        window.firebaseImports.onAuthStateChanged(window.firebaseAuth, async (user) => {
            currentUser = user;
            
            if (user) {
    console.log('ログイン中 UID:', user.uid, 'メール:', user.email);
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', user.uid)
        );
        
        if (userDoc.exists()) {
            currentUserData = userDoc.data();
            currentUserRole = currentUserData.role;
            currentViewTarget = user.uid; // 必ず自分のデータを表示
            
            // 🆕 起動時は必ず現在月を表示
            const fiscalStructure = getFiscalYearStructure();
            activeDashboardMonthKey = fiscalStructure.currentMonthKey;
            
            // グローバル月セレクターを現在月に設定
            const globalSelector = document.getElementById('globalMonthSelector');
            if (globalSelector) {
                globalSelector.value = activeDashboardMonthKey;
            }
            
            // ヘッダーの日付表示を更新
            const monthInfo = fiscalStructure.months.find(m => m.key === activeDashboardMonthKey);
            if (monthInfo) {
                document.getElementById('currentDateDisplay').textContent = monthInfo.label;
            }
            
            // マスタービューが表示中なら通常画面に戻す
            document.getElementById('masterViewContent').style.display = 'none';
            document.getElementById('normalDashboardContent').style.display = 'block';
            
            await loadAvailableViewTargets();
            updateAuthUI();
            updateViewSelector();
            
            await loadCardsDataForTarget(currentViewTarget);
            await syncPersonalSettingsOnLogin();

            // 自分の設定をキャッシュに保存（必須）
            if (user && user.uid) {
                userSettingsCache[user.uid] = { ...personalSettings };
            }

            progressCache = null;
            renderCardsOptimized();
            updateDashboard();
            
            showToast(`${currentUserData.name}さん（${currentUserRole}）として認識されました`, 'success');
        }else {
                        showToast('ユーザー情報が未登録です（Step 4を確認）', 'error');
                    }
                } catch (error) {
                    console.error('ユーザーデータ取得エラー:', error);
                    showToast('ユーザーデータの取得に失敗しました', 'error');
                }
            } else {
                console.log('未ログイン状態');
                currentUserData = null;
                currentUserRole = null;
                currentViewTarget = null;
                availableViewTargets = [];
                userSettingsCache = {}; // キャッシュクリア
                progressCache = null;   // 進捗キャッシュクリア
                updateAuthUI();
                cardsData = [];
                renderCardsOptimized();
                updateDashboard();      // 表示リセット
            }
        });
    } else {
        setTimeout(setupFirebaseAuth, 100);
    }
}


let cardsData = [];
let nextCardId = 1;
let progressCache = null;
let progressChart = null;
let searchTimeout;
let renderTimeout;
let scrollPosition = 0;
let currentEditingMemo = null;
let isComposing = false;
        let activeDashboardMonthKey = null; // 追加：ダッシュボードのアクティブ月

let personalSettings = {
    userName: '担当者',
    profitRate: 0,
    yearlyProfitTarget: 0,
    yearlyProfitIncreaseTarget: 0,
    yearlySalesIncreaseTarget: 0,
    personalSalesIncreaseTarget: 0, // 🆕 個人設定売上増目標
    monthlyProfitActuals: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    },
    monthlyProfitTargets: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    },
    cumulativeProfitActual: 0,
    monthlyCumulativeProfitActuals: {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    }
};


let activeProbabilityFilter = 'all';
let userSettingsCache = {};
        
const PROBABILITY_CONFIG = {
    options: [
        { value: 40, label: '50未満' },
        { value: 50, label: '50%' },
        { value: 60, label: '60%' },
        { value: 70, label: '70%' },
        { value: 80, label: '80%' },
        { value: 90, label: '90%' },
        { value: 100, label: '100%' }
    ],
    
    filters: [
    { value: 'all', label: '全確率' },
    { value: 'under50', label: '50未満' },
    { value: '50-60', label: '50-70' },  // 表示名を50-70に変更
    { value: '70', label: '70%' },
    { value: '80', label: '80%' },
    { value: '90', label: '90%' },
    { value: '100', label: '100%' }
]

};

function getCurrentMonth() { 
    return new Date().getMonth() + 1; 
}

        function getDefaultSettings() {
    return {
        userName: '担当者',
        profitRate: 0,
        yearlyProfitTarget: 0,
        yearlyProfitIncreaseTarget: 0,
        yearlySalesIncreaseTarget: 0,
        personalSalesIncreaseTarget: 0, // 🆕 追加
        monthlyProfitActuals: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        },
        monthlyProfitTargets: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        },
        cumulativeProfitActual: 0,
        monthlyCumulativeProfitActuals: {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        }
    };
}

// アクティブな個人設定を取得する関数
function getActiveSettings() {
    const selfId = currentUser?.uid || null;
    const targetId = currentViewTarget || selfId;
    // 自分のデータを表示しているときは常に最新の personalSettings を使う
    if (selfId && targetId === selfId) {
        return personalSettings;
    }
    // 他人表示時のみキャッシュを参照（なければデフォルト）
    return (targetId && userSettingsCache[targetId]) 
        ? userSettingsCache[targetId] 
        : getDefaultSettings();
}


// 指定ユーザーの個人設定を読み込む関数
async function loadSettingsForTarget(uid) {
    if (!uid || !window.firebaseImports || !window.db) return;
    if (userSettingsCache[uid]) return; // 既にキャッシュ済み
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', uid)
        );
        
        if (userDoc.exists() && userDoc.data().personalSettings) {
            userSettingsCache[uid] = { 
                ...getDefaultSettings(), 
                ...userDoc.data().personalSettings 
            };
            console.log(`${uid}の個人設定を読み込みました`);
        } else {
            userSettingsCache[uid] = getDefaultSettings();
            console.warn(`${uid}の個人設定が未設定のためデフォルト値を使用`);
        }
    } catch (error) {
        console.error('個人設定読み込みエラー:', error);
        userSettingsCache[uid] = getDefaultSettings();
        showToast('個人設定の読み込みに失敗しました', 'error');
    }
}


function formatManYen(amount, decimals = 1) {
    const absAmount = Math.abs(amount || 0);
    const manYen = absAmount / 10000;
    const sign = amount < 0 ? '-' : '';
    return `${sign}¥${manYen.toFixed(decimals)}万`;
}
        function formatManPlain(amount, decimals = 1) {
    const num = Number(amount) || 0;
    const sign = num < 0 ? '-' : '';
    return `${sign}${(Math.abs(num) / 10000).toFixed(decimals)}万円`;
}

function formatAmount(amount) {
    const num = Number.isFinite(amount) ? amount : 0;
    const rounded = Math.round(num); // 四捨五入で整数化
    const absAmount = Math.abs(rounded);
    const sign = rounded < 0 ? '-' : '';
    return `${sign}¥${absAmount.toLocaleString()}`;
}


        // === 4枚カード用ヘルパー関数群（エラー解消） ===

// 売上フィールドを強制的に編集不可にする防御機能
function lockAutoCalculatedFields() {
    ['monthlySalesActual', 'cumulativeSalesActual'].forEach(id => {
        const element = document.getElementById(id);
        if (!element) return;
        
        element.classList.remove('editable-profit-field');
        element.removeAttribute('onclick');
        element.style.cursor = 'default';
    });
}

// 住所から市区町村を抽出する関数
function extractMunicipality(address) {
    if (!address || typeof address !== 'string') return '';
    
    const cleanAddress = address.trim();
    if (!cleanAddress) return '';

    // 政令指定都市の区（例：大阪市中央区）
    const cityWardMatch = cleanAddress.match(/(.+?市.+?区)/);
    if (cityWardMatch) return cityWardMatch[1];

    // 東京23区（例：新宿区）
    const tokyoWardMatch = cleanAddress.match(/([^都道府県]+区)(?![市町村])/);
    if (tokyoWardMatch) return tokyoWardMatch[1];

    // 一般市（例：豊中市）
    const cityMatch = cleanAddress.match(/(.+?市)/);
    if (cityMatch) return cityMatch[1];

    // 町村（例：○○町）
    const townVillageMatch = cleanAddress.match(/(.+?[町村])/);
    if (townVillageMatch) return townVillageMatch[1];

    // フォールバック処理
    let fallbackAddress = cleanAddress;
    ['都', '道', '府', '県'].forEach(suffix => {
        const index = fallbackAddress.indexOf(suffix);
        if (index !== -1) {
            fallbackAddress = fallbackAddress.substring(index + 1);
        }
    });

    return fallbackAddress.split(/[\s　,、]/)[0] || cleanAddress;
}

        
function formatDifferenceAmount(amount, formatter = formatAmount) {
    if (!Number.isFinite(amount)) amount = 0;
    
    const absAmount = Math.abs(amount);
    const formattedAmount = formatter(absAmount);
    
    if (amount < 0) {
        return { text: `Δ${formattedAmount}`, isNegative: true };
    } else {
        return { text: formattedAmount, isNegative: false };
    }
}

        // カード値更新のヘルパー関数（エラー解決の核心）
function updateCardValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`Element with id '${elementId}' not found`);
    }
}

// カード差額更新のヘルパー関数
function updateCardDifference(elementId, amount, formatter = formatAmount) {
    const element = document.getElementById(elementId);
    if (element) {
        const diff = formatDifferenceAmount(amount, formatter);
        element.textContent = diff.text;
        element.classList.remove('negative', 'positive', 'neutral');
        if (diff.isNegative) {
            element.classList.add('negative');
        } else if (amount > 0) {
            element.classList.add('positive');
        } else {
            element.classList.add('neutral');
        }
    } else {
        console.warn(`Element with id '${elementId}' not found`);
    }
}

function editMonthlyProfitInline(element) {
    if (!currentUser || currentViewTarget !== currentUser.uid) {
        showToast('自分のデータ表示中のみ編集可能です', 'error');
        return;
    }

    const currentMonth = getCurrentMonth();
    const currentValue = personalSettings.monthlyProfitActuals[currentMonth] || 0;
    
    const newValue = prompt('月別粗利実績を入力してください（円）\n\n例: 500000', currentValue);
    if (newValue === null) return;
    
    const parsedValue = parseNumberSafely(newValue);

    // 1) データ更新
    personalSettings.monthlyProfitActuals[currentMonth] = parsedValue;

    // 2) UI即時反映
    element.textContent = formatAmount(parsedValue);

    // 3) 再計算を即時反映（キャッシュ無効化→再描画）
    progressCache = null;
    updateDashboard();

    // 4) 保存はアイドル時間に遅延実行（体感速度を最優先）
    scheduleSavePersonalSettings();

    showToast('月別粗利実績を更新しました', 'success');
}

function editCumulativeProfitInline(element) {
    if (!currentUser || currentViewTarget !== currentUser.uid) {
        showToast('自分のデータ表示中のみ編集可能です', 'error');
        return;
    }

    // 🆕 グローバル月セレクターに連動した対象月を取得
    const { months } = getFiscalYearStructure();
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeMonthInfo = months.find(m => m.key === activeMonthKey);
    const targetMonth = activeMonthInfo ? activeMonthInfo.month : getCurrentMonth();
    
    // 🆕 月ごとの累積粗利実績データ構造を確実に初期化
    if (!personalSettings.monthlyCumulativeProfitActuals) {
        personalSettings.monthlyCumulativeProfitActuals = {
            10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
            4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
        };
    }

    const currentValue = personalSettings.monthlyCumulativeProfitActuals[targetMonth] || 0;
    
    const newValue = prompt(
        `累積粗利実績を入力してください（円）\n対象月: ${targetMonth}月\n※${targetMonth}月時点での累積粗利の数値を直接入力\n\n例: 5,000,000\n（空欄で削除）`, 
        currentValue
    );
    if (newValue === null) return;
    
    // 🆕 空欄入力で該当月の値を削除（未設定化）
    if (String(newValue).trim() === '') {
        delete personalSettings.monthlyCumulativeProfitActuals[targetMonth];
        element.textContent = formatAmount(0);
        progressCache = null;
        updateDashboard();
        scheduleSavePersonalSettings();
        showToast(`${targetMonth}月の累積粗利実績を削除しました`, 'success');
        return;
    }
    
    const parsedValue = parseNumberSafely(newValue);
    
    // 🆕 選択月の累積粗利実績を直接保存（月別管理）
    personalSettings.monthlyCumulativeProfitActuals[targetMonth] = Number(parsedValue);
    
    // 後方互換性のため旧フィールドも更新（現在月の場合のみ）
    if (targetMonth === getCurrentMonth()) {
        personalSettings.cumulativeProfitActual = Number(parsedValue);
    }
    
    // UIを即時更新
    element.textContent = formatAmount(parsedValue);
    
    // 再計算と描画更新
    progressCache = null;
    updateDashboard();
    
    // 保存処理
    scheduleSavePersonalSettings();
    
    showToast(`${targetMonth}月の累積粗利実績を更新しました`, 'success');
}


function formatDateForDisplay(s) {
    if (!s) return '—';
    
    // Firestore Timestamp対応
    if (s && typeof s.toDate === 'function') {
        const d = s.toDate();
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    }
    
    try {
        const d = new Date(s);
        if (isNaN(d.getTime())) return '—';
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), da = String(d.getDate()).padStart(2, '0'), h = String(d.getHours()).padStart(2, '0'), mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${da} ${h}:${mi}`;
    } catch (e) {
        return '—';
    }
}


function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

        // 数値カンマフォーマット関数
function formatWithCommas(value) {
    const num = parseNumberSafely(value);
    return Number.isFinite(num) ? num.toLocaleString() : '';
}

// 数値フィールドのフォーカス・ブラー処理
function setupNumberFormatting() {
    const numberFields = [
    'newSalesIncreaseForecast', 'newProfitActual', 
    'editProfitActual', 'yearlyProfitTarget', 'yearlyProfitIncreaseTarget',
    'personalSalesIncreaseTarget' // 🆕 追加
];

    
    numberFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        // スマホで数字キーボード表示、type=textでカンマ表示可能に
        field.setAttribute('inputmode', 'numeric');
        field.setAttribute('type', 'text');
        
        // 初期表示時にカンマ付与（0以外の値のみ）
        if (field.value && field.value !== '0') {
            field.value = formatWithCommas(field.value.replace(/[,，\s]/g, ''));
        }
        
        // フォーカス時：カンマ除去＋全選択
        field.addEventListener('focus', function() {
            this.value = this.value.replace(/[,，\s]/g, '');
            setTimeout(() => this.select(), 0);
        });
        
        // ブラー時：カンマ付与
        field.addEventListener('blur', function() {
            if (this.value && this.value !== '0') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
    
    // 月別入力フィールドの処理（個人設定内）
    document.querySelectorAll('.monthly-input').forEach(input => {
        input.setAttribute('inputmode', 'numeric');
        input.setAttribute('type', 'text');
        
        // 初期表示時にカンマ付与
        if (input.value && input.value !== '0') {
            input.value = formatWithCommas(input.value.replace(/[,，\s]/g, ''));
        }
        
        input.addEventListener('focus', function() {
            if (this.value && this.value !== '0') {
                this.value = this.value.replace(/[,，\s]/g, '');
                setTimeout(() => this.select(), 0);
            }
        });
        
        input.addEventListener('blur', function() {
            if (this.value && this.value !== '') {
                this.value = formatWithCommas(this.value);
            }
        });
    });
}

function parseNumberSafely(value) {
    if (value == null || value === '') return 0;
    
    const normalized = String(value)
        .replace(/[０-９]/g, (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0))
        .replace(/[,，\s]/g, '')
        .replace(/[^0-9.-]/g, '');
    
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? Math.max(0, parsed) : 0;
}

        function editYearlyProfitTarget(element) {
    const currentValue = personalSettings.yearlyProfitTarget || 0;
    
    const newValue = prompt('年間粗利目標を入力してください（円）\n\n例: 12000000', currentValue);
    if (newValue === null) return; // キャンセル時は何もしない
    
    const parsedValue = parseNumberSafely(newValue);
    personalSettings.yearlyProfitTarget = parsedValue;
    
    // 即座に表示を更新
    element.textContent = formatAmount(parsedValue);
    
    // データ保存と全体更新
    savePersonalSettingsComplete();
    progressCache = null;
    updateDashboard();
    showToast('年間粗利目標を更新しました', 'success');
}
        
function getMonthKeyFromTimestamp(ts, fallbackKey) {
    try {
        let d;
        if (ts && typeof ts.toDate === 'function') d = ts.toDate();
        else if (ts) d = new Date(ts);
        else return fallbackKey;
        if (isNaN(d.getTime())) return fallbackKey;
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        return `${y}-${String(m).padStart(2, '0')}`;
    } catch {
        return fallbackKey;
    }
}
        
function getProbabilityLabel(value) {
    if (value === 40) return '50未満';
    return `${value}%`;
}

function getProbabilityFilterGroup(value) {
    if (value < 50) return 'under50';
    if (value < 70) return '50-70';
    if (value < 90) return '70-90';
    return '90-100';
}

function matchesProbabilityFilter(probability, filterValue) {
    if (filterValue === 'all') return true;
    
    switch (filterValue) {
        case 'under50': return probability < 50;
        case '50-60': return probability >= 50 && probability <= 60;  // 50,60のみ
        case '70': return probability === 70;
        case '80': return probability === 80;
        case '90': return probability === 90;
        case '100': return probability === 100;
        default: return true;
    }
}


function getFiscalYearStructure() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    const fiscalStartYear = currentMonth >= 10 ? currentYear : currentYear - 1;
    
    const months = [];
    for (let i = 0; i < 12; i++) {
        const month = ((10 + i - 1) % 12) + 1;
        const year = month >= 10 ? fiscalStartYear : fiscalStartYear + 1;
        months.push({
            key: `${year}-${String(month).padStart(2, '0')}`,
            year: year,
            month: month,
            label: `${year}年${month}月`
        });
    }
    
    return {
        months: months,
        currentMonthKey: `${currentYear}-${String(currentMonth).padStart(2, '0')}`,
        currentMonthIndex: months.findIndex(m => m.key === `${currentYear}-${String(currentMonth).padStart(2, '0')}`)
    };
}

function getPreviousMonth(monthKey) {
    const fiscalStructure = getFiscalYearStructure();
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === monthKey);
    const prevIndex = currentIndex > 0 ? currentIndex - 1 : 11;
    return fiscalStructure.months[prevIndex];
}

function calculateMonthlyChange(cardData, monthKey) {
    const f = getFiscalYearStructure();
    const m = f.months.find(x => x.key === monthKey);
    const cur = (cardData.monthlyData?.[monthKey] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    if (m && m.month === 10) return { amount: cur, direction: cur > 0 ? 'increase' : 'neutral' };
    const prev = getPreviousMonth(monthKey);
    const p = (cardData.monthlyData?.[prev.key] || { salesIncreaseForecast: 0 }).salesIncreaseForecast || 0;
    const d = cur - p;
    return { amount: d, direction: d > 0 ? 'increase' : d < 0 ? 'decrease' : 'neutral' };
}

function calculateSalesFromProfit(profitActual) {
    const settings = getActiveSettings();
    const profitRate = (settings.profitRate || 0) / 100;
    if (profitRate <= 0) return 0;
    return Math.round((profitActual || 0) / profitRate);
}


function getCardLevel(v) {
    if (v < 100000) return 0;
    if (v < 300000) return 1;
    if (v < 500000) return 2;
    if (v < 1000000) return 3;
    return 4;
}

function updatePersonalSalesTarget() {
    const p = personalSettings.profitRate / 100;
    personalSettings.yearlySalesIncreaseTarget = p > 0 ? Math.round(personalSettings.yearlyProfitIncreaseTarget / p) : 0;
    const el = document.getElementById('yearlySalesIncreaseTarget');
    if (el) el.value = personalSettings.yearlySalesIncreaseTarget;
}

function validateCardData(cardData) {
    const errors = [];
    
    if (!cardData.jukuName || cardData.jukuName.trim().length === 0) {
        errors.push('塾名は必須です');
    }
    
    if (cardData.jukuName && cardData.jukuName.length > 100) {
        errors.push('塾名は100文字以内で入力してください');
    }
    
    if (cardData.annualProfitActual < 0) {
        errors.push('年間粗利実績は0以上で入力してください');
    }
    
    if (cardData.monthlyData) {
        Object.entries(cardData.monthlyData).forEach(([monthKey, monthData]) => {
            if (monthData.salesIncreaseForecast < 0) {
                errors.push(`${monthKey}の売上増見込みは0以上で入力してください`);
            }
            
            if (monthData.probability < 0 || monthData.probability > 100) {
                errors.push(`${monthKey}の確率は0-100%の範囲で入力してください`);
            }
        });
    }
    
    return errors;
}

function saveBackup(data) {
    try {
        const backups = JSON.parse(localStorage.getItem('salesDashboard_backups') || '[]');
        backups.unshift({ ...data, backupTime: Date.now() });
        backups.splice(3);
        localStorage.setItem('salesDashboard_backups', JSON.stringify(backups));
    } catch (e) {
        console.warn('Backup save failed:', e);
    }
}

function cleanupOldBackups() {
    try {
        localStorage.removeItem('salesDashboard_backups');
        for (let key in localStorage) {
            if (key.startsWith('salesDashboard_') && key.includes('_old')) {
                localStorage.removeItem(key);
            }
        }
    } catch (e) {
        console.warn('Cleanup failed:', e);
    }
}

async function saveCardsData() {
    if (!currentUser || !window.firebaseImports || !window.db) {
        try {
            localStorage.setItem('salesDashboard_cardsData_v9', JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId
            }));
            console.log('LocalStorageに保存しました（未ログイン/オフライン）');
        } catch (e) {
            console.error('LocalStorage save error:', e);
            showToast('ローカル保存に失敗しました', 'error');
        }
        return;
    }

    // 他人表示中は保存しない（権限エラー防止）
    if (currentViewTarget && currentViewTarget !== currentUser.uid) {
        console.log('他人データ表示中のため、Firestore保存をスキップしました');
        return;
    }
    
    try {
        // 自分のカードのみフィルタリング
        const ownCards = cardsData.filter(card => 
            card.assignedUserId === currentUser.uid
        );

        for (const card of ownCards) {
            const assignedId = currentUser.uid;
            
            if (!card.docId) {
                card.docId = `${assignedId}_${card.id}`;
            }
            
            const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', card.docId);
            
            const cardToSave = {
                ...card,
                assignedUserId: assignedId,
                assignedUserName: card.assignedUserName || (currentUserData?.name || personalSettings.userName),
                lastUpdated: window.firebaseImports.serverTimestamp(),
                updatedBy: currentUser.uid
            };
            
            await window.firebaseImports.setDoc(cardRef, cardToSave);
        }

        updateAreaFilterOptions();
        showToast('データを保存しました', 'success');
        console.log('Firestoreに保存完了:', ownCards.length, '件');
        
    } catch (error) {
    console.error('Firestore save error:', error);
    
    // 🆕 ネットワークエラーの自動判定
    const isNetworkError = error.code === 'unavailable' || 
                          error.code === 'deadline-exceeded' ||
                          error.message?.includes('net::ERR_QUIC_PROTOCOL_ERROR') ||
                          error.message?.includes('400');
    
    if (isNetworkError) {
        console.log('ネットワークエラーを検出：自動回復を開始');
        
        // まずローカルにデータを退避保存
        try {
            const backupKey = `salesDashboard_network_backup_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify({
                cardsData: cardsData,
                nextCardId: nextCardId,
                timestamp: new Date().toISOString(),
                userInfo: currentUser?.uid || 'unknown',
                errorType: 'network_error'
            }));
            
            showToast('ネットワーク不安定：ローカルに保存しました（5秒後に自動再試行）', 'info');
            
            // 🆕 5秒後に自動でもう一度保存を試す
            setTimeout(() => {
                console.log('自動リトライを実行中...');
                saveCardsData();
            }, 5000);
            
        } catch (backupError) {
            console.error('バックアップ保存失敗:', backupError);
            showToast('保存に失敗しました。重要なデータは手動で控えてください', 'error');
        }
        return; // ネットワークエラーの場合はここで終了
    }
    
    // 通常のエラー（権限不足など）の処理
    const errorMessages = {
        'permission-denied': '保存権限がありません。管理者にお問い合わせください',
        'quota-exceeded': 'ストレージ容量が上限に達しています',
        'unauthenticated': '認証が必要です。再ログインしてください'
    };
    
    const message = errorMessages[error.code] || `保存エラー: ${error.message || 'データ保存に失敗しました'}`;
    showToast(message, 'error');
    
    // 既存のバックアップ機能
    try {
        const backupKey = `salesDashboard_backup_${Date.now()}`;
        localStorage.setItem(backupKey, JSON.stringify({
            cardsData: cardsData,
            nextCardId: nextCardId,
            timestamp: new Date().toISOString(),
            userInfo: currentUser?.uid || 'unknown',
            errorCode: error.code || 'unknown_error'
        }));
        console.log('バックアップ保存完了:', backupKey);
    } catch (backupError) {
        console.error('バックアップ失敗:', backupError);
    }
}
}

function loadCardsData() {
    try {
        const saved = localStorage.getItem('salesDashboard_cardsData_v9');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.cardsData) {
                cardsData = data.cardsData;
                nextCardId = data.nextCardId || 1;
            } else {
                cardsData = data;
                const savedNextId = localStorage.getItem('salesDashboard_nextCardId_v9');
                nextCardId = parseInt(savedNextId) || 1;
            }
        } else {
            cardsData = [];
            nextCardId = 1;
        }
    } catch (e) {
        showToast('データ読み込みエラー', 'error');
        console.error('Load error:', e);
        cardsData = [];
        nextCardId = 1;
    }
}

function savePersonalSettings() {
    try {
        localStorage.setItem('salesDashboard_personalSettings_v9', JSON.stringify(personalSettings));
    } catch (e) {
        showToast('個人設定保存エラー', 'error');
        console.error('Personal settings save error:', e);
    }
}
        
async function savePersonalSettingsComplete() {
    // ローカル保存
    savePersonalSettings();

    // キャッシュ即時更新（自分表示中の反映遅延を解消）
    if (currentUser?.uid) {
        userSettingsCache[currentUser.uid] = { ...personalSettings };
    }
    
    // Firebase保存
    if (currentUser && window.db && window.firebaseImports) {
        try {
            await window.firebaseImports.setDoc(
                window.firebaseImports.doc(window.db, 'users', currentUser.uid),
                { personalSettings },
                { merge: true }
            );
            showToast('個人設定をクラウドに保存しました', 'success');
        } catch (error) {
            console.error('Firebase個人設定保存エラー:', error);
            showToast('クラウド保存でエラーが発生しました', 'error');
        }
    }
}
        // 保存処理をブラウザのアイドル時間に遅延実行（重複をまとめる）
let scheduledSaveToken = null;

function scheduleSavePersonalSettings() {
    // 既にスケジュール済みなら何もしない（連打を1回にまとめる）
    if (scheduledSaveToken) return;

    const executeSave = () => {
        scheduledSaveToken = null; // 次のスケジュールを許可
        try {
            savePersonalSettingsComplete();
        } catch (error) {
            console.error('Delayed save failed:', error);
            showToast('保存処理でエラーが発生しました', 'error');
        }
    };

    if ('requestIdleCallback' in window) {
        // Safari等で未実装のことがあるため timeout も設定
        scheduledSaveToken = requestIdleCallback(executeSave, { timeout: 2000 });
    } else {
        // フォールバック（次フレームで実行）
        scheduledSaveToken = setTimeout(executeSave, 0);
    }
}

// ログイン時同期関数
async function syncPersonalSettingsOnLogin() {
    if (!currentUser || !window.db) return;
    
    try {
        const userDoc = await window.firebaseImports.getDoc(
            window.firebaseImports.doc(window.db, 'users', currentUser.uid)
        );
        
                if (userDoc.exists() && userDoc.data().personalSettings) {
    // 🆕 クラウド優先：ローカル設定を完全に置き換え
    personalSettings = { 
        ...getDefaultSettings(),
        ...userDoc.data().personalSettings 
    };
    
    // 🆕 後方互換性の強化：古いcumulativeProfitActualを現在月に移行
if (!personalSettings.monthlyCumulativeProfitActuals) {
    personalSettings.monthlyCumulativeProfitActuals = {
        10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
        4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
    };
    
    // 古いデータがある場合は現在月に移行
    if (personalSettings.cumulativeProfitActual && personalSettings.cumulativeProfitActual > 0) {
        const currentMonth = getCurrentMonth();
        personalSettings.monthlyCumulativeProfitActuals[currentMonth] = personalSettings.cumulativeProfitActual;
        console.log(`古い累積粗利データ(${personalSettings.cumulativeProfitActual})を${currentMonth}月に移行しました`);
    }
}

    
    // 🆕 ローカルストレージを最新クラウドデータで強制更新
    savePersonalSettings();
    updatePersonalSalesTarget();
    updateDashboard();

    showToast('クラウドから個人設定を同期し、ローカルを更新しました', 'info');

        } else {
            // 初回：ローカル設定をクラウドに保存
            await savePersonalSettingsComplete();
            showToast('個人設定をクラウドに初期保存しました', 'success');
        }
    } catch (error) {
        console.error('個人設定同期エラー:', error);
        showToast('設定同期に失敗（ローカル設定を使用）', 'error');
    }
}

function loadPersonalSettings() {
    try {
        const saved = localStorage.getItem('salesDashboard_personalSettings_v9');
        if (saved) {
            const savedSettings = JSON.parse(saved);
            personalSettings = { ...personalSettings, ...savedSettings };
            
            if (!personalSettings.monthlyProfitTargets) {
                personalSettings.monthlyProfitTargets = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            if (!personalSettings.monthlyProfitActuals) {
                personalSettings.monthlyProfitActuals = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            
            // 🆕 新フィールド（月ごとの累積粗利実績）を初期化
            if (!personalSettings.monthlyCumulativeProfitActuals) {
                personalSettings.monthlyCumulativeProfitActuals = {
                    10: 0, 11: 0, 12: 0, 1: 0, 2: 0, 3: 0,
                    4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
                };
            }
            
            updatePersonalSalesTarget();
            
            // 🆕 後方互換性：旧データから新構造への一回限りの移行
            const oldCumulativeValue = Number(personalSettings.cumulativeProfitActual || 0);
            if (oldCumulativeValue > 0) {
                const currentMonth = getCurrentMonth();
                const existingValue = Number(personalSettings.monthlyCumulativeProfitActuals[currentMonth] || 0);
                
                // 現在月の新データが未設定の場合のみ移行（重複防止）
                if (!existingValue || existingValue === 0) {
                    personalSettings.monthlyCumulativeProfitActuals[currentMonth] = oldCumulativeValue;
                    
                    // 移行完了をローカルストレージに保存
                    try {
                        savePersonalSettings();
                        console.log(`データ移行完了: cumulativeProfitActual(${oldCumulativeValue}) → monthlyCumulativeProfitActuals[${currentMonth}]`);
                    } catch(e) {
                        console.warn('移行データの保存に失敗:', e);
                    }
                }
            }
        }
    } catch (e) {
        showToast('個人設定読み込みエラー', 'error');
        console.error('Personal settings load error:', e);
    }
}


function migrateToV9Structure() {
    const fiscalStructure = getFiscalYearStructure();
    let migrationCount = 0;
    
    cardsData.forEach(cardData => {
        let needsMigration = false;
        
        if (cardData.hasOwnProperty('annualSalesIncreaseTarget')) {
            delete cardData.annualSalesIncreaseTarget;
            needsMigration = true;
        }
        if (cardData.hasOwnProperty('annualProfitIncreaseExpected')) {
            delete cardData.annualProfitIncreaseExpected;
            needsMigration = true;
        }
        
        if (!cardData.monthlyData) {
            cardData.monthlyData = {};
            needsMigration = true;
            
            fiscalStructure.months.forEach(monthInfo => {
                cardData.monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: 0,
                    probability: 50,
                    memo: ""
                };
            });
            
            if (cardData.memo) {
                cardData.monthlyData[fiscalStructure.currentMonthKey].memo = cardData.memo;
                delete cardData.memo;
            }
            
            if (cardData.probability) {
                let numericProbability = 50;
                switch(cardData.probability) {
                    case '80+': numericProbability = 90; break;
                    case '60-80': numericProbability = 70; break;
                    case '50-60': numericProbability = 60; break;
                    case '50-': numericProbability = 40; break;
                }
                cardData.monthlyData[fiscalStructure.currentMonthKey].probability = numericProbability;
                delete cardData.probability;
            }
        }
        
        if (!cardData.displayMonth) {
            cardData.displayMonth = fiscalStructure.currentMonthKey;
            needsMigration = true;
        }
        
        if (!cardData.annualMaterials) {
            cardData.annualMaterials = {
                yearRound: { hasOrder: false, orderPeriod: "" },
                seasonalExam: { hasUsage: false, usagePeriod: "" }
            };
            needsMigration = true;
        }

        if (!cardData.registeredMonth) {
    cardData.registeredMonth = getMonthKeyFromTimestamp(
        cardData.lastUpdated, 
        fiscalStructure.currentMonthKey
    );
    needsMigration = true;
}


        if (!cardData.hasOwnProperty('area')) {
            cardData.area = "";
            needsMigration = true;
        }

        if (!cardData.hasOwnProperty('assignedUser')) {
            cardData.assignedUser = personalSettings.userName;
            needsMigration = true;
        }

        if (needsMigration) {
            migrationCount++;
        }
    });
    
    if (migrationCount > 0) {
        saveCardsData();
        showToast(`${migrationCount}件のデータをv10.0形式に移行しました`, 'info');
    }
}

function initializeDisplayMonth() {
    const currentMonthKey = getFiscalYearStructure().currentMonthKey;
    
    cardsData.forEach(cardData => {
        if (!cardData.displayMonth) {
            cardData.displayMonth = currentMonthKey;
        }
    });
    
    const globalSelector = document.getElementById('globalMonthSelector');
    if (globalSelector) {
        globalSelector.value = currentMonthKey;
    }
    
    saveCardsData();
}

function updateAreaFilterOptions() {
    const areaFilter = document.getElementById('areaFilter');
    if (!areaFilter) return;
    
    const currentValue = areaFilter.value || 'all';
    areaFilter.innerHTML = '<option value="all">全地域</option>';
    
    const municipalitySet = new Set();
    
    cardsData.forEach(card => {
        const address = card.address || '';
        if (address.trim()) {
            const municipality = extractMunicipality(address);
            if (municipality) {
                municipalitySet.add(municipality);
            }
        }
    });
    
    const sortedMunicipalities = Array.from(municipalitySet).sort((a, b) => 
        a.localeCompare(b, 'ja', { numeric: true })
    );
    
    sortedMunicipalities.forEach(municipality => {
        const option = document.createElement('option');
        option.value = municipality;
        option.textContent = municipality;
        areaFilter.appendChild(option);
    });
    
    if (sortedMunicipalities.includes(currentValue) || currentValue === 'all') {
        areaFilter.value = currentValue;
    }
}


function updateProbabilityFilterOptions() {
    // 確率プルダウン削除により無効化
    console.log('Probability filter removed - function disabled');
}


function updateGlobalMonthSelector() {
    const selector = document.getElementById('globalMonthSelector');
    if (!selector) return;
    
    const fiscalStructure = getFiscalYearStructure();
    selector.innerHTML = '';
    
    fiscalStructure.months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.key;
        option.textContent = `${month.month}月`;
        if (month.key === fiscalStructure.currentMonthKey) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
    
    const currentMonthInfo = fiscalStructure.months.find(m => m.key === fiscalStructure.currentMonthKey);
    if (currentMonthInfo) {
        document.getElementById('currentDateDisplay').textContent = currentMonthInfo.label;
    }
}

function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 200);
        }, 2500);
    });
}

function calculateQualifiedProspects() {
    const settings = getActiveSettings();
    const currentMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    const qualifiedProfit = cardsData.reduce((total, card) => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 50 
        };
        
        if (monthData.probability < 80) return total;
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        return total + profit;
    }, 0);
    
    return qualifiedProfit;
}


function calculateAllProgress() {
    const settings = getActiveSettings();
    const now = Date.now();
    const monthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const cacheKey = `${cardsData.length}-${settings.yearlyProfitIncreaseTarget}-${monthKey}-${currentViewTarget || ''}`;
    
    if (progressCache && 
        progressCache.cacheKey === cacheKey && 
        (now - progressCache.timestamp) < 5000) {
        return progressCache.data;
    }

    const currentMonth = getCurrentMonth();
    
    const monthlyTarget = settings.monthlyProfitTargets[currentMonth] || 0;
    const monthlyActual = settings.monthlyProfitActuals[currentMonth] || 0;
    const monthlyDifference = monthlyActual - monthlyTarget;
    const monthlyRate = monthlyTarget > 0 ? (monthlyActual / monthlyTarget) * 100 : 0;
    
    const yearlyTarget = settings.yearlyProfitTarget || 0;
    const yearlyActual = Object.values(settings.monthlyProfitActuals)
                                .reduce((sum, monthlyProfit) => sum + (monthlyProfit || 0), 0);
    const yearlyRate = yearlyTarget > 0 ? (yearlyActual / yearlyTarget) * 100 : 0;
    
    const salesIncreaseTarget = settings.yearlySalesIncreaseTarget || 0;
    const totalSalesProspect = cardsData.reduce((sum, card) => {
        const monthData = card.monthlyData?.[monthKey] || { salesIncreaseForecast: 0 };
        return sum + (monthData.salesIncreaseForecast || 0);
    }, 0);
    const salesTargetRate = salesIncreaseTarget > 0 ? (totalSalesProspect / salesIncreaseTarget) * 100 : 0;
    
    const prospectTotal = calculateQualifiedProspects();
    const prospectRate = (settings.yearlyProfitIncreaseTarget || 0) > 0 ? 
        (prospectTotal / settings.yearlyProfitIncreaseTarget) * 100 : 0;
    
    // 6段階ファネル
    let probUnder50 = 0, prob5060 = 0, prob70 = 0, prob80 = 0, prob90 = 0, prob100 = 0;

    cardsData.forEach(card => {
        const monthData = card.monthlyData?.[monthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 50 
        };
        
        const profit = (monthData.salesIncreaseForecast || 0) 
                     * ((settings.profitRate || 0) / 100);
        
        if (monthData.probability < 50) {
            probUnder50 += profit;
        } else if (monthData.probability <= 60) {
            prob5060 += profit;
        } else if (monthData.probability === 70) {
            prob70 += profit;
        } else if (monthData.probability === 80) {
            prob80 += profit;
        } else if (monthData.probability === 90) {
            prob90 += profit;
        } else if (monthData.probability === 100) {
            prob100 += profit;
        }
    });
   
    const result = {
        monthly: { target: monthlyTarget, actual: monthlyActual, difference: monthlyDifference, rate: monthlyRate },
        yearly: { target: yearlyTarget, actual: yearlyActual, rate: yearlyRate },
        salesTarget: { target: salesIncreaseTarget, prospect: totalSalesProspect, rate: salesTargetRate },
        prospect: { total: prospectTotal, rate: prospectRate },
        funnel: { probUnder50, prob5060, prob70, prob80, prob90, prob100 }
    };
    
    progressCache = {
        data: result,
        cacheKey: cacheKey,
        timestamp: now
    };
    
    return result;
}

function updateMiddleCards() {
    const elSales = document.getElementById('salesProspectDisplay');
    const elProfit = document.getElementById('profitProspectDisplay');
    const elPersonal = document.getElementById('personalIncreaseTargetDisplay'); // 🆕 3枚目要素取得
    if (!elSales || !elProfit || !elPersonal) return; // 🆕 3枚目チェック追加

    const settings = getActiveSettings();
    const currentMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    // 80%以上の確度のみで売上・粗利見込を集計
    let totalSalesProspect = 0;
    let totalProfitProspect = 0;
    
    cardsData.forEach(card => {
        const monthData = card.monthlyData?.[currentMonthKey] || { 
            salesIncreaseForecast: 0, 
            probability: 50 
        };
        
        if (monthData.probability >= 80) {
            const salesAmount = monthData.salesIncreaseForecast || 0;
            const profitAmount = salesAmount * ((settings.profitRate || 0) / 100);
            totalSalesProspect += salesAmount;
            totalProfitProspect += profitAmount;
        }
    });
    
    const salesTarget = settings.yearlySalesIncreaseTarget || 0;
    const profitTarget = settings.yearlyProfitIncreaseTarget || 0;
    const salesRate = salesTarget > 0 ? (totalSalesProspect / salesTarget) * 100 : 0;
    const profitRate = profitTarget > 0 ? (totalProfitProspect / profitTarget) * 100 : 0;
    
    // 見込み値を強調表示
    elSales.innerHTML = `売上増見込 <span class="value-emphasis">${formatAmount(totalSalesProspect)}</span>/${formatAmount(salesTarget)} (${salesRate.toFixed(1)}%)`;
    elProfit.innerHTML = `粗利増見込 <span class="value-emphasis">${formatAmount(totalProfitProspect)}</span>/${formatAmount(profitTarget)} (${profitRate.toFixed(1)}%)`;

    // 🆕 3枚目カードの更新処理
    const manualTarget = settings.personalSalesIncreaseTarget || settings.yearlySalesIncreaseTarget || 0;
    const pr = Number(settings.profitRate || 0);
    elPersonal.innerHTML = `個人設定売上増目標 <span class="value-emphasis">${formatManPlain(manualTarget)}</span> | 粗利率 ${pr.toFixed(1)}%`;
}

function updateDashboard() {
    // 売上フィールドの編集機能を無効化
    lockAutoCalculatedFields();
    
    if (!document.getElementById('monthlyProfitTarget')) {
        console.log('Dashboard elements not ready yet, skipping update');
        return;
    }

    const settings = getActiveSettings();
    const { months, currentMonthIndex } = getFiscalYearStructure();
    const profitRate = (settings.profitRate || 0) / 100;

    // アクティブ月の取得（グローバル月セレクターに連動）
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeMonthInfo = months.find(m => m.key === activeMonthKey);
    const activeMonth = activeMonthInfo ? activeMonthInfo.month : months[currentMonthIndex].month;
    const activeIndex = activeMonthInfo ? months.indexOf(activeMonthInfo) : currentMonthIndex;

    // 1. 月別粗利（選択月に対応）
    const monthlyProfitTarget = settings.monthlyProfitTargets[activeMonth] || 0;
    const monthlyProfitActual = settings.monthlyProfitActuals[activeMonth] || 0;

    const monthlyProfitDiff = monthlyProfitActual - monthlyProfitTarget;
    const monthlyProfitRate = monthlyProfitTarget > 0 ? (monthlyProfitActual / monthlyProfitTarget) * 100 : 0;

    updateCardValue('monthlyProfitTarget', formatAmount(monthlyProfitTarget));
    updateCardValue('monthlyProfitActual', formatAmount(monthlyProfitActual));
    updateCardDifference('monthlyProfitDiff', monthlyProfitDiff);
    updateCardValue('monthlyProfitRate', `${monthlyProfitRate.toFixed(1)}%`);

    // 2. 月別売上（円表記）
    const monthlySalesTarget = profitRate > 0 ? monthlyProfitTarget / profitRate : 0;
    const monthlySalesActual = profitRate > 0 ? monthlyProfitActual / profitRate : 0;
    const monthlySalesDiff = monthlySalesActual - monthlySalesTarget;
    const monthlySalesRate = monthlySalesTarget > 0 ? (monthlySalesActual / monthlySalesTarget) * 100 : 0;

    updateCardValue('monthlySalesTarget', formatAmount(monthlySalesTarget));
    updateCardValue('monthlySalesActual', formatAmount(monthlySalesActual));
    updateCardDifference('monthlySalesDiff', monthlySalesDiff);
    updateCardValue('monthlySalesRate', `${monthlySalesRate.toFixed(1)}%`);

    // 3. 累積粗利（目標：選択月まで合算、実績：選択月の手入力値）
    let cumulativeProfitTarget = 0;
    for (let i = 0; i <= activeIndex; i++) {
        const monthNum = months[i].month;
        cumulativeProfitTarget += settings.monthlyProfitTargets[monthNum] || 0;
    }
    
    // 月ごとの累積粗利実績から選択月の値を取得（後方互換性あり）
    // 🆕 0を正しい値として扱う：undefined/nullの場合のみフォールバック
const monthCumulativeValue = settings.monthlyCumulativeProfitActuals?.[activeMonth];
const cumulativeProfitActual = (monthCumulativeValue !== undefined && monthCumulativeValue !== null)
    ? monthCumulativeValue
    : (settings.cumulativeProfitActual ?? 0);


    const cumulativeProfitDiff = cumulativeProfitActual - cumulativeProfitTarget;
    const cumulativeProfitRate = cumulativeProfitTarget > 0 ? (cumulativeProfitActual / cumulativeProfitTarget) * 100 : 0;

    updateCardValue('cumulativeProfitTarget', formatAmount(cumulativeProfitTarget));
    updateCardValue('cumulativeProfitActual', formatAmount(cumulativeProfitActual));
    updateCardDifference('cumulativeProfitDiff', cumulativeProfitDiff);
    updateCardValue('cumulativeProfitRate', `${cumulativeProfitRate.toFixed(1)}%`);

    // 4. 累積売上（円表記）
    const cumulativeSalesTarget = profitRate > 0 ? cumulativeProfitTarget / profitRate : 0;
    const cumulativeSalesActual = profitRate > 0 ? cumulativeProfitActual / profitRate : 0;
    const cumulativeSalesDiff = cumulativeSalesActual - cumulativeSalesTarget;
    const cumulativeSalesRate = cumulativeSalesTarget > 0 ? (cumulativeSalesActual / cumulativeSalesTarget) * 100 : 0;

    updateCardValue('cumulativeSalesTarget', formatAmount(cumulativeSalesTarget));
    updateCardValue('cumulativeSalesActual', formatAmount(cumulativeSalesActual));
    updateCardDifference('cumulativeSalesDiff', cumulativeSalesDiff);
    updateCardValue('cumulativeSalesRate', `${cumulativeSalesRate.toFixed(1)}%`);

    // ファネル更新
    const progress = calculateAllProgress();
    const safeUpdateElement = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    };
    
    safeUpdateElement('probUnder50', formatManYen(progress.funnel.probUnder50));
    safeUpdateElement('prob5060', formatManYen(progress.funnel.prob5060));
    safeUpdateElement('prob70', formatManYen(progress.funnel.prob70));
    safeUpdateElement('prob80', formatManYen(progress.funnel.prob80));
    safeUpdateElement('prob90', formatManYen(progress.funnel.prob90));
    safeUpdateElement('prob100', formatManYen(progress.funnel.prob100));

    updateMiddleCards();
}

async function displayMasterView() {
    if (window.innerWidth < 1025) {
        showToast('マスタービューはPC版でのみ利用可能です', 'info');
        return;
    }
    if (currentUserRole !== 'admin') {
        showToast('管理者権限が必要です', 'error');
        return;
    }
    
    const masterViewContentDiv = document.getElementById('masterViewContent');
    // ローディング表示
    masterViewContentDiv.innerHTML = '<div style="text-align: center; padding: 50px;"><p>📊 データ読み込み中...</p></div>';

    try {
        console.log('マスタービュー: ユーザーデータ読み込み開始');
        const usersCollection = await window.firebaseImports.getDocs(
            window.firebaseImports.collection(window.db, 'users')
        );
        console.log('マスタービュー: ユーザーデータ読み込み完了', usersCollection.size, '件');
        
        const staffList = [];
        usersCollection.forEach((doc) => {
            const userData = doc.data();
            const userId = doc.id;
            staffList.push({
                id: userId,
                name: userData.name,
                role: userData.role,
                settings: userData.personalSettings || getDefaultSettings()
            });
        });
        
        // コンテンツ初期化
        masterViewContentDiv.innerHTML = '';
        const masterContainer = document.createElement('div');
        masterContainer.className = 'master-view-container';
        masterContainer.innerHTML = '<h2>👑 マスター管理画面（全スタッフ一覧）</h2>';
        
        // 各スタッフのセクション生成
        for (const staff of staffList) {
            console.log(`マスタービュー: ${staff.name}さんのデータ処理中`);
            const staffSection = document.createElement('div');
            staffSection.className = 'master-staff-section';
            
            try {
                const staffCardsQuery = window.firebaseImports.query(
                    window.firebaseImports.collection(window.db, 'juku_cards'),
                    window.firebaseImports.where('assignedUserId', '==', staff.id)
                );
                const staffCards = await window.firebaseImports.getDocs(staffCardsQuery);
                
                const staffCardsData = [];
                staffCards.forEach((doc) => staffCardsData.push(doc.data()));
                console.log(`マスタービュー: ${staff.name}さんの塾データ ${staffCardsData.length}件`);
                
                staffSection.innerHTML = `
                    <div class="master-staff-name">担当: ${staff.name}（${staff.role === 'admin' ? '管理者' : staff.role === 'manager' ? 'マネージャー' : '営業担当'}）</div>
                    <div class="master-main-cards">
                        ${generateMasterMainCards(staff, staffCardsData)}
                    </div>
                    <div class="master-middle-cards">
                        ${generateMasterMiddleCards(staff, staffCardsData)}
                    </div>
                    <div class="master-funnel">
                        ${generateMasterFunnel(staff, staffCardsData)}
                    </div>
                `;
                
            } catch (staffError) {
                console.error(`${staff.name}さんのデータ取得エラー:`, staffError);
                staffSection.innerHTML = `
                    <div class="master-staff-name">担当: ${staff.name} - データ取得エラー</div>
                    <div style="color: red; padding: 20px; text-align: center;">このスタッフのデータを読み込めませんでした</div>
                `;
            }
            
            masterContainer.appendChild(staffSection);
        }
        
        masterViewContentDiv.appendChild(masterContainer);
        console.log('マスタービュー表示完了');

    } catch (error) {
        console.error('マスタービューエラー:', error);
        masterViewContentDiv.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #D32F2F;">
                <h3>⚠️ マスタービューの読み込みに失敗しました</h3>
                <p><strong>エラー:</strong> ${error.message}</p>
                <p style="margin-top: 15px;">Firestoreの読み取り権限を確認してください</p>
                <button onclick="location.reload()" style="padding: 12px 24px; margin-top: 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">ページを再読み込み</button>
            </div>
        `;
        showToast('マスタービューの読み込みに失敗しました。権限設定を確認してください。', 'error');
    }
}

function generateMasterMainCards(staff, cardsData) {
    const s = staff.settings;
    const { months } = getFiscalYearStructure();

    // グローバル月セレクターの値を使用
    const activeKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    const activeIndex = Math.max(0, months.findIndex(m => m.key === activeKey));
    const fallbackIndex = getFiscalYearStructure().currentMonthIndex;
    const idx = activeIndex >= 0 ? activeIndex : fallbackIndex;

    const currentMonth = months[idx].month;
    const profitRate = (s.profitRate || 0) / 100;

    // 月別粗利（選択月）
    const monthlyProfitTarget = s.monthlyProfitTargets?.[currentMonth] || 0;
    const monthlyProfitActual = s.monthlyProfitActuals?.[currentMonth] || 0;
    const monthlyProfitDiff = monthlyProfitActual - monthlyProfitTarget;
    const monthlyProfitRate = monthlyProfitTarget > 0 ? (monthlyProfitActual / monthlyProfitTarget) * 100 : 0;

    // 月別売上（選択月）
    const monthlySalesTarget = profitRate > 0 ? monthlyProfitTarget / profitRate : 0;
    const monthlySalesActual = profitRate > 0 ? monthlyProfitActual / profitRate : 0;
    const monthlySalesDiff = monthlySalesActual - monthlySalesTarget;
    const monthlySalesRate = monthlySalesTarget > 0 ? (monthlySalesActual / monthlySalesTarget) * 100 : 0;

    // 累積粗利（選択月まで目標合算、選択月実績値）
    let cumulativeProfitTarget = 0;
    for (let i = 0; i <= idx; i++) {
        const monthNum = months[i].month;
        cumulativeProfitTarget += s.monthlyProfitTargets?.[monthNum] || 0;
    }

    // 選択月の累積粗利実績を取得（後方互換性あり）
    const selectedMonth = months[idx].month;
    // 🆕 マスタービューでも同様の修正
const monthCumulativeValue = s.monthlyCumulativeProfitActuals?.[selectedMonth];
const cumulativeProfitActual = (monthCumulativeValue !== undefined && monthCumulativeValue !== null)
    ? monthCumulativeValue
    : (s.cumulativeProfitActual ?? 0);


    const cumulativeProfitDiff = cumulativeProfitActual - cumulativeProfitTarget;
    const cumulativeProfitRate = cumulativeProfitTarget > 0 ? (cumulativeProfitActual / cumulativeProfitTarget) * 100 : 0;

    // 累積売上（選択月まで）
    const cumulativeSalesTarget = profitRate > 0 ? cumulativeProfitTarget / profitRate : 0;
    const cumulativeSalesActual = profitRate > 0 ? cumulativeProfitActual / profitRate : 0;
    const cumulativeSalesDiff = cumulativeSalesActual - cumulativeSalesTarget;
    const cumulativeSalesRate = cumulativeSalesTarget > 0 ? (cumulativeSalesActual / cumulativeSalesTarget) * 100 : 0;

    // 差額表示のヘルパー関数
    const formatDiff = (amount) => {
        const diff = formatDifferenceAmount(amount, formatAmount);
        const className = diff.isNegative ? 'negative' : (amount > 0 ? 'positive' : 'neutral');
        return `<span class="metric-value ${className}">${diff.text}</span>`;
    };

    return `
        <!-- 月別粗利カード -->
        <div class="progress-card monthly-profit-card">
            <h3>月別粗利</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(monthlyProfitTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(monthlyProfitActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(monthlyProfitDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${monthlyProfitRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 月別売上カード -->
        <div class="progress-card monthly-sales-card">
            <h3>月別売上</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(monthlySalesTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(monthlySalesActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(monthlySalesDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${monthlySalesRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 累積粗利カード -->
        <div class="progress-card cumulative-profit-card">
            <h3>累積粗利</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(cumulativeProfitTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(cumulativeProfitActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(cumulativeProfitDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${cumulativeProfitRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>

        <!-- 累積売上カード -->
        <div class="progress-card cumulative-sales-card">
            <h3>累積売上</h3>
            <div class="card-metrics">
                <div class="metric-row">
                    <span class="metric-label">目標:</span>
                    <span class="metric-value">${formatAmount(cumulativeSalesTarget)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">実績:</span>
                    <span class="metric-value">${formatAmount(cumulativeSalesActual)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">差額:</span>
                    ${formatDiff(cumulativeSalesDiff)}
                </div>
                <div class="metric-row">
                    <span class="metric-label">達成率:</span>
                    <span class="metric-value">${cumulativeSalesRate.toFixed(1)}%</span>
                </div>
            </div>
        </div>
    `;
}

function generateMasterMiddleCards(staff, cardsData) {
    const s = staff.settings;
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    
    let totalSalesProspect = 0;
    let totalProfitProspect = 0;
    cardsData.forEach(card => {
        const md = card.monthlyData?.[activeMonthKey] || { salesIncreaseForecast: 0, probability: 50 };
        if (md.probability >= 80) {
            const salesAmount = md.salesIncreaseForecast || 0;
            const profitAmount = salesAmount * ((s.profitRate || 0) / 100);
            totalSalesProspect += salesAmount;
            totalProfitProspect += profitAmount;
        }
    });
    const salesTarget = s.yearlySalesIncreaseTarget || 0;
    const profitTarget = s.yearlyProfitIncreaseTarget || 0;
    const salesRate = salesTarget > 0 ? (totalSalesProspect / salesTarget) * 100 : 0;
    const profitRate = profitTarget > 0 ? (totalProfitProspect / profitTarget) * 100 : 0;
    
    // 🆕 3枚目カード用データ取得
    const manualTarget = s.personalSalesIncreaseTarget || s.yearlySalesIncreaseTarget || 0;
    const pr = Number(s.profitRate || 0);
    
    return `
        <div class="master-middle-card">売上増見込 ${formatAmount(totalSalesProspect)}/${formatAmount(salesTarget)} (${salesRate.toFixed(1)}%)</div>
        <div class="master-middle-card">粗利増見込 ${formatAmount(totalProfitProspect)}/${formatAmount(profitTarget)} (${profitRate.toFixed(1)}%)</div>
        <div class="master-middle-card full-width">
            個人設定売上増目標 <span class="value-emphasis">${formatManPlain(manualTarget)}</span> | 粗利率 ${pr.toFixed(1)}%
        </div>
    `;
}

function generateMasterFunnel(staff, cardsData) {
    const s = staff.settings;
    const activeMonthKey = activeDashboardMonthKey || getFiscalYearStructure().currentMonthKey;
    let probUnder50 = 0, prob5060 = 0, prob70 = 0, prob80 = 0, prob90 = 0, prob100 = 0;
    
    cardsData.forEach(card => {
        const md = card.monthlyData?.[activeMonthKey] || { salesIncreaseForecast: 0, probability: 50 };
        const profit = (md.salesIncreaseForecast || 0) * ((s.profitRate || 0) / 100);
        if (md.probability < 50) probUnder50 += profit;
        else if (md.probability < 70) prob5060 += profit;
        else if (md.probability < 80) prob70 += profit;
        else if (md.probability < 90) prob80 += profit;
        else if (md.probability < 100) prob90 += profit;
        else prob100 += profit;
    });
    
    return `
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="funnel-item" style="flex:1;min-width:120px;background:#fff;border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">50%未満</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(probUnder50)}</div>
            </div>
            <div class="funnel-item" style="flex:1;min-width:120px;background:#fff;border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">50%-70%未満</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(prob5060)}</div>
            </div>
            <div class="funnel-item" style="flex:1;min-width:120px;background:#fff;border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">70%以上</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(prob70)}</div>
            </div>
            <div class="funnel-item" style="flex:1;min-width:120px;background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.25);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">80%以上</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(prob80)}</div>
            </div>
            <div class="funnel-item" style="flex:1;min-width:120px;background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.25);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">90%以上</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(prob90)}</div>
            </div>
            <div class="funnel-item" style="flex:1;min-width:120px;background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.25);border-radius:8px;padding:8px;text-align:center;">
                <div style="font-size:11px;margin-bottom:2px;color:#333;">100%</div>
                <div style="font-size:12px;font-weight:bold;color:#333;">${formatManYen(prob100)}</div>
            </div>
        </div>
    `;
}
       
function createTableRow(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = cardData.displayMonth || fiscalStructure.currentMonthKey;
    const previousMonth = getPreviousMonth(displayMonth);
    
    // 2ヶ月分のデータ取得
    const currentData = cardData.monthlyData?.[displayMonth] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    const previousData = cardData.monthlyData?.[previousMonth.key] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    
    const level = getCardLevel(currentData.salesIncreaseForecast || 0);
    const change = calculateMonthlyChange(cardData, displayMonth);
    
    // 編集権限の判定
    const canEdit = hasPermission('edit_data', cardData);
    const isCurrentMonth = displayMonth === fiscalStructure.currentMonthKey;
    
    const row = document.createElement('tr');
    row.dataset.cardId = cardData.id;
    
    row.innerHTML = `
        <td class="col-level">
            <div class="level-indicator level-${level}"></div>
        </td>
        <td class="col-name">
            ${canEdit ? `
                <div class="editable-cell" onclick="editTableName(${cardData.id})">
                    ${escapeHtml(cardData.jukuName)}
                </div>
            ` : `
                <div>${escapeHtml(cardData.jukuName)}</div>
            `}
        </td>
        <td class="col-prev-amount">
            ${formatManYen(previousData.salesIncreaseForecast || 0)}
        </td>
        <td class="col-prev-prob">
            ${getProbabilityLabel(previousData.probability || 50)}
        </td>
        <td class="col-current-amount">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableForecast(${cardData.id},'${displayMonth}')">
                    ${formatManYen(currentData.salesIncreaseForecast || 0)}
                </div>
            ` : `
                ${formatManYen(currentData.salesIncreaseForecast || 0)}
            `}
        </td>
        <td class="col-current-prob">
            ${canEdit && isCurrentMonth ? `
                <div class="editable-cell" onclick="editTableProbability(${cardData.id},'${displayMonth}')">
                    ${getProbabilityLabel(currentData.probability || 50)}
                </div>
            ` : `
                ${getProbabilityLabel(currentData.probability || 50)}
            `}
        </td>
        <td class="col-change">
            <span class="change-${change.direction}">
                ${formatManYen(change.amount)} ${change.direction === 'increase' ? '↗' : change.direction === 'decrease' ? '↘' : '→'}
            </span>
        </td>
        <td class="col-detail">
            <button class="detail-btn" onclick="openMonthlyHistoryModal(${cardData.id})">詳細</button>
        </td>
    `;
    
    // 閲覧専用カードのスタイル適用
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        row.style.cssText = 'opacity: 0.7; background: #fff3cd;';
    }
    
    return row;
}


function editTableName(id) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    const v = prompt('塾名を編集', c.jukuName);
    if (v !== null && v.trim() !== c.jukuName) {
        c.jukuName = v.trim();
        c.lastUpdated = new Date().toISOString();
        saveCardsData();
        renderCardsOptimized();
        showToast('塾名を更新', 'success');
    }
}

function editTableForecast(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能', 'info');
        return;
    }
    const cur = c.monthlyData?.[key] || { salesIncreaseForecast: 0 };
    const v = prompt('売上増見込を入力（円）', cur.salesIncreaseForecast || 0);
    if (v !== null) {
        const n = parseNumberSafely(v);
        if (!c.monthlyData) c.monthlyData = {};
        if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        c.monthlyData[key].salesIncreaseForecast = n;
        c.lastUpdated = new Date().toISOString();
        if (confirm('将来月も更新?')) propagateToFutureMonths(id, n, c.monthlyData[key].probability);
        else saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('売上増見込を更新', 'success');
    }
}

function editTableProbability(id, key) {
    const c = cardsData.find(x => x.id === id);
    if (!c || !hasPermission('edit_data', c)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    if (key !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能', 'info');
        return;
    }
    const opts = ['50未満', '50%', '60%', '70%', '80%', '90%', '100%'], vals = [40, 50, 60, 70, 80, 90, 100];
    const cur = c.monthlyData?.[key] || { probability: 50 };
    const idx = vals.indexOf(cur.probability);
    const choice = prompt(`確率選択:\n0:${opts[0]}\n1:${opts[1]}\n2:${opts[2]}\n3:${opts[3]}\n4:${opts[4]}\n5:${opts[5]}\n6:${opts[6]}\n現在:${opts[idx >= 0 ? idx : 1]}`, idx >= 0 ? idx : 1);
    if (choice !== null) {
        const i = parseInt(choice);
        if (i >= 0 && i < vals.length) {
            const nv = vals[i];
            if (!c.monthlyData) c.monthlyData = {};
            if (!c.monthlyData[key]) c.monthlyData[key] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
            c.monthlyData[key].probability = nv;
            c.lastUpdated = new Date().toISOString();
            if (confirm('将来月も更新?')) propagateToFutureMonths(id, c.monthlyData[key].salesIncreaseForecast, nv);
            else saveCardsData();
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
            showToast('確率を更新', 'success');
        }
    }
}

function createNewCardElement(cardData) {
    const fiscalStructure = getFiscalYearStructure();
    const displayMonth = cardData.displayMonth || fiscalStructure.currentMonthKey;
    const previousMonth = getPreviousMonth(displayMonth);
    
    const currentData = cardData.monthlyData?.[displayMonth] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    const previousData = cardData.monthlyData?.[previousMonth.key] || { 
        salesIncreaseForecast: 0, probability: 50, memo: "" 
    };
    
    const cardLevel = getCardLevel(currentData.salesIncreaseForecast || 0);
    
    const card = document.createElement('div');
    card.className = `card card-level-${cardLevel}`;
    card.dataset.cardId = cardData.id;
    
    const lastUpdated = formatDateForDisplay(cardData.lastUpdated);
    
    const currentForecast = currentData.salesIncreaseForecast || 0;
    const previousForecast = previousData.salesIncreaseForecast || 0;
    const difference = currentForecast - previousForecast;
    const changeIcon = difference > 0 ? '📈' : difference < 0 ? '📉' : '➡️';
    const changeClass = difference > 0 ? 'comparison-positive' : difference < 0 ? 'comparison-negative' : 'comparison-neutral';
    
    card.innerHTML = `
        <div class="card-header-new">
            <div class="card-title-clickable" onclick="openMonthlyHistoryModal(${cardData.id})">
                ${escapeHtml(cardData.jukuName)}
            </div>
            <select class="month-selector" onchange="changeCardDisplayMonth(${cardData.id}, this.value)">
                ${fiscalStructure.months.map(month => 
                    `<option value="${month.key}" ${month.key === displayMonth ? 'selected' : ''}>${month.month}月</option>`                ).join('')}
            </select>
        </div>
        
        <div class="annual-metrics-row">
            <div class="annual-metric">
                <div class="annual-metric-label">売上増見込（${fiscalStructure.months.find(m => m.key === displayMonth)?.month}月時点）</div>
                <div class="annual-metric-value">${formatAmount(currentData.salesIncreaseForecast || 0)}</div>
                <div class="change-indicator ${changeClass}">
                    ${changeIcon} ${formatAmount(difference)}
                </div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">エリア</div>
                <div class="annual-metric-value">${escapeHtml(cardData.area || '未設定')}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">年間粗利実績</div>
                <div class="annual-metric-value">${formatAmount(cardData.annualProfitActual || 0)}</div>
            </div>
            <div class="annual-metric">
                <div class="annual-metric-label">年間売上実績</div>
                <div class="annual-metric-value">${formatAmount(calculateSalesFromProfit(cardData.annualProfitActual || 0))}</div>
            </div>
        </div>
        
        <div class="monthly-comparison-section">
            <div class="month-data-column">
                <div class="month-data-header">先月 (${previousMonth.month}月)</div>
                <div class="month-data-content">
                    <div class="forecast-amount">売上増見込: ${formatAmount(previousData.salesIncreaseForecast)}</div>
                    <div class="forecast-probability">確率: ${getProbabilityLabel(previousData.probability)}</div>
                </div>
            </div>
            <div class="month-data-column">
                <div class="month-data-header">今月 (${fiscalStructure.months.find(m => m.key === displayMonth)?.month}月)</div>
                <div class="month-data-content">
                    <div class="editable-field" onclick="editSalesIncreaseForecast(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">売上増見込: ${formatAmount(currentData.salesIncreaseForecast)}</span>
                        <input type="number" class="edit-input" value="${currentData.salesIncreaseForecast}" style="display:none;">
                    </div>
                    <div class="editable-field" onclick="editProbability(${cardData.id}, '${displayMonth}', this)">
                        <span class="display-value">確率: ${getProbabilityLabel(currentData.probability)}</span>
                        <select class="edit-select" style="display:none;">
                            ${PROBABILITY_CONFIG.options.map(opt => 
                                `<option value="${opt.value}" ${currentData.probability === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="memo-comparison-section">
            <div class="memo-column">
                <div class="memo-header">先月メモ</div>
                <div class="memo-content">${escapeHtml(previousData.memo || '未入力')}</div>
            </div>
            <div class="memo-column">
                <div class="memo-header">今月メモ</div>
                <div class="memo-content" onclick="openMemoDetailModal(${cardData.id}, '${displayMonth}')">${escapeHtml(currentData.memo || '未入力')}</div>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="last-updated">最終更新: ${lastUpdated}</div>
            <div class="card-actions">
                <button class="action-btn" title="履歴" aria-label="履歴" onclick="openMonthlyHistoryModal(${cardData.id})">📊</button>
                ${hasPermission('edit_data', cardData) ? `<button class="action-btn" title="編集" aria-label="編集" onclick="editCard(this)">✏️</button>` : ''}
                ${hasPermission('delete_data', cardData) ? `<button class="action-btn" title="削除" aria-label="削除" onclick="deleteCard(${cardData.id})">🗑️</button>` : ''}
            </div>
        </div>
    `;
    
    if (cardData.assignedUserId !== (currentUser?.uid || '')) {
        card.style.opacity = '0.8';
        card.classList.add('read-only-card');
        card.style.position = 'relative';
        
        const readOnlyBadge = document.createElement('div');
        readOnlyBadge.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        `;
        readOnlyBadge.textContent = '👁️ 閲覧専用';
        card.appendChild(readOnlyBadge);
        
        const assignedUserName = cardData.assignedUserName || '不明';
        card.title = `担当者: ${assignedUserName}さんのデータ（閲覧専用）`;
    }

    return card;
}

function propagateToFutureMonths(cardId, newForecast, newProbability) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    const fiscalStructure = getFiscalYearStructure();
    const currentMonthKey = fiscalStructure.currentMonthKey;
    const registeredIndex = fiscalStructure.months.findIndex(m => 
        m.key === (cardData.registeredMonth || currentMonthKey)
    );
    const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);
    
    fiscalStructure.months.forEach((monthInfo, index) => {
        if (index > Math.max(registeredIndex, currentIndex)) {
            if (!cardData.monthlyData[monthInfo.key]) {
                cardData.monthlyData[monthInfo.key] = { 
                    salesIncreaseForecast: 0, probability: 50, memo: "" 
                };
            }
            cardData.monthlyData[monthInfo.key].salesIncreaseForecast = newForecast;
            cardData.monthlyData[monthInfo.key].probability = newProbability;
        }
    });
    
    saveCardsData();
    showToast('将来月のデータを一括更新しました', 'success');
}

function openModal(modalId) {
    scrollPosition = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('modal-open');
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.classList.remove('modal-open');
    window.scrollTo(0, scrollPosition);
    document.getElementById(modalId).style.display = 'none';
}

function openProgressGraphModal(cardIndex) {
    const cardTitles = ['月別目標（粗利）', '年間目標（粗利）', '年間売上増目標', '営業見込（粗利増）'];
    document.getElementById('graphModalTitle').textContent = `${cardTitles[cardIndex]} - 年間進捗グラフ`;
    
    generateProgressChart(cardIndex);
    openModal('progressGraphModal');
}

function closeProgressGraphModal() {
    if (progressChart) {
        progressChart.destroy();
        progressChart = null;
    }
    closeModal('progressGraphModal');
}

function generateProgressChart(graphType) {
    const ctx = document.getElementById('progressChart').getContext('2d');
    const data = generateFiscalYearData(graphType);
    
    if (progressChart) {
        progressChart.destroy();
    }
    
    const chartColors = {
        actual: '#00E5FF',
        target: '#FFEA00',
        positive: '#00E676',
        negative: '#FF1744',
        line: '#E040FB'
    };

    const chartConfigs = {
        0: {
            type: 'bar',
            datasets: [
                {
                    label: '実績値',
                    data: data.actualData,
                    backgroundColor: chartColors.actual,
                    borderColor: chartColors.actual,
                    borderWidth: 2
                },
                {
                    label: '目標値',
                    data: data.targetData,
                    backgroundColor: chartColors.target,
                    borderColor: chartColors.target,
                    borderWidth: 2
                }
            ]
        },
        1: {
            type: 'bar',
            datasets: [
                {
                    label: '累積実績',
                    data: data.actualData,
                    backgroundColor: chartColors.actual,
                    borderColor: chartColors.actual,
                    borderWidth: 2
                },
                {
                    label: '累積目標',
                    data: data.targetData,
                    backgroundColor: chartColors.target,
                    borderColor: chartColors.target,
                    borderWidth: 2
                }
            ]
        },
        2: {
    type: 'bar',
    datasets: [
        {
            label: '売上増見込（累計）',
            data: data.actualData,
            backgroundColor: chartColors.actual,
            borderColor: chartColors.actual,
            borderWidth: 2,
            type: 'bar'
        },
        {
            label: '売上増目標ライン',
            data: data.targetData,
            borderColor: chartColors.target,
            borderWidth: 3,
            borderDash: [8, 8],
            type: 'line',
            fill: false,
            pointRadius: 0,
            tension: 0
        }
    ]
},
        3: {
            type: 'line',
            datasets: [
                {
                    label: '営業見込達成率（%）',
                    data: data.actualData,
                    borderColor: chartColors.line,
                    backgroundColor: 'rgba(224, 64, 251, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 6,
                    pointBackgroundColor: chartColors.line,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                },
                {
                    label: '100%ライン',
                    data: data.targetData,
                    borderColor: chartColors.target,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                }
            ]
        }
    };
    
    const config = chartConfigs[graphType];
    
    progressChart = new Chart(ctx, {
        type: config.type,
        data: {
            labels: data.labels,
            datasets: config.datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(0,176,255,0.7)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === null) return null;
                            if (graphType === 3) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                            }
                            return `${context.dataset.label}: ${formatAmount(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255,255,255,0.2)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#E0E0E0'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255,255,255,0.2)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#E0E0E0',
                        callback: function(value) {
                            if (graphType === 3) {
                                return value + '%';
                            }
                            return formatManYen(value, 0);
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    updateGraphLegend(config.datasets);
}

function generateFiscalYearData(graphType) {
    const settings = getActiveSettings();
    const { months, currentMonthIndex } = getFiscalYearStructure();
    
    const actualData = [];
    const targetData = [];
    const labels = months.map(m => m.label.substring(m.label.indexOf('年') + 1));
    
    let cumActual = 0;
    let cumTarget = 0;
    
    months.forEach((monthInfo, index) => {
        const isPastMonth = index <= currentMonthIndex;
        const monthNum = monthInfo.month;
        
        switch(graphType) {
            case 0: {
                const monthlyTarget = settings.monthlyProfitTargets[monthNum] || 0;
                const monthlyActual = isPastMonth ? (settings.monthlyProfitActuals[monthNum] || 0) : 0;
                targetData.push(monthlyTarget);
                actualData.push(isPastMonth ? monthlyActual : null);
                break;
            }
            case 1: {
                const t = settings.monthlyProfitTargets[monthNum] || 0;
                const a = isPastMonth ? (settings.monthlyProfitActuals[monthNum] || 0) : 0;
                cumTarget += t;
                cumActual += isPastMonth ? a : 0;
                targetData.push(cumTarget);
                actualData.push(isPastMonth ? cumActual : null);
                break;
            }
            case 2: {
                const salesIncreaseTarget = settings.yearlySalesIncreaseTarget || 0;
                let cumSalesProspect = 0;
                for (let j = 0; j <= index; j++) {
                    const key = months[j].key;
                    cardsData.forEach(card => {
                        const md = card.monthlyData?.[key] || { salesIncreaseForecast: 0 };
                        cumSalesProspect += md.salesIncreaseForecast || 0;
                    });
                }
                targetData.push(salesIncreaseTarget);
                actualData.push(isPastMonth ? cumSalesProspect : null);
                break;
            }
            case 3: {
                let cumProspectProfit = 0;
                for (let j = 0; j <= index; j++) {
                    const key = months[j].key;
                    cardsData.forEach(card => {
                        const md = card.monthlyData?.[key] || { 
                            salesIncreaseForecast: 0, 
                            probability: 50 
                        };
                        if (md.probability >= 80) {
                            cumProspectProfit += (md.salesIncreaseForecast || 0) 
                                               * ((settings.profitRate || 0) / 100);
                        }
                    });
                }
                const profitIncreaseTarget = settings.yearlyProfitIncreaseTarget || 0;
                const rate = profitIncreaseTarget > 0 ? 
                    (cumProspectProfit / profitIncreaseTarget) * 100 : 0;
                actualData.push(isPastMonth ? rate : null);
                targetData.push(100);
                break;
            }
        }
    });
    
    return { labels, actualData, targetData };
}


function updateGraphLegend(datasets) {
    const legendContainer = document.getElementById('graphLegend');
    legendContainer.innerHTML = '';

    datasets.forEach(dataset => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        const legendColor = Array.isArray(dataset.backgroundColor) ? 
                            dataset.backgroundColor[0] : 
                            (dataset.backgroundColor || dataset.borderColor);
        
        legendItem.innerHTML = `
            <span class="legend-color" style="background: ${legendColor};"></span>
            <span>${dataset.label}</span>
        `;
        legendContainer.appendChild(legendItem);
    });
}

function filterByProbability(probability) {
    activeProbabilityFilter = probability || 'all';
    applyFilters();
    showToast(`確率${probability === 'all' ? '全体' : probability}で絞り込みました`, 'info');
}


function openNewCardModal() {
    if (!hasPermission('create_data')) {
        showToast('自分のデータ表示中のみ新規登録できます', 'error');
        return;
    }
    
    document.getElementById('newCardForm').reset();
    updateActualSales('new');
    document.getElementById('newSalesActual').readOnly = true;
    document.getElementById('newSalesActual').style.background = '#f8f9fa';
    openModal('newCardModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closeNewCardModal() {
    document.getElementById('newCardForm').reset();
    closeModal('newCardModal');
}

function openPersonalSettingsModal() {
    document.getElementById('userName').value = personalSettings.userName;
    document.getElementById('profitRate').value = personalSettings.profitRate;
    document.getElementById('yearlyProfitTarget').value = personalSettings.yearlyProfitTarget;
    document.getElementById('yearlyProfitIncreaseTarget').value = personalSettings.yearlyProfitIncreaseTarget;
    document.getElementById('yearlySalesIncreaseTarget').value = personalSettings.yearlySalesIncreaseTarget;
document.getElementById('personalSalesIncreaseTarget').value = personalSettings.personalSalesIncreaseTarget || 0;
    
    const monthlyContainer = document.getElementById('monthlyProfitContainer');
    const fiscalMonths = getFiscalYearStructure().months;
    
    monthlyContainer.innerHTML = '';
    
    fiscalMonths.forEach(monthInfo => {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'monthly-row';
        const actualValue = personalSettings.monthlyProfitActuals[monthInfo.month] || 0;
        const targetValue = personalSettings.monthlyProfitTargets[monthInfo.month] || 0;
        const actualDisplay = actualValue === 0 ? '' : actualValue;
        const targetDisplay = targetValue === 0 ? '' : targetValue;
        
        monthDiv.innerHTML = `
            <div class="month-name">${monthInfo.label.substring(monthInfo.label.indexOf('年') + 1)}</div>
            <input type="number" class="monthly-input" placeholder="実績" id="monthlyProfitActual${monthInfo.month}" value="${actualDisplay}">
            <input type="number" class="monthly-input" placeholder="目標" id="monthlyProfitTarget${monthInfo.month}" value="${targetDisplay}">
            <div style="font-size: 10px; color: rgba(0,0,0,0.7); text-align: center;"></div>
        `;
        monthlyContainer.appendChild(monthDiv);
    });
    
    setTimeout(() => {
        setupMonthlyInputHandlers('monthlyProfitContainer');
    }, 100);
    
    openModal('personalSettingsModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closePersonalSettingsModal() {
    closeModal('personalSettingsModal');
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    activeProbabilityFilter = 'all';
    document.getElementById('areaFilter').value = 'all';
    document.getElementById('sortSelect').value = 'sales-desc';
    renderCardsOptimized();
    showToast('フィルタをクリアしました', 'info');
}

function applySorting() {
    renderCardsOptimized();
}

function applyFilters() {
    renderCardsOptimized();
}

function changeCardDisplayMonth(cardId, newMonthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    cardData.displayMonth = newMonthKey;

    // 自分のデータ表示中のときだけ保存
    if (currentUser?.uid && currentViewTarget === currentUser.uid) {
        saveCardsData();
        showToast('表示月を変更し、データを保存しました', 'info');
    } else {
        showToast('表示月を変更しました（閲覧モード）', 'info');
    }

    renderCardsOptimized();
}

function changeAllCardsDisplayMonth(newMonthKey) {
    // UIのアクティブ月を更新
    activeDashboardMonthKey = newMonthKey;

    // 自分表示中のみ displayMonth を保存対象にする
    const selfId = currentUser?.uid || null;
    if (selfId && currentViewTarget === selfId) {
        cardsData.forEach(cardData => {
            cardData.displayMonth = newMonthKey;
        });
        saveCardsData();
        showToast('表示月を変更し、データを保存しました', 'info');
    } else {
        showToast('表示月を変更しました（閲覧モード）', 'info');
    }

    const fiscalStructure = getFiscalYearStructure();
    const monthInfo = fiscalStructure.months.find(m => m.key === newMonthKey);
    if (monthInfo) {
        document.getElementById('currentDateDisplay').textContent = monthInfo.label;
    }

    // マスタービュー表示中なら再描画
    if (currentViewTarget === 'master') {
        displayMasterView();
    }

    // 再計算と描画は常に実行
    progressCache = null;
    updateDashboard();
    renderCardsOptimized();
}


function openMonthlyHistoryModal(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    document.getElementById('historyModalTitle').textContent = `${cardData.jukuName} - 月別履歴（表示専用）`;
    
    const container = document.getElementById('monthlyHistoryContainer');
    container.innerHTML = '';
    
    const fiscalStructure = getFiscalYearStructure();

    fiscalStructure.months.forEach(monthInfo => {
        const monthData = cardData.monthlyData?.[monthInfo.key] || { 
            salesIncreaseForecast: 0, probability: 50, memo: "" 
        };

        const monthRow = document.createElement('div');
        monthRow.className = 'compact-month-row past-month';
        
        monthRow.innerHTML = `
            <div class="compact-month-header">
                ${monthInfo.label}
                <span class="readonly-badge">表示のみ</span>
            </div>
            <div class="compact-data-grid">
                <div class="compact-field">
                    <div class="compact-field-label">売上増見込</div>
                    <div class="compact-field-value">${formatManYen(monthData.salesIncreaseForecast)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">確率</div>
                    <div class="compact-field-value">${getProbabilityLabel(monthData.probability)}</div>
                </div>
                <div class="compact-field">
                    <div class="compact-field-label">メモ</div>
                    <div class="compact-memo">${escapeHtml(monthData.memo || '未入力')}</div>
                </div>
            </div>
        `;
        
        container.appendChild(monthRow);
    });
    
    openModal('monthlyHistoryModal');
}

function closeMonthlyHistoryModal() {
    closeModal('monthlyHistoryModal');
}

function editCard(button) {
    const card = button.closest('.card');
    const cardId = parseInt(card.dataset.cardId);
    const cardData = cardsData.find(card => card.id === cardId);
    
    if (!cardData) return;

    document.getElementById('editCardId').value = cardData.id;
    document.getElementById('editModalTitle').textContent = `${cardData.jukuName} - 編集`;
    document.getElementById('editJukuName').value = cardData.jukuName;
    document.getElementById('editJukuStatus').value = cardData.status;
    document.getElementById('editAddressInput').value = cardData.address;
    document.getElementById('editAreaInput').value = cardData.area || '';
    document.getElementById('editProfitActual').value = cardData.annualProfitActual;
    document.getElementById('editSalesActual').value = calculateSalesFromProfit(cardData.annualProfitActual || 0);
    
    const materials = cardData.annualMaterials || {
        yearRound: { hasOrder: false, orderPeriod: "" },
        seasonalExam: { hasUsage: null, usagePeriod: "" }
    };
    document.getElementById('editYearRoundOrder').value = String(materials.yearRound.hasOrder);
    document.getElementById('editYearRoundPeriod').value = materials.yearRound.orderPeriod || '';
    const seasonalValue = (materials.seasonalExam.hasUsage === null || typeof materials.seasonalExam.hasUsage === 'undefined')
    ? 'unknown'
    : String(materials.seasonalExam.hasUsage);
document.getElementById('editSeasonalUsage').value = seasonalValue;

    document.getElementById('editSeasonalPeriod').value = materials.seasonalExam.usagePeriod || '';
    
    openEditCardModal();
}

function openEditCardModal() {
    updateActualSales('edit');
    document.getElementById('editSalesActual').readOnly = true;
    document.getElementById('editSalesActual').style.background = '#f8f9fa';
    openModal('editCardModal');
    setTimeout(() => setupNumberFormatting(), 100);
}

function closeEditCardModal() {
    closeModal('editCardModal');
}

async function deleteCard(cardId) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    
    if (!hasPermission('delete_data', cardData)) {
        showToast('削除権限がありません', 'error');
        return;
    }
    
    const cardName = cardData ? cardData.jukuName : 'この塾';
    
    if (confirm(`『${cardName}』を削除します。この操作は元に戻せません。よろしいですか？`)) {
        cardsData = cardsData.filter(card => card.id !== cardId);
        
        if (currentUser && window.firebaseImports && window.db) {
            try {
                const docId = cardData.docId || `${cardData.assignedUserId || currentUser.uid}_${cardData.id}`;
                const cardRef = window.firebaseImports.doc(window.db, 'juku_cards', docId);
                await window.firebaseImports.deleteDoc(cardRef);
                console.log('Firestoreから削除完了:', docId);
            } catch (error) {

                console.error('Firestore delete error:', error);
                showToast('クラウド削除でエラーが発生しました', 'error');
            }
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        showToast('データを削除しました', 'success');
    }
}

function openMemoDetailModal(cardId, monthKey) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    const monthData = cardData.monthlyData?.[monthKey] || { memo: "" };
    const fiscalStructure = getFiscalYearStructure();
    const monthLabel = fiscalStructure.months.find(m => m.key === monthKey)?.label;

    document.getElementById('memoModalTitle').textContent = `メモ詳細 - ${monthLabel}`;
    document.getElementById('memoCardName').textContent = `塾名: ${cardData.jukuName}`;
    document.getElementById('memoContentInput').value = monthData.memo || '';
    
    // 🆕 権限チェック追加
    const canEdit = hasPermission('edit_data', cardData) &&
                    monthKey === getFiscalYearStructure().currentMonthKey;
    
    const textarea = document.getElementById('memoContentInput');
    const saveBtn = document.querySelector('#memoDetailModal .btn-primary');
    
    textarea.readOnly = !canEdit;
    saveBtn.style.display = canEdit ? 'inline-block' : 'none';
    
    if (!canEdit) {
        textarea.style.backgroundColor = '#f8f9fa';
        textarea.style.cursor = 'not-allowed';
        textarea.title = '編集権限がないか、過去月のため編集できません';
    } else {
        textarea.style.backgroundColor = '';
        textarea.style.cursor = '';
        textarea.title = '';
    }
    
    currentEditingMemo = { cardId, monthKey };
    openModal('memoDetailModal');
}


function closeMemoDetailModal() {
    currentEditingMemo = null;
    closeModal('memoDetailModal');
}

function saveMemoContent() {
    if (!currentEditingMemo) return;

    const { cardId, monthKey } = currentEditingMemo;
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;

    // 🆕 権限チェック追加（この4行を追加）
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません', 'error');
        return;
    }
    
    if (monthKey !== getFiscalYearStructure().currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    // 既存のコードはそのまま
    const newMemoContent = document.getElementById('memoContentInput').value;
    
    if (!cardData.monthlyData) cardData.monthlyData = {};
    if (!cardData.monthlyData[monthKey]) {
        cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
    }

    cardData.monthlyData[monthKey].memo = newMemoContent;
    cardData.lastUpdated = new Date().toISOString();

    saveCardsData();
    renderCardsOptimized();
    showToast('メモを保存しました', 'success');
    closeMemoDetailModal();
}

function updateActualSales(prefix) {
    const profitActual = parseNumberSafely(document.getElementById(`${prefix}ProfitActual`).value);
    const salesActual = calculateSalesFromProfit(profitActual);
    document.getElementById(`${prefix}SalesActual`).value = salesActual;
}

function setupMonthlyInputHandlers(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const inputs = container.querySelectorAll('.monthly-input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if (this.value === '0') {
                this.value = '';
            }
        });
    });
}

function getCardActiveMonthKey(card) {
    const globalSel = document.getElementById('globalMonthSelector');
    const globalKey = globalSel && globalSel.value ? globalSel.value : getFiscalYearStructure().currentMonthKey;
    return card.displayMonth || globalKey;
}

function getSortedCards(cards) {
    const sortType = document.getElementById('sortSelect').value;
    const sortedCards = [...cards];
    
    switch (sortType) {
        case 'sales-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                return bForecast - aForecast;
            });
        case 'sales-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aForecast = a.monthlyData?.[aKey]?.salesIncreaseForecast || 0;
                const bForecast = b.monthlyData?.[bKey]?.salesIncreaseForecast || 0;
                return aForecast - bForecast;
            });
        case 'updated-desc':
            return sortedCards.sort((a, b) => new Date(b.lastUpdated || '1970-01-01') - new Date(a.lastUpdated || '1970-01-01'));
        case 'updated-asc':
            return sortedCards.sort((a, b) => new Date(a.lastUpdated || '1970-01-01') - new Date(b.lastUpdated || '1970-01-01'));
        case 'probability-desc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 50;
                const bProb = b.monthlyData?.[bKey]?.probability || 50;
                return bProb - aProb;
            });
        case 'probability-asc':
            return sortedCards.sort((a, b) => {
                const aKey = getCardActiveMonthKey(a);
                const bKey = getCardActiveMonthKey(b);
                const aProb = a.monthlyData?.[aKey]?.probability || 50;
                const bProb = b.monthlyData?.[bKey]?.probability || 50;
                return aProb - bProb;
            });
        default:
            return sortedCards;
    }
}

function updateSortInfo() {
    const sortType = document.getElementById('sortSelect').value;
    const sortInfo = document.getElementById('sortInfo');
    
    const sortLabels = {
        'sales-desc': '売上増見込順（大→小）',
        'sales-asc': '売上増見込順（小→大）',
        'updated-desc': '最終更新日順（新→古）',
        'updated-asc': '最終更新日順（古→新）',
        'probability-desc': '受注確率順（高→低）',
        'probability-asc': '受注確率順（低→高）'
    };
    
    sortInfo.textContent = sortLabels[sortType] || '売上増見込順（大→小）';
}

function renderCardsOptimized() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => {
        const startTime = performance.now();
        renderCards();
        const endTime = performance.now();
        if (endTime - startTime > 100) {
            console.warn(`Slow render detected: ${endTime - startTime}ms`);
        }
    }, RENDER_DEBOUNCE_MS);
}
function editSalesIncreaseForecast(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません（閲覧専用）', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const inputField = element.querySelector('.edit-input');

    displaySpan.style.display = 'none';
    inputField.style.display = 'block';
    inputField.focus();
    inputField.select();

    const saveChanges = () => {
        const newValue = parseNumberSafely(inputField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].salesIncreaseForecast !== newValue) {
            cardData.monthlyData[monthKey].salesIncreaseForecast = newValue;
            cardData.lastUpdated = new Date().toISOString();
            
            if (confirm('将来月のデータも同じ値に更新しますか？\n（キャンセルすると当月のみ更新されます）')) {
                propagateToFutureMonths(cardId, newValue, cardData.monthlyData[monthKey].probability);
            } else {
                saveCardsData();
                showToast('当月の売上増見込を更新しました', 'success');
            }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            inputField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        inputField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

    inputField.onblur = saveChanges;
    inputField.onkeydown = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            saveChanges();
        } else if (event.key === 'Escape') {
            event.preventDefault();
            cancelEdit();
        }
    };
}

function editProbability(cardId, monthKey, element) {
    const cardData = cardsData.find(card => card.id === cardId);
    if (!cardData) return;
    if (!hasPermission('edit_data', cardData)) {
        showToast('編集権限がありません（閲覧専用）', 'error');
        return;
    }
    
    const fiscalStructure = getFiscalYearStructure();
    if (monthKey !== fiscalStructure.currentMonthKey) {
        showToast('当月分のみ編集可能です', 'info');
        return;
    }

    const displaySpan = element.querySelector('.display-value');
    const selectField = element.querySelector('.edit-select');

    displaySpan.style.display = 'none';
    selectField.style.display = 'block';
    selectField.focus();

    const saveChanges = () => {
        const newValue = parseInt(selectField.value);
        if (!cardData.monthlyData) cardData.monthlyData = {};
        if (!cardData.monthlyData[monthKey]) {
            cardData.monthlyData[monthKey] = { salesIncreaseForecast: 0, probability: 50, memo: "" };
        }
        
        if (cardData.monthlyData[monthKey].probability !== newValue) {
            cardData.monthlyData[monthKey].probability = newValue;
            cardData.lastUpdated = new Date().toISOString();
            
            if (confirm('将来月のデータも同じ確率に更新しますか？\n（キャンセルすると当月のみ更新されます）')) {
                propagateToFutureMonths(cardId, cardData.monthlyData[monthKey].salesIncreaseForecast, newValue);
            } else {
                saveCardsData();
                showToast('当月の確率を更新しました', 'success');
            }
            
            progressCache = null;
            updateDashboard();
            renderCardsOptimized();
        } else {
            selectField.style.display = 'none';
            displaySpan.style.display = 'block';
        }
    };

    const cancelEdit = () => {
        selectField.style.display = 'none';
        displaySpan.style.display = 'block';
    };

    selectField.onchange = saveChanges;
    selectField.onblur = saveChanges;
    selectField.onkeydown = (event) => {
        if (event.key === 'Escape') {
            event.preventDefault();
            cancelEdit();
        }
    };
}
function renderCards() {
    const tb = document.getElementById('jukuTableBody');
    const mc = document.getElementById('cardsContainer');
    tb.innerHTML = '';
    mc.innerHTML = '';

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const probabilityFilter = activeProbabilityFilter || 'all';
    const areaFilter = document.getElementById('areaFilter').value;

        let filteredCards = cardsData.filter(cardData => {
        const title = cardData.jukuName.toLowerCase();
        const status = cardData.status;
        const cardAddress = cardData.address || '';
        const cardMunicipality = extractMunicipality(cardAddress);
        
        // カードの現在表示月の確率を取得
        const activeKey = getCardActiveMonthKey(cardData);
        const cardProbability = cardData.monthlyData?.[activeKey]?.probability || 50;
        
        let show = true;
        if (searchTerm && !title.includes(searchTerm)) show = false;
        if (statusFilter !== 'all' && status !== statusFilter) show = false;
        if (areaFilter !== 'all' && cardMunicipality !== areaFilter) show = false;
        if (probabilityFilter !== 'all' && !matchesProbabilityFilter(cardProbability, probabilityFilter)) show = false;
        return show;
    });

    // 並び替え処理
    filteredCards = getSortedCards(filteredCards);

    // DOM要素への反映
    filteredCards.forEach((cardData) => {
        const tableRow = createTableRow(cardData);
        tb.appendChild(tableRow);
        
        const cardElement = createNewCardElement(cardData);
        mc.appendChild(cardElement);
    });
    
    // 並び替え情報の更新
    updateSortInfo();
    
    // 進捗キャッシュの更新判定
    if (Date.now() - (progressCache?.timestamp || 0) > 2000) {
        progressCache = null;
        updateDashboard();
    }
}

function setupSearchWithIMESupport() {
    const searchInput = document.getElementById('searchInput');
    
    searchInput.addEventListener('compositionstart', () => {
        isComposing = true;
    });
    
    searchInput.addEventListener('compositionend', () => {
        isComposing = false;
        applySearchFilter();
    });
    
    searchInput.addEventListener('input', () => {
        if (!isComposing) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applySearchFilter, 300);
        }
    });
    
    function applySearchFilter() {
        applyFilters();
    }
}

function enhanceAccessibility() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadPersonalSettings();
    loadCardsData();
    initializeDisplayMonth();
    migrateToV9Structure();
    
    updateProbabilityFilterOptions();
    updateAreaFilterOptions();
    updateGlobalMonthSelector();
    
    document.getElementById('sortSelect').value = 'sales-desc';
    
    setupSearchWithIMESupport();
    enhanceAccessibility();
    setupFirebaseAuth();
    setupNumberFormatting(); 

    document.addEventListener('click', function(e) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal[style*="flex"]');
            if (openModal) {
                closeModal(openModal.id);
            }
        }
    });

    document.getElementById('personalSettingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        personalSettings.userName = document.getElementById('userName').value;
        personalSettings.profitRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('profitRate').value) || 0));
        personalSettings.yearlyProfitTarget = parseNumberSafely(document.getElementById('yearlyProfitTarget').value);
        personalSettings.yearlyProfitIncreaseTarget = parseNumberSafely(document.getElementById('yearlyProfitIncreaseTarget').value);
personalSettings.personalSalesIncreaseTarget = parseNumberSafely(document.getElementById('personalSalesIncreaseTarget').value);
        
        updatePersonalSalesTarget();
        // 累積粗利実績の互換性確保
if (typeof personalSettings.cumulativeProfitActual === 'undefined') {
    personalSettings.cumulativeProfitActual = 0;
}
        
        const fiscalMonths = getFiscalYearStructure().months;
        fiscalMonths.forEach(monthInfo => {
            const actualInput = document.getElementById(`monthlyProfitActual${monthInfo.month}`);
            const targetInput = document.getElementById(`monthlyProfitTarget${monthInfo.month}`);
            if (actualInput) {
                personalSettings.monthlyProfitActuals[monthInfo.month] = parseNumberSafely(actualInput.value);
            }
            if (targetInput) {
                personalSettings.monthlyProfitTargets[monthInfo.month] = parseNumberSafely(targetInput.value);
            }
        });
        
        await savePersonalSettingsComplete();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast('個人設定を保存しました！', 'success');
        closePersonalSettingsModal();
    });

    document.getElementById('newCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const jukuName = document.getElementById('newJukuName').value.trim();
        const status = document.getElementById('newJukuStatus').value;
        const address = document.getElementById('newAddressInput').value.trim();
        const area = document.getElementById('newAreaInput').value.trim();
        const salesIncreaseForecast = parseNumberSafely(document.getElementById('newSalesIncreaseForecast').value);
        const probability = parseInt(document.getElementById('newProbability').value) || 50;
        const annualProfitActual = parseNumberSafely(document.getElementById('newProfitActual').value);
        
        if (!jukuName) {
            showToast('塾名を入力してください', 'error');
            return;
        }
        
        const fiscalStructure = getFiscalYearStructure();
        const currentMonthKey = fiscalStructure.currentMonthKey;
        const currentIndex = fiscalStructure.months.findIndex(m => m.key === currentMonthKey);

        const monthlyData = {};
        fiscalStructure.months.forEach((monthInfo, index) => {
            if (index < currentIndex) {
                monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: 0,
                    probability: 50,
                    memo: ""
                };
            } else {
                monthlyData[monthInfo.key] = {
                    salesIncreaseForecast: salesIncreaseForecast,
                    probability: probability,
                    memo: ""
                };
            }
        });

        const annualMaterials = {
            yearRound: {
                hasOrder: document.getElementById('newYearRoundOrder').value === 'true',
                orderPeriod: document.getElementById('newYearRoundPeriod').value.trim()
            },
            seasonalExam: {
                hasUsage: (value => {
        if (value === 'unknown') return null;
        return value === 'true';
    })(document.getElementById('newSeasonalUsage').value),
                usagePeriod: document.getElementById('newSeasonalPeriod').value.trim()
            }
        };

                // docId生成（ユーザーUID_カードIDで一意性確保）
        const newDocId = `${currentUser.uid}_${nextCardId}`;

        const cardData = {
            id: nextCardId++,
            docId: newDocId,  // この行を追加
            jukuName: jukuName,
            status: status,
            address: address,
            area: area,
            assignedUserId: currentUser.uid,
            assignedUserName: currentUserData.name,

            displayMonth: currentMonthKey,
            monthlyData: monthlyData,
            annualProfitActual: annualProfitActual,
            annualMaterials: annualMaterials,
            registeredMonth: currentMonthKey,
            lastUpdated: new Date().toISOString()
        };

        const errors = validateCardData(cardData);
        if (errors.length > 0) {
            showToast(errors[0], 'error');
            return;
        }
        
        cardsData.push(cardData);
        await saveCardsData();
        progressCache = null;
        renderCardsOptimized();
        updateDashboard();
        
        document.getElementById('newCardForm').reset();
        closeNewCardModal();
        showToast(`新規塾「${cardData.jukuName}」を登録しました！`, 'success');
    });

    document.getElementById('editCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const cardId = parseInt(document.getElementById('editCardId').value);
        const cardData = cardsData.find(card => card.id === cardId);
        
        if (!cardData) {
            showToast('編集対象のデータが見つかりません', 'error');
            return;
        }

        const annualProfitActual = parseNumberSafely(document.getElementById('editProfitActual').value);
        
        cardData.jukuName = document.getElementById('editJukuName').value.trim();
        cardData.status = document.getElementById('editJukuStatus').value;
        cardData.address = document.getElementById('editAddressInput').value.trim();
        cardData.area = document.getElementById('editAreaInput').value.trim();
        cardData.annualProfitActual = annualProfitActual;
        
        cardData.annualMaterials = {
            yearRound: {
                hasOrder: document.getElementById('editYearRoundOrder').value === 'true',
                orderPeriod: document.getElementById('editYearRoundPeriod').value.trim()
            },
            seasonalExam: {
    hasUsage: (value => {
        if (value === 'unknown') return null;
        return value === 'true';
    })(document.getElementById('editSeasonalUsage').value),
    usagePeriod: document.getElementById('editSeasonalPeriod').value.trim()
}

        };
        
        cardData.lastUpdated = new Date().toISOString();

        const errors = validateCardData(cardData);
        if (errors.length > 0) {
            showToast(errors[0], 'error');
            return;
        }
        
        await saveCardsData();
        progressCache = null;
        updateDashboard();
        renderCardsOptimized();
        
        showToast(`${cardData.jukuName}のデータを更新しました！`, 'success');
        closeEditCardModal();
    });

    renderCardsOptimized();
    updateDashboard();
});
        // 🆕 ネットワーク状態の監視機能
window.addEventListener('offline', () => {
    showToast('オフラインになりました（ローカル保存に切替）', 'info');
    console.log('Network status: OFFLINE - Switching to local storage mode');
});

window.addEventListener('online', () => {
    showToast('オンラインに復帰しました', 'success');
    console.log('Network status: ONLINE - Firebase sync available');
});

// 🆕 初期読み込み時のネットワーク状態確認
document.addEventListener('DOMContentLoaded', () => {
    if (!navigator.onLine) {
        console.log('Initial network status: OFFLINE');
        setTimeout(() => {
            showToast('オフラインモードで起動しました', 'info');
        }, 1000); // 他の初期化処理後に表示
    }
});

    </script>
    <button class="fab-settings" onclick="openPersonalSettingsModal()" title="個人設定" aria-label="個人設定">⚙️</button>
<button class="fab-add" onclick="openNewCardModal()" title="塾登録" aria-label="塾登録">➕</button>
</body>
</html>
